!function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}sm.siteId=sm.conf.engagement.site_id;var n=t(e);function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function d(e,t,n){return(d=h()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&f(i,n.prototype),i}).apply(null,arguments)}function b(e){var t="function"==typeof Map?new Map:void 0;return(b=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return d(e,arguments,p(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),f(r,e)})(e)}function v(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}function m(e){var t=h();return function(){var n,r=p(e);if(t){var i=p(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return v(this,n)}}function y(e,t,n){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=p(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,i,o=[],s=!0,a=!1;try{for(n=n.call(e);!(s=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);s=!0);}catch(e){a=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(a)throw i}}return o}(e,t)||w(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _(e){return function(e){if(Array.isArray(e))return O(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||w(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){if(e){if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?O(e,t):void 0}}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var E="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function S(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function T(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var x=T((function(e){
/*!
     * EventEmitter v4.2.5 - git.io/ee
     * Oliver Caldwell
     * MIT license
     * @preserve
     */
(function(){function t(){}var n=t.prototype,r=this,i=r.EventEmitter;function s(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1}function a(e){return function(){return this[e].apply(this,arguments)}}n.getListeners=function(e){var t,n,r=this._getEvents();if("object"===o(e))for(n in t={},r)r.hasOwnProperty(n)&&e.test(n)&&(t[n]=r[n]);else t=r[e]||(r[e]=[]);return t},n.flattenListeners=function(e){var t,n=[];for(t=0;t<e.length;t+=1)n.push(e[t].listener);return n},n.getListenersAsObject=function(e){var t,n=this.getListeners(e);return n instanceof Array&&((t={})[e]=n),t||n},n.addListener=function(e,t){var n,r=this.getListenersAsObject(e),i="object"===o(t);for(n in r)r.hasOwnProperty(n)&&-1===s(r[n],t)&&r[n].push(i?t:{listener:t,once:!1});return this},n.on=a("addListener"),n.addOnceListener=function(e,t){return this.addListener(e,{listener:t,once:!0})},n.once=a("addOnceListener"),n.defineEvent=function(e){return this.getListeners(e),this},n.defineEvents=function(e){for(var t=0;t<e.length;t+=1)this.defineEvent(e[t]);return this},n.removeListener=function(e,t){var n,r,i=this.getListenersAsObject(e);for(r in i)i.hasOwnProperty(r)&&-1!==(n=s(i[r],t))&&i[r].splice(n,1);return this},n.off=a("removeListener"),n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,a=e?this.removeListeners:this.addListeners;if("object"!==o(t)||t instanceof RegExp)for(r=n.length;r--;)s.call(this,t,n[r]);else for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&("function"==typeof i?s.call(this,r,i):a.call(this,r,i));return this},n.removeEvent=function(e){var t,n=o(e),r=this._getEvents();if("string"===n)delete r[e];else if("object"===n)for(t in r)r.hasOwnProperty(t)&&e.test(t)&&delete r[t];else delete this._events;return this},n.removeAllListeners=a("removeEvent"),n.emitEvent=function(e,t){var n,r,i,o=this.getListenersAsObject(e);for(i in o)if(o.hasOwnProperty(i))for(r=o[i].length;r--;)!0===(n=o[i][r]).once&&this.removeListener(e,n.listener),n.listener.apply(this,t||[])===this._getOnceReturnValue()&&this.removeListener(e,n.listener);return this},n.trigger=a("emitEvent"),n.emit=function(e){var t=Array.prototype.slice.call(arguments,1);return this.emitEvent(e,t)},n.setOnceReturnValue=function(e){return this._onceReturnValue=e,this},n._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},n._getEvents=function(){return this._events||(this._events={})},t.noConflict=function(){return r.EventEmitter=i,t},e.exports?e.exports=t:this.EventEmitter=t}).call(E)})),A=T((function(e,t){(function(){var t,n,r,i,s,a,c,u={"@@functional/placeholder":!0},l=function(e,t){switch(e){case 0:return function(){return t.apply(this,arguments)};case 1:return function(e){return t.apply(this,arguments)};case 2:return function(e,n){return t.apply(this,arguments)};case 3:return function(e,n,r){return t.apply(this,arguments)};case 4:return function(e,n,r,i){return t.apply(this,arguments)};case 5:return function(e,n,r,i,o){return t.apply(this,arguments)};case 6:return function(e,n,r,i,o,s){return t.apply(this,arguments)};case 7:return function(e,n,r,i,o,s,a){return t.apply(this,arguments)};case 8:return function(e,n,r,i,o,s,a,c){return t.apply(this,arguments)};case 9:return function(e,n,r,i,o,s,a,c,u){return t.apply(this,arguments)};case 10:return function(e,n,r,i,o,s,a,c,u,l){return t.apply(this,arguments)};default:throw new Error("First argument to _arity must be a non-negative integer no greater than ten")}},p=function(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n},f=function(e){return new RegExp(e.source,(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.sticky?"y":"")+(e.unicode?"u":""))},h=function(e){return function(){return!e.apply(this,arguments)}},d=function(e,t){var n;t=t||[];var r=(e=e||[]).length,i=t.length,o=[];for(n=0;n<r;)o[o.length]=e[n],n+=1;for(n=0;n<i;)o[o.length]=t[n],n+=1;return o},b=function(e,t,n){for(var r=0,i=n.length;r<i;){if(e(t,n[r]))return!0;r+=1}return!1},v=function(e,t){for(var n=0,r=t.length,i=[];n<r;)e(t[n])&&(i[i.length]=t[n]),n+=1;return i},m=function(e,t){return Object.prototype.hasOwnProperty.call(t,e)},y=function(e){return e},g=function(){var e=Object.prototype.toString;return"[object Arguments]"===e.call(arguments)?function(t){return"[object Arguments]"===e.call(t)}:function(e){return m("callee",e)}}(),_=Array.isArray||function(e){return null!=e&&e.length>=0&&"[object Array]"===Object.prototype.toString.call(e)},w=Number.isInteger||function(e){return e<<0===e},O=function(e){return"[object Number]"===Object.prototype.toString.call(e)},E=function(e){return"[object Object]"===Object.prototype.toString.call(e)},S=function(e){return null!=e&&"object"===o(e)&&!0===e["@@functional/placeholder"]},T=function(e){return"[object String]"===Object.prototype.toString.call(e)},x=function(e){return"function"==typeof e["@@transducer/step"]},A=function(e,t){for(var n=0,r=t.length,i=Array(r);n<r;)i[n]=e(t[n]),n+=1;return i},k=function(e,t){return function(){return t.call(this,e.apply(this,arguments))}},I=function(e,t){return function(){var n=this;return e.apply(n,arguments).then((function(e){return t.call(n,e)}))}},N=function(e){return'"'+e.replace(/\\/g,"\\\\").replace(/[\b]/g,"\\b").replace(/\f/g,"\\f").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\v/g,"\\v").replace(/\0/g,"\\0").replace(/"/g,'\\"')+'"'},R=function(e){return e&&e["@@transducer/reduced"]?e:{"@@transducer/value":e,"@@transducer/reduced":!0}},C=function e(t,n,r){switch(arguments.length){case 1:return e(t,0,t.length);case 2:return e(t,n,t.length);default:for(var i=[],o=0,s=Math.max(0,Math.min(t.length,r)-n);o<s;)i[o]=t[n+o],o+=1;return i}},P=(t=function(e){return(e<10?"0":"")+e},"function"==typeof Date.prototype.toISOString?function(e){return e.toISOString()}:function(e){return e.getUTCFullYear()+"-"+t(e.getUTCMonth()+1)+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}),M={init:function(){return this.xf["@@transducer/init"]()},result:function(e){return this.xf["@@transducer/result"](e)}},j=function(){function e(e){this.f=e}return e.prototype["@@transducer/init"]=function(){throw new Error("init not implemented on XWrap")},e.prototype["@@transducer/result"]=function(e){return e},e.prototype["@@transducer/step"]=function(e,t){return this.f(e,t)},function(t){return new e(t)}}(),q=function(e,t){return function(){var n=arguments.length;if(0===n)return t();var r=arguments[n-1];return _(r)||"function"!=typeof r[e]?t.apply(this,arguments):r[e].apply(r,C(arguments,0,n-1))}},L=function(e){return function t(n){return 0===arguments.length||S(n)?t:e.apply(this,arguments)}},U=function(e){return function t(n,r){switch(arguments.length){case 0:return t;case 1:return S(n)?t:L((function(t){return e(n,t)}));default:return S(n)&&S(r)?t:S(n)?L((function(t){return e(t,r)})):S(r)?L((function(t){return e(n,t)})):e(n,r)}}},V=function(e){return function t(n,r,i){switch(arguments.length){case 0:return t;case 1:return S(n)?t:U((function(t,r){return e(n,t,r)}));case 2:return S(n)&&S(r)?t:S(n)?U((function(t,n){return e(t,r,n)})):S(r)?U((function(t,r){return e(n,t,r)})):L((function(t){return e(n,r,t)}));default:return S(n)&&S(r)&&S(i)?t:S(n)&&S(r)?U((function(t,n){return e(t,n,i)})):S(n)&&S(i)?U((function(t,n){return e(t,r,n)})):S(r)&&S(i)?U((function(t,r){return e(n,t,r)})):S(n)?L((function(t){return e(t,r,i)})):S(r)?L((function(t){return e(n,t,i)})):S(i)?L((function(t){return e(n,r,t)})):e(n,r,i)}}},D=function e(t,n,r){return function(){for(var i=[],o=0,s=t,a=0;a<n.length||o<arguments.length;){var c;a<n.length&&(!S(n[a])||o>=arguments.length)?c=n[a]:(c=arguments[o],o+=1),i[a]=c,S(c)||(s-=1),a+=1}return s<=0?r.apply(this,i):l(s,e(t,i,r))}},F=function(e,t,n){return function(){var r=arguments.length;if(0===r)return n();var i=arguments[r-1];if(!_(i)){var o=C(arguments,0,r-1);if("function"==typeof i[e])return i[e].apply(i,o);if(x(i)){var s=t.apply(null,o);return s(i)}}return n.apply(this,arguments)}},B=function(){function e(e,t){this.xf=t,this.f=e,this.all=!0}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.all&&(e=this.xf["@@transducer/step"](e,!0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)||(this.all=!1,e=R(this.xf["@@transducer/step"](e,!1))),e},U((function(t,n){return new e(t,n)}))}(),W=function(){function e(e,t){this.xf=t,this.f=e,this.any=!1}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.any||(e=this.xf["@@transducer/step"](e,!1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.any=!0,e=R(this.xf["@@transducer/step"](e,!0))),e},U((function(t,n){return new e(t,n)}))}(),H=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.store(t),this.full?this.xf["@@transducer/step"](e,this.getCopy()):e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},e.prototype.getCopy=function(){return d(C(this.acc,this.pos),C(this.acc,0,this.pos))},U((function(t,n){return new e(t,n)}))}(),G=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){return this.n>0?(this.n-=1,e):this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),z=function(){function e(e,t){this.xf=t,this.pos=0,this.full=!1,this.acc=new Array(e)}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.acc=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.full&&(e=this.xf["@@transducer/step"](e,this.acc[this.pos])),this.store(t),e},e.prototype.store=function(e){this.acc[this.pos]=e,this.pos+=1,this.pos===this.acc.length&&(this.pos=0,this.full=!0)},U((function(t,n){return new e(t,n)}))}(),J=function(){function e(e,t){this.xf=t,this.pred=e,this.lastValue=void 0,this.seenFirstValue=!1}return e.prototype["@@transducer/init"]=function(){return this.xf["@@transducer/init"]()},e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=!1;return this.seenFirstValue?this.pred(this.lastValue,t)&&(n=!0):this.seenFirstValue=!0,this.lastValue=t,n?e:this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Q=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){if(this.f){if(this.f(t))return e;this.f=null}return this.xf["@@transducer/step"](e,t)},U((function(t,n){return new e(t,n)}))}(),Y=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):e},U((function(t,n){return new e(t,n)}))}(),K=function(){function e(e,t){this.xf=t,this.f=e,this.found=!1}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,void 0)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.found=!0,e=R(this.xf["@@transducer/step"](e,t))),e},U((function(t,n){return new e(t,n)}))}(),X=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.found=!1}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.found||(e=this.xf["@@transducer/step"](e,-1)),this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.found=!0,e=R(this.xf["@@transducer/step"](e,this.idx))),e},U((function(t,n){return new e(t,n)}))}(),$=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.last))},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)&&(this.last=t),e},U((function(t,n){return new e(t,n)}))}(),Z=function(){function e(e,t){this.xf=t,this.f=e,this.idx=-1,this.lastIdx=-1}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.xf["@@transducer/result"](this.xf["@@transducer/step"](e,this.lastIdx))},e.prototype["@@transducer/step"]=function(e,t){return this.idx+=1,this.f(t)&&(this.lastIdx=this.idx),e},U((function(t,n){return new e(t,n)}))}(),ee=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){return this.xf["@@transducer/step"](e,this.f(t))},U((function(t,n){return new e(t,n)}))}(),te=function(){function e(e,t){this.xf=t,this.n=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){return 0===this.n?R(e):(this.n-=1,this.xf["@@transducer/step"](e,t))},U((function(t,n){return new e(t,n)}))}(),ne=function(){function e(e,t){this.xf=t,this.f=e}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=M.result,e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.xf["@@transducer/step"](e,t):R(e)},U((function(t,n){return new e(t,n)}))}(),re=U((function(e,t){return e+t})),ie=V((function(e,t,n){if(t>=n.length||t<-n.length)return n;var r=(t<0?n.length:0)+t,i=d(n);return i[r]=e(n[r]),i})),oe=U(F("all",B,(function(e,t){for(var n=0;n<t.length;){if(!e(t[n]))return!1;n+=1}return!0}))),se=L((function(e){return function(){return e}})),ae=U((function(e,t){return e&&t})),ce=U(F("any",W,(function(e,t){for(var n=0;n<t.length;){if(e(t[n]))return!0;n+=1}return!1}))),ue=U(F("aperture",H,(function(e,t){for(var n=0,r=t.length-(e-1),i=new Array(r>=0?r:0);n<r;)i[n]=C(t,n,n+e),n+=1;return i}))),le=U((function(e,t){return d(t,[e])})),pe=U((function(e,t){return e.apply(this,t)})),fe=V((function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r})),he=V((function e(t,n,r){switch(t.length){case 0:return n;case 1:return fe(t[0],n,r);default:return fe(t[0],e(C(t,1),n,Object(r[t[0]])),r)}})),de=U((function(e,t){return l(e.length,(function(){return e.apply(t,arguments)}))})),be=U((function(e,t){return function(){return e.apply(this,arguments)&&t.apply(this,arguments)}})),ve=L((function(e){return function(t,n){return e(t,n)?-1:e(n,t)?1:0}})),me=L((function(e){return function(){for(var t=0;t<e.length;){if(e[t][0].apply(this,arguments))return e[t][1].apply(this,arguments);t+=1}}})),ye=U((function(e,t){for(var n={},r=t.length,i=0;i<r;){var o=e(t[i]);n[o]=(m(o,n)?n[o]:0)+1,i+=1}return n})),ge=U((function(e,t){return 1===e?L(t):l(e,D(e,[],t))})),_e=re(-1),we=U((function(e,t){return null==t||t!=t?e:t})),Oe=V((function(e,t,n){for(var r=[],i=0,o=t.length;i<o;)b(e,t[i],n)||b(e,t[i],r)||r.push(t[i]),i+=1;return r})),Ee=U((function(e,t){var n={};for(var r in t)r!==e&&(n[r]=t[r]);return n})),Se=U((function e(t,n){switch(t.length){case 0:return n;case 1:return Ee(t[0],n);default:var r=t[0],i=C(t,1);return null==n[r]?n:fe(r,e(i,n[r]),n)}})),Te=U((function(e,t){return e/t})),xe=U(F("dropWhile",Q,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return C(t,n)}))),Ae=U((function(e,t){return function(){return e.apply(this,arguments)||t.apply(this,arguments)}})),ke=L((function(e){return null!=e&&"function"==typeof e.empty?e.empty():null!=e&&null!=e.constructor&&"function"==typeof e.constructor.empty?e.constructor.empty():_(e)?[]:T(e)?"":E(e)?{}:g(e)?function(){return arguments}():void 0})),Ie=U((function e(t,n){var r,i,s,a={};for(i in n)s=o(r=t[i]),a[i]="function"===s?r(n[i]):"object"===s?e(t[i],n[i]):n[i];return a})),Ne=U(F("find",K,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return t[n];n+=1}}))),Re=U(F("findIndex",X,(function(e,t){for(var n=0,r=t.length;n<r;){if(e(t[n]))return n;n+=1}return-1}))),Ce=U(F("findLast",$,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return t[n];n-=1}}))),Pe=U(F("findLastIndex",Z,(function(e,t){for(var n=t.length-1;n>=0;){if(e(t[n]))return n;n-=1}return-1}))),Me=U(q("forEach",(function(e,t){for(var n=t.length,r=0;r<n;)e(t[r]),r+=1;return t}))),je=L((function(e){for(var t=0,n=e.length,r={};t<n;)_(e[t])&&e[t].length&&(r[e[t][0]]=e[t][1]),t+=1;return r})),qe=U((function(e,t){return e>t})),Le=U((function(e,t){return e>=t})),Ue=U(m),Ve=U((function(e,t){return e in t})),De=U((function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t})),Fe=L(y),Be=V((function(e,t,n){return ge(Math.max(e.length,t.length,n.length),(function(){return e.apply(this,arguments)?t.apply(this,arguments):n.apply(this,arguments)}))})),We=re(1),He=V((function(e,t,n){e=e<n.length&&e>=0?e:n.length;var r=C(n);return r.splice(e,0,t),r})),Ge=V((function(e,t,n){return e=e<n.length&&e>=0?e:n.length,d(d(C(n,0,e),t),C(n,e))})),ze=U(q("intersperse",(function(e,t){for(var n=[],r=0,i=t.length;r<i;)r===i-1?n.push(t[r]):n.push(t[r],e),r+=1;return n}))),Je=U((function(e,t){return null!=t&&t.constructor===e||t instanceof e})),Qe=L((function(e){return!!_(e)||!!e&&("object"===o(e)&&(!(e instanceof String)&&(1===e.nodeType?!!e.length:0===e.length||e.length>0&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))})),Ye=L((function(e){return null==e})),Ke=function(){var e=!{toString:null}.propertyIsEnumerable("toString"),t=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],n=function(){return arguments.propertyIsEnumerable("length")}(),r=function(e,t){for(var n=0;n<e.length;){if(e[n]===t)return!0;n+=1}return!1};return"function"!=typeof Object.keys||n?L((function(i){if(Object(i)!==i)return[];var o,s,a=[],c=n&&g(i);for(o in i)!m(o,i)||c&&"length"===o||(a[a.length]=o);if(e)for(s=t.length-1;s>=0;)m(o=t[s],i)&&!r(a,o)&&(a[a.length]=o),s-=1;return a})):L((function(e){return Object(e)!==e?[]:Object.keys(e)}))}(),Xe=L((function(e){var t,n=[];for(t in e)n[n.length]=t;return n})),$e=L((function(e){return null!=e&&Je(Number,e.length)?e.length:NaN})),Ze=U((function(e,t){return e<t})),et=U((function(e,t){return e<=t})),tt=V((function(e,t,n){for(var r=0,i=n.length,o=[],s=[t];r<i;)s=e(s[0],n[r]),o[r]=s[1],r+=1;return[s[0],o]})),nt=V((function(e,t,n){for(var r=n.length-1,i=[],o=[t];r>=0;)o=e(o[0],n[r]),i[r]=o[1],r-=1;return[o[0],i]})),rt=U((function(e,t){return t.match(e)||[]})),it=U((function(e,t){return w(e)?!w(t)||t<1?NaN:(e%t+t)%t:NaN})),ot=U((function(e,t){return t>e?t:e})),st=V((function(e,t,n){return e(n)>e(t)?n:t})),at=V((function(e,t,n){var r,i={};for(r in t)m(r,t)&&(i[r]=m(r,n)?e(r,t[r],n[r]):t[r]);for(r in n)m(r,n)&&!m(r,i)&&(i[r]=n[r]);return i})),ct=U((function(e,t){return t<e?t:e})),ut=V((function(e,t,n){return e(n)<e(t)?n:t})),lt=U((function(e,t){return e%t})),pt=U((function(e,t){return e*t})),ft=U((function(e,t){switch(e){case 0:return function(){return t.call(this)};case 1:return function(e){return t.call(this,e)};case 2:return function(e,n){return t.call(this,e,n)};case 3:return function(e,n,r){return t.call(this,e,n,r)};case 4:return function(e,n,r,i){return t.call(this,e,n,r,i)};case 5:return function(e,n,r,i,o){return t.call(this,e,n,r,i,o)};case 6:return function(e,n,r,i,o,s){return t.call(this,e,n,r,i,o,s)};case 7:return function(e,n,r,i,o,s,a){return t.call(this,e,n,r,i,o,s,a)};case 8:return function(e,n,r,i,o,s,a,c){return t.call(this,e,n,r,i,o,s,a,c)};case 9:return function(e,n,r,i,o,s,a,c,u){return t.call(this,e,n,r,i,o,s,a,c,u)};case 10:return function(e,n,r,i,o,s,a,c,u,l){return t.call(this,e,n,r,i,o,s,a,c,u,l)};default:throw new Error("First argument to nAry must be a non-negative integer no greater than ten")}})),ht=L((function(e){return-e})),dt=U(h(F("any",W,ce))),bt=L((function(e){return!e})),vt=U((function(e,t){var n=e<0?t.length+e:e;return T(t)?t.charAt(n):t[n]})),mt=L((function(e){return function(){return vt(e,arguments)}})),yt=U((function(e,t){var n={};return n[e]=t,n})),gt=L((function(e){return[e]})),_t=L((function(e){var t,n=!1;return l(e.length,(function(){return n?t:(n=!0,t=e.apply(this,arguments))}))})),wt=U((function(e,t){return e||t})),Ot=(n=function e(t){return{value:t,map:function(n){return e(n(t))}}},V((function(e,t,r){return e((function(e){return n(t(e))}))(r).value}))),Et=U((function(e,t){return[e,t]})),St=U((function(e,t){for(var n=t,r=0;r<e.length;){if(null==n)return;n=n[e[r]],r+=1}return n})),Tt=V((function(e,t,n){return we(e,St(t,n))})),xt=V((function(e,t,n){return t.length>0&&e(St(t,n))})),At=U((function(e,t){for(var n={},r=0;r<e.length;)e[r]in t&&(n[e[r]]=t[e[r]]),r+=1;return n})),kt=U((function(e,t){for(var n={},r=0,i=e.length;r<i;){var o=e[r];n[o]=t[o],r+=1}return n})),It=U((function(e,t){var n={};for(var r in t)e(t[r],r,t)&&(n[r]=t[r]);return n})),Nt=U((function(e,t){return d([e],t)})),Rt=U((function(e,t){return t[e]})),Ct=V((function(e,t,n){return null!=n&&m(t,n)?n[t]:e})),Pt=V((function(e,t,n){return e(n[t])})),Mt=U((function(e,t){for(var n=e.length,r=[],i=0;i<n;)r[i]=t[e[i]],i+=1;return r})),jt=U((function(e,t){if(!O(e)||!O(t))throw new TypeError("Both arguments to range must be numbers");for(var n=[],r=e;r<t;)n.push(r),r+=1;return n})),qt=V((function(e,t,n){for(var r=n.length-1;r>=0;)t=e(t,n[r]),r-=1;return t})),Lt=L(R),Ut=V((function(e,t,n){return d(C(n,0,Math.min(e,n.length)),C(n,Math.min(n.length,e+t)))})),Vt=V((function(e,t,n){return n.replace(e,t)})),Dt=L((function(e){return T(e)?e.split("").reverse().join(""):C(e).reverse()})),Ft=V((function(e,t,n){for(var r=0,i=n.length,o=[t];r<i;)t=e(t,n[r]),o[r+1]=t,r+=1;return o})),Bt=V((function(e,t,n){return Ot(e,se(t),n)})),Wt=V(q("slice",(function(e,t,n){return Array.prototype.slice.call(n,e,t)}))),Ht=U((function(e,t){return C(t).sort(e)})),Gt=U((function(e,t){return C(t).sort((function(t,n){var r=e(t),i=e(n);return r<i?-1:r>i?1:0}))})),zt=U((function(e,t){return[Wt(0,e,t),Wt(e,$e(t),t)]})),Jt=U((function(e,t){if(e<=0)throw new Error("First argument to splitEvery must be a positive integer");for(var n=[],r=0;r<t.length;)n.push(Wt(r,r+=e,t));return n})),Qt=U((function(e,t){for(var n=0,r=t.length,i=[];n<r&&!e(t[n]);)i.push(t[n]),n+=1;return[i,C(t,n)]})),Yt=U((function(e,t){return e-t})),Kt=q("tail",Wt(1,1/0)),Xt=U(F("take",te,(function(e,t){return Wt(0,e<0?1/0:e,t)}))),$t=U((function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return C(t,n+1,1/0)})),Zt=U(F("takeWhile",ne,(function(e,t){for(var n=0,r=t.length;n<r&&e(t[n]);)n+=1;return C(t,0,n)}))),en=U((function(e,t){return e(t),t})),tn=U((function(e,t){var n,r=Number(t),i=0;if(r<0||isNaN(r))throw new RangeError("n must be a non-negative number");for(n=new Array(r);i<r;)n[i]=e(i),i+=1;return n})),nn=L((function(e){var t=[];for(var n in e)m(n,e)&&(t[t.length]=[n,e[n]]);return t})),rn=L((function(e){var t=[];for(var n in e)t[t.length]=[n,e[n]];return t})),on=L((function(e){for(var t=0,n=[];t<e.length;){for(var r=e[t],i=0;i<r.length;)void 0===n[i]&&(n[i]=[]),n[i].push(r[i]),i+=1;t+=1}return n})),sn=(r="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff","function"==typeof String.prototype.trim&&!r.trim()&&"​".trim()?L((function(e){return e.trim()})):L((function(e){var t=new RegExp("^["+r+"]["+r+"]*"),n=new RegExp("["+r+"]["+r+"]*$");return e.replace(t,"").replace(n,"")}))),an=L((function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)})),cn=L((function(e){return function(){return e(C(arguments))}})),un=L((function(e){return ft(1,e)})),ln=U((function(e,t){return ge(e,(function(){for(var n,r=1,i=t,o=0;r<=e&&"function"==typeof i;)n=r===e?arguments.length:o+i.length,i=i.apply(this,C(arguments,o,n)),r+=1,o=n;return i}))})),pn=U((function(e,t){for(var n=e(t),r=[];n&&n.length;)r[r.length]=n[0],n=e(n[1]);return r})),fn=U((function(e,t){for(var n,r=0,i=t.length,o=[];r<i;)n=t[r],b(e,n,o)||(o[o.length]=n),r+=1;return o})),hn=V((function(e,t,n){return e(n)?n:t(n)})),dn=V((function(e,t,n){return ie(se(t),e,n)})),bn=U((function(e,t){return ge(t.length,(function(){for(var n=[],r=0;r<t.length;)n.push(t[r].call(this,arguments[r])),r+=1;return e.apply(this,n.concat(C(arguments,t.length)))}))})),vn=L((function(e){for(var t=Ke(e),n=t.length,r=[],i=0;i<n;)r[i]=e[t[i]],i+=1;return r})),mn=L((function(e){var t,n=[];for(t in e)n[n.length]=e[t];return n})),yn=(i=function(e){return{value:e,map:function(){return this}}},U((function(e,t){return e(i)(t).value}))),gn=V((function(e,t,n){return e(n)?t(n):n})),_n=U((function(e,t){for(var n in e)if(m(n,e)&&!e[n](t[n]))return!1;return!0})),wn=U((function(e,t){return ge(e.length,(function(){return t.apply(this,d([e],arguments))}))})),On=U((function(e,t){for(var n,r=0,i=e.length,o=t.length,s=[];r<i;){for(n=0;n<o;)s[s.length]=[e[r],t[n]],n+=1;r+=1}return s})),En=U((function(e,t){for(var n=[],r=0,i=Math.min(e.length,t.length);r<i;)n[r]=[e[r],t[r]],r+=1;return n})),Sn=U((function(e,t){for(var n=0,r=e.length,i={};n<r;)i[e[n]]=t[n],n+=1;return i})),Tn=V((function(e,t,n){for(var r=[],i=0,o=Math.min(t.length,n.length);i<o;)r[i]=e(t[i],n[i]),i+=1;return r})),xn=se(!1),An=se(!0),kn=function e(t,n,r){var i=function(i){for(var o=n.length,s=0;s<o;){if(t===n[s])return r[s];s+=1}for(var a in n[s+1]=t,r[s+1]=i,t)i[a]=e(t[a],n,r);return i};switch(an(t)){case"Object":return i({});case"Array":return i([]);case"Date":return new Date(t.valueOf());case"RegExp":return f(t);default:return t}},In=function(e){return U((function(t,n){return l(Math.max(0,t.length-n.length),(function(){return t.apply(this,e(n,arguments))}))}))},Nn=function e(t,n,r,i){if(De(t,n))return!0;if(an(t)!==an(n))return!1;if(null==t||null==n)return!1;if("function"==typeof t.equals||"function"==typeof n.equals)return"function"==typeof t.equals&&t.equals(n)&&"function"==typeof n.equals&&n.equals(t);switch(an(t)){case"Arguments":case"Array":case"Object":break;case"Boolean":case"Number":case"String":if(o(t)!==o(n)||!De(t.valueOf(),n.valueOf()))return!1;break;case"Date":if(!De(t.valueOf(),n.valueOf()))return!1;break;case"Error":return t.name===n.name&&t.message===n.message;case"RegExp":if(t.source!==n.source||t.global!==n.global||t.ignoreCase!==n.ignoreCase||t.multiline!==n.multiline||t.sticky!==n.sticky||t.unicode!==n.unicode)return!1;break;case"Map":case"Set":if(!e(p(t.entries()),p(n.entries()),r,i))return!1;break;case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var s=Ke(t);if(s.length!==Ke(n).length)return!1;for(var a=r.length-1;a>=0;){if(r[a]===t)return i[a]===n;a-=1}for(r.push(t),i.push(n),a=s.length-1;a>=0;){var c=s[a];if(!m(c,n)||!e(n[c],t[c],r,i))return!1;a-=1}return r.pop(),i.pop(),!0},Rn=function(e){return function t(n){for(var r,i,o,s=[],a=0,c=n.length;a<c;){if(Qe(n[a]))for(o=0,i=(r=e?t(n[a]):n[a]).length;o<i;)s[s.length]=r[o],o+=1;else s[s.length]=n[a];a+=1}return s}},Cn=function(){function e(e,t,n){for(var r=n.next();!r.done;){if((t=e["@@transducer/step"](t,r.value))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r=n.next()}return e["@@transducer/result"](t)}var t="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator";return function(n,r,i){if("function"==typeof n&&(n=j(n)),Qe(i))return function(e,t,n){for(var r=0,i=n.length;r<i;){if((t=e["@@transducer/step"](t,n[r]))&&t["@@transducer/reduced"]){t=t["@@transducer/value"];break}r+=1}return e["@@transducer/result"](t)}(n,r,i);if("function"==typeof i.reduce)return function(e,t,n){return e["@@transducer/result"](n.reduce(de(e["@@transducer/step"],e),t))}(n,r,i);if(null!=i[t])return e(n,r,i[t]());if("function"==typeof i.next)return e(n,r,i);throw new TypeError("reduce: list must be array or iterable")}}(),Pn=function(){function e(e,t){this.f=e,this.retained=[],this.xf=t}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){return this.retained=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){return this.f(t)?this.retain(e,t):this.flush(e,t)},e.prototype.flush=function(e,t){return e=Cn(this.xf["@@transducer/step"],e,this.retained),this.retained=[],this.xf["@@transducer/step"](e,t)},e.prototype.retain=function(e,t){return this.retained.push(t),e},U((function(t,n){return new e(t,n)}))}(),Mn=function(){function e(e,t){this.xf=t,this.f=e,this.inputs={}}return e.prototype["@@transducer/init"]=M.init,e.prototype["@@transducer/result"]=function(e){var t;for(t in this.inputs)if(m(t,this.inputs)&&(e=this.xf["@@transducer/step"](e,this.inputs[t]))["@@transducer/reduced"]){e=e["@@transducer/value"];break}return this.inputs=null,this.xf["@@transducer/result"](e)},e.prototype["@@transducer/step"]=function(e,t){var n=this.f(t);return this.inputs[n]=this.inputs[n]||[n,[]],this.inputs[n][1]=le(t,this.inputs[n][1]),e},U((function(t,n){return new e(t,n)}))}(),jn=L((function(e){return ge(e.length,(function(){var t=0,n=arguments[0],r=arguments[arguments.length-1],i=C(arguments);return i[0]=function(){var e=n.apply(this,d(arguments,[t,r]));return t+=1,e},e.apply(this,i)}))})),qn=L((function(e){return ft(2,e)})),Ln=L((function(e){return null!=e&&"function"==typeof e.clone?e.clone():kn(e,[],[])})),Un=L((function(e){return ge(e.length,e)})),Vn=U(F("drop",G,(function(e,t){return Wt(Math.max(0,e),1/0,t)}))),Dn=U(F("dropLast",z,(function(e,t){return Xt(e<t.length?t.length-e:0,t)}))),Fn=U(F("dropLastWhile",Pn,(function(e,t){for(var n=t.length-1;n>=0&&e(t[n]);)n-=1;return C(t,0,n+1)}))),Bn=U((function(e,t){return Nn(e,t,[],[])})),Wn=U(F("filter",Y,(function(e,t){return E(t)?Cn((function(n,r){return e(t[r])&&(n[r]=t[r]),n}),{},Ke(t)):v(e,t)}))),Hn=L(Rn(!0)),Gn=L((function(e){return Un((function(t,n){var r=C(arguments);return r[0]=n,r[1]=t,e.apply(this,r)}))})),zn=U(F("groupBy",Mn,(function(e,t){return Cn((function(t,n){var r=e(n);return t[r]=le(n,t[r]||(t[r]=[])),t}),{},t)}))),Jn=vt(0),Qn=U((function(e,t){return Cn((function(t,n){return t[e(n)]=n,t}),{},t)})),Yn=Wt(0,-1),Kn=V((function(e,t,n){for(var r=[],i=0;i<t.length;)b(e,t[i],n)&&(r[r.length]=t[i]),i+=1;return fn(e,r)})),Xn=L((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r],s=e[o],a=m(s,i)?i[s]:i[s]=[];a[a.length]=o,r+=1}return i})),$n=L((function(e){for(var t=Ke(e),n=t.length,r=0,i={};r<n;){var o=t[r];i[e[o]]=o,r+=1}return i})),Zn=L((function(e){return null!=e&&Bn(e,ke(e))})),er=vt(-1),tr=U((function(e,t){if("function"!=typeof t.lastIndexOf||_(t)){for(var n=t.length-1;n>=0;){if(Bn(t[n],e))return n;n-=1}return-1}return t.lastIndexOf(e)})),nr=U(F("map",ee,(function(e,t){switch(Object.prototype.toString.call(t)){case"[object Function]":return ge(t.length,(function(){return e.call(this,t.apply(this,arguments))}));case"[object Object]":return Cn((function(n,r){return n[r]=e(t[r]),n}),{},Ke(t));default:return A(e,t)}}))),rr=U((function(e,t){return Cn((function(n,r){return n[r]=e(t[r],r,t),n}),{},Ke(t))})),ir=V((function(e,t,n){return at((function(t,n,r){return e(n,r)}),t,n)})),or=In(d),sr=In(Gn(d)),ar=U((function(e,t){return Cn((function(t,n){var r=t[e(n)?0:1];return r[r.length]=n,t}),[[],[]],t)})),cr=V((function(e,t,n){return Bn(St(e,n),t)})),ur=U((function(e,t){return nr(Rt(e),t)})),lr=bn(A,[kt,Fe]),pr=V((function(e,t,n){return Pt(Bn(t),e,n)})),fr=V((function(e,t,n){return Pt(Je(e),t,n)})),hr=V(Cn),dr=U((function(e,t){return Wn(h(e),t)})),br=U((function(e,t){return tn(se(e),t)})),vr=hr(re,0),mr=U((function(e,t){return Vn(e>=0?t.length-e:0,t)})),yr=ge(4,(function(e,t,n,r){return Cn(e("function"==typeof t?j(t):t),n,r)})),gr=V((function(e,t,n){return fn(e,d(t,n))})),_r=U((function(e,t){return _n(nr(Bn,e),t)})),wr=function(e){var t=function(e){return{"@@transducer/init":M.init,"@@transducer/result":function(t){return e["@@transducer/result"](t)},"@@transducer/step":function(t,n){var r=e["@@transducer/step"](t,n);return r["@@transducer/reduced"]?{"@@transducer/value":r,"@@transducer/reduced":!0}:r}}}(e);return{"@@transducer/init":M.init,"@@transducer/result":function(e){return t["@@transducer/result"](e)},"@@transducer/step":function(e,n){return Qe(n)?Cn(t,e,n):Cn(t,e,[n])}}},Or=function(e,t,n){var r,i;if("function"==typeof e.indexOf)switch(o(t)){case"number":if(0===t){for(r=1/t;n<e.length;){if(0===(i=e[n])&&1/i===r)return n;n+=1}return-1}if(t!=t){for(;n<e.length;){if("number"==typeof(i=e[n])&&i!=i)return n;n+=1}return-1}return e.indexOf(t,n);case"string":case"boolean":case"function":case"undefined":return e.indexOf(t,n);case"object":if(null===t)return e.indexOf(t,n)}for(;n<e.length;){if(Bn(e[n],t))return n;n+=1}return-1},Er=U((function(e,t){return nr(e,wr(t))})),Sr=L((function(e){return ge(hr(ot,0,ur("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(!e[t].apply(this,arguments))return!1;t+=1}return!0}))})),Tr=L((function(e){for(var t=e.length,n=0;n<t;){if(Or(e,e[n],n+1)>=0)return!1;n+=1}return!0})),xr=L((function(e){return ge(hr(ot,0,ur("length",e)),(function(){for(var t=0,n=e.length;t<n;){if(e[t].apply(this,arguments))return!0;t+=1}return!1}))})),Ar=U((function(e,t){return"function"==typeof e.ap?e.ap(t):"function"==typeof e?ge(Math.max(e.length,t.length),(function(){return e.apply(this,arguments)(t.apply(this,arguments))})):Cn((function(e,n){return d(e,nr(n,t))}),[],e)})),kr=Un((function(e){return e.apply(this,C(arguments,1))})),Ir=U(F("chain",Er,(function(e,t){return"function"==typeof t?function(){return t.call(this,e.apply(this,arguments)).apply(this,arguments)}:Rn(!1)(nr(e,t))}))),Nr=V((function(e,t,n){return qt((function(t,n){return Ar(nr(Nt,e(n)),t)}),t([]),n)})),Rr=U((function(e,t){if(e>10)throw new Error("Constructor with greater than ten arguments");return 0===e?function(){return new t}:Un(ft(e,(function(e,n,r,i,o,s,a,c,u,l){switch(arguments.length){case 1:return new t(e);case 2:return new t(e,n);case 3:return new t(e,n,r);case 4:return new t(e,n,r,i);case 5:return new t(e,n,r,i,o);case 6:return new t(e,n,r,i,o,s);case 7:return new t(e,n,r,i,o,s,a);case 8:return new t(e,n,r,i,o,s,a,c);case 9:return new t(e,n,r,i,o,s,a,c,u);case 10:return new t(e,n,r,i,o,s,a,c,u,l)}})))})),Cr=U((function(e,t){return ge(Math.max.apply(Math,ur("length",t)),(function(){var n=arguments,r=this;return e.apply(r,A((function(e){return e.apply(r,n)}),t))}))})),Pr=U(F("dropRepeatsWith",J,(function(e,t){var n=[],r=1,i=t.length;if(0!==i)for(n[0]=t[0];r<i;)e(er(n),t[r])||(n[n.length]=t[r]),r+=1;return n}))),Mr=V((function(e,t,n){return Bn(e(t),e(n))})),jr=V((function(e,t,n){return Bn(t[e],n[e])})),qr=U((function(e,t){return"function"!=typeof t.indexOf||_(t)?Or(t,e,0):t.indexOf(e)})),Lr=L((function(e){return function(){return nr(pe(u,arguments),e)}})),Ur=U((function(e,t){return function(n){return function(r){return nr((function(e){return t(e,r)}),n(e(r)))}}})),Vr=L((function(e){return Ur(vt(e),dn(e))})),Dr=L((function(e){return Ur(St(e),he(e))})),Fr=L((function(e){return Ur(Rt(e),fe(e))})),Br=U((function(e,t){var n=ge(e,t);return ge(e,(function(){return Cn(Ar,nr(n,arguments[0]),C(arguments,1))}))})),Wr=L((function(e){return vr(e)/e.length})),Hr=L((function(e){var t=e.length;if(0===t)return NaN;var n=2-t%2,r=(t-n)/2;return Wr(C(e).sort((function(e,t){return e<t?-1:e>t?1:0})).slice(r,r+n))})),Gr=ir((function(e,t){return t})),zr=L((function(e){return hr(Gr,{},e)})),Jr=function(){if(0===arguments.length)throw new Error("pipe requires at least one argument");return l(arguments[0].length,hr(k,arguments[0],Kt(arguments)))},Qr=function(){if(0===arguments.length)throw new Error("pipeP requires at least one argument");return l(arguments[0].length,hr(I,arguments[0],Kt(arguments)))},Yr=hr(pt,1),Kr=U((function(e,t){return"function"==typeof t.sequence?t.sequence(e):qt((function(e,t){return Ar(nr(Nt,t),e)}),e([]),t)})),Xr=V((function(e,t,n){return Kr(e,nr(t,n))})),$r=Ir(y),Zr=function(e,t){return Or(t,e,0)>=0},ei=(s={"@@transducer/init":Array,"@@transducer/step":function(e,t){return d(e,[t])},"@@transducer/result":y},a={"@@transducer/init":String,"@@transducer/step":function(e,t){return e+t},"@@transducer/result":y},c={"@@transducer/init":Object,"@@transducer/step":function(e,t){return Gr(e,Qe(t)?yt(t[0],t[1]):t)},"@@transducer/result":y},function(e){if(x(e))return e;if(Qe(e))return s;if("string"==typeof e)return a;if("object"===o(e))return c;throw new Error("Cannot create transformer for "+e)}),ti=function e(t,n){var r=function(r){var i=n.concat([t]);return Zr(r,i)?"<Circular>":e(r,i)},i=function(e,t){return A((function(t){return N(t)+": "+r(e[t])}),t.slice().sort())};switch(Object.prototype.toString.call(t)){case"[object Arguments]":return"(function() { return arguments; }("+A(r,t).join(", ")+"))";case"[object Array]":return"["+A(r,t).concat(i(t,dr((function(e){return/^\d+$/.test(e)}),Ke(t)))).join(", ")+"]";case"[object Boolean]":return"object"===o(t)?"new Boolean("+r(t.valueOf())+")":t.toString();case"[object Date]":return"new Date("+(isNaN(t.valueOf())?r(NaN):N(P(t)))+")";case"[object Null]":return"null";case"[object Number]":return"object"===o(t)?"new Number("+r(t.valueOf())+")":1/t==-1/0?"-0":t.toString(10);case"[object String]":return"object"===o(t)?"new String("+r(t.valueOf())+")":N(t);case"[object Undefined]":return"undefined";default:if("function"==typeof t.toString){var s=t.toString();if("[object Object]"!==s)return s}return"{"+i(t,Ke(t)).join(", ")+"}"}},ni=Nr(Fe),ri=function(){if(0===arguments.length)throw new Error("compose requires at least one argument");return Jr.apply(this,Dt(arguments))},ii=function(){return ri.apply(this,Nt(Fe,nr(Ir,arguments)))},oi=L((function(e){return Rr(e.length,e)})),si=U(Zr),ai=U((function(e,t){for(var n=[],r=0,i=e.length;r<i;)Zr(e[r],t)||Zr(e[r],n)||(n[n.length]=e[r]),r+=1;return n})),ci=L(F("dropRepeats",J(Bn),Pr(Bn))),ui=V((function(e,t,n){return x(e)?Cn(t(e),e["@@transducer/init"](),n):Cn(t(ei(e)),e,n)})),li=L((function(e){return Br(e.length,e)})),pi=U((function(e,t){var n={};for(var r in t)Zr(r,e)||(n[r]=t[r]);return n})),fi=L((function(e){return ti(e,[])})),hi=U("undefined"==typeof Set?function(e,t){for(var n,r,i=0,o=[],s=[];i<t.length;)n=e(r=t[i]),Zr(n,o)||(s.push(r),o.push(n)),i+=1;return s}:function(e,t){for(var n,r,i,s=new Set,a=[],c=0,u=[],l=!1,p=!1,f=0;f<t.length;){switch(o(n=e(r=t[f]))){case"number":if(0===n&&!p&&1/n==-1/0){p=!0,u.push(r);break}case"string":case"boolean":case"function":case"undefined":s.add(n),(i=s.size)>c&&(u.push(r),c=i);break;case"object":if(null===n){l||(l=!0,u.push(null));break}default:Zr(n,a)||(a.push(n),u.push(r))}f+=1}return u}),di=U((function(e,t){return dr(Gn(Zr)(e),t)})),bi=li(bt),vi=U((function(e,t){return ge(e+1,(function(){var n=arguments[e];if(null!=n&&Je(Function,n[t]))return n[t].apply(n,C(arguments,0,e));throw new TypeError(fi(n)+' does not have a method named "'+t+'"')}))})),mi=vi(1,"join"),yi=L((function(e){var t={};return l(e.length,(function(){var n=fi(arguments);return m(n,t)||(t[n]=e.apply(this,arguments)),t[n]}))})),gi=vi(1,"split"),_i=U((function(e,t){if(n=e,"[object RegExp]"!==Object.prototype.toString.call(n))throw new TypeError("‘test’ requires a value of type RegExp as its first argument; received "+fi(e));var n;return f(e).test(t)})),wi=vi(0,"toLowerCase"),Oi=vi(0,"toUpperCase"),Ei=hi(Fe),Si=Gn(vi(1,"concat")),Ti=U((function(e,t){return Ei(v(Gn(Zr)(e),t))})),xi=U((function(e,t){return Si(ai(e,t),ai(t,e))})),Ai=V((function(e,t,n){return Si(Oe(e,t,n),Oe(e,n,t))})),ki=U(ri(Ei,d)),Ii={F:xn,T:An,__:u,add:re,addIndex:jn,adjust:ie,all:oe,allPass:Sr,allUniq:Tr,always:se,and:ae,any:ce,anyPass:xr,ap:Ar,aperture:ue,append:le,apply:pe,assoc:fe,assocPath:he,binary:qn,bind:de,both:be,call:kr,chain:Ir,clone:Ln,commute:ni,commuteMap:Nr,comparator:ve,complement:bi,compose:ri,composeK:ii,composeP:function(){if(0===arguments.length)throw new Error("composeP requires at least one argument");return Qr.apply(this,Dt(arguments))},concat:Si,cond:me,construct:oi,constructN:Rr,contains:si,converge:Cr,countBy:ye,curry:Un,curryN:ge,dec:_e,defaultTo:we,difference:ai,differenceWith:Oe,dissoc:Ee,dissocPath:Se,divide:Te,drop:Vn,dropLast:Dn,dropLastWhile:Fn,dropRepeats:ci,dropRepeatsWith:Pr,dropWhile:xe,either:Ae,empty:ke,eqBy:Mr,eqProps:jr,equals:Bn,evolve:Ie,filter:Wn,find:Ne,findIndex:Re,findLast:Ce,findLastIndex:Pe,flatten:Hn,flip:Gn,forEach:Me,fromPairs:je,groupBy:zn,gt:qe,gte:Le,has:Ue,hasIn:Ve,head:Jn,identical:De,identity:Fe,ifElse:Be,inc:We,indexBy:Qn,indexOf:qr,init:Yn,insert:He,insertAll:Ge,intersection:Ti,intersectionWith:Kn,intersperse:ze,into:ui,invert:Xn,invertObj:$n,invoker:vi,is:Je,isArrayLike:Qe,isEmpty:Zn,isNil:Ye,join:mi,juxt:Lr,keys:Ke,keysIn:Xe,last:er,lastIndexOf:tr,length:$e,lens:Ur,lensIndex:Vr,lensPath:Dr,lensProp:Fr,lift:li,liftN:Br,lt:Ze,lte:et,map:nr,mapAccum:tt,mapAccumRight:nt,mapObjIndexed:rr,match:rt,mathMod:it,max:ot,maxBy:st,mean:Wr,median:Hr,memoize:yi,merge:Gr,mergeAll:zr,mergeWith:ir,mergeWithKey:at,min:ct,minBy:ut,modulo:lt,multiply:pt,nAry:ft,negate:ht,none:dt,not:bt,nth:vt,nthArg:mt,objOf:yt,of:gt,omit:pi,once:_t,or:wt,over:Ot,pair:Et,partial:or,partialRight:sr,partition:ar,path:St,pathEq:cr,pathOr:Tt,pathSatisfies:xt,pick:At,pickAll:kt,pickBy:It,pipe:Jr,pipeK:function(){return ii.apply(this,Dt(arguments))},pipeP:Qr,pluck:ur,prepend:Nt,product:Yr,project:lr,prop:Rt,propEq:pr,propIs:fr,propOr:Ct,propSatisfies:Pt,props:Mt,range:jt,reduce:hr,reduceRight:qt,reduced:Lt,reject:dr,remove:Ut,repeat:br,replace:Vt,reverse:Dt,scan:Ft,sequence:Kr,set:Bt,slice:Wt,sort:Ht,sortBy:Gt,split:gi,splitAt:zt,splitEvery:Jt,splitWhen:Qt,subtract:Yt,sum:vr,symmetricDifference:xi,symmetricDifferenceWith:Ai,tail:Kt,take:Xt,takeLast:mr,takeLastWhile:$t,takeWhile:Zt,tap:en,test:_i,times:tn,toLower:wi,toPairs:nn,toPairsIn:rn,toString:fi,toUpper:Oi,transduce:yr,transpose:on,traverse:Xr,trim:sn,type:an,unapply:cn,unary:un,uncurryN:ln,unfold:pn,union:ki,unionWith:gr,uniq:Ei,uniqBy:hi,uniqWith:fn,unless:hn,unnest:$r,update:dn,useWith:bn,values:vn,valuesIn:mn,view:yn,when:gn,where:_n,whereEq:_r,without:di,wrap:wn,xprod:On,zip:En,zipObj:Sn,zipWith:Tn};e.exports=Ii}).call(E)})),k={enabled:!0},I=function(e,t,n,r,i){t||(t=6e4),void 0===n&&(n=2),void 0===r&&(r=.5),i||(i=Math.random);var o=null,s=function(s){if(!k.enabled)return 6048e5;var a=e*Math.pow(n,s);o&&(a=Math.max(a,o),o=null);var c=i(),u=Math.floor(c*r*a),l=Math.floor(10*c)%2==0?a-u:a+u;return a=Math.min(l,t),k.maxDelay&&a>k.maxDelay?k.maxDelay:k.minDelay&&a<=k.minDelay?k.minDelay:a};return s.setNextDelayMinimum=function(e){o=e},s.maximizeNextDelay=function(){return s.setNextDelayMinimum(t)},s},N=function e(t){var n=t.calculateAttemptDelay,r=t.attempt,i=t.onGiveUp,o=t.retryLimit,s=t.retryCount,a=0===s?0:n(s);return setTimeout((function(){return r({context:{retryLimit:o,retryCount:s,delay:a},repeat:function(t){return 0===o||s<o?e({calculateAttemptDelay:n,attempt:r,onGiveUp:i,retryLimit:o,retryCount:s+1}):i(t)}})}),a)},R=function(e){var t=e.calculateAttemptDelay,n=e.attempt,r=e.onGiveUp,i=e.retryLimit;if(0!==i&&!r)throw new Error("Must define onGiveUp if retryLimit is not 0");return N({calculateAttemptDelay:t,attempt:n,onGiveUp:r,retryLimit:i,retryCount:0})},C=function(){return sm.conf.integrities_enabled},P=function(e){if(C()||e.force){var t=e.name?A.propEq("name",e.name):A.propEq("versioned_name",e.versionedName),n=A.find(t,sm.conf.integrities);if(n)return A.prop("integrity",n);sm.logger.error("Could not find expected integrity for module",e)}},M=function(e){var t=e.beforeLoad,n=e.onAttempt,r=e.onLoad,i=e.onError,o=e.onGiveUp,s=e.integrity,a=e.fileUrl,c=e.retryLimit,u=void 0===c?5:c,l=e.backoffDelay;R({calculateAttemptDelay:I(void 0===l?1e3:l),attempt:function(e){var o=e.repeat;"function"==typeof n&&n();var c=document.createElement("script");return c.type="text/javascript",c.onload=function(){"function"==typeof r&&r()},c.onerror=function(){"function"==typeof i&&i(),document.head.removeChild(c),o()},c.src=a,s&&(c.setAttribute("integrity",s),c.setAttribute("crossorigin","*")),"function"==typeof t&&t(c),document.head.appendChild(c),c},onGiveUp:function(){"function"==typeof o&&o()},retryLimit:u})};function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function q(){var e=this;this.list=[],this.add=function(t){10===e.list.length&&(e.list=e.list.slice(1)),e.list.push(t)}}var L=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var i in t)n[i]=t[i];return n},U=function(e){var t={};for(var n in e){var r=e[n];t[n]="function"==typeof r?r():r}return t},V=function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n)},D=["string","number","boolean","null","undefined"];var F=function(e){return Object.keys(e).map((function(t){return e[t]}))};var B={CustomTransport:function(e){if(!e)throw new Error("processFn must be specificed when using CustomTransport");this.process=e},HttpTransport:function(e){var t=e.url,n=e.method,r=e.headers,i=e.encode;if(!t)throw new Error("url must be specificed when using HttpTransport");n||(n="POST"),r||(r={}),i||(i=function(e){return JSON.stringify(e)}),this.process=window.fetch?function(e){var o=e.payload;return window.fetch(t,{method:n,headers:r,keepalive:!0,body:i(o)})}:function(e){var o=e.payload;return new Promise((function(e,s){var a=new XMLHttpRequest;a.open(n,t),Object.keys(r).forEach((function(e){a.setRequestHeader(e,r[e])})),a.onload=function(){a.status<200||status>=300?s():e()},a.onerror=function(){return s()},a.send(i(o))}))}}},W=function(e){return function(t){var n=t.namespace;return{attempted:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.tags,i=void 0===r?[]:r,o=Date.now(),s=!1,a=function(t){var r=t.action,o=t.reason,s=["action:".concat(r)];return o&&s.push("reason:".concat(o)),e.increment("sm.lib.".concat(n),A.concat(i,s))},c=function(e){return a({action:"failed",reason:e})},u=function(t){var r=t.action;s=!0;var a=Date.now()-o;e.histogram("sm.timing.lib.".concat(n),a,A.concat(i,["client:browser","action:".concat(r)]))};return a({action:"attempted"}),{succeeded:function(){a({action:"succeeded"}),u({action:"succeeded"})},failed:function(e){c(e),u({action:"failed"})},timedOut:function(){c("timed_out"),u({action:"failed"})},failedUnknown:function(){c("unknown"),u({action:"failed"})},isFinished:function(){return s}}}}}},H=["timing","increment","decrement","gauge","histogram","set"],G=function(){function e(){var t=this;s(this,e),this.withTags=this.withTags.bind(this),this.instrument=function(){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}},H.forEach((function(e){t[e]=function(){}}))}return c(e,[{key:"recordMessageHubConnectionEstablished",value:function(){}},{key:"recordBaseDomCaching",value:function(){}},{key:"clientHandlerError",value:function(){}},{key:"statApiUsage",value:function(e){e.resource;return function(e){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}}},{key:"statScreenShareUsage",value:function(e,t){return{attempted:function(){return{succeeded:function(){},failed:function(){},timedOut:function(){},failedUnknown:function(){},isFinished:function(){}}}}}},{key:"withTags",value:function(){return this}}]),e}(),z=function(){function e(t,n){var r=this;s(this,e),this.statApiUsage=this.statApiUsage.bind(this),this.statScreenShareUsage=this.statScreenShareUsage.bind(this),this.withTags=this.withTags.bind(this),this.statsClient=t,this.latencyMeasurer=n,this.instrument=W(this.statsClient),H.forEach((function(e){r.statsClient[e]&&(r[e]=r.statsClient[e].bind(r.statsClient))}))}return c(e,[{key:"recordBaseDomCaching",value:function(e){var t=e.result;this.statsClient.increment("sm.app.visitor.api.cached_base_dom",["action:save","result:".concat(t)])}},{key:"clientHandlerError",value:function(e){this.statsClient.increment("sm.app.visitor.api.client_handler",["action:failed","executor:".concat(e)])}},{key:"statApiUsage",value:function(e){var t=this,n=e.protocol,r=e.resource;return function(e){return W(t.statsClient.withTags(["protocol:".concat(n),"method:".concat(e)]))({namespace:r})}}},{key:"statScreenShareUsage",value:function(e){var t=e.stage,n=e.resource;return W(this.statsClient.withTags(["stage:".concat(t)]))({namespace:n})}},{key:"withTags",value:function(t){return new e(this.statsClient.withTags(t))}}],[{key:"createDummy",value:function(){return new G}}]),e}(),J="undefined"!=typeof window&&window,Q="undefined"!=typeof self&&"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&self,Y=J||void 0!==E&&E||Q,K=Y;!function(){if(!Y)throw new Error("RxJS could not find any global context (window, self, global)")}();var X={root:K};var $={isFunction:function(e){return"function"==typeof e}},Z={isArray:Array.isArray||function(e){return e&&"number"==typeof e.length}};var ee,te={isObject:function(e){return null!=e&&"object"===o(e)}},ne={errorObject:{e:{}}};function re(){try{return ee.apply(this,arguments)}catch(e){return ne.errorObject.e=e,ne.errorObject}}var ie={tryCatch:function(e){return ee=e,re}},oe=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},se={UnsubscriptionError:function(e){function t(t){e.call(this),this.errors=t;var n=Error.call(this,t?t.length+" errors occurred during unsubscription:\n  "+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"");this.name=n.name="UnsubscriptionError",this.stack=n.stack,this.message=n.message}return oe(t,e),t}(Error)},ae=function(){function e(e){this.closed=!1,this._parent=null,this._parents=null,this._subscriptions=null,e&&(this._unsubscribe=e)}return e.prototype.unsubscribe=function(){var e,t=!1;if(!this.closed){var n=this,r=n._parent,i=n._parents,o=n._unsubscribe,s=n._subscriptions;this.closed=!0,this._parent=null,this._parents=null,this._subscriptions=null;for(var a=-1,c=i?i.length:0;r;)r.remove(this),r=++a<c&&i[a]||null;if($.isFunction(o))ie.tryCatch(o).call(this)===ne.errorObject&&(t=!0,e=e||(ne.errorObject.e instanceof se.UnsubscriptionError?ce(ne.errorObject.e.errors):[ne.errorObject.e]));if(Z.isArray(s))for(a=-1,c=s.length;++a<c;){var u=s[a];if(te.isObject(u))if(ie.tryCatch(u.unsubscribe).call(u)===ne.errorObject){t=!0,e=e||[];var l=ne.errorObject.e;l instanceof se.UnsubscriptionError?e=e.concat(ce(l.errors)):e.push(l)}}if(t)throw new se.UnsubscriptionError(e)}},e.prototype.add=function(t){if(!t||t===e.EMPTY)return e.EMPTY;if(t===this)return this;var n=t;switch(o(t)){case"function":n=new e(t);case"object":if(n.closed||"function"!=typeof n.unsubscribe)return n;if(this.closed)return n.unsubscribe(),n;if("function"!=typeof n._addParent){var r=n;(n=new e)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+t+" added to Subscription.")}return(this._subscriptions||(this._subscriptions=[])).push(n),n._addParent(this),n},e.prototype.remove=function(e){var t=this._subscriptions;if(t){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}},e.prototype._addParent=function(e){var t=this._parent,n=this._parents;t&&t!==e?n?-1===n.indexOf(e)&&n.push(e):this._parents=[e]:this._parent=e},e.EMPTY=function(e){return e.closed=!0,e}(new e),e}();function ce(e){return e.reduce((function(e,t){return e.concat(t instanceof se.UnsubscriptionError?t.errors:t)}),[])}var ue={Subscription:ae},le={closed:!0,next:function(e){},error:function(e){throw e},complete:function(){}},pe=T((function(e,t){var n=X.root.Symbol;t.rxSubscriber="function"==typeof n&&"function"==typeof n.for?n.for("rxSubscriber"):"@@rxSubscriber",t.$$rxSubscriber=t.rxSubscriber})),fe=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},he=function(e){function t(t,n,r){switch(e.call(this),this.syncErrorValue=null,this.syncErrorThrown=!1,this.syncErrorThrowable=!1,this.isStopped=!1,arguments.length){case 0:this.destination=le;break;case 1:if(!t){this.destination=le;break}if("object"===o(t)){if(ve(t)){var i=t[pe.rxSubscriber]();this.syncErrorThrowable=i.syncErrorThrowable,this.destination=i,i.add(this)}else this.syncErrorThrowable=!0,this.destination=new be(this,t);break}default:this.syncErrorThrowable=!0,this.destination=new be(this,t,n,r)}}return fe(t,e),t.prototype[pe.rxSubscriber]=function(){return this},t.create=function(e,n,r){var i=new t(e,n,r);return i.syncErrorThrowable=!1,i},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this))},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},t.prototype._unsubscribeAndRecycle=function(){var e=this._parent,t=this._parents;return this._parent=null,this._parents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parent=e,this._parents=t,this},t}(ue.Subscription),de=he,be=function(e){function t(t,n,r,i){var o;e.call(this),this._parentSubscriber=t;var s=this;$.isFunction(n)?o=n:n&&(o=n.next,r=n.error,i=n.complete,n!==le&&(s=Object.create(n),$.isFunction(s.unsubscribe)&&this.add(s.unsubscribe.bind(s)),s.unsubscribe=this.unsubscribe.bind(this))),this._context=s,this._next=o,this._error=r,this._complete=i}return fe(t,e),t.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},t.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber;if(this._error)t.syncErrorThrowable?(this.__tryOrSetError(t,this._error,e),this.unsubscribe()):(this.__tryOrUnsub(this._error,e),this.unsubscribe());else{if(!t.syncErrorThrowable)throw this.unsubscribe(),e;t.syncErrorValue=e,t.syncErrorThrown=!0,this.unsubscribe()}}},t.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var n=function(){return e._complete.call(e._context)};t.syncErrorThrowable?(this.__tryOrSetError(t,n),this.unsubscribe()):(this.__tryOrUnsub(n),this.unsubscribe())}else this.unsubscribe()}},t.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){throw this.unsubscribe(),e}},t.prototype.__tryOrSetError=function(e,t,n){try{t.call(this._context,n)}catch(t){return e.syncErrorValue=t,e.syncErrorThrown=!0,!0}return!1},t.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},t}(he);function ve(e){return e instanceof he||"syncErrorThrowable"in e&&e[pe.rxSubscriber]}var me={Subscriber:de};var ye={toSubscriber:function(e,t,n){if(e){if(e instanceof me.Subscriber)return e;if(e[pe.rxSubscriber])return e[pe.rxSubscriber]()}return e||t||n?new me.Subscriber(e,t,n):new me.Subscriber(le)}},ge=T((function(e,t){function n(e){var t,n=e.Symbol;return"function"==typeof n?n.observable?t=n.observable:(t=n("observable"),n.observable=t):t="@@observable",t}t.getSymbolObservable=n,t.observable=n(X.root),t.$$observable=t.observable}));var _e={noop:function(){}};function we(e){return e?1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}:_e.noop}var Oe={pipe:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return we(e)},pipeFromArray:we},Ee=function(){function e(e){this._isScalar=!1,e&&(this._subscribe=e)}return e.prototype.lift=function(t){var n=new e;return n.source=this,n.operator=t,n},e.prototype.subscribe=function(e,t,n){var r=this.operator,i=ye.toSubscriber(e,t,n);if(r?r.call(i,this.source):i.add(this.source||!i.syncErrorThrowable?this._subscribe(i):this._trySubscribe(i)),i.syncErrorThrowable&&(i.syncErrorThrowable=!1,i.syncErrorThrown))throw i.syncErrorValue;return i},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.syncErrorThrown=!0,e.syncErrorValue=t,e.error(t)}},e.prototype.forEach=function(e,t){var n=this;if(t||(X.root.Rx&&X.root.Rx.config&&X.root.Rx.config.Promise?t=X.root.Rx.config.Promise:X.root.Promise&&(t=X.root.Promise)),!t)throw new Error("no Promise impl found");return new t((function(t,r){var i;i=n.subscribe((function(t){if(i)try{e(t)}catch(e){r(e),i.unsubscribe()}else e(t)}),r,t)}))},e.prototype._subscribe=function(e){return this.source.subscribe(e)},e.prototype[ge.observable]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return 0===e.length?this:Oe.pipeFromArray(e)(this)},e.prototype.toPromise=function(e){var t=this;if(e||(X.root.Rx&&X.root.Rx.config&&X.root.Rx.config.Promise?e=X.root.Rx.config.Promise:X.root.Promise&&(e=X.root.Promise)),!e)throw new Error("no Promise impl found");return new e((function(e,n){var r;t.subscribe((function(e){return r=e}),(function(e){return n(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}(),Se={Observable:Ee},Te=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},xe={ObjectUnsubscribedError:function(e){function t(){var t=e.call(this,"object unsubscribed");this.name=t.name="ObjectUnsubscribedError",this.stack=t.stack,this.message=t.message}return Te(t,e),t}(Error)},Ae=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ke={SubjectSubscription:function(e){function t(t,n){e.call(this),this.subject=t,this.subscriber=n,this.closed=!1}return Ae(t,e),t.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var e=this.subject,t=e.observers;if(this.subject=null,t&&0!==t.length&&!e.isStopped&&!e.closed){var n=t.indexOf(this.subscriber);-1!==n&&t.splice(n,1)}}},t}(ue.Subscription)},Ie=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Ne=function(e){function t(t){e.call(this,t),this.destination=t}return Ie(t,e),t}(me.Subscriber),Re=Ne,Ce=function(e){function t(){e.call(this),this.observers=[],this.closed=!1,this.isStopped=!1,this.hasError=!1,this.thrownError=null}return Ie(t,e),t.prototype[pe.rxSubscriber]=function(){return new Ne(this)},t.prototype.lift=function(e){var t=new Me(this,this);return t.operator=e,t},t.prototype.next=function(e){if(this.closed)throw new xe.ObjectUnsubscribedError;if(!this.isStopped)for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].next(e)},t.prototype.error=function(e){if(this.closed)throw new xe.ObjectUnsubscribedError;this.hasError=!0,this.thrownError=e,this.isStopped=!0;for(var t=this.observers,n=t.length,r=t.slice(),i=0;i<n;i++)r[i].error(e);this.observers.length=0},t.prototype.complete=function(){if(this.closed)throw new xe.ObjectUnsubscribedError;this.isStopped=!0;for(var e=this.observers,t=e.length,n=e.slice(),r=0;r<t;r++)n[r].complete();this.observers.length=0},t.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},t.prototype._trySubscribe=function(t){if(this.closed)throw new xe.ObjectUnsubscribedError;return e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){if(this.closed)throw new xe.ObjectUnsubscribedError;return this.hasError?(e.error(this.thrownError),ue.Subscription.EMPTY):this.isStopped?(e.complete(),ue.Subscription.EMPTY):(this.observers.push(e),new ke.SubjectSubscription(this,e))},t.prototype.asObservable=function(){var e=new Se.Observable;return e.source=this,e},t.create=function(e,t){return new Me(e,t)},t}(Se.Observable),Pe=Ce,Me=function(e){function t(t,n){e.call(this),this.destination=t,this.source=n}return Ie(t,e),t.prototype.next=function(e){var t=this.destination;t&&t.next&&t.next(e)},t.prototype.error=function(e){var t=this.destination;t&&t.error&&this.destination.error(e)},t.prototype.complete=function(){var e=this.destination;e&&e.complete&&this.destination.complete()},t.prototype._subscribe=function(e){return this.source?this.source.subscribe(e):ue.Subscription.EMPTY},t}(Ce),je={SubjectSubscriber:Re,Subject:Pe,AnonymousSubject:Me},qe=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Le={AsyncSubject:function(e){function t(){e.apply(this,arguments),this.value=null,this.hasNext=!1,this.hasCompleted=!1}return qe(t,e),t.prototype._subscribe=function(t){return this.hasError?(t.error(this.thrownError),ue.Subscription.EMPTY):this.hasCompleted&&this.hasNext?(t.next(this.value),t.complete(),ue.Subscription.EMPTY):e.prototype._subscribe.call(this,t)},t.prototype.next=function(e){this.hasCompleted||(this.value=e,this.hasNext=!0)},t.prototype.error=function(t){this.hasCompleted||e.prototype.error.call(this,t)},t.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&e.prototype.next.call(this,this.value),e.prototype.complete.call(this)},t}(je.Subject)},Ue=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};function Ve(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function De(e){var t=e.err;e.subject.error(t)}var Fe={bindCallback:{BoundCallbackObservable:function(e){function t(t,n,r,i,o){e.call(this),this.callbackFunc=t,this.selector=n,this.args=r,this.context=i,this.scheduler=o}return Ue(t,e),t.create=function(e,n,r){return void 0===n&&(n=void 0),function(){for(var i=[],o=0;o<arguments.length;o++)i[o-0]=arguments[o];return new t(e,n,i,this,r)}},t.prototype._subscribe=function(e){var n=this.callbackFunc,r=this.args,i=this.scheduler,o=this.subject;if(i)return i.schedule(t.dispatch,0,{source:this,subscriber:e,context:this.context});if(!o){o=this.subject=new Le.AsyncSubject;var s=function e(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=e.source,i=r.selector,o=r.subject;if(i){var s=ie.tryCatch(i).apply(this,t);s===ne.errorObject?o.error(ne.errorObject.e):(o.next(s),o.complete())}else o.next(t.length<=1?t[0]:t),o.complete()};s.source=this,ie.tryCatch(n).apply(this.context,r.concat(s))===ne.errorObject&&o.error(ne.errorObject.e)}return o.subscribe(e)},t.dispatch=function(e){var t=this,n=e.source,r=e.subscriber,i=e.context,o=n.callbackFunc,s=n.args,a=n.scheduler,c=n.subject;if(!c){c=n.subject=new Le.AsyncSubject;var u=function e(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var i=e.source,o=i.selector,s=i.subject;if(o){var c=ie.tryCatch(o).apply(this,n);c===ne.errorObject?t.add(a.schedule(De,0,{err:ne.errorObject.e,subject:s})):t.add(a.schedule(Ve,0,{value:c,subject:s}))}else{var u=n.length<=1?n[0]:n;t.add(a.schedule(Ve,0,{value:u,subject:s}))}};u.source=n,ie.tryCatch(o).apply(i,s.concat(u))===ne.errorObject&&c.error(ne.errorObject.e)}t.add(c.subscribe(r))},t}(Se.Observable)}.BoundCallbackObservable.create};Se.Observable.bindCallback=Fe.bindCallback;var Be=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};function We(e){var t=this,n=e.source,r=e.subscriber,i=e.context,o=n,s=o.callbackFunc,a=o.args,c=o.scheduler,u=n.subject;if(!u){u=n.subject=new Le.AsyncSubject;var l=function e(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];var i=e.source,o=i.selector,s=i.subject,a=n.shift();if(a)t.add(c.schedule(Ge,0,{err:a,subject:s}));else if(o){var u=ie.tryCatch(o).apply(this,n);u===ne.errorObject?t.add(c.schedule(Ge,0,{err:ne.errorObject.e,subject:s})):t.add(c.schedule(He,0,{value:u,subject:s}))}else{var l=n.length<=1?n[0]:n;t.add(c.schedule(He,0,{value:l,subject:s}))}};l.source=n,ie.tryCatch(s).apply(i,a.concat(l))===ne.errorObject&&t.add(c.schedule(Ge,0,{err:ne.errorObject.e,subject:u}))}t.add(u.subscribe(r))}function He(e){var t=e.value,n=e.subject;n.next(t),n.complete()}function Ge(e){var t=e.err;e.subject.error(t)}var ze={bindNodeCallback:{BoundNodeCallbackObservable:function(e){function t(t,n,r,i,o){e.call(this),this.callbackFunc=t,this.selector=n,this.args=r,this.context=i,this.scheduler=o}return Be(t,e),t.create=function(e,n,r){return void 0===n&&(n=void 0),function(){for(var i=[],o=0;o<arguments.length;o++)i[o-0]=arguments[o];return new t(e,n,i,this,r)}},t.prototype._subscribe=function(e){var t=this.callbackFunc,n=this.args,r=this.scheduler,i=this.subject;if(r)return r.schedule(We,0,{source:this,subscriber:e,context:this.context});if(!i){i=this.subject=new Le.AsyncSubject;var o=function e(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=e.source,i=r.selector,o=r.subject,s=t.shift();if(s)o.error(s);else if(i){var a=ie.tryCatch(i).apply(this,t);a===ne.errorObject?o.error(ne.errorObject.e):(o.next(a),o.complete())}else o.next(t.length<=1?t[0]:t),o.complete()};o.source=this,ie.tryCatch(t).apply(this.context,n.concat(o))===ne.errorObject&&i.error(ne.errorObject.e)}return i.subscribe(e)},t}(Se.Observable)}.BoundNodeCallbackObservable.create};Se.Observable.bindNodeCallback=ze.bindNodeCallback;var Je={isScheduler:function(e){return e&&"function"==typeof e.schedule}},Qe=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Ye={ScalarObservable:function(e){function t(t,n){e.call(this),this.value=t,this.scheduler=n,this._isScalar=!0,n&&(this._isScalar=!1)}return Qe(t,e),t.create=function(e,n){return new t(e,n)},t.dispatch=function(e){var t=e.done,n=e.value,r=e.subscriber;t?r.complete():(r.next(n),r.closed||(e.done=!0,this.schedule(e)))},t.prototype._subscribe=function(e){var n=this.value,r=this.scheduler;if(r)return r.schedule(t.dispatch,0,{done:!1,value:n,subscriber:e});e.next(n),e.closed||e.complete()},t}(Se.Observable)},Ke=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Xe={EmptyObservable:function(e){function t(t){e.call(this),this.scheduler=t}return Ke(t,e),t.create=function(e){return new t(e)},t.dispatch=function(e){e.subscriber.complete()},t.prototype._subscribe=function(e){var n=this.scheduler;if(n)return n.schedule(t.dispatch,0,{subscriber:e});e.complete()},t}(Se.Observable)},$e=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Ze={ArrayObservable:function(e){function t(t,n){e.call(this),this.array=t,this.scheduler=n,n||1!==t.length||(this._isScalar=!0,this.value=t[0])}return $e(t,e),t.create=function(e,n){return new t(e,n)},t.of=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];var r=e[e.length-1];Je.isScheduler(r)?e.pop():r=null;var i=e.length;return i>1?new t(e,r):1===i?new Ye.ScalarObservable(e[0],r):new Xe.EmptyObservable(r)},t.dispatch=function(e){var t=e.array,n=e.index,r=e.count,i=e.subscriber;n>=r?i.complete():(i.next(t[n]),i.closed||(e.index=n+1,this.schedule(e)))},t.prototype._subscribe=function(e){var n=this.array,r=n.length,i=this.scheduler;if(i)return i.schedule(t.dispatch,0,{array:n,index:0,count:r,subscriber:e});for(var o=0;o<r&&!e.closed;o++)e.next(n[o]);e.complete()},t}(Se.Observable)},et=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},tt={OuterSubscriber:function(e){function t(){e.apply(this,arguments)}return et(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(t)},t.prototype.notifyError=function(e,t){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.destination.complete()},t}(me.Subscriber)},nt=function(e){return e&&"number"==typeof e.length};var rt={isPromise:function(e){return e&&"function"!=typeof e.subscribe&&"function"==typeof e.then}},it=T((function(e,t){function n(e){var t=e.Symbol;if("function"==typeof t)return t.iterator||(t.iterator=t("iterator polyfill")),t.iterator;var n=e.Set;if(n&&"function"==typeof(new n)["@@iterator"])return"@@iterator";var r=e.Map;if(r)for(var i=Object.getOwnPropertyNames(r.prototype),o=0;o<i.length;++o){var s=i[o];if("entries"!==s&&"size"!==s&&r.prototype[s]===r.prototype.entries)return s}return"@@iterator"}t.symbolIteratorPonyfill=n,t.iterator=n(X.root),t.$$iterator=t.iterator})),ot=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},st={InnerSubscriber:function(e){function t(t,n,r){e.call(this),this.parent=t,this.outerValue=n,this.outerIndex=r,this.index=0}return ot(t,e),t.prototype._next=function(e){this.parent.notifyNext(this.outerValue,e,this.outerIndex,this.index++,this)},t.prototype._error=function(e){this.parent.notifyError(e,this),this.unsubscribe()},t.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},t}(me.Subscriber)};var at={subscribeToResult:function(e,t,n,r){var i=new st.InnerSubscriber(e,n,r);if(i.closed)return null;if(t instanceof Se.Observable)return t._isScalar?(i.next(t.value),i.complete(),null):(i.syncErrorThrowable=!0,t.subscribe(i));if(nt(t)){for(var o=0,s=t.length;o<s&&!i.closed;o++)i.next(t[o]);i.closed||i.complete()}else{if(rt.isPromise(t))return t.then((function(e){i.closed||(i.next(e),i.complete())}),(function(e){return i.error(e)})).then(null,(function(e){X.root.setTimeout((function(){throw e}))})),i;if(t&&"function"==typeof t[it.iterator])for(var a=t[it.iterator]();;){var c=a.next();if(c.done){i.complete();break}if(i.next(c.value),i.closed)break}else if(t&&"function"==typeof t[ge.observable]){var u=t[ge.observable]();if("function"==typeof u.subscribe)return u.subscribe(new st.InnerSubscriber(e,n,r));i.error(new TypeError("Provided object does not correctly implement Symbol.observable"))}else{var l="You provided "+(te.isObject(t)?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.";i.error(new TypeError(l))}}return null}},ct=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ut={};var lt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=null;return"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Z.isArray(e[0])&&(e=e[0].slice()),function(t){return t.lift.call(new Ze.ArrayObservable([t].concat(e)),new pt(n))}},pt=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new ht(e,this.project))},e}(),ft=pt,ht=function(e){function t(t,n){e.call(this,t),this.project=n,this.active=0,this.values=[],this.observables=[]}return ct(t,e),t.prototype._next=function(e){this.values.push(ut),this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{this.active=t,this.toRespond=t;for(var n=0;n<t;n++){var r=e[n];this.add(at.subscribeToResult(this,r,r,n))}}},t.prototype.notifyComplete=function(e){0==(this.active-=1)&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.values,s=o[n],a=this.toRespond?s===ut?--this.toRespond:this.toRespond:0;o[n]=t,0===a&&(this.project?this._tryProject(o):this.destination.next(o.slice()))},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(tt.OuterSubscriber),dt={combineLatest:lt,CombineLatestOperator:ft,CombineLatestSubscriber:ht};var bt=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=null,r=null;return Je.isScheduler(e[e.length-1])&&(r=e.pop()),"function"==typeof e[e.length-1]&&(n=e.pop()),1===e.length&&Z.isArray(e[0])&&(e=e[0]),new Ze.ArrayObservable(e,r).lift(new dt.CombineLatestOperator(n))},vt={combineLatest:bt};Se.Observable.combineLatest=vt.combineLatest;var mt=Ze.ArrayObservable.of,yt={of:mt},gt=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};function _t(e){var t=e.value,n=e.subscriber;n.closed||(n.next(t),n.complete())}function wt(e){var t=e.err,n=e.subscriber;n.closed||n.error(t)}var Ot={PromiseObservable:function(e){function t(t,n){e.call(this),this.promise=t,this.scheduler=n}return gt(t,e),t.create=function(e,n){return new t(e,n)},t.prototype._subscribe=function(e){var t=this,n=this.promise,r=this.scheduler;if(null==r)this._isScalar?e.closed||(e.next(this.value),e.complete()):n.then((function(n){t.value=n,t._isScalar=!0,e.closed||(e.next(n),e.complete())}),(function(t){e.closed||e.error(t)})).then(null,(function(e){X.root.setTimeout((function(){throw e}))}));else if(this._isScalar){if(!e.closed)return r.schedule(_t,0,{value:this.value,subscriber:e})}else n.then((function(n){t.value=n,t._isScalar=!0,e.closed||e.add(r.schedule(_t,0,{value:n,subscriber:e}))}),(function(t){e.closed||e.add(r.schedule(wt,0,{err:t,subscriber:e}))})).then(null,(function(e){X.root.setTimeout((function(){throw e}))}))},t}(Se.Observable)},Et=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},St=function(e){function t(t,n){if(e.call(this),this.scheduler=n,null==t)throw new Error("iterator cannot be null.");this.iterator=At(t)}return Et(t,e),t.create=function(e,n){return new t(e,n)},t.dispatch=function(e){var t=e.index,n=e.hasError,r=e.iterator,i=e.subscriber;if(n)i.error(e.error);else{var o=r.next();o.done?i.complete():(i.next(o.value),e.index=t+1,i.closed?"function"==typeof r.return&&r.return():this.schedule(e))}},t.prototype._subscribe=function(e){var n=this.iterator,r=this.scheduler;if(r)return r.schedule(t.dispatch,0,{index:0,iterator:n,subscriber:e});for(;;){var i=n.next();if(i.done){e.complete();break}if(e.next(i.value),e.closed){"function"==typeof n.return&&n.return();break}}},t}(Se.Observable),Tt=function(){function e(e,t,n){void 0===t&&(t=0),void 0===n&&(n=e.length),this.str=e,this.idx=t,this.len=n}return e.prototype[it.iterator]=function(){return this},e.prototype.next=function(){return this.idx<this.len?{done:!1,value:this.str.charAt(this.idx++)}:{done:!0,value:void 0}},e}(),xt=function(){function e(e,t,n){void 0===t&&(t=0),void 0===n&&(n=function(e){var t=+e.length;if(isNaN(t))return 0;if(0===t||(n=t,"number"!=typeof n||!X.root.isFinite(n)))return t;var n;if((t=function(e){var t=+e;if(0===t)return t;if(isNaN(t))return t;return t<0?-1:1}(t)*Math.floor(Math.abs(t)))<=0)return 0;if(t>kt)return kt;return t}(e)),this.arr=e,this.idx=t,this.len=n}return e.prototype[it.iterator]=function(){return this},e.prototype.next=function(){return this.idx<this.len?{done:!1,value:this.arr[this.idx++]}:{done:!0,value:void 0}},e}();function At(e){var t=e[it.iterator];if(!t&&"string"==typeof e)return new Tt(e);if(!t&&void 0!==e.length)return new xt(e);if(!t)throw new TypeError("object is not iterable");return e[it.iterator]()}var kt=Math.pow(2,53)-1;var It={IteratorObservable:St},Nt=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Rt={ArrayLikeObservable:function(e){function t(t,n){e.call(this),this.arrayLike=t,this.scheduler=n,n||1!==t.length||(this._isScalar=!0,this.value=t[0])}return Nt(t,e),t.create=function(e,n){var r=e.length;return 0===r?new Xe.EmptyObservable:1===r?new Ye.ScalarObservable(e[0],n):new t(e,n)},t.dispatch=function(e){var t=e.arrayLike,n=e.index,r=e.length,i=e.subscriber;i.closed||(n>=r?i.complete():(i.next(t[n]),e.index=n+1,this.schedule(e)))},t.prototype._subscribe=function(e){var n=this.arrayLike,r=this.scheduler,i=n.length;if(r)return r.schedule(t.dispatch,0,{arrayLike:n,index:0,length:i,subscriber:e});for(var o=0;o<i&&!e.closed;o++)e.next(n[o]);e.complete()},t}(Se.Observable)},Ct={Notification:function(){function e(e,t,n){this.kind=e,this.value=t,this.error=n,this.hasValue="N"===e}return e.prototype.observe=function(e){switch(this.kind){case"N":return e.next&&e.next(this.value);case"E":return e.error&&e.error(this.error);case"C":return e.complete&&e.complete()}},e.prototype.do=function(e,t,n){switch(this.kind){case"N":return e&&e(this.value);case"E":return t&&t(this.error);case"C":return n&&n()}},e.prototype.accept=function(e,t,n){return e&&"function"==typeof e.next?this.observe(e):this.do(e,t,n)},e.prototype.toObservable=function(){switch(this.kind){case"N":return Se.Observable.of(this.value);case"E":return Se.Observable.throw(this.error);case"C":return Se.Observable.empty()}throw new Error("unexpected notification kind value")},e.createNext=function(t){return void 0!==t?new e("N",t):e.undefinedValueNotification},e.createError=function(t){return new e("E",void 0,t)},e.createComplete=function(){return e.completeNotification},e.completeNotification=new e("C"),e.undefinedValueNotification=new e("N",void 0),e}()},Pt=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Mt=function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new jt(e,t))}},jt=function(){function e(e,t){void 0===t&&(t=0),this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return t.subscribe(new Lt(e,this.scheduler,this.delay))},e}(),qt=jt,Lt=function(e){function t(t,n,r){void 0===r&&(r=0),e.call(this,t),this.scheduler=n,this.delay=r}return Pt(t,e),t.dispatch=function(e){var t=e.notification,n=e.destination;t.observe(n),this.unsubscribe()},t.prototype.scheduleMessage=function(e){this.add(this.scheduler.schedule(t.dispatch,this.delay,new Ut(e,this.destination)))},t.prototype._next=function(e){this.scheduleMessage(Ct.Notification.createNext(e))},t.prototype._error=function(e){this.scheduleMessage(Ct.Notification.createError(e))},t.prototype._complete=function(){this.scheduleMessage(Ct.Notification.createComplete())},t}(me.Subscriber),Ut=function(e,t){this.notification=e,this.destination=t},Vt={observeOn:Mt,ObserveOnOperator:qt,ObserveOnSubscriber:Lt,ObserveOnMessage:Ut},Dt=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Ft={FromObservable:function(e){function t(t,n){e.call(this,null),this.ish=t,this.scheduler=n}return Dt(t,e),t.create=function(e,n){if(null!=e){if("function"==typeof e[ge.observable])return e instanceof Se.Observable&&!n?e:new t(e,n);if(Z.isArray(e))return new Ze.ArrayObservable(e,n);if(rt.isPromise(e))return new Ot.PromiseObservable(e,n);if("function"==typeof e[it.iterator]||"string"==typeof e)return new It.IteratorObservable(e,n);if(nt(e))return new Rt.ArrayLikeObservable(e,n)}throw new TypeError((null!==e&&o(e)||e)+" is not observable")},t.prototype._subscribe=function(e){var t=this.ish,n=this.scheduler;return null==n?t[ge.observable]().subscribe(e):t[ge.observable]().subscribe(new Vt.ObserveOnSubscriber(e,n,0))},t}(Se.Observable)},Bt=Ft.FromObservable.create,Wt={from:Bt},Ht=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Gt=function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),function(r){return"number"==typeof t&&(n=t,t=null),r.lift(new zt(e,t,n))}},zt=function(){function e(e,t,n){void 0===n&&(n=Number.POSITIVE_INFINITY),this.project=e,this.resultSelector=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new Qt(e,this.project,this.resultSelector,this.concurrent))},e}(),Jt=zt,Qt=function(e){function t(t,n,r,i){void 0===i&&(i=Number.POSITIVE_INFINITY),e.call(this,t),this.project=n,this.resultSelector=r,this.concurrent=i,this.hasCompleted=!1,this.buffer=[],this.active=0,this.index=0}return Ht(t,e),t.prototype._next=function(e){this.active<this.concurrent?this._tryNext(e):this.buffer.push(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this.active++,this._innerSub(t,e,n)},t.prototype._innerSub=function(e,t,n){this.add(at.subscribeToResult(this,e,t,n))},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){this.resultSelector?this._notifyResultSelector(e,t,n,r):this.destination.next(t)},t.prototype._notifyResultSelector=function(e,t,n,r){var i;try{i=this.resultSelector(e,t,n,r)}catch(e){return void this.destination.error(e)}this.destination.next(i)},t.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t}(tt.OuterSubscriber),Yt={mergeMap:Gt,MergeMapOperator:Jt,MergeMapSubscriber:Qt};var Kt={identity:function(e){return e}};var Xt={mergeAll:function(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),Yt.mergeMap(Kt.identity,null,e)}};var $t={concatAll:function(){return Xt.mergeAll(1)}};var Zt={concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return 1===e.length||2===e.length&&Je.isScheduler(e[1])?Wt.from(e[0]):$t.concatAll()(yt.of.apply(void 0,e))}};Se.Observable.concat=Zt.concat;var en=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},tn=function(e){function t(t){e.call(this),this.observableFactory=t}return en(t,e),t.create=function(e){return new t(e)},t.prototype._subscribe=function(e){return new nn(e,this.observableFactory)},t}(Se.Observable),nn=function(e){function t(t,n){e.call(this,t),this.factory=n,this.tryDefer()}return en(t,e),t.prototype.tryDefer=function(){try{this._callFactory()}catch(e){this._error(e)}},t.prototype._callFactory=function(){var e=this.factory();e&&this.add(at.subscribeToResult(this,e))},t}(tt.OuterSubscriber),rn={defer:{DeferObservable:tn}.DeferObservable.create};Se.Observable.defer=rn.defer;var on=Xe.EmptyObservable.create,sn={empty:on};Se.Observable.empty=sn.empty;var an=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},cn=function(e){function t(t,n){e.call(this),this.sources=t,this.resultSelector=n}return an(t,e),t.create=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];if(null===e||0===arguments.length)return new Xe.EmptyObservable;var r=null;return"function"==typeof e[e.length-1]&&(r=e.pop()),1===e.length&&Z.isArray(e[0])&&(e=e[0]),0===e.length?new Xe.EmptyObservable:new t(e,r)},t.prototype._subscribe=function(e){return new un(e,this.sources,this.resultSelector)},t}(Se.Observable),un=function(e){function t(t,n,r){e.call(this,t),this.sources=n,this.resultSelector=r,this.completed=0,this.haveValues=0;var i=n.length;this.total=i,this.values=new Array(i);for(var o=0;o<i;o++){var s=n[o],a=at.subscribeToResult(this,s,null,o);a&&(a.outerIndex=o,this.add(a))}}return an(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.values[n]=t,i._hasValue||(i._hasValue=!0,this.haveValues++)},t.prototype.notifyComplete=function(e){var t=this.destination,n=this,r=n.haveValues,i=n.resultSelector,o=n.values,s=o.length;if(e._hasValue){if(this.completed++,this.completed===s){if(r===s){var a=i?i.apply(this,o):o;t.next(a)}t.complete()}}else t.complete()},t}(tt.OuterSubscriber),ln={forkJoin:{ForkJoinObservable:cn}.ForkJoinObservable.create};Se.Observable.forkJoin=ln.forkJoin,Se.Observable.from=Wt.from;var pn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},fn=Object.prototype.toString;var hn={fromEvent:{FromEventObservable:function(e){function t(t,n,r,i){e.call(this),this.sourceObj=t,this.eventName=n,this.selector=r,this.options=i}return pn(t,e),t.create=function(e,n,r,i){return $.isFunction(r)&&(i=r,r=void 0),new t(e,n,i,r)},t.setupSubscription=function(e,n,r,i,o){var s;if(function(e){return!!e&&"[object NodeList]"===fn.call(e)}(e)||function(e){return!!e&&"[object HTMLCollection]"===fn.call(e)}(e))for(var a=0,c=e.length;a<c;a++)t.setupSubscription(e[a],n,r,i,o);else if(function(e){return!!e&&"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}(e)){var u=e;e.addEventListener(n,r,o),s=function(){return u.removeEventListener(n,r,o)}}else if(function(e){return!!e&&"function"==typeof e.on&&"function"==typeof e.off}(e)){var l=e;e.on(n,r),s=function(){return l.off(n,r)}}else{if(!function(e){return!!e&&"function"==typeof e.addListener&&"function"==typeof e.removeListener}(e))throw new TypeError("Invalid event target");var p=e;e.addListener(n,r),s=function(){return p.removeListener(n,r)}}i.add(new ue.Subscription(s))},t.prototype._subscribe=function(e){var n=this.sourceObj,r=this.eventName,i=this.options,o=this.selector,s=o?function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var r=ie.tryCatch(o).apply(void 0,t);r===ne.errorObject?e.error(ne.errorObject.e):e.next(r)}:function(t){return e.next(t)};t.setupSubscription(n,r,s,e,i)},t}(Se.Observable)}.FromEventObservable.create};Se.Observable.fromEvent=hn.fromEvent;var dn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},bn={fromEventPattern:{FromEventPatternObservable:function(e){function t(t,n,r){e.call(this),this.addHandler=t,this.removeHandler=n,this.selector=r}return dn(t,e),t.create=function(e,n,r){return new t(e,n,r)},t.prototype._subscribe=function(e){var t=this,n=this.removeHandler,r=this.selector?function(){for(var n=[],r=0;r<arguments.length;r++)n[r-0]=arguments[r];t._callSelector(e,n)}:function(t){e.next(t)},i=this._callAddHandler(r,e);$.isFunction(n)&&e.add(new ue.Subscription((function(){n(r,i)})))},t.prototype._callSelector=function(e,t){try{var n=this.selector.apply(this,t);e.next(n)}catch(t){e.error(t)}},t.prototype._callAddHandler=function(e,t){try{return this.addHandler(e)||null}catch(e){t.error(e)}},t}(Se.Observable)}.FromEventPatternObservable.create};Se.Observable.fromEventPattern=bn.fromEventPattern;var vn=Ot.PromiseObservable.create,mn={fromPromise:vn};Se.Observable.fromPromise=mn.fromPromise;var yn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},gn=function(e){return e},_n={generate:{GenerateObservable:function(e){function t(t,n,r,i,o){e.call(this),this.initialState=t,this.condition=n,this.iterate=r,this.resultSelector=i,this.scheduler=o}return yn(t,e),t.create=function(e,n,r,i,o){return 1==arguments.length?new t(e.initialState,e.condition,e.iterate,e.resultSelector||gn,e.scheduler):void 0===i||Je.isScheduler(i)?new t(e,n,r,gn,i):new t(e,n,r,i,o)},t.prototype._subscribe=function(e){var n=this.initialState;if(this.scheduler)return this.scheduler.schedule(t.dispatch,0,{subscriber:e,iterate:this.iterate,condition:this.condition,resultSelector:this.resultSelector,state:n});for(var r=this,i=r.condition,o=r.resultSelector,s=r.iterate;;){if(i){var a=void 0;try{a=i(n)}catch(t){return void e.error(t)}if(!a){e.complete();break}}var c=void 0;try{c=o(n)}catch(t){return void e.error(t)}if(e.next(c),e.closed)break;try{n=s(n)}catch(t){return void e.error(t)}}},t.dispatch=function(e){var t=e.subscriber,n=e.condition;if(!t.closed){if(e.needIterate)try{e.state=e.iterate(e.state)}catch(e){return void t.error(e)}else e.needIterate=!0;if(n){var r=void 0;try{r=n(e.state)}catch(e){return void t.error(e)}if(!r)return void t.complete();if(t.closed)return}var i;try{i=e.resultSelector(e.state)}catch(e){return void t.error(e)}if(!t.closed&&(t.next(i),!t.closed))return this.schedule(e)}},t}(Se.Observable)}.GenerateObservable.create};Se.Observable.generate=_n.generate;var wn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},On=function(e){function t(t,n,r){e.call(this),this.condition=t,this.thenSource=n,this.elseSource=r}return wn(t,e),t.create=function(e,n,r){return new t(e,n,r)},t.prototype._subscribe=function(e){var t=this,n=t.condition,r=t.thenSource,i=t.elseSource;return new En(e,n,r,i)},t}(Se.Observable),En=function(e){function t(t,n,r,i){e.call(this,t),this.condition=n,this.thenSource=r,this.elseSource=i,this.tryIf()}return wn(t,e),t.prototype.tryIf=function(){var e=this,t=e.condition,n=e.thenSource,r=e.elseSource;try{var i=t()?n:r;i?this.add(at.subscribeToResult(this,i)):this._complete()}catch(e){this._error(e)}},t}(tt.OuterSubscriber),Sn={_if:{IfObservable:On}.IfObservable.create};Se.Observable.if=Sn._if;var Tn={isNumeric:function(e){return!Z.isArray(e)&&e-parseFloat(e)+1>=0}},xn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},An={Action:function(e){function t(t,n){e.call(this)}return xn(t,e),t.prototype.schedule=function(e,t){return this},t}(ue.Subscription)},kn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},In={AsyncAction:function(e){function t(t,n){e.call(this,t,n),this.scheduler=t,this.pending=!1,this.work=n}return kn(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e,this.pending=!0;var n=this.id,r=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(r,n,t)),this.delay=t,this.id=this.id||this.requestAsyncId(r,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),X.root.setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;X.root.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,r=void 0;try{this.work(e)}catch(e){n=!0,r=!!e&&e||new Error(e)}if(n)return this.unsubscribe(),r},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,r=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==r&&n.splice(r,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(An.Action)},Nn={Scheduler:function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=Date.now?Date.now:function(){return+new Date},e}()},Rn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Cn={AsyncScheduler:function(e){function t(){e.apply(this,arguments),this.actions=[],this.active=!1,this.scheduled=void 0}return Rn(t,e),t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(Nn.Scheduler)},Pn={async:new Cn.AsyncScheduler(In.AsyncAction)},Mn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},jn={IntervalObservable:function(e){function t(t,n){void 0===t&&(t=0),void 0===n&&(n=Pn.async),e.call(this),this.period=t,this.scheduler=n,(!Tn.isNumeric(t)||t<0)&&(this.period=0),n&&"function"==typeof n.schedule||(this.scheduler=Pn.async)}return Mn(t,e),t.create=function(e,n){return void 0===e&&(e=0),void 0===n&&(n=Pn.async),new t(e,n)},t.dispatch=function(e){var t=e.index,n=e.subscriber,r=e.period;n.next(t),n.closed||(e.index+=1,this.schedule(e,r))},t.prototype._subscribe=function(e){var n=this.period,r=this.scheduler;e.add(r.schedule(t.dispatch,n,{index:0,subscriber:e,period:n}))},t}(Se.Observable)}.IntervalObservable.create,qn={interval:jn};Se.Observable.interval=qn.interval;var Ln=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=Number.POSITIVE_INFINITY,r=null,i=e[e.length-1];return Je.isScheduler(i)?(r=e.pop(),e.length>1&&"number"==typeof e[e.length-1]&&(n=e.pop())):"number"==typeof i&&(n=e.pop()),null===r&&1===e.length&&e[0]instanceof Se.Observable?e[0]:Xt.mergeAll(n)(new Ze.ArrayObservable(e,r))},Un={merge:Ln};Se.Observable.merge=Un.merge;var Vn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Dn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];if(1===e.length){if(!Z.isArray(e[0]))return e[0];e=e[0]}return new Ze.ArrayObservable(e).lift(new Fn)},Fn=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Wn(e))},e}(),Bn=Fn,Wn=function(e){function t(t){e.call(this,t),this.hasFirst=!1,this.observables=[],this.subscriptions=[]}return Vn(t,e),t.prototype._next=function(e){this.observables.push(e)},t.prototype._complete=function(){var e=this.observables,t=e.length;if(0===t)this.destination.complete();else{for(var n=0;n<t&&!this.hasFirst;n++){var r=e[n],i=at.subscribeToResult(this,r,r,n);this.subscriptions&&this.subscriptions.push(i),this.add(i)}this.observables=null}},t.prototype.notifyNext=function(e,t,n,r,i){if(!this.hasFirst){this.hasFirst=!0;for(var o=0;o<this.subscriptions.length;o++)if(o!==n){var s=this.subscriptions[o];s.unsubscribe(),this.remove(s)}this.subscriptions=null}this.destination.next(t)},t}(tt.OuterSubscriber),Hn={race:Dn,RaceOperator:Bn,RaceSubscriber:Wn};Se.Observable.race=Hn.race;var Gn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},zn={never:{NeverObservable:function(e){function t(){e.call(this)}return Gn(t,e),t.create=function(){return new t},t.prototype._subscribe=function(e){_e.noop()},t}(Se.Observable)}.NeverObservable.create};Se.Observable.never=zn.never,Se.Observable.of=yt.of;var Jn=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Qn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return 1===e.length&&Z.isArray(e[0])&&(e=e[0]),function(t){return t.lift(new Kn(e))}};var Yn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=null;return 1===e.length&&Z.isArray(e[0])&&(e=e[0]),n=e.shift(),new Ft.FromObservable(n,null).lift(new Kn(e))},Kn=function(){function e(e){this.nextSources=e}return e.prototype.call=function(e,t){return t.subscribe(new Xn(e,this.nextSources))},e}(),Xn=function(e){function t(t,n){e.call(this,t),this.destination=t,this.nextSources=n}return Jn(t,e),t.prototype.notifyError=function(e,t){this.subscribeToNextSource()},t.prototype.notifyComplete=function(e){this.subscribeToNextSource()},t.prototype._error=function(e){this.subscribeToNextSource()},t.prototype._complete=function(){this.subscribeToNextSource()},t.prototype.subscribeToNextSource=function(){var e=this.nextSources.shift();e?this.add(at.subscribeToResult(this,e)):this.destination.complete()},t}(tt.OuterSubscriber),$n={onErrorResumeNext:Qn,onErrorResumeNextStatic:Yn},Zn={onErrorResumeNext:$n.onErrorResumeNextStatic};Se.Observable.onErrorResumeNext=Zn.onErrorResumeNext;var er=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};function tr(e){var t=e.obj,n=e.keys,r=e.length,i=e.index,o=e.subscriber;if(i!==r){var s=n[i];o.next([s,t[s]]),e.index=i+1,this.schedule(e)}else o.complete()}var nr={pairs:{PairsObservable:function(e){function t(t,n){e.call(this),this.obj=t,this.scheduler=n,this.keys=Object.keys(t)}return er(t,e),t.create=function(e,n){return new t(e,n)},t.prototype._subscribe=function(e){var t=this.keys,n=this.scheduler,r=t.length;if(n)return n.schedule(tr,0,{obj:this.obj,keys:t,length:r,index:0,subscriber:e});for(var i=0;i<r;i++){var o=t[i];e.next([o,this.obj[o]])}e.complete()},t}(Se.Observable)}.PairsObservable.create};Se.Observable.pairs=nr.pairs;var rr=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ir={range:{RangeObservable:function(e){function t(t,n,r){e.call(this),this.start=t,this._count=n,this.scheduler=r}return rr(t,e),t.create=function(e,n,r){return void 0===e&&(e=0),void 0===n&&(n=0),new t(e,n,r)},t.dispatch=function(e){var t=e.start,n=e.index,r=e.count,i=e.subscriber;n>=r?i.complete():(i.next(t),i.closed||(e.index=n+1,e.start=t+1,this.schedule(e)))},t.prototype._subscribe=function(e){var n=0,r=this.start,i=this._count,o=this.scheduler;if(o)return o.schedule(t.dispatch,0,{index:n,count:i,start:r,subscriber:e});for(;;){if(n++>=i){e.complete();break}if(e.next(r++),e.closed)break}},t}(Se.Observable)}.RangeObservable.create};Se.Observable.range=ir.range;var or=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},sr=function(e){function t(t,n){e.call(this),this.resourceFactory=t,this.observableFactory=n}return or(t,e),t.create=function(e,n){return new t(e,n)},t.prototype._subscribe=function(e){var t,n=this.resourceFactory,r=this.observableFactory;try{return t=n(),new ar(e,t,r)}catch(t){e.error(t)}},t}(Se.Observable),ar=function(e){function t(t,n,r){e.call(this,t),this.resource=n,this.observableFactory=r,t.add(n),this.tryUse()}return or(t,e),t.prototype.tryUse=function(){try{var e=this.observableFactory.call(this,this.resource);e&&this.add(at.subscribeToResult(this,e))}catch(e){this._error(e)}},t}(tt.OuterSubscriber),cr={using:{UsingObservable:sr}.UsingObservable.create};Se.Observable.using=cr.using;var ur=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},lr={ErrorObservable:function(e){function t(t,n){e.call(this),this.error=t,this.scheduler=n}return ur(t,e),t.create=function(e,n){return new t(e,n)},t.dispatch=function(e){var t=e.error;e.subscriber.error(t)},t.prototype._subscribe=function(e){var n=this.error,r=this.scheduler;if(e.syncErrorThrowable=!0,r)return r.schedule(t.dispatch,0,{error:n,subscriber:e});e.error(n)},t}(Se.Observable)}.ErrorObservable.create,pr={_throw:lr};Se.Observable.throw=pr._throw;var fr={isDate:function(e){return e instanceof Date&&!isNaN(+e)}},hr=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},dr={TimerObservable:function(e){function t(t,n,r){void 0===t&&(t=0),e.call(this),this.period=-1,this.dueTime=0,Tn.isNumeric(n)?this.period=Number(n)<1?1:Number(n):Je.isScheduler(n)&&(r=n),Je.isScheduler(r)||(r=Pn.async),this.scheduler=r,this.dueTime=fr.isDate(t)?+t-this.scheduler.now():t}return hr(t,e),t.create=function(e,n,r){return void 0===e&&(e=0),new t(e,n,r)},t.dispatch=function(e){var t=e.index,n=e.period,r=e.subscriber;if(r.next(t),!r.closed){if(-1===n)return r.complete();e.index=t+1,this.schedule(e,n)}},t.prototype._subscribe=function(e){var n=this,r=n.period,i=n.dueTime;return n.scheduler.schedule(t.dispatch,i,{index:0,period:r,subscriber:e})},t}(Se.Observable)}.TimerObservable.create,br={timer:dr};Se.Observable.timer=br.timer;var vr=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var mr=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){return t.lift.call(yr.apply(void 0,[t].concat(e)))}};function yr(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=e[e.length-1];return"function"==typeof n&&e.pop(),new Ze.ArrayObservable(e).lift(new _r(n))}var gr=yr,_r=function(){function e(e){this.project=e}return e.prototype.call=function(e,t){return t.subscribe(new Or(e,this.project))},e}(),wr=_r,Or=function(e){function t(t,n,r){void 0===r&&(r=Object.create(null)),e.call(this,t),this.iterators=[],this.active=0,this.project="function"==typeof n?n:null,this.values=r}return vr(t,e),t.prototype._next=function(e){var t=this.iterators;Z.isArray(e)?t.push(new Tr(e)):"function"==typeof e[it.iterator]?t.push(new Sr(e[it.iterator]())):t.push(new xr(this.destination,this,e))},t.prototype._complete=function(){var e=this.iterators,t=e.length;if(0!==t){this.active=t;for(var n=0;n<t;n++){var r=e[n];r.stillUnsubscribed?this.add(r.subscribe(r,n)):this.active--}}else this.destination.complete()},t.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},t.prototype.checkIterators=function(){for(var e=this.iterators,t=e.length,n=this.destination,r=0;r<t;r++){if("function"==typeof(s=e[r]).hasValue&&!s.hasValue())return}var i=!1,o=[];for(r=0;r<t;r++){var s,a=(s=e[r]).next();if(s.hasCompleted()&&(i=!0),a.done)return void n.complete();o.push(a.value)}this.project?this._tryProject(o):n.next(o),i&&n.complete()},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(me.Subscriber),Er=Or,Sr=function(){function e(e){this.iterator=e,this.nextResult=e.next()}return e.prototype.hasValue=function(){return!0},e.prototype.next=function(){var e=this.nextResult;return this.nextResult=this.iterator.next(),e},e.prototype.hasCompleted=function(){var e=this.nextResult;return e&&e.done},e}(),Tr=function(){function e(e){this.array=e,this.index=0,this.length=0,this.length=e.length}return e.prototype[it.iterator]=function(){return this},e.prototype.next=function(e){var t=this.index++,n=this.array;return t<this.length?{value:n[t],done:!1}:{value:null,done:!0}},e.prototype.hasValue=function(){return this.array.length>this.index},e.prototype.hasCompleted=function(){return this.array.length===this.index},e}(),xr=function(e){function t(t,n,r){e.call(this,t),this.parent=n,this.observable=r,this.stillUnsubscribed=!0,this.buffer=[],this.isComplete=!1}return vr(t,e),t.prototype[it.iterator]=function(){return this},t.prototype.next=function(){var e=this.buffer;return 0===e.length&&this.isComplete?{value:null,done:!0}:{value:e.shift(),done:!1}},t.prototype.hasValue=function(){return this.buffer.length>0},t.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},t.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){this.buffer.push(t),this.parent.checkIterators()},t.prototype.subscribe=function(e,t){return at.subscribeToResult(this,this.observable,this,t)},t}(tt.OuterSubscriber),Ar={zip:mr,zipStatic:gr,ZipOperator:wr,ZipSubscriber:Er},kr={zip:Ar.zipStatic};Se.Observable.zip=kr.zip;var Ir=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Nr=function(e,t){return function(n){if("function"!=typeof e)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return n.lift(new Rr(e,t))}},Rr=function(){function e(e,t){this.project=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new Pr(e,this.project,this.thisArg))},e}(),Cr=Rr,Pr=function(e){function t(t,n,r){e.call(this,t),this.project=n,this.count=0,this.thisArg=r||this}return Ir(t,e),t.prototype._next=function(e){var t;try{t=this.project.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(me.Subscriber),Mr={map:Nr,MapOperator:Cr},jr=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};function qr(){if(X.root.XMLHttpRequest)return new X.root.XMLHttpRequest;if(X.root.XDomainRequest)return new X.root.XDomainRequest;throw new Error("CORS is not supported by your browser")}function Lr(e,t){return void 0===t&&(t=null),new Kr({method:"GET",url:e,headers:t})}var Ur=Lr;function Vr(e,t,n){return new Kr({method:"POST",url:e,body:t,headers:n})}var Dr=Vr;function Fr(e,t){return new Kr({method:"DELETE",url:e,headers:t})}var Br=Fr;function Wr(e,t,n){return new Kr({method:"PUT",url:e,body:t,headers:n})}var Hr=Wr;function Gr(e,t,n){return new Kr({method:"PATCH",url:e,body:t,headers:n})}var zr=Gr,Jr=Mr.map((function(e,t){return e.response}));function Qr(e,t){return Jr(new Kr({method:"GET",url:e,responseType:"json",headers:t}))}var Yr=Qr,Kr=function(e){function t(t){e.call(this);var n={async:!0,createXHR:function(){return this.crossDomain?qr.call(this):function(){if(X.root.XMLHttpRequest)return new X.root.XMLHttpRequest;var e=void 0;try{for(var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=0;n<3;n++)try{if(e=t[n],new X.root.ActiveXObject(e))break}catch(e){}return new X.root.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}()},crossDomain:!1,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof t)n.url=t;else for(var r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);this.request=n}return jr(t,e),t.prototype._subscribe=function(e){return new $r(e,this.request)},t.create=function(){var e=function(e){return new t(e)};return e.get=Lr,e.post=Vr,e.delete=Fr,e.put=Wr,e.patch=Gr,e.getJSON=Qr,e}(),t}(Se.Observable),Xr=Kr,$r=function(e){function t(t,n){e.call(this,t),this.request=n,this.done=!1;var r=n.headers=n.headers||{};n.crossDomain||r["X-Requested-With"]||(r["X-Requested-With"]="XMLHttpRequest"),"Content-Type"in r||X.root.FormData&&n.body instanceof X.root.FormData||void 0===n.body||(r["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),n.body=this.serializeBody(n.body,n.headers["Content-Type"]),this.send()}return jr(t,e),t.prototype.next=function(e){this.done=!0;var t=this,n=t.xhr,r=t.request,i=t.destination,o=new ei(e,n,r);i.next(o)},t.prototype.send=function(){var e=this.request,t=this.request,n=t.user,r=t.method,i=t.url,o=t.async,s=t.password,a=t.headers,c=t.body,u=e.createXHR,l=ie.tryCatch(u).call(e);if(l===ne.errorObject)this.error(ne.errorObject.e);else{this.xhr=l,this.setupEvents(l,e);if((n?ie.tryCatch(l.open).call(l,r,i,o,n,s):ie.tryCatch(l.open).call(l,r,i,o))===ne.errorObject)return this.error(ne.errorObject.e),null;if(o&&(l.timeout=e.timeout,l.responseType=e.responseType),"withCredentials"in l&&(l.withCredentials=!!e.withCredentials),this.setHeaders(l,a),(c?ie.tryCatch(l.send).call(l,c):ie.tryCatch(l.send).call(l))===ne.errorObject)return this.error(ne.errorObject.e),null}return l},t.prototype.serializeBody=function(e,t){if(!e||"string"==typeof e)return e;if(X.root.FormData&&e instanceof X.root.FormData)return e;if(t){var n=t.indexOf(";");-1!==n&&(t=t.substring(0,n))}switch(t){case"application/x-www-form-urlencoded":return Object.keys(e).map((function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])})).join("&");case"application/json":return JSON.stringify(e);default:return e}},t.prototype.setHeaders=function(e,t){for(var n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n])},t.prototype.setupEvents=function(e,t){var n=t.progressSubscriber;function r(e){var t=r,n=t.subscriber,i=t.progressSubscriber,o=t.request;i&&i.error(e),n.error(new oi(this,o))}if(e.ontimeout=r,r.request=t,r.subscriber=this,r.progressSubscriber=n,e.upload&&"withCredentials"in e){var i,o;if(n)i=function(e){i.progressSubscriber.next(e)},X.root.XDomainRequest?e.onprogress=i:e.upload.onprogress=i,i.progressSubscriber=n;o=function(e){var t=o,n=t.progressSubscriber,r=t.subscriber,i=t.request;n&&n.error(e),r.error(new ni("ajax error",this,i))},e.onerror=o,o.request=t,o.subscriber=this,o.progressSubscriber=n}function s(e){var t=s,n=t.subscriber,r=t.progressSubscriber,i=t.request;if(4===this.readyState){var o=1223===this.status?204:this.status,a="text"===this.responseType?this.response||this.responseText:this.response;0===o&&(o=a?200:0),200<=o&&o<300?(r&&r.complete(),n.next(e),n.complete()):(r&&r.error(e),n.error(new ni("ajax error "+o,this,i)))}}e.onreadystatechange=s,s.subscriber=this,s.progressSubscriber=n,s.request=t},t.prototype.unsubscribe=function(){var t=this.done,n=this.xhr;!t&&n&&4!==n.readyState&&"function"==typeof n.abort&&n.abort(),e.prototype.unsubscribe.call(this)},t}(me.Subscriber),Zr=$r,ei=function(e,t,n){this.originalEvent=e,this.xhr=t,this.request=n,this.status=t.status,this.responseType=t.responseType||n.responseType,this.response=ii(this.responseType,t)},ti=ei,ni=function(e){function t(t,n,r){e.call(this,t),this.message=t,this.xhr=n,this.request=r,this.status=n.status,this.responseType=n.responseType||r.responseType,this.response=ii(this.responseType,n)}return jr(t,e),t}(Error),ri=ni;function ii(e,t){switch(e){case"json":return"response"in t?t.responseType?t.response:JSON.parse(t.response||t.responseText||"null"):JSON.parse(t.responseText||"null");case"xml":return t.responseXML;case"text":default:return"response"in t?t.response:t.responseText}}var oi=function(e){function t(t,n){e.call(this,"ajax timeout",t,n)}return jr(t,e),t}(ni),si={ajaxGet:Ur,ajaxPost:Dr,ajaxDelete:Br,ajaxPut:Hr,ajaxPatch:zr,ajaxGetJSON:Yr,AjaxObservable:Xr,AjaxSubscriber:Zr,AjaxResponse:ti,AjaxError:ri,AjaxTimeoutError:oi},ai={ajax:si.AjaxObservable.create};Se.Observable.ajax=ai.ajax;var ci=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ui={QueueAction:function(e){function t(t,n){e.call(this,t,n),this.scheduler=t,this.work=n}return ci(t,e),t.prototype.schedule=function(t,n){return void 0===n&&(n=0),n>0?e.prototype.schedule.call(this,t,n):(this.delay=n,this.state=t,this.scheduler.flush(this),this)},t.prototype.execute=function(t,n){return n>0||this.closed?e.prototype.execute.call(this,t,n):this._execute(t,n)},t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0?e.prototype.requestAsyncId.call(this,t,n,r):t.flush(this)},t}(In.AsyncAction)},li=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},pi={queue:new({QueueScheduler:function(e){function t(){e.apply(this,arguments)}return li(t,e),t}(Cn.AsyncScheduler)}.QueueScheduler)(ui.QueueAction)},fi=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},hi=function(e){function t(t,n,r){void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=Number.POSITIVE_INFINITY),e.call(this),this.scheduler=r,this._events=[],this._bufferSize=t<1?1:t,this._windowTime=n<1?1:n}return fi(t,e),t.prototype.next=function(t){var n=this._getNow();this._events.push(new di(n,t)),this._trimBufferThenGetEvents(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){var t,n=this._trimBufferThenGetEvents(),r=this.scheduler;if(this.closed)throw new xe.ObjectUnsubscribedError;this.hasError||this.isStopped?t=ue.Subscription.EMPTY:(this.observers.push(e),t=new ke.SubjectSubscription(this,e)),r&&e.add(e=new Vt.ObserveOnSubscriber(e,r));for(var i=n.length,o=0;o<i&&!e.closed;o++)e.next(n[o].value);return this.hasError?e.error(this.thrownError):this.isStopped&&e.complete(),t},t.prototype._getNow=function(){return(this.scheduler||pi.queue).now()},t.prototype._trimBufferThenGetEvents=function(){for(var e=this._getNow(),t=this._bufferSize,n=this._windowTime,r=this._events,i=r.length,o=0;o<i&&!(e-r[o].time<n);)o++;return i>t&&(o=Math.max(o,i-t)),o>0&&r.splice(0,o),r},t}(je.Subject),di=function(e,t){this.time=e,this.value=t},bi={ReplaySubject:hi};function vi(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];for(var r=t.length,i=0;i<r;i++){var o=t[i];for(var s in o)o.hasOwnProperty(s)&&(e[s]=o[s])}return e}function mi(e){return e.Object.assign||vi}var yi={assignImpl:vi,getAssign:mi,assign:mi(X.root)},gi=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},_i={webSocket:{WebSocketSubject:function(e){function t(t,n){if(t instanceof Se.Observable)e.call(this,n,t);else{if(e.call(this),this.WebSocketCtor=X.root.WebSocket,this._output=new je.Subject,"string"==typeof t?this.url=t:yi.assign(this,t),!this.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new bi.ReplaySubject}}return gi(t,e),t.prototype.resultSelector=function(e){return JSON.parse(e.data)},t.create=function(e){return new t(e)},t.prototype.lift=function(e){var n=new t(this,this.destination);return n.operator=e,n},t.prototype._resetState=function(){this.socket=null,this.source||(this.destination=new bi.ReplaySubject),this._output=new je.Subject},t.prototype.multiplex=function(e,t,n){var r=this;return new Se.Observable((function(i){var o=ie.tryCatch(e)();o===ne.errorObject?i.error(ne.errorObject.e):r.next(o);var s=r.subscribe((function(e){var t=ie.tryCatch(n)(e);t===ne.errorObject?i.error(ne.errorObject.e):t&&i.next(e)}),(function(e){return i.error(e)}),(function(){return i.complete()}));return function(){var e=ie.tryCatch(t)();e===ne.errorObject?i.error(ne.errorObject.e):r.next(e),s.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this.WebSocketCtor,n=this._output,r=null;try{r=this.protocol?new t(this.url,this.protocol):new t(this.url),this.socket=r,this.binaryType&&(this.socket.binaryType=this.binaryType)}catch(e){return void n.error(e)}var i=new ue.Subscription((function(){e.socket=null,r&&1===r.readyState&&r.close()}));r.onopen=function(t){var o=e.openObserver;o&&o.next(t);var s=e.destination;e.destination=me.Subscriber.create((function(e){return 1===r.readyState&&r.send(e)}),(function(t){var i=e.closingObserver;i&&i.next(void 0),t&&t.code?r.close(t.code,t.reason):n.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e.closingObserver;t&&t.next(void 0),r.close(),e._resetState()})),s&&s instanceof bi.ReplaySubject&&i.add(s.subscribe(e.destination))},r.onerror=function(t){e._resetState(),n.error(t)},r.onclose=function(t){e._resetState();var r=e.closeObserver;r&&r.next(t),t.wasClean?n.complete():n.error(t)},r.onmessage=function(t){var r=ie.tryCatch(e.resultSelector)(t);r===ne.errorObject?n.error(ne.errorObject.e):n.next(r)}},t.prototype._subscribe=function(e){var t=this,n=this.source;if(n)return n.subscribe(e);this.socket||this._connectSocket();var r=new ue.Subscription;return r.add(this._output.subscribe(e)),r.add((function(){var e=t.socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())})),r},t.prototype.unsubscribe=function(){var t=this.source,n=this.socket;n&&1===n.readyState&&(n.close(),this._resetState()),e.prototype.unsubscribe.call(this),t||(this.destination=new bi.ReplaySubject)},t}(je.AnonymousSubject)}.WebSocketSubject.create};Se.Observable.webSocket=_i.webSocket;var wi=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Oi=function(e){return function(t){return t.lift(new Ei(e))}},Ei=function(){function e(e){this.closingNotifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Si(e,this.closingNotifier))},e}(),Si=function(e){function t(t,n){e.call(this,t),this.buffer=[],this.add(at.subscribeToResult(this,n))}return wi(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.buffer;this.buffer=[],this.destination.next(o)},t}(tt.OuterSubscriber),Ti={buffer:Oi};var xi={buffer:function(e){return Ti.buffer(e)(this)}};Se.Observable.prototype.buffer=xi.buffer;var Ai=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ki=function(e,t){return void 0===t&&(t=null),function(n){return n.lift(new Ii(e,t))}},Ii=function(){function e(e,t){this.bufferSize=e,this.startBufferEvery=t,this.subscriberClass=t&&e!==t?Ri:Ni}return e.prototype.call=function(e,t){return t.subscribe(new this.subscriberClass(e,this.bufferSize,this.startBufferEvery))},e}(),Ni=function(e){function t(t,n){e.call(this,t),this.bufferSize=n,this.buffer=[]}return Ai(t,e),t.prototype._next=function(e){var t=this.buffer;t.push(e),t.length==this.bufferSize&&(this.destination.next(t),this.buffer=[])},t.prototype._complete=function(){var t=this.buffer;t.length>0&&this.destination.next(t),e.prototype._complete.call(this)},t}(me.Subscriber),Ri=function(e){function t(t,n,r){e.call(this,t),this.bufferSize=n,this.startBufferEvery=r,this.buffers=[],this.count=0}return Ai(t,e),t.prototype._next=function(e){var t=this,n=t.bufferSize,r=t.startBufferEvery,i=t.buffers,o=t.count;this.count++,o%r==0&&i.push([]);for(var s=i.length;s--;){var a=i[s];a.push(e),a.length===n&&(i.splice(s,1),this.destination.next(a))}},t.prototype._complete=function(){for(var t=this.buffers,n=this.destination;t.length>0;){var r=t.shift();r.length>0&&n.next(r)}e.prototype._complete.call(this)},t}(me.Subscriber),Ci={bufferCount:ki};var Pi={bufferCount:function(e,t){return void 0===t&&(t=null),Ci.bufferCount(e,t)(this)}};Se.Observable.prototype.bufferCount=Pi.bufferCount;var Mi=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ji=function(e){var t=arguments.length,n=Pn.async;Je.isScheduler(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),function(t){return t.lift(new qi(e,r,i,n))}},qi=function(){function e(e,t,n,r){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Ui(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),Li=function(){this.buffer=[]},Ui=function(e){function t(t,n,r,i,o){e.call(this,t),this.bufferTimeSpan=n,this.bufferCreationInterval=r,this.maxBufferSize=i,this.scheduler=o,this.contexts=[];var s=this.openContext();if(this.timespanOnly=null==r||r<0,this.timespanOnly){var a={subscriber:this,context:s,bufferTimeSpan:n};this.add(s.closeAction=o.schedule(Vi,n,a))}else{var c={subscriber:this,context:s},u={bufferTimeSpan:n,bufferCreationInterval:r,subscriber:this,scheduler:o};this.add(s.closeAction=o.schedule(Fi,n,c)),this.add(o.schedule(Di,r,u))}}return Mi(t,e),t.prototype._next=function(e){for(var t,n=this.contexts,r=n.length,i=0;i<r;i++){var o=n[i],s=o.buffer;s.push(e),s.length==this.maxBufferSize&&(t=o)}t&&this.onBufferFull(t)},t.prototype._error=function(t){this.contexts.length=0,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts,n=this.destination;t.length>0;){var r=t.shift();n.next(r.buffer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.contexts=null},t.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var n=this.bufferTimeSpan,r={subscriber:this,context:e,bufferTimeSpan:n};this.add(e.closeAction=this.scheduler.schedule(Vi,n,r))}},t.prototype.openContext=function(){var e=new Li;return this.contexts.push(e),e},t.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts;(t?t.indexOf(e):-1)>=0&&t.splice(t.indexOf(e),1)},t}(me.Subscriber);function Vi(e){var t=e.subscriber,n=e.context;n&&t.closeContext(n),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function Di(e){var t=e.bufferCreationInterval,n=e.bufferTimeSpan,r=e.subscriber,i=e.scheduler,o=r.openContext();r.closed||(r.add(o.closeAction=i.schedule(Fi,n,{subscriber:r,context:o})),this.schedule(e,t))}function Fi(e){var t=e.subscriber,n=e.context;t.closeContext(n)}var Bi={bufferTime:ji};var Wi={bufferTime:function(e){var t=arguments.length,n=Pn.async;Je.isScheduler(arguments[arguments.length-1])&&(n=arguments[arguments.length-1],t--);var r=null;t>=2&&(r=arguments[1]);var i=Number.POSITIVE_INFINITY;return t>=3&&(i=arguments[2]),Bi.bufferTime(e,r,i,n)(this)}};Se.Observable.prototype.bufferTime=Wi.bufferTime;var Hi=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Gi=function(e,t){return function(n){return n.lift(new zi(e,t))}},zi=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Ji(e,this.openings,this.closingSelector))},e}(),Ji=function(e){function t(t,n,r){e.call(this,t),this.openings=n,this.closingSelector=r,this.contexts=[],this.add(at.subscribeToResult(this,n))}return Hi(t,e),t.prototype._next=function(e){for(var t=this.contexts,n=t.length,r=0;r<n;r++)t[r].buffer.push(e)},t.prototype._error=function(t){for(var n=this.contexts;n.length>0;){var r=n.shift();r.subscription.unsubscribe(),r.buffer=null,r.subscription=null}this.contexts=null,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this.contexts;t.length>0;){var n=t.shift();this.destination.next(n.buffer),n.subscription.unsubscribe(),n.buffer=null,n.subscription=null}this.contexts=null,e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t,n,r,i){e?this.closeBuffer(e):this.openBuffer(t)},t.prototype.notifyComplete=function(e){this.closeBuffer(e.context)},t.prototype.openBuffer=function(e){try{var t=this.closingSelector.call(this,e);t&&this.trySubscribe(t)}catch(e){this._error(e)}},t.prototype.closeBuffer=function(e){var t=this.contexts;if(t&&e){var n=e.buffer,r=e.subscription;this.destination.next(n),t.splice(t.indexOf(e),1),this.remove(r),r.unsubscribe()}},t.prototype.trySubscribe=function(e){var t=this.contexts,n=new ue.Subscription,r={buffer:[],subscription:n};t.push(r);var i=at.subscribeToResult(this,e,r);!i||i.closed?this.closeBuffer(r):(i.context=r,this.add(i),n.add(i))},t}(tt.OuterSubscriber),Qi={bufferToggle:Gi};var Yi={bufferToggle:function(e,t){return Qi.bufferToggle(e,t)(this)}};Se.Observable.prototype.bufferToggle=Yi.bufferToggle;var Ki=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Xi=function(e){return function(t){return t.lift(new $i(e))}},$i=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Zi(e,this.closingSelector))},e}(),Zi=function(e){function t(t,n){e.call(this,t),this.closingSelector=n,this.subscribing=!1,this.openBuffer()}return Ki(t,e),t.prototype._next=function(e){this.buffer.push(e)},t.prototype._complete=function(){var t=this.buffer;t&&this.destination.next(t),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.buffer=null,this.subscribing=!1},t.prototype.notifyNext=function(e,t,n,r,i){this.openBuffer()},t.prototype.notifyComplete=function(){this.subscribing?this.complete():this.openBuffer()},t.prototype.openBuffer=function(){var e=this.closingSubscription;e&&(this.remove(e),e.unsubscribe());var t=this.buffer;this.buffer&&this.destination.next(t),this.buffer=[];var n=ie.tryCatch(this.closingSelector)();n===ne.errorObject?this.error(ne.errorObject.e):(e=new ue.Subscription,this.closingSubscription=e,this.add(e),this.subscribing=!0,e.add(at.subscribeToResult(this,n)),this.subscribing=!1)},t}(tt.OuterSubscriber),eo={bufferWhen:Xi};var to={bufferWhen:function(e){return eo.bufferWhen(e)(this)}};Se.Observable.prototype.bufferWhen=to.bufferWhen;var no=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ro=function(e){return function(t){var n=new io(e),r=t.lift(n);return n.caught=r}},io=function(){function e(e){this.selector=e}return e.prototype.call=function(e,t){return t.subscribe(new oo(e,this.selector,this.caught))},e}(),oo=function(e){function t(t,n,r){e.call(this,t),this.selector=n,this.caught=r}return no(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=void 0;try{n=this.selector(t,this.caught)}catch(t){return void e.prototype.error.call(this,t)}this._unsubscribeAndRecycle(),this.add(at.subscribeToResult(this,n))}},t}(tt.OuterSubscriber),so={catchError:ro};var ao={_catch:function(e){return so.catchError(e)(this)}};Se.Observable.prototype.catch=ao._catch,Se.Observable.prototype._catch=ao._catch;var co={combineAll:function(e){return function(t){return t.lift(new dt.CombineLatestOperator(e))}}};var uo={combineAll:function(e){return co.combineAll(e)(this)}};Se.Observable.prototype.combineAll=uo.combineAll;var lo={combineLatest:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return dt.combineLatest.apply(void 0,e)(this)}};Se.Observable.prototype.combineLatest=lo.combineLatest;var po={concatStatic:Zt.concat,concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){return t.lift.call(Zt.concat.apply(void 0,[t].concat(e)))}}};var fo={concatStatic:Zt.concat,concat:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return po.concat.apply(void 0,e)(this)}};Se.Observable.prototype.concat=fo.concat;var ho={concatAll:function(){return $t.concatAll()(this)}};Se.Observable.prototype.concatAll=ho.concatAll;var bo={concatMap:function(e,t){return Yt.mergeMap(e,t,1)}};var vo={concatMap:function(e,t){return bo.concatMap(e,t)(this)}};Se.Observable.prototype.concatMap=vo.concatMap;var mo={concatMapTo:function(e,t){return bo.concatMap((function(){return e}),t)}};var yo={concatMapTo:function(e,t){return mo.concatMapTo(e,t)(this)}};Se.Observable.prototype.concatMapTo=yo.concatMapTo;var go=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var _o=function(e){return function(t){return t.lift(new wo(e,t))}},wo=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Oo(e,this.predicate,this.source))},e}(),Oo=function(e){function t(t,n,r){e.call(this,t),this.predicate=n,this.source=r,this.count=0,this.index=0}return go(t,e),t.prototype._next=function(e){this.predicate?this._tryPredicate(e):this.count++},t.prototype._tryPredicate=function(e){var t;try{t=this.predicate(e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t&&this.count++},t.prototype._complete=function(){this.destination.next(this.count),this.destination.complete()},t}(me.Subscriber),Eo={count:_o};var So={count:function(e){return Eo.count(e)(this)}};Se.Observable.prototype.count=So.count;var To=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var xo=function(){return function(e){return e.lift(new Ao)}},Ao=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new ko(e))},e}(),ko=function(e){function t(t){e.call(this,t)}return To(t,e),t.prototype._next=function(e){e.observe(this.destination)},t}(me.Subscriber),Io={dematerialize:xo};var No={dematerialize:function(){return Io.dematerialize()(this)}};Se.Observable.prototype.dematerialize=No.dematerialize;var Ro=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Co=function(e){return function(t){return t.lift(new Po(e))}},Po=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Mo(e,this.durationSelector))},e}(),Mo=function(e){function t(t,n){e.call(this,t),this.durationSelector=n,this.hasValue=!1,this.durationSubscription=null}return Ro(t,e),t.prototype._next=function(e){try{var t=this.durationSelector.call(this,e);t&&this._tryNext(e,t)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.emitValue(),this.destination.complete()},t.prototype._tryNext=function(e,t){var n=this.durationSubscription;this.value=e,this.hasValue=!0,n&&(n.unsubscribe(),this.remove(n)),(n=at.subscribeToResult(this,t)).closed||this.add(this.durationSubscription=n)},t.prototype.notifyNext=function(e,t,n,r,i){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){if(this.hasValue){var t=this.value,n=this.durationSubscription;n&&(this.durationSubscription=null,n.unsubscribe(),this.remove(n)),this.value=null,this.hasValue=!1,e.prototype._next.call(this,t)}},t}(tt.OuterSubscriber),jo={debounce:Co};var qo={debounce:function(e){return jo.debounce(e)(this)}};Se.Observable.prototype.debounce=qo.debounce;var Lo=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Uo=function(e,t){return void 0===t&&(t=Pn.async),function(n){return n.lift(new Vo(e,t))}},Vo=function(){function e(e,t){this.dueTime=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Do(e,this.dueTime,this.scheduler))},e}(),Do=function(e){function t(t,n,r){e.call(this,t),this.dueTime=n,this.scheduler=r,this.debouncedSubscription=null,this.lastValue=null,this.hasValue=!1}return Lo(t,e),t.prototype._next=function(e){this.clearDebounce(),this.lastValue=e,this.hasValue=!0,this.add(this.debouncedSubscription=this.scheduler.schedule(Fo,this.dueTime,this))},t.prototype._complete=function(){this.debouncedNext(),this.destination.complete()},t.prototype.debouncedNext=function(){this.clearDebounce(),this.hasValue&&(this.destination.next(this.lastValue),this.lastValue=null,this.hasValue=!1)},t.prototype.clearDebounce=function(){var e=this.debouncedSubscription;null!==e&&(this.remove(e),e.unsubscribe(),this.debouncedSubscription=null)},t}(me.Subscriber);function Fo(e){e.debouncedNext()}var Bo={debounceTime:Uo};var Wo={debounceTime:function(e,t){return void 0===t&&(t=Pn.async),Bo.debounceTime(e,t)(this)}};Se.Observable.prototype.debounceTime=Wo.debounceTime;var Ho=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Go=function(e){return void 0===e&&(e=null),function(t){return t.lift(new zo(e))}},zo=function(){function e(e){this.defaultValue=e}return e.prototype.call=function(e,t){return t.subscribe(new Jo(e,this.defaultValue))},e}(),Jo=function(e){function t(t,n){e.call(this,t),this.defaultValue=n,this.isEmpty=!0}return Ho(t,e),t.prototype._next=function(e){this.isEmpty=!1,this.destination.next(e)},t.prototype._complete=function(){this.isEmpty&&this.destination.next(this.defaultValue),this.destination.complete()},t}(me.Subscriber),Qo={defaultIfEmpty:Go};var Yo={defaultIfEmpty:function(e){return void 0===e&&(e=null),Qo.defaultIfEmpty(e)(this)}};Se.Observable.prototype.defaultIfEmpty=Yo.defaultIfEmpty;var Ko=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Xo=function(e,t){void 0===t&&(t=Pn.async);var n=fr.isDate(e)?+e-t.now():Math.abs(e);return function(e){return e.lift(new $o(n,t))}},$o=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Zo(e,this.delay,this.scheduler))},e}(),Zo=function(e){function t(t,n,r){e.call(this,t),this.delay=n,this.scheduler=r,this.queue=[],this.active=!1,this.errored=!1}return Ko(t,e),t.dispatch=function(e){for(var t=e.source,n=t.queue,r=e.scheduler,i=e.destination;n.length>0&&n[0].time-r.now()<=0;)n.shift().notification.observe(i);if(n.length>0){var o=Math.max(0,n[0].time-r.now());this.schedule(e,o)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,n=new es(t.now()+this.delay,e);this.queue.push(n),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(Ct.Notification.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e)},t.prototype._complete=function(){this.scheduleNotification(Ct.Notification.createComplete())},t}(me.Subscriber),es=function(e,t){this.time=e,this.notification=t},ts={delay:Xo};var ns={delay:function(e,t){return void 0===t&&(t=Pn.async),ts.delay(e,t)(this)}};Se.Observable.prototype.delay=ns.delay;var rs=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var is=function(e,t){return t?function(n){return new as(n,t).lift(new os(e))}:function(t){return t.lift(new os(e))}},os=function(){function e(e){this.delayDurationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new ss(e,this.delayDurationSelector))},e}(),ss=function(e){function t(t,n){e.call(this,t),this.delayDurationSelector=n,this.completed=!1,this.delayNotifierSubscriptions=[],this.values=[]}return rs(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.destination.next(e),this.removeSubscription(i),this.tryComplete()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){var t=this.removeSubscription(e);t&&this.destination.next(t),this.tryComplete()},t.prototype._next=function(e){try{var t=this.delayDurationSelector(e);t&&this.tryDelay(t,e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.completed=!0,this.tryComplete()},t.prototype.removeSubscription=function(e){e.unsubscribe();var t=this.delayNotifierSubscriptions.indexOf(e),n=null;return-1!==t&&(n=this.values[t],this.delayNotifierSubscriptions.splice(t,1),this.values.splice(t,1)),n},t.prototype.tryDelay=function(e,t){var n=at.subscribeToResult(this,e,t);n&&!n.closed&&(this.add(n),this.delayNotifierSubscriptions.push(n)),this.values.push(t)},t.prototype.tryComplete=function(){this.completed&&0===this.delayNotifierSubscriptions.length&&this.destination.complete()},t}(tt.OuterSubscriber),as=function(e){function t(t,n){e.call(this),this.source=t,this.subscriptionDelay=n}return rs(t,e),t.prototype._subscribe=function(e){this.subscriptionDelay.subscribe(new cs(e,this.source))},t}(Se.Observable),cs=function(e){function t(t,n){e.call(this),this.parent=t,this.source=n,this.sourceSubscribed=!1}return rs(t,e),t.prototype._next=function(e){this.subscribeToSource()},t.prototype._error=function(e){this.unsubscribe(),this.parent.error(e)},t.prototype._complete=function(){this.subscribeToSource()},t.prototype.subscribeToSource=function(){this.sourceSubscribed||(this.sourceSubscribed=!0,this.unsubscribe(),this.source.subscribe(this.parent))},t}(me.Subscriber),us={delayWhen:is};var ls={delayWhen:function(e,t){return us.delayWhen(e,t)(this)}};function ps(){return function(){function e(){this._values=[]}return e.prototype.add=function(e){this.has(e)||this._values.push(e)},e.prototype.has=function(e){return-1!==this._values.indexOf(e)},Object.defineProperty(e.prototype,"size",{get:function(){return this._values.length},enumerable:!0,configurable:!0}),e.prototype.clear=function(){this._values.length=0},e}()}Se.Observable.prototype.delayWhen=ls.delayWhen;var fs={minimalSetImpl:ps,Set:X.root.Set||ps()},hs=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ds=function(e,t){return function(n){return n.lift(new bs(e,t))}},bs=function(){function e(e,t){this.keySelector=e,this.flushes=t}return e.prototype.call=function(e,t){return t.subscribe(new vs(e,this.keySelector,this.flushes))},e}(),vs=function(e){function t(t,n,r){e.call(this,t),this.keySelector=n,this.values=new fs.Set,r&&this.add(at.subscribeToResult(this,r))}return hs(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.values.clear()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype._next=function(e){this.keySelector?this._useKeySelector(e):this._finalizeNext(e,e)},t.prototype._useKeySelector=function(e){var t,n=this.destination;try{t=this.keySelector(e)}catch(e){return void n.error(e)}this._finalizeNext(t,e)},t.prototype._finalizeNext=function(e,t){var n=this.values;n.has(e)||(n.add(e),this.destination.next(t))},t}(tt.OuterSubscriber),ms={distinct:ds,DistinctSubscriber:vs};var ys={distinct:function(e,t){return ms.distinct(e,t)(this)}};Se.Observable.prototype.distinct=ys.distinct;var gs=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var _s=function(e,t){return function(n){return n.lift(new ws(e,t))}},ws=function(){function e(e,t){this.compare=e,this.keySelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Os(e,this.compare,this.keySelector))},e}(),Os=function(e){function t(t,n,r){e.call(this,t),this.keySelector=r,this.hasKey=!1,"function"==typeof n&&(this.compare=n)}return gs(t,e),t.prototype.compare=function(e,t){return e===t},t.prototype._next=function(e){var t=e;if(this.keySelector&&(t=ie.tryCatch(this.keySelector)(e))===ne.errorObject)return this.destination.error(ne.errorObject.e);var n=!1;if(this.hasKey){if((n=ie.tryCatch(this.compare)(this.key,t))===ne.errorObject)return this.destination.error(ne.errorObject.e)}else this.hasKey=!0;!1===Boolean(n)&&(this.key=t,this.destination.next(e))},t}(me.Subscriber),Es={distinctUntilChanged:_s};var Ss={distinctUntilChanged:function(e,t){return Es.distinctUntilChanged(e,t)(this)}};Se.Observable.prototype.distinctUntilChanged=Ss.distinctUntilChanged;var Ts={distinctUntilKeyChanged:function(e,t){return Es.distinctUntilChanged((function(n,r){return t?t(n[e],r[e]):n[e]===r[e]}))}};var xs={distinctUntilKeyChanged:function(e,t){return Ts.distinctUntilKeyChanged(e,t)(this)}};Se.Observable.prototype.distinctUntilKeyChanged=xs.distinctUntilKeyChanged;var As=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ks=function(e,t,n){return function(r){return r.lift(new Is(e,t,n))}},Is=function(){function e(e,t,n){this.nextOrObserver=e,this.error=t,this.complete=n}return e.prototype.call=function(e,t){return t.subscribe(new Ns(e,this.nextOrObserver,this.error,this.complete))},e}(),Ns=function(e){function t(t,n,r,i){e.call(this,t);var o=new me.Subscriber(n,r,i);o.syncErrorThrowable=!0,this.add(o),this.safeSubscriber=o}return As(t,e),t.prototype._next=function(e){var t=this.safeSubscriber;t.next(e),t.syncErrorThrown?this.destination.error(t.syncErrorValue):this.destination.next(e)},t.prototype._error=function(e){var t=this.safeSubscriber;t.error(e),t.syncErrorThrown?this.destination.error(t.syncErrorValue):this.destination.error(e)},t.prototype._complete=function(){var e=this.safeSubscriber;e.complete(),e.syncErrorThrown?this.destination.error(e.syncErrorValue):this.destination.complete()},t}(me.Subscriber),Rs={tap:ks};var Cs={_do:function(e,t,n){return Rs.tap(e,t,n)(this)}};Se.Observable.prototype.do=Cs._do,Se.Observable.prototype._do=Cs._do;var Ps=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Ms=function(){return function(e){return e.lift(new js)}},js=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new qs(e))},e}(),qs=function(e){function t(t){e.call(this,t),this.hasCompleted=!1,this.hasSubscription=!1}return Ps(t,e),t.prototype._next=function(e){this.hasSubscription||(this.hasSubscription=!0,this.add(at.subscribeToResult(this,e)))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},t.prototype.notifyComplete=function(e){this.remove(e),this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tt.OuterSubscriber),Ls={exhaust:Ms};var Us={exhaust:function(){return Ls.exhaust()(this)}};Se.Observable.prototype.exhaust=Us.exhaust;var Vs=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Ds=function(e,t){return function(n){return n.lift(new Fs(e,t))}},Fs=function(){function e(e,t){this.project=e,this.resultSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Bs(e,this.project,this.resultSelector))},e}(),Bs=function(e){function t(t,n,r){e.call(this,t),this.project=n,this.resultSelector=r,this.hasSubscription=!1,this.hasCompleted=!1,this.index=0}return Vs(t,e),t.prototype._next=function(e){this.hasSubscription||this.tryNext(e)},t.prototype.tryNext=function(e){var t=this.index++,n=this.destination;try{var r=this.project(e,t);this.hasSubscription=!0,this.add(at.subscribeToResult(this,r,e,t))}catch(e){n.error(e)}},t.prototype._complete=function(){this.hasCompleted=!0,this.hasSubscription||this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.resultSelector,s=this.destination;o?this.trySelectResult(e,t,n,r):s.next(t)},t.prototype.trySelectResult=function(e,t,n,r){var i=this.resultSelector,o=this.destination;try{var s=i(e,t,n,r);o.next(s)}catch(e){o.error(e)}},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(e){this.remove(e),this.hasSubscription=!1,this.hasCompleted&&this.destination.complete()},t}(tt.OuterSubscriber),Ws={exhaustMap:Ds};var Hs={exhaustMap:function(e,t){return Ws.exhaustMap(e,t)(this)}};Se.Observable.prototype.exhaustMap=Hs.exhaustMap;var Gs=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var zs=function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=void 0),t=(t||0)<1?Number.POSITIVE_INFINITY:t,function(r){return r.lift(new Js(e,t,n))}},Js=function(){function e(e,t,n){this.project=e,this.concurrent=t,this.scheduler=n}return e.prototype.call=function(e,t){return t.subscribe(new Ys(e,this.project,this.concurrent,this.scheduler))},e}(),Qs=Js,Ys=function(e){function t(t,n,r,i){e.call(this,t),this.project=n,this.concurrent=r,this.scheduler=i,this.index=0,this.active=0,this.hasCompleted=!1,r<Number.POSITIVE_INFINITY&&(this.buffer=[])}return Gs(t,e),t.dispatch=function(e){var t=e.subscriber,n=e.result,r=e.value,i=e.index;t.subscribeToProjection(n,r,i)},t.prototype._next=function(e){var n=this.destination;if(n.closed)this._complete();else{var r=this.index++;if(this.active<this.concurrent){n.next(e);var i=ie.tryCatch(this.project)(e,r);if(i===ne.errorObject)n.error(ne.errorObject.e);else if(this.scheduler){var o={subscriber:this,result:i,value:e,index:r};this.add(this.scheduler.schedule(t.dispatch,0,o))}else this.subscribeToProjection(i,e,r)}else this.buffer.push(e)}},t.prototype.subscribeToProjection=function(e,t,n){this.active++,this.add(at.subscribeToResult(this,e,t,n))},t.prototype._complete=function(){this.hasCompleted=!0,this.hasCompleted&&0===this.active&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){this._next(t)},t.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,t&&t.length>0&&this._next(t.shift()),this.hasCompleted&&0===this.active&&this.destination.complete()},t}(tt.OuterSubscriber),Ks={expand:zs,ExpandOperator:Qs,ExpandSubscriber:Ys};var Xs={expand:function(e,t,n){return void 0===t&&(t=Number.POSITIVE_INFINITY),void 0===n&&(n=void 0),t=(t||0)<1?Number.POSITIVE_INFINITY:t,Ks.expand(e,t,n)(this)}};Se.Observable.prototype.expand=Xs.expand;var $s=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Zs={ArgumentOutOfRangeError:function(e){function t(){var t=e.call(this,"argument out of range");this.name=t.name="ArgumentOutOfRangeError",this.stack=t.stack,this.message=t.message}return $s(t,e),t}(Error)},ea=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ta=function(e,t){return function(n){return n.lift(new na(e,t))}},na=function(){function e(e,t){if(this.index=e,this.defaultValue=t,e<0)throw new Zs.ArgumentOutOfRangeError}return e.prototype.call=function(e,t){return t.subscribe(new ra(e,this.index,this.defaultValue))},e}(),ra=function(e){function t(t,n,r){e.call(this,t),this.index=n,this.defaultValue=r}return ea(t,e),t.prototype._next=function(e){0==this.index--&&(this.destination.next(e),this.destination.complete())},t.prototype._complete=function(){var e=this.destination;this.index>=0&&(void 0!==this.defaultValue?e.next(this.defaultValue):e.error(new Zs.ArgumentOutOfRangeError)),e.complete()},t}(me.Subscriber),ia={elementAt:ta};var oa={elementAt:function(e,t){return ia.elementAt(e,t)(this)}};Se.Observable.prototype.elementAt=oa.elementAt;var sa=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var aa=function(e,t){return function(n){return n.lift(new ca(e,t))}},ca=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new ua(e,this.predicate,this.thisArg))},e}(),ua=function(e){function t(t,n,r){e.call(this,t),this.predicate=n,this.thisArg=r,this.count=0}return sa(t,e),t.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},t}(me.Subscriber),la={filter:aa};var pa={filter:function(e,t){return la.filter(e,t)(this)}};Se.Observable.prototype.filter=pa.filter;var fa=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ha=function(e){return function(t){return t.lift(new da(e))}},da=function(){function e(e){this.callback=e}return e.prototype.call=function(e,t){return t.subscribe(new ba(e,this.callback))},e}(),ba=function(e){function t(t,n){e.call(this,t),this.add(new ue.Subscription(n))}return fa(t,e),t}(me.Subscriber),va={finalize:ha};var ma={_finally:function(e){return va.finalize(e)(this)}};Se.Observable.prototype.finally=ma._finally,Se.Observable.prototype._finally=ma._finally;var ya=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ga=function(e,t){if("function"!=typeof e)throw new TypeError("predicate is not a function");return function(n){return n.lift(new _a(e,n,!1,t))}},_a=function(){function e(e,t,n,r){this.predicate=e,this.source=t,this.yieldIndex=n,this.thisArg=r}return e.prototype.call=function(e,t){return t.subscribe(new Oa(e,this.predicate,this.source,this.yieldIndex,this.thisArg))},e}(),wa=_a,Oa=function(e){function t(t,n,r,i,o){e.call(this,t),this.predicate=n,this.source=r,this.yieldIndex=i,this.thisArg=o,this.index=0}return ya(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype._next=function(e){var t=this.predicate,n=this.thisArg,r=this.index++;try{t.call(n||this,e,r,this.source)&&this.notifyComplete(this.yieldIndex?r:e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){this.notifyComplete(this.yieldIndex?-1:void 0)},t}(me.Subscriber),Ea={find:ga,FindValueOperator:wa,FindValueSubscriber:Oa};var Sa={find:function(e,t){return Ea.find(e,t)(this)}};Se.Observable.prototype.find=Sa.find;var Ta={findIndex:function(e,t){return function(n){return n.lift(new Ea.FindValueOperator(e,n,!0,t))}}};var xa={findIndex:function(e,t){return Ta.findIndex(e,t)(this)}};Se.Observable.prototype.findIndex=xa.findIndex;var Aa=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ka={EmptyError:function(e){function t(){var t=e.call(this,"no elements in sequence");this.name=t.name="EmptyError",this.stack=t.stack,this.message=t.message}return Aa(t,e),t}(Error)},Ia=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Na=function(e,t,n){return function(r){return r.lift(new Ra(e,t,n,r))}},Ra=function(){function e(e,t,n,r){this.predicate=e,this.resultSelector=t,this.defaultValue=n,this.source=r}return e.prototype.call=function(e,t){return t.subscribe(new Ca(e,this.predicate,this.resultSelector,this.defaultValue,this.source))},e}(),Ca=function(e){function t(t,n,r,i,o){e.call(this,t),this.predicate=n,this.resultSelector=r,this.defaultValue=i,this.source=o,this.index=0,this.hasCompleted=!1,this._emitted=!1}return Ia(t,e),t.prototype._next=function(e){var t=this.index++;this.predicate?this._tryPredicate(e,t):this._emit(e,t)},t.prototype._tryPredicate=function(e,t){var n;try{n=this.predicate(e,t,this.source)}catch(e){return void this.destination.error(e)}n&&this._emit(e,t)},t.prototype._emit=function(e,t){this.resultSelector?this._tryResultSelector(e,t):this._emitFinal(e)},t.prototype._tryResultSelector=function(e,t){var n;try{n=this.resultSelector(e,t)}catch(e){return void this.destination.error(e)}this._emitFinal(n)},t.prototype._emitFinal=function(e){var t=this.destination;this._emitted||(this._emitted=!0,t.next(e),t.complete(),this.hasCompleted=!0)},t.prototype._complete=function(){var e=this.destination;this.hasCompleted||void 0===this.defaultValue?this.hasCompleted||e.error(new ka.EmptyError):(e.next(this.defaultValue),e.complete())},t}(me.Subscriber),Pa={first:Na};var Ma={first:function(e,t,n){return Pa.first(e,t,n)(this)}};Se.Observable.prototype.first=Ma.first;var ja={MapPolyfill:function(){function e(){this.size=0,this._values=[],this._keys=[]}return e.prototype.get=function(e){var t=this._keys.indexOf(e);return-1===t?void 0:this._values[t]},e.prototype.set=function(e,t){var n=this._keys.indexOf(e);return-1===n?(this._keys.push(e),this._values.push(t),this.size++):this._values[n]=t,this},e.prototype.delete=function(e){var t=this._keys.indexOf(e);return-1!==t&&(this._values.splice(t,1),this._keys.splice(t,1),this.size--,!0)},e.prototype.clear=function(){this._keys.length=0,this._values.length=0,this.size=0},e.prototype.forEach=function(e,t){for(var n=0;n<this.size;n++)e.call(t,this._values[n],this._keys[n])},e}()},qa={Map:X.root.Map||ja.MapPolyfill},La={FastMap:function(){function e(){this.values={}}return e.prototype.delete=function(e){return this.values[e]=null,!0},e.prototype.set=function(e,t){return this.values[e]=t,this},e.prototype.get=function(e){return this.values[e]},e.prototype.forEach=function(e,t){var n=this.values;for(var r in n)n.hasOwnProperty(r)&&null!==n[r]&&e.call(t,n[r],r)},e.prototype.clear=function(){this.values={}},e}()},Ua=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Va=function(e,t,n,r){return function(i){return i.lift(new Da(e,t,n,r))}},Da=function(){function e(e,t,n,r){this.keySelector=e,this.elementSelector=t,this.durationSelector=n,this.subjectSelector=r}return e.prototype.call=function(e,t){return t.subscribe(new Fa(e,this.keySelector,this.elementSelector,this.durationSelector,this.subjectSelector))},e}(),Fa=function(e){function t(t,n,r,i,o){e.call(this,t),this.keySelector=n,this.elementSelector=r,this.durationSelector=i,this.subjectSelector=o,this.groups=null,this.attemptedToUnsubscribe=!1,this.count=0}return Ua(t,e),t.prototype._next=function(e){var t;try{t=this.keySelector(e)}catch(e){return void this.error(e)}this._group(e,t)},t.prototype._group=function(e,t){var n=this.groups;n||(n=this.groups="string"==typeof t?new La.FastMap:new qa.Map);var r,i=n.get(t);if(this.elementSelector)try{r=this.elementSelector(e)}catch(e){this.error(e)}else r=e;if(!i){i=this.subjectSelector?this.subjectSelector():new je.Subject,n.set(t,i);var o=new Wa(t,i,this);if(this.destination.next(o),this.durationSelector){var s=void 0;try{s=this.durationSelector(new Wa(t,i))}catch(e){return void this.error(e)}this.add(s.subscribe(new Ba(t,i,this)))}}i.closed||i.next(r)},t.prototype._error=function(e){var t=this.groups;t&&(t.forEach((function(t,n){t.error(e)})),t.clear()),this.destination.error(e)},t.prototype._complete=function(){var e=this.groups;e&&(e.forEach((function(e,t){e.complete()})),e.clear()),this.destination.complete()},t.prototype.removeGroup=function(e){this.groups.delete(e)},t.prototype.unsubscribe=function(){this.closed||(this.attemptedToUnsubscribe=!0,0===this.count&&e.prototype.unsubscribe.call(this))},t}(me.Subscriber),Ba=function(e){function t(t,n,r){e.call(this,n),this.key=t,this.group=n,this.parent=r}return Ua(t,e),t.prototype._next=function(e){this.complete()},t.prototype._unsubscribe=function(){var e=this.parent,t=this.key;this.key=this.parent=null,e&&e.removeGroup(t)},t}(me.Subscriber),Wa=function(e){function t(t,n,r){e.call(this),this.key=t,this.groupSubject=n,this.refCountSubscription=r}return Ua(t,e),t.prototype._subscribe=function(e){var t=new ue.Subscription,n=this.refCountSubscription,r=this.groupSubject;return n&&!n.closed&&t.add(new Ga(n)),t.add(r.subscribe(e)),t},t}(Se.Observable),Ha=Wa,Ga=function(e){function t(t){e.call(this),this.parent=t,t.count++}return Ua(t,e),t.prototype.unsubscribe=function(){var t=this.parent;t.closed||this.closed||(e.prototype.unsubscribe.call(this),t.count-=1,0===t.count&&t.attemptedToUnsubscribe&&t.unsubscribe())},t}(ue.Subscription),za={groupBy:Va,GroupedObservable:Ha};var Ja={GroupedObservable:za.GroupedObservable,groupBy:function(e,t,n,r){return za.groupBy(e,t,n,r)(this)}};Se.Observable.prototype.groupBy=Ja.groupBy;var Qa=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Ya=function(){return function(e){return e.lift(new Ka)}},Ka=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Xa(e))},e}(),Xa=function(e){function t(){e.apply(this,arguments)}return Qa(t,e),t.prototype._next=function(e){_e.noop()},t}(me.Subscriber),$a={ignoreElements:Ya};var Za={ignoreElements:function(){return $a.ignoreElements()(this)}};Se.Observable.prototype.ignoreElements=Za.ignoreElements;var ec=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var tc=function(){return function(e){return e.lift(new nc)}},nc=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new rc(e))},e}(),rc=function(e){function t(t){e.call(this,t)}return ec(t,e),t.prototype.notifyComplete=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype._next=function(e){this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(me.Subscriber),ic={isEmpty:tc};var oc={isEmpty:function(){return ic.isEmpty()(this)}};Se.Observable.prototype.isEmpty=oc.isEmpty;var sc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ac=function(e){return function(t){return t.lift(new cc(e))}},cc=function(){function e(e){this.durationSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new uc(e,this.durationSelector))},e}(),uc=function(e){function t(t,n){e.call(this,t),this.durationSelector=n,this.hasValue=!1}return sc(t,e),t.prototype._next=function(e){if(this.value=e,this.hasValue=!0,!this.throttled){var t=ie.tryCatch(this.durationSelector)(e);if(t===ne.errorObject)this.destination.error(ne.errorObject.e);else{var n=at.subscribeToResult(this,t);n.closed?this.clearThrottle():this.add(this.throttled=n)}}},t.prototype.clearThrottle=function(){var e=this,t=e.value,n=e.hasValue,r=e.throttled;r&&(this.remove(r),this.throttled=null,r.unsubscribe()),n&&(this.value=null,this.hasValue=!1,this.destination.next(t))},t.prototype.notifyNext=function(e,t,n,r){this.clearThrottle()},t.prototype.notifyComplete=function(){this.clearThrottle()},t}(tt.OuterSubscriber),lc={audit:ac};var pc={audit:function(e){return lc.audit(e)(this)}};Se.Observable.prototype.audit=pc.audit;var fc={auditTime:function(e,t){return void 0===t&&(t=Pn.async),lc.audit((function(){return br.timer(e,t)}))}};var hc={auditTime:function(e,t){return void 0===t&&(t=Pn.async),fc.auditTime(e,t)(this)}};Se.Observable.prototype.auditTime=hc.auditTime;var dc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var bc=function(e,t,n){return function(r){return r.lift(new vc(e,t,n,r))}},vc=function(){function e(e,t,n,r){this.predicate=e,this.resultSelector=t,this.defaultValue=n,this.source=r}return e.prototype.call=function(e,t){return t.subscribe(new mc(e,this.predicate,this.resultSelector,this.defaultValue,this.source))},e}(),mc=function(e){function t(t,n,r,i,o){e.call(this,t),this.predicate=n,this.resultSelector=r,this.defaultValue=i,this.source=o,this.hasValue=!1,this.index=0,void 0!==i&&(this.lastValue=i,this.hasValue=!0)}return dc(t,e),t.prototype._next=function(e){var t=this.index++;if(this.predicate)this._tryPredicate(e,t);else{if(this.resultSelector)return void this._tryResultSelector(e,t);this.lastValue=e,this.hasValue=!0}},t.prototype._tryPredicate=function(e,t){var n;try{n=this.predicate(e,t,this.source)}catch(e){return void this.destination.error(e)}if(n){if(this.resultSelector)return void this._tryResultSelector(e,t);this.lastValue=e,this.hasValue=!0}},t.prototype._tryResultSelector=function(e,t){var n;try{n=this.resultSelector(e,t)}catch(e){return void this.destination.error(e)}this.lastValue=n,this.hasValue=!0},t.prototype._complete=function(){var e=this.destination;this.hasValue?(e.next(this.lastValue),e.complete()):e.error(new ka.EmptyError)},t}(me.Subscriber),yc={last:bc};var gc={last:function(e,t,n){return yc.last(e,t,n)(this)}};Se.Observable.prototype.last=gc.last;var _c={letProto:function(e){return e(this)}};Se.Observable.prototype.let=_c.letProto,Se.Observable.prototype.letBind=_c.letProto;var wc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Oc=function(e,t){return function(n){return n.lift(new Ec(e,t,n))}},Ec=function(){function e(e,t,n){this.predicate=e,this.thisArg=t,this.source=n}return e.prototype.call=function(e,t){return t.subscribe(new Sc(e,this.predicate,this.thisArg,this.source))},e}(),Sc=function(e){function t(t,n,r,i){e.call(this,t),this.predicate=n,this.thisArg=r,this.source=i,this.index=0,this.thisArg=r||this}return wc(t,e),t.prototype.notifyComplete=function(e){this.destination.next(e),this.destination.complete()},t.prototype._next=function(e){var t=!1;try{t=this.predicate.call(this.thisArg,e,this.index++,this.source)}catch(e){return void this.destination.error(e)}t||this.notifyComplete(!1)},t.prototype._complete=function(){this.notifyComplete(!0)},t}(me.Subscriber),Tc={every:Oc};var xc={every:function(e,t){return Tc.every(e,t)(this)}};Se.Observable.prototype.every=xc.every;var Ac={map:function(e,t){return Mr.map(e,t)(this)}};Se.Observable.prototype.map=Ac.map;var kc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Ic=function(e){return function(t){return t.lift(new Nc(e))}},Nc=function(){function e(e){this.value=e}return e.prototype.call=function(e,t){return t.subscribe(new Rc(e,this.value))},e}(),Rc=function(e){function t(t,n){e.call(this,t),this.value=n}return kc(t,e),t.prototype._next=function(e){this.destination.next(this.value)},t}(me.Subscriber),Cc={mapTo:Ic};var Pc={mapTo:function(e){return Cc.mapTo(e)(this)}};Se.Observable.prototype.mapTo=Pc.mapTo;var Mc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var jc=function(){return function(e){return e.lift(new qc)}},qc=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Lc(e))},e}(),Lc=function(e){function t(t){e.call(this,t)}return Mc(t,e),t.prototype._next=function(e){this.destination.next(Ct.Notification.createNext(e))},t.prototype._error=function(e){var t=this.destination;t.next(Ct.Notification.createError(e)),t.complete()},t.prototype._complete=function(){var e=this.destination;e.next(Ct.Notification.createComplete()),e.complete()},t}(me.Subscriber),Uc={materialize:jc};var Vc={materialize:function(){return Uc.materialize()(this)}};Se.Observable.prototype.materialize=Vc.materialize;var Dc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Fc=function(e,t){var n=!1;return arguments.length>=2&&(n=!0),function(r){return r.lift(new Bc(e,t,n))}},Bc=function(){function e(e,t,n){void 0===n&&(n=!1),this.accumulator=e,this.seed=t,this.hasSeed=n}return e.prototype.call=function(e,t){return t.subscribe(new Wc(e,this.accumulator,this.seed,this.hasSeed))},e}(),Wc=function(e){function t(t,n,r,i){e.call(this,t),this.accumulator=n,this._seed=r,this.hasSeed=i,this.index=0}return Dc(t,e),Object.defineProperty(t.prototype,"seed",{get:function(){return this._seed},set:function(e){this.hasSeed=!0,this._seed=e},enumerable:!0,configurable:!0}),t.prototype._next=function(e){if(this.hasSeed)return this._tryNext(e);this.seed=e,this.destination.next(e)},t.prototype._tryNext=function(e){var t,n=this.index++;try{t=this.accumulator(this.seed,e,n)}catch(e){this.destination.error(e)}this.seed=t,this.destination.next(t)},t}(me.Subscriber),Hc={scan:Fc},Gc=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var zc=function(e){return function(t){return 0===e?new Xe.EmptyObservable:t.lift(new Jc(e))}},Jc=function(){function e(e){if(this.total=e,this.total<0)throw new Zs.ArgumentOutOfRangeError}return e.prototype.call=function(e,t){return t.subscribe(new Qc(e,this.total))},e}(),Qc=function(e){function t(t,n){e.call(this,t),this.total=n,this.ring=new Array,this.count=0}return Gc(t,e),t.prototype._next=function(e){var t=this.ring,n=this.total,r=this.count++;t.length<n?t.push(e):t[r%n]=e},t.prototype._complete=function(){var e=this.destination,t=this.count;if(t>0)for(var n=this.count>=this.total?this.total:this.count,r=this.ring,i=0;i<n;i++){var o=t++%n;e.next(r[o])}e.complete()},t}(me.Subscriber),Yc={takeLast:zc};var Kc={reduce:function(e,t){return arguments.length>=2?function(n){return Oe.pipe(Hc.scan(e,t),Yc.takeLast(1),Qo.defaultIfEmpty(t))(n)}:function(t){return Oe.pipe(Hc.scan((function(t,n,r){return e(t,n,r+1)})),Yc.takeLast(1))(t)}}};var Xc={max:function(e){var t="function"==typeof e?function(t,n){return e(t,n)>0?t:n}:function(e,t){return e>t?e:t};return Kc.reduce(t)}};var $c={max:function(e){return Xc.max(e)(this)}};Se.Observable.prototype.max=$c.max;var Zc={mergeStatic:Un.merge,merge:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){return t.lift.call(Un.merge.apply(void 0,[t].concat(e)))}}};var eu={mergeStatic:Un.merge,merge:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return Zc.merge.apply(void 0,e)(this)}};Se.Observable.prototype.merge=eu.merge;var tu={mergeAll:function(e){return void 0===e&&(e=Number.POSITIVE_INFINITY),Xt.mergeAll(e)(this)}};Se.Observable.prototype.mergeAll=tu.mergeAll;var nu={mergeMap:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),Yt.mergeMap(e,t,n)(this)}};Se.Observable.prototype.mergeMap=nu.mergeMap,Se.Observable.prototype.flatMap=nu.mergeMap;var ru=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var iu=function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),"number"==typeof t&&(n=t,t=null),function(r){return r.lift(new ou(e,t,n))}},ou=function(){function e(e,t,n){void 0===n&&(n=Number.POSITIVE_INFINITY),this.ish=e,this.resultSelector=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new au(e,this.ish,this.resultSelector,this.concurrent))},e}(),su=ou,au=function(e){function t(t,n,r,i){void 0===i&&(i=Number.POSITIVE_INFINITY),e.call(this,t),this.ish=n,this.resultSelector=r,this.concurrent=i,this.hasCompleted=!1,this.buffer=[],this.active=0,this.index=0}return ru(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=this.resultSelector,n=this.index++,r=this.ish,i=this.destination;this.active++,this._innerSub(r,i,t,e,n)}else this.buffer.push(e)},t.prototype._innerSub=function(e,t,n,r,i){this.add(at.subscribeToResult(this,e,r,i))},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete()},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.resultSelector,s=this.destination;o?this.trySelectResult(e,t,n,r):s.next(t)},t.prototype.trySelectResult=function(e,t,n,r){var i,o=this.resultSelector,s=this.destination;try{i=o(e,t,n,r)}catch(e){return void s.error(e)}s.next(i)},t.prototype.notifyError=function(e){this.destination.error(e)},t.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},t}(tt.OuterSubscriber),cu={mergeMapTo:iu,MergeMapToOperator:su,MergeMapToSubscriber:au};var uu={mergeMapTo:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),cu.mergeMapTo(e,t,n)(this)}};Se.Observable.prototype.flatMapTo=uu.mergeMapTo,Se.Observable.prototype.mergeMapTo=uu.mergeMapTo;var lu=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var pu=function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),function(r){return r.lift(new fu(e,t,n))}},fu=function(){function e(e,t,n){this.accumulator=e,this.seed=t,this.concurrent=n}return e.prototype.call=function(e,t){return t.subscribe(new du(e,this.accumulator,this.seed,this.concurrent))},e}(),hu=fu,du=function(e){function t(t,n,r,i){e.call(this,t),this.accumulator=n,this.acc=r,this.concurrent=i,this.hasValue=!1,this.hasCompleted=!1,this.buffer=[],this.active=0,this.index=0}return lu(t,e),t.prototype._next=function(e){if(this.active<this.concurrent){var t=this.index++,n=ie.tryCatch(this.accumulator)(this.acc,e),r=this.destination;n===ne.errorObject?r.error(ne.errorObject.e):(this.active++,this._innerSub(n,e,t))}else this.buffer.push(e)},t.prototype._innerSub=function(e,t,n){this.add(at.subscribeToResult(this,e,t,n))},t.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.destination;this.acc=t,this.hasValue=!0,o.next(t)},t.prototype.notifyComplete=function(e){var t=this.buffer;this.remove(e),this.active--,t.length>0?this._next(t.shift()):0===this.active&&this.hasCompleted&&(!1===this.hasValue&&this.destination.next(this.acc),this.destination.complete())},t}(tt.OuterSubscriber),bu={mergeScan:pu,MergeScanOperator:hu,MergeScanSubscriber:du};var vu={mergeScan:function(e,t,n){return void 0===n&&(n=Number.POSITIVE_INFINITY),bu.mergeScan(e,t,n)(this)}};Se.Observable.prototype.mergeScan=vu.mergeScan;var mu={min:function(e){var t="function"==typeof e?function(t,n){return e(t,n)<0?t:n}:function(e,t){return e<t?e:t};return Kc.reduce(t)}};var yu={min:function(e){return mu.min(e)(this)}};Se.Observable.prototype.min=yu.min;var gu=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var _u=function(){return function(e){return e.lift(new wu(e))}},wu=function(){function e(e){this.connectable=e}return e.prototype.call=function(e,t){var n=this.connectable;n._refCount++;var r=new Ou(e,n),i=t.subscribe(r);return r.closed||(r.connection=n.connect()),i},e}(),Ou=function(e){function t(t,n){e.call(this,t),this.connectable=n}return gu(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var n=this.connection,r=e._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null},t}(me.Subscriber),Eu={refCount:_u},Su=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Tu=function(e){function t(t,n){e.call(this),this.source=t,this.subjectFactory=n,this._refCount=0,this._isComplete=!1}return Su(t,e),t.prototype._subscribe=function(e){return this.getSubject().subscribe(e)},t.prototype.getSubject=function(){var e=this._subject;return e&&!e.isStopped||(this._subject=this.subjectFactory()),this._subject},t.prototype.connect=function(){var e=this._connection;return e||(this._isComplete=!1,(e=this._connection=new ue.Subscription).add(this.source.subscribe(new Iu(this.getSubject(),this))),e.closed?(this._connection=null,e=ue.Subscription.EMPTY):this._connection=e),e},t.prototype.refCount=function(){return Eu.refCount()(this)},t}(Se.Observable),xu=Tu,Au=Tu.prototype,ku={operator:{value:null},_refCount:{value:0,writable:!0},_subject:{value:null,writable:!0},_connection:{value:null,writable:!0},_subscribe:{value:Au._subscribe},_isComplete:{value:Au._isComplete,writable:!0},getSubject:{value:Au.getSubject},connect:{value:Au.connect},refCount:{value:Au.refCount}},Iu=function(e){function t(t,n){e.call(this,t),this.connectable=n}return Su(t,e),t.prototype._error=function(t){this._unsubscribe(),e.prototype._error.call(this,t)},t.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._connection;e._refCount=0,e._subject=null,e._connection=null,t&&t.unsubscribe()}},t}(je.SubjectSubscriber),Nu=(function(e){function t(t,n){e.call(this,t),this.connectable=n}Su(t,e),t.prototype._unsubscribe=function(){var e=this.connectable;if(e){this.connectable=null;var t=e._refCount;if(t<=0)this.connection=null;else if(e._refCount=t-1,t>1)this.connection=null;else{var n=this.connection,r=e._connection;this.connection=null,!r||n&&r!==n||r.unsubscribe()}}else this.connection=null}}(me.Subscriber),{ConnectableObservable:xu,connectableObservableDescriptor:ku});var Ru=function(e,t){return function(n){var r;if(r="function"==typeof e?e:function(){return e},"function"==typeof t)return n.lift(new Cu(r,t));var i=Object.create(n,Nu.connectableObservableDescriptor);return i.source=n,i.subjectFactory=r,i}},Cu=function(){function e(e,t){this.subjectFactory=e,this.selector=t}return e.prototype.call=function(e,t){var n=this.selector,r=this.subjectFactory(),i=n(r).subscribe(e);return i.add(t.subscribe(r)),i},e}(),Pu={multicast:Ru,MulticastOperator:Cu};var Mu={multicast:function(e,t){return Pu.multicast(e,t)(this)}};Se.Observable.prototype.multicast=Mu.multicast;var ju={observeOn:function(e,t){return void 0===t&&(t=0),Vt.observeOn(e,t)(this)}};Se.Observable.prototype.observeOn=ju.observeOn;var qu={onErrorResumeNext:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return $n.onErrorResumeNext.apply(void 0,e)(this)}};Se.Observable.prototype.onErrorResumeNext=qu.onErrorResumeNext;var Lu=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Uu=function(){return function(e){return e.lift(new Vu)}},Vu=function(){function e(){}return e.prototype.call=function(e,t){return t.subscribe(new Du(e))},e}(),Du=function(e){function t(t){e.call(this,t),this.hasPrev=!1}return Lu(t,e),t.prototype._next=function(e){this.hasPrev?this.destination.next([this.prev,e]):this.hasPrev=!0,this.prev=e},t}(me.Subscriber),Fu={pairwise:Uu};var Bu={pairwise:function(){return Fu.pairwise()(this)}};Se.Observable.prototype.pairwise=Bu.pairwise;var Wu={not:function(e,t){function n(){return!n.pred.apply(n.thisArg,arguments)}return n.pred=e,n.thisArg=t,n}};var Hu={partition:function(e,t){return function(n){return[la.filter(e,t)(n),la.filter(Wu.not(e,t))(n)]}}};var Gu={partition:function(e,t){return Hu.partition(e,t)(this)}};function zu(e,t){return function(n){for(var r=n,i=0;i<t;i++){var o=r[e[i]];if(void 0===o)return;r=o}return r}}Se.Observable.prototype.partition=Gu.partition;var Ju={pluck:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=e.length;if(0===n)throw new Error("list of properties cannot be empty.");return function(t){return Mr.map(zu(e,n))(t)}}};var Qu={pluck:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return Ju.pluck.apply(void 0,e)(this)}};Se.Observable.prototype.pluck=Qu.pluck;var Yu={publish:function(e){return e?Pu.multicast((function(){return new je.Subject}),e):Pu.multicast(new je.Subject)}};var Ku={publish:function(e){return Yu.publish(e)(this)}};Se.Observable.prototype.publish=Ku.publish;var Xu=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},$u={BehaviorSubject:function(e){function t(t){e.call(this),this._value=t}return Xu(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),t.prototype._subscribe=function(t){var n=e.prototype._subscribe.call(this,t);return n&&!n.closed&&t.next(this._value),n},t.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new xe.ObjectUnsubscribedError;return this._value},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(je.Subject)};var Zu={publishBehavior:function(e){return function(t){return Pu.multicast(new $u.BehaviorSubject(e))(t)}}};var el={publishBehavior:function(e){return Zu.publishBehavior(e)(this)}};Se.Observable.prototype.publishBehavior=el.publishBehavior;var tl={publishReplay:function(e,t,n,r){n&&"function"!=typeof n&&(r=n);var i="function"==typeof n?n:void 0,o=new bi.ReplaySubject(e,t,r);return function(e){return Pu.multicast((function(){return o}),i)(e)}}};var nl={publishReplay:function(e,t,n,r){return tl.publishReplay(e,t,n,r)(this)}};Se.Observable.prototype.publishReplay=nl.publishReplay;var rl={publishLast:function(){return function(e){return Pu.multicast(new Le.AsyncSubject)(e)}}};var il={publishLast:function(){return rl.publishLast()(this)}};Se.Observable.prototype.publishLast=il.publishLast;var ol={race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){return 1===e.length&&Z.isArray(e[0])&&(e=e[0]),t.lift.call(Hn.race.apply(void 0,[t].concat(e)))}}};var sl={raceStatic:Hn.race,race:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return ol.race.apply(void 0,e)(this)}};Se.Observable.prototype.race=sl.race;var al={reduce:function(e,t){return arguments.length>=2?Kc.reduce(e,t)(this):Kc.reduce(e)(this)}};Se.Observable.prototype.reduce=al.reduce;var cl=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ul=function(e){return void 0===e&&(e=-1),function(t){return 0===e?new Xe.EmptyObservable:e<0?t.lift(new ll(-1,t)):t.lift(new ll(e-1,t))}},ll=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new pl(e,this.count,this.source))},e}(),pl=function(e){function t(t,n,r){e.call(this,t),this.count=n,this.source=r}return cl(t,e),t.prototype.complete=function(){if(!this.isStopped){var t=this.source,n=this.count;if(0===n)return e.prototype.complete.call(this);n>-1&&(this.count=n-1),t.subscribe(this._unsubscribeAndRecycle())}},t}(me.Subscriber),fl={repeat:ul};var hl={repeat:function(e){return void 0===e&&(e=-1),fl.repeat(e)(this)}};Se.Observable.prototype.repeat=hl.repeat;var dl=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var bl=function(e){return function(t){return t.lift(new vl(e))}},vl=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new ml(e,this.notifier,t))},e}(),ml=function(e){function t(t,n,r){e.call(this,t),this.notifier=n,this.source=r,this.sourceIsBeingSubscribedTo=!0}return dl(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.sourceIsBeingSubscribedTo=!0,this.source.subscribe(this)},t.prototype.notifyComplete=function(t){if(!1===this.sourceIsBeingSubscribedTo)return e.prototype.complete.call(this)},t.prototype.complete=function(){if(this.sourceIsBeingSubscribedTo=!1,!this.isStopped){if(this.retries||this.subscribeToRetries(),!this.retriesSubscription||this.retriesSubscription.closed)return e.prototype.complete.call(this);this._unsubscribeAndRecycle(),this.notifications.next()}},t.prototype._unsubscribe=function(){var e=this.notifications,t=this.retriesSubscription;e&&(e.unsubscribe(),this.notifications=null),t&&(t.unsubscribe(),this.retriesSubscription=null),this.retries=null},t.prototype._unsubscribeAndRecycle=function(){var t=this,n=t.notifications,r=t.retries,i=t.retriesSubscription;return this.notifications=null,this.retries=null,this.retriesSubscription=null,e.prototype._unsubscribeAndRecycle.call(this),this.notifications=n,this.retries=r,this.retriesSubscription=i,this},t.prototype.subscribeToRetries=function(){this.notifications=new je.Subject;var t=ie.tryCatch(this.notifier)(this.notifications);if(t===ne.errorObject)return e.prototype.complete.call(this);this.retries=t,this.retriesSubscription=at.subscribeToResult(this,t)},t}(tt.OuterSubscriber),yl={repeatWhen:bl};var gl={repeatWhen:function(e){return yl.repeatWhen(e)(this)}};Se.Observable.prototype.repeatWhen=gl.repeatWhen;var _l=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var wl=function(e){return void 0===e&&(e=-1),function(t){return t.lift(new Ol(e,t))}},Ol=function(){function e(e,t){this.count=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new El(e,this.count,this.source))},e}(),El=function(e){function t(t,n,r){e.call(this,t),this.count=n,this.source=r}return _l(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.source,r=this.count;if(0===r)return e.prototype.error.call(this,t);r>-1&&(this.count=r-1),n.subscribe(this._unsubscribeAndRecycle())}},t}(me.Subscriber),Sl={retry:wl};var Tl={retry:function(e){return void 0===e&&(e=-1),Sl.retry(e)(this)}};Se.Observable.prototype.retry=Tl.retry;var xl=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Al=function(e){return function(t){return t.lift(new kl(e,t))}},kl=function(){function e(e,t){this.notifier=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new Il(e,this.notifier,this.source))},e}(),Il=function(e){function t(t,n,r){e.call(this,t),this.notifier=n,this.source=r}return xl(t,e),t.prototype.error=function(t){if(!this.isStopped){var n=this.errors,r=this.retries,i=this.retriesSubscription;if(r)this.errors=null,this.retriesSubscription=null;else{if(n=new je.Subject,(r=ie.tryCatch(this.notifier)(n))===ne.errorObject)return e.prototype.error.call(this,ne.errorObject.e);i=at.subscribeToResult(this,r)}this._unsubscribeAndRecycle(),this.errors=n,this.retries=r,this.retriesSubscription=i,n.next(t)}},t.prototype._unsubscribe=function(){var e=this.errors,t=this.retriesSubscription;e&&(e.unsubscribe(),this.errors=null),t&&(t.unsubscribe(),this.retriesSubscription=null),this.retries=null},t.prototype.notifyNext=function(e,t,n,r,i){var o=this,s=o.errors,a=o.retries,c=o.retriesSubscription;this.errors=null,this.retries=null,this.retriesSubscription=null,this._unsubscribeAndRecycle(),this.errors=s,this.retries=a,this.retriesSubscription=c,this.source.subscribe(this)},t}(tt.OuterSubscriber),Nl={retryWhen:Al};var Rl={retryWhen:function(e){return Nl.retryWhen(e)(this)}};Se.Observable.prototype.retryWhen=Rl.retryWhen;var Cl=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Pl=function(e){return function(t){return t.lift(new Ml(e))}},Ml=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){var n=new jl(e),r=t.subscribe(n);return r.add(at.subscribeToResult(n,this.notifier)),r},e}(),jl=function(e){function t(){e.apply(this,arguments),this.hasValue=!1}return Cl(t,e),t.prototype._next=function(e){this.value=e,this.hasValue=!0},t.prototype.notifyNext=function(e,t,n,r,i){this.emitValue()},t.prototype.notifyComplete=function(){this.emitValue()},t.prototype.emitValue=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.value))},t}(tt.OuterSubscriber),ql={sample:Pl};var Ll={sample:function(e){return ql.sample(e)(this)}};Se.Observable.prototype.sample=Ll.sample;var Ul=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Vl=function(e,t){return void 0===t&&(t=Pn.async),function(n){return n.lift(new Dl(e,t))}},Dl=function(){function e(e,t){this.period=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new Fl(e,this.period,this.scheduler))},e}(),Fl=function(e){function t(t,n,r){e.call(this,t),this.period=n,this.scheduler=r,this.hasValue=!1,this.add(r.schedule(Bl,n,{subscriber:this,period:n}))}return Ul(t,e),t.prototype._next=function(e){this.lastValue=e,this.hasValue=!0},t.prototype.notifyNext=function(){this.hasValue&&(this.hasValue=!1,this.destination.next(this.lastValue))},t}(me.Subscriber);function Bl(e){var t=e.subscriber,n=e.period;t.notifyNext(),this.schedule(e,n)}var Wl={sampleTime:Vl};var Hl={sampleTime:function(e,t){return void 0===t&&(t=Pn.async),Wl.sampleTime(e,t)(this)}};Se.Observable.prototype.sampleTime=Hl.sampleTime;var Gl={scan:function(e,t){return arguments.length>=2?Hc.scan(e,t)(this):Hc.scan(e)(this)}};Se.Observable.prototype.scan=Gl.scan;var zl=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Jl=function(e,t){return function(n){return n.lift(new Ql(e,t))}},Ql=function(){function e(e,t){this.compareTo=e,this.comparor=t}return e.prototype.call=function(e,t){return t.subscribe(new Kl(e,this.compareTo,this.comparor))},e}(),Yl=Ql,Kl=function(e){function t(t,n,r){e.call(this,t),this.compareTo=n,this.comparor=r,this._a=[],this._b=[],this._oneComplete=!1,this.add(n.subscribe(new $l(t,this)))}return zl(t,e),t.prototype._next=function(e){this._oneComplete&&0===this._b.length?this.emit(!1):(this._a.push(e),this.checkValues())},t.prototype._complete=function(){this._oneComplete?this.emit(0===this._a.length&&0===this._b.length):this._oneComplete=!0},t.prototype.checkValues=function(){for(var e=this,t=e._a,n=e._b,r=e.comparor;t.length>0&&n.length>0;){var i=t.shift(),o=n.shift(),s=!1;r?(s=ie.tryCatch(r)(i,o))===ne.errorObject&&this.destination.error(ne.errorObject.e):s=i===o,s||this.emit(!1)}},t.prototype.emit=function(e){var t=this.destination;t.next(e),t.complete()},t.prototype.nextB=function(e){this._oneComplete&&0===this._a.length?this.emit(!1):(this._b.push(e),this.checkValues())},t}(me.Subscriber),Xl=Kl,$l=function(e){function t(t,n){e.call(this,t),this.parent=n}return zl(t,e),t.prototype._next=function(e){this.parent.nextB(e)},t.prototype._error=function(e){this.parent.error(e)},t.prototype._complete=function(){this.parent._complete()},t}(me.Subscriber),Zl={sequenceEqual:Jl,SequenceEqualOperator:Yl,SequenceEqualSubscriber:Xl};var ep={sequenceEqual:function(e,t){return Zl.sequenceEqual(e,t)(this)}};function tp(){return new je.Subject}Se.Observable.prototype.sequenceEqual=ep.sequenceEqual;var np={share:function(){return function(e){return Eu.refCount()(Pu.multicast(tp)(e))}}};var rp={share:function(){return np.share()(this)}};Se.Observable.prototype.share=rp.share;var ip={shareReplay:function(e,t,n){return function(r){return r.lift(function(e,t,n){var r,i,o=0,s=!1,a=!1;return function(c){o++,r&&!s||(s=!1,r=new bi.ReplaySubject(e,t,n),i=c.subscribe({next:function(e){r.next(e)},error:function(e){s=!0,r.error(e)},complete:function(){a=!0,r.complete()}}));var u=r.subscribe(this);return function(){o--,u.unsubscribe(),i&&0===o&&a&&i.unsubscribe()}}}(e,t,n))}}};var op={shareReplay:function(e,t,n){return ip.shareReplay(e,t,n)(this)}};Se.Observable.prototype.shareReplay=op.shareReplay;var sp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ap=function(e){return function(t){return t.lift(new cp(e,t))}},cp=function(){function e(e,t){this.predicate=e,this.source=t}return e.prototype.call=function(e,t){return t.subscribe(new up(e,this.predicate,this.source))},e}(),up=function(e){function t(t,n,r){e.call(this,t),this.predicate=n,this.source=r,this.seenValue=!1,this.index=0}return sp(t,e),t.prototype.applySingleValue=function(e){this.seenValue?this.destination.error("Sequence contains more than one element"):(this.seenValue=!0,this.singleValue=e)},t.prototype._next=function(e){var t=this.index++;this.predicate?this.tryNext(e,t):this.applySingleValue(e)},t.prototype.tryNext=function(e,t){try{this.predicate(e,t,this.source)&&this.applySingleValue(e)}catch(e){this.destination.error(e)}},t.prototype._complete=function(){var e=this.destination;this.index>0?(e.next(this.seenValue?this.singleValue:void 0),e.complete()):e.error(new ka.EmptyError)},t}(me.Subscriber),lp={single:ap};var pp={single:function(e){return lp.single(e)(this)}};Se.Observable.prototype.single=pp.single;var fp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var hp=function(e){return function(t){return t.lift(new dp(e))}},dp=function(){function e(e){this.total=e}return e.prototype.call=function(e,t){return t.subscribe(new bp(e,this.total))},e}(),bp=function(e){function t(t,n){e.call(this,t),this.total=n,this.count=0}return fp(t,e),t.prototype._next=function(e){++this.count>this.total&&this.destination.next(e)},t}(me.Subscriber),vp={skip:hp};var mp={skip:function(e){return vp.skip(e)(this)}};Se.Observable.prototype.skip=mp.skip;var yp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var gp=function(e){return function(t){return t.lift(new _p(e))}},_p=function(){function e(e){if(this._skipCount=e,this._skipCount<0)throw new Zs.ArgumentOutOfRangeError}return e.prototype.call=function(e,t){return 0===this._skipCount?t.subscribe(new me.Subscriber(e)):t.subscribe(new wp(e,this._skipCount))},e}(),wp=function(e){function t(t,n){e.call(this,t),this._skipCount=n,this._count=0,this._ring=new Array(n)}return yp(t,e),t.prototype._next=function(e){var t=this._skipCount,n=this._count++;if(n<t)this._ring[n]=e;else{var r=n%t,i=this._ring,o=i[r];i[r]=e,this.destination.next(o)}},t}(me.Subscriber),Op={skipLast:gp};var Ep={skipLast:function(e){return Op.skipLast(e)(this)}};Se.Observable.prototype.skipLast=Ep.skipLast;var Sp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Tp=function(e){return function(t){return t.lift(new xp(e))}},xp=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new Ap(e,this.notifier))},e}(),Ap=function(e){function t(t,n){e.call(this,t),this.hasValue=!1,this.isInnerStopped=!1,this.add(at.subscribeToResult(this,n))}return Sp(t,e),t.prototype._next=function(t){this.hasValue&&e.prototype._next.call(this,t)},t.prototype._complete=function(){this.isInnerStopped?e.prototype._complete.call(this):this.unsubscribe()},t.prototype.notifyNext=function(e,t,n,r,i){this.hasValue=!0},t.prototype.notifyComplete=function(){this.isInnerStopped=!0,this.isStopped&&e.prototype._complete.call(this)},t}(tt.OuterSubscriber),kp={skipUntil:Tp};var Ip={skipUntil:function(e){return kp.skipUntil(e)(this)}};Se.Observable.prototype.skipUntil=Ip.skipUntil;var Np=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Rp=function(e){return function(t){return t.lift(new Cp(e))}},Cp=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscribe(new Pp(e,this.predicate))},e}(),Pp=function(e){function t(t,n){e.call(this,t),this.predicate=n,this.skipping=!0,this.index=0}return Np(t,e),t.prototype._next=function(e){var t=this.destination;this.skipping&&this.tryCallPredicate(e),this.skipping||t.next(e)},t.prototype.tryCallPredicate=function(e){try{var t=this.predicate(e,this.index++);this.skipping=Boolean(t)}catch(e){this.destination.error(e)}},t}(me.Subscriber),Mp={skipWhile:Rp};var jp={skipWhile:function(e){return Mp.skipWhile(e)(this)}};Se.Observable.prototype.skipWhile=jp.skipWhile;var qp={startWith:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){var n=e[e.length-1];Je.isScheduler(n)?e.pop():n=null;var r=e.length;return 1===r?Zt.concat(new Ye.ScalarObservable(e[0],n),t):r>1?Zt.concat(new Ze.ArrayObservable(e,n),t):Zt.concat(new Xe.EmptyObservable(n),t)}}};var Lp={startWith:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return qp.startWith.apply(void 0,e)(this)}};Se.Observable.prototype.startWith=Lp.startWith;var Up=function(){function e(e){if(this.root=e,e.setImmediate&&"function"==typeof e.setImmediate)this.setImmediate=e.setImmediate.bind(e),this.clearImmediate=e.clearImmediate.bind(e);else{this.nextHandle=1,this.tasksByHandle={},this.currentlyRunningATask=!1,this.canUseProcessNextTick()?this.setImmediate=this.createProcessNextTickSetImmediate():this.canUsePostMessage()?this.setImmediate=this.createPostMessageSetImmediate():this.canUseMessageChannel()?this.setImmediate=this.createMessageChannelSetImmediate():this.canUseReadyStateChange()?this.setImmediate=this.createReadyStateChangeSetImmediate():this.setImmediate=this.createSetTimeoutSetImmediate();var t=function e(t){delete e.instance.tasksByHandle[t]};t.instance=this,this.clearImmediate=t}}return e.prototype.identify=function(e){return this.root.Object.prototype.toString.call(e)},e.prototype.canUseProcessNextTick=function(){return"[object process]"===this.identify(this.root.process)},e.prototype.canUseMessageChannel=function(){return Boolean(this.root.MessageChannel)},e.prototype.canUseReadyStateChange=function(){var e=this.root.document;return Boolean(e&&"onreadystatechange"in e.createElement("script"))},e.prototype.canUsePostMessage=function(){var e=this.root;if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}return!1},e.prototype.partiallyApplied=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=function e(){var t=e.handler,n=e.args;"function"==typeof t?t.apply(void 0,n):new Function(""+t)()};return r.handler=e,r.args=t,r},e.prototype.addFromSetImmediateArguments=function(e){return this.tasksByHandle[this.nextHandle]=this.partiallyApplied.apply(void 0,e),this.nextHandle++},e.prototype.createProcessNextTickSetImmediate=function(){var e=function e(){var t=e.instance,n=t.addFromSetImmediateArguments(arguments);return t.root.process.nextTick(t.partiallyApplied(t.runIfPresent,n)),n};return e.instance=this,e},e.prototype.createPostMessageSetImmediate=function(){var e=this.root,t="setImmediate$"+e.Math.random()+"$",n=function n(r){var i=n.instance;r.source===e&&"string"==typeof r.data&&0===r.data.indexOf(t)&&i.runIfPresent(+r.data.slice(t.length))};n.instance=this,e.addEventListener("message",n,!1);var r=function e(){var t=e,n=t.messagePrefix,r=t.instance,i=r.addFromSetImmediateArguments(arguments);return r.root.postMessage(n+i,"*"),i};return r.instance=this,r.messagePrefix=t,r},e.prototype.runIfPresent=function(e){if(this.currentlyRunningATask)this.root.setTimeout(this.partiallyApplied(this.runIfPresent,e),0);else{var t=this.tasksByHandle[e];if(t){this.currentlyRunningATask=!0;try{t()}finally{this.clearImmediate(e),this.currentlyRunningATask=!1}}}},e.prototype.createMessageChannelSetImmediate=function(){var e=this,t=new this.root.MessageChannel;t.port1.onmessage=function(t){var n=t.data;e.runIfPresent(n)};var n=function e(){var t=e,n=t.channel,r=t.instance,i=r.addFromSetImmediateArguments(arguments);return n.port2.postMessage(i),i};return n.channel=t,n.instance=this,n},e.prototype.createReadyStateChangeSetImmediate=function(){var e=function e(){var t=e.instance,n=t.root,r=n.document,i=r.documentElement,o=t.addFromSetImmediateArguments(arguments),s=r.createElement("script");return s.onreadystatechange=function(){t.runIfPresent(o),s.onreadystatechange=null,i.removeChild(s),s=null},i.appendChild(s),o};return e.instance=this,e},e.prototype.createSetTimeoutSetImmediate=function(){var e=function e(){var t=e.instance,n=t.addFromSetImmediateArguments(arguments);return t.root.setTimeout(t.partiallyApplied(t.runIfPresent,n),0),n};return e.instance=this,e},e}(),Vp={ImmediateDefinition:Up,Immediate:new Up(X.root)},Dp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Fp={AsapAction:function(e){function t(t,n){e.call(this,t,n),this.scheduler=t,this.work=n}return Dp(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=Vp.Immediate.setImmediate(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(Vp.Immediate.clearImmediate(n),t.scheduled=void 0)},t}(In.AsyncAction)},Bp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Wp={asap:new({AsapScheduler:function(e){function t(){e.apply(this,arguments)}return Bp(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Cn.AsyncScheduler)}.AsapScheduler)(Fp.AsapAction)},Hp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Gp={SubscribeOnObservable:function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=Wp.asap),e.call(this),this.source=t,this.delayTime=n,this.scheduler=r,(!Tn.isNumeric(n)||n<0)&&(this.delayTime=0),r&&"function"==typeof r.schedule||(this.scheduler=Wp.asap)}return Hp(t,e),t.create=function(e,n,r){return void 0===n&&(n=0),void 0===r&&(r=Wp.asap),new t(e,n,r)},t.dispatch=function(e){var t=e.source,n=e.subscriber;return this.add(t.subscribe(n))},t.prototype._subscribe=function(e){var n=this.delayTime,r=this.source;return this.scheduler.schedule(t.dispatch,n,{source:r,subscriber:e})},t}(Se.Observable)};var zp=function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Jp(e,t))}},Jp=function(){function e(e,t){this.scheduler=e,this.delay=t}return e.prototype.call=function(e,t){return new Gp.SubscribeOnObservable(t,this.delay,this.scheduler).subscribe(e)},e}(),Qp={subscribeOn:zp};var Yp={subscribeOn:function(e,t){return void 0===t&&(t=0),Qp.subscribeOn(e,t)(this)}};Se.Observable.prototype.subscribeOn=Yp.subscribeOn;var Kp=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Xp=function(e,t){return function(n){return n.lift(new $p(e,t))}},$p=function(){function e(e,t){this.project=e,this.resultSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Zp(e,this.project,this.resultSelector))},e}(),Zp=function(e){function t(t,n,r){e.call(this,t),this.project=n,this.resultSelector=r,this.index=0}return Kp(t,e),t.prototype._next=function(e){var t,n=this.index++;try{t=this.project(e,n)}catch(e){return void this.destination.error(e)}this._innerSub(t,e,n)},t.prototype._innerSub=function(e,t,n){var r=this.innerSubscription;r&&r.unsubscribe(),this.add(this.innerSubscription=at.subscribeToResult(this,e,t,n))},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.innerSubscription=null},t.prototype.notifyComplete=function(t){this.remove(t),this.innerSubscription=null,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t,n,r,i){this.resultSelector?this._tryNotifyNext(e,t,n,r):this.destination.next(t)},t.prototype._tryNotifyNext=function(e,t,n,r){var i;try{i=this.resultSelector(e,t,n,r)}catch(e){return void this.destination.error(e)}this.destination.next(i)},t}(tt.OuterSubscriber),ef={switchMap:Xp};var tf={switchAll:function(){return ef.switchMap(Kt.identity)}};var nf={_switch:function(){return tf.switchAll()(this)}};Se.Observable.prototype.switch=nf._switch,Se.Observable.prototype._switch=nf._switch;var rf={switchMap:function(e,t){return ef.switchMap(e,t)(this)}};Se.Observable.prototype.switchMap=rf.switchMap;var of=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var sf=function(e,t){return function(n){return n.lift(new af(e,t))}},af=function(){function e(e,t){this.observable=e,this.resultSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new cf(e,this.observable,this.resultSelector))},e}(),cf=function(e){function t(t,n,r){e.call(this,t),this.inner=n,this.resultSelector=r,this.index=0}return of(t,e),t.prototype._next=function(e){var t=this.innerSubscription;t&&t.unsubscribe(),this.add(this.innerSubscription=at.subscribeToResult(this,this.inner,e,this.index++))},t.prototype._complete=function(){var t=this.innerSubscription;t&&!t.closed||e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.innerSubscription=null},t.prototype.notifyComplete=function(t){this.remove(t),this.innerSubscription=null,this.isStopped&&e.prototype._complete.call(this)},t.prototype.notifyNext=function(e,t,n,r,i){var o=this.resultSelector,s=this.destination;o?this.tryResultSelector(e,t,n,r):s.next(t)},t.prototype.tryResultSelector=function(e,t,n,r){var i,o=this.resultSelector,s=this.destination;try{i=o(e,t,n,r)}catch(e){return void s.error(e)}s.next(i)},t}(tt.OuterSubscriber),uf={switchMapTo:sf};var lf={switchMapTo:function(e,t){return uf.switchMapTo(e,t)(this)}};Se.Observable.prototype.switchMapTo=lf.switchMapTo;var pf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var ff=function(e){return function(t){return 0===e?new Xe.EmptyObservable:t.lift(new hf(e))}},hf=function(){function e(e){if(this.total=e,this.total<0)throw new Zs.ArgumentOutOfRangeError}return e.prototype.call=function(e,t){return t.subscribe(new df(e,this.total))},e}(),df=function(e){function t(t,n){e.call(this,t),this.total=n,this.count=0}return pf(t,e),t.prototype._next=function(e){var t=this.total,n=++this.count;n<=t&&(this.destination.next(e),n===t&&(this.destination.complete(),this.unsubscribe()))},t}(me.Subscriber),bf={take:ff};var vf={take:function(e){return bf.take(e)(this)}};Se.Observable.prototype.take=vf.take;var mf={takeLast:function(e){return Yc.takeLast(e)(this)}};Se.Observable.prototype.takeLast=mf.takeLast;var yf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var gf=function(e){return function(t){return t.lift(new _f(e))}},_f=function(){function e(e){this.notifier=e}return e.prototype.call=function(e,t){return t.subscribe(new wf(e,this.notifier))},e}(),wf=function(e){function t(t,n){e.call(this,t),this.notifier=n,this.add(at.subscribeToResult(this,n))}return yf(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.complete()},t.prototype.notifyComplete=function(){},t}(tt.OuterSubscriber),Of={takeUntil:gf};var Ef={takeUntil:function(e){return Of.takeUntil(e)(this)}};Se.Observable.prototype.takeUntil=Ef.takeUntil;var Sf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Tf=function(e){return function(t){return t.lift(new xf(e))}},xf=function(){function e(e){this.predicate=e}return e.prototype.call=function(e,t){return t.subscribe(new Af(e,this.predicate))},e}(),Af=function(e){function t(t,n){e.call(this,t),this.predicate=n,this.index=0}return Sf(t,e),t.prototype._next=function(e){var t,n=this.destination;try{t=this.predicate(e,this.index++)}catch(e){return void n.error(e)}this.nextOrComplete(e,t)},t.prototype.nextOrComplete=function(e,t){var n=this.destination;Boolean(t)?n.next(e):n.complete()},t}(me.Subscriber),kf={takeWhile:Tf};var If={takeWhile:function(e){return kf.takeWhile(e)(this)}};Se.Observable.prototype.takeWhile=If.takeWhile;var Nf=T((function(e,t){var n=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};t.defaultThrottleConfig={leading:!0,trailing:!1},t.throttle=function(e,n){return void 0===n&&(n=t.defaultThrottleConfig),function(t){return t.lift(new r(e,n.leading,n.trailing))}};var r=function(){function e(e,t,n){this.durationSelector=e,this.leading=t,this.trailing=n}return e.prototype.call=function(e,t){return t.subscribe(new i(e,this.durationSelector,this.leading,this.trailing))},e}(),i=function(e){function t(t,n,r,i){e.call(this,t),this.destination=t,this.durationSelector=n,this._leading=r,this._trailing=i,this._hasTrailingValue=!1}return n(t,e),t.prototype._next=function(e){if(this.throttled)this._trailing&&(this._hasTrailingValue=!0,this._trailingValue=e);else{var t=this.tryDurationSelector(e);t&&this.add(this.throttled=at.subscribeToResult(this,t)),this._leading&&(this.destination.next(e),this._trailing&&(this._hasTrailingValue=!0,this._trailingValue=e))}},t.prototype.tryDurationSelector=function(e){try{return this.durationSelector(e)}catch(e){return this.destination.error(e),null}},t.prototype._unsubscribe=function(){var e=this,t=e.throttled;e._trailingValue,e._hasTrailingValue,e._trailing;this._trailingValue=null,this._hasTrailingValue=!1,t&&(this.remove(t),this.throttled=null,t.unsubscribe())},t.prototype._sendTrailing=function(){var e=this,t=e.destination,n=e.throttled,r=e._trailing,i=e._trailingValue,o=e._hasTrailingValue;n&&r&&o&&(t.next(i),this._trailingValue=null,this._hasTrailingValue=!1)},t.prototype.notifyNext=function(e,t,n,r,i){this._sendTrailing(),this._unsubscribe()},t.prototype.notifyComplete=function(){this._sendTrailing(),this._unsubscribe()},t}(tt.OuterSubscriber)}));var Rf={throttle:function(e,t){return void 0===t&&(t=Nf.defaultThrottleConfig),Nf.throttle(e,t)(this)}};Se.Observable.prototype.throttle=Rf.throttle;var Cf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Pf=function(e,t,n){return void 0===t&&(t=Pn.async),void 0===n&&(n=Nf.defaultThrottleConfig),function(r){return r.lift(new Mf(e,t,n.leading,n.trailing))}},Mf=function(){function e(e,t,n,r){this.duration=e,this.scheduler=t,this.leading=n,this.trailing=r}return e.prototype.call=function(e,t){return t.subscribe(new jf(e,this.duration,this.scheduler,this.leading,this.trailing))},e}(),jf=function(e){function t(t,n,r,i,o){e.call(this,t),this.duration=n,this.scheduler=r,this.leading=i,this.trailing=o,this._hasTrailingValue=!1,this._trailingValue=null}return Cf(t,e),t.prototype._next=function(e){this.throttled?this.trailing&&(this._trailingValue=e,this._hasTrailingValue=!0):(this.add(this.throttled=this.scheduler.schedule(qf,this.duration,{subscriber:this})),this.leading&&this.destination.next(e))},t.prototype.clearThrottle=function(){var e=this.throttled;e&&(this.trailing&&this._hasTrailingValue&&(this.destination.next(this._trailingValue),this._trailingValue=null,this._hasTrailingValue=!1),e.unsubscribe(),this.remove(e),this.throttled=null)},t}(me.Subscriber);function qf(e){e.subscriber.clearThrottle()}var Lf={throttleTime:Pf};var Uf={throttleTime:function(e,t,n){return void 0===t&&(t=Pn.async),void 0===n&&(n=Nf.defaultThrottleConfig),Lf.throttleTime(e,t,n)(this)}};Se.Observable.prototype.throttleTime=Uf.throttleTime;var Vf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Df=function(e){return void 0===e&&(e=Pn.async),function(t){return t.lift(new Wf(e))}},Ff=function(e,t){this.value=e,this.interval=t},Bf=Ff,Wf=function(){function e(e){this.scheduler=e}return e.prototype.call=function(e,t){return t.subscribe(new Hf(e,this.scheduler))},e}(),Hf=function(e){function t(t,n){e.call(this,t),this.scheduler=n,this.lastTime=0,this.lastTime=n.now()}return Vf(t,e),t.prototype._next=function(e){var t=this.scheduler.now(),n=t-this.lastTime;this.lastTime=t,this.destination.next(new Ff(e,n))},t}(me.Subscriber),Gf={timeInterval:Df,TimeInterval:Bf};var zf={TimeInterval:Gf.TimeInterval,timeInterval:function(e){return void 0===e&&(e=Pn.async),Gf.timeInterval(e)(this)}};Se.Observable.prototype.timeInterval=zf.timeInterval;var Jf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Qf={TimeoutError:function(e){function t(){var t=e.call(this,"Timeout has occurred");this.name=t.name="TimeoutError",this.stack=t.stack,this.message=t.message}return Jf(t,e),t}(Error)},Yf=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Kf=function(e,t){void 0===t&&(t=Pn.async);var n=fr.isDate(e),r=n?+e-t.now():Math.abs(e);return function(e){return e.lift(new Xf(r,n,t,new Qf.TimeoutError))}},Xf=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.scheduler=n,this.errorInstance=r}return e.prototype.call=function(e,t){return t.subscribe(new $f(e,this.absoluteTimeout,this.waitFor,this.scheduler,this.errorInstance))},e}(),$f=function(e){function t(t,n,r,i,o){e.call(this,t),this.absoluteTimeout=n,this.waitFor=r,this.scheduler=i,this.errorInstance=o,this.action=null,this.scheduleTimeout()}return Yf(t,e),t.dispatchTimeout=function(e){e.error(e.errorInstance)},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=null,this.scheduler=null,this.errorInstance=null},t}(me.Subscriber),Zf={timeout:Kf};var eh={timeout:function(e,t){return void 0===t&&(t=Pn.async),Zf.timeout(e,t)(this)}};Se.Observable.prototype.timeout=eh.timeout;var th=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var nh=function(e,t,n){return void 0===n&&(n=Pn.async),function(r){var i=fr.isDate(e),o=i?+e-n.now():Math.abs(e);return r.lift(new rh(o,i,t,n))}},rh=function(){function e(e,t,n,r){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new ih(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),ih=function(e){function t(t,n,r,i,o){e.call(this,t),this.absoluteTimeout=n,this.waitFor=r,this.withObservable=i,this.scheduler=o,this.action=null,this.scheduleTimeout()}return th(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(at.subscribeToResult(e,t))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=null,this.scheduler=null,this.withObservable=null},t}(tt.OuterSubscriber),oh={timeoutWith:nh};var sh={timeoutWith:function(e,t,n){return void 0===n&&(n=Pn.async),oh.timeoutWith(e,t,n)(this)}};Se.Observable.prototype.timeoutWith=sh.timeoutWith;var ah=function(e){return void 0===e&&(e=Pn.async),Mr.map((function(t){return new ch(t,e.now())}))},ch=function(e,t){this.value=e,this.timestamp=t},uh={timestamp:ah,Timestamp:ch};var lh={timestamp:function(e){return void 0===e&&(e=Pn.async),uh.timestamp(e)(this)}};function ph(e,t,n){return 0===n?[t]:(e.push(t),e)}Se.Observable.prototype.timestamp=lh.timestamp;var fh={toArray:function(){return Kc.reduce(ph,[])}};var hh={toArray:function(){return fh.toArray()(this)}};Se.Observable.prototype.toArray=hh.toArray;var dh=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var bh=function(e){return function(t){return t.lift(new vh(e))}},vh=function(){function e(e){this.windowBoundaries=e}return e.prototype.call=function(e,t){var n=new mh(e),r=t.subscribe(n);return r.closed||n.add(at.subscribeToResult(n,this.windowBoundaries)),r},e}(),mh=function(e){function t(t){e.call(this,t),this.window=new je.Subject,t.next(this.window)}return dh(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.openWindow()},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){this._complete()},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e)},t.prototype._complete=function(){this.window.complete(),this.destination.complete()},t.prototype._unsubscribe=function(){this.window=null},t.prototype.openWindow=function(){var e=this.window;e&&e.complete();var t=this.destination,n=this.window=new je.Subject;t.next(n)},t}(tt.OuterSubscriber),yh={window:bh};var gh={window:function(e){return yh.window(e)(this)}};Se.Observable.prototype.window=gh.window;var _h=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var wh=function(e,t){return void 0===t&&(t=0),function(n){return n.lift(new Oh(e,t))}},Oh=function(){function e(e,t){this.windowSize=e,this.startWindowEvery=t}return e.prototype.call=function(e,t){return t.subscribe(new Eh(e,this.windowSize,this.startWindowEvery))},e}(),Eh=function(e){function t(t,n,r){e.call(this,t),this.destination=t,this.windowSize=n,this.startWindowEvery=r,this.windows=[new je.Subject],this.count=0,t.next(this.windows[0])}return _h(t,e),t.prototype._next=function(e){for(var t=this.startWindowEvery>0?this.startWindowEvery:this.windowSize,n=this.destination,r=this.windowSize,i=this.windows,o=i.length,s=0;s<o&&!this.closed;s++)i[s].next(e);var a=this.count-r+1;if(a>=0&&a%t==0&&!this.closed&&i.shift().complete(),++this.count%t==0&&!this.closed){var c=new je.Subject;i.push(c),n.next(c)}},t.prototype._error=function(e){var t=this.windows;if(t)for(;t.length>0&&!this.closed;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){var e=this.windows;if(e)for(;e.length>0&&!this.closed;)e.shift().complete();this.destination.complete()},t.prototype._unsubscribe=function(){this.count=0,this.windows=null},t}(me.Subscriber),Sh={windowCount:wh};var Th={windowCount:function(e,t){return void 0===t&&(t=0),Sh.windowCount(e,t)(this)}};Se.Observable.prototype.windowCount=Th.windowCount;var xh=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Ah=function(e){var t=Pn.async,n=null,r=Number.POSITIVE_INFINITY;return Je.isScheduler(arguments[3])&&(t=arguments[3]),Je.isScheduler(arguments[2])?t=arguments[2]:Tn.isNumeric(arguments[2])&&(r=arguments[2]),Je.isScheduler(arguments[1])?t=arguments[1]:Tn.isNumeric(arguments[1])&&(n=arguments[1]),function(i){return i.lift(new kh(e,n,r,t))}},kh=function(){function e(e,t,n,r){this.windowTimeSpan=e,this.windowCreationInterval=t,this.maxWindowSize=n,this.scheduler=r}return e.prototype.call=function(e,t){return t.subscribe(new Nh(e,this.windowTimeSpan,this.windowCreationInterval,this.maxWindowSize,this.scheduler))},e}(),Ih=function(e){function t(){e.apply(this,arguments),this._numberOfNextedValues=0}return xh(t,e),t.prototype.next=function(t){this._numberOfNextedValues++,e.prototype.next.call(this,t)},Object.defineProperty(t.prototype,"numberOfNextedValues",{get:function(){return this._numberOfNextedValues},enumerable:!0,configurable:!0}),t}(je.Subject),Nh=function(e){function t(t,n,r,i,o){e.call(this,t),this.destination=t,this.windowTimeSpan=n,this.windowCreationInterval=r,this.maxWindowSize=i,this.scheduler=o,this.windows=[];var s=this.openWindow();if(null!==r&&r>=0){var a={subscriber:this,window:s,context:null},c={windowTimeSpan:n,windowCreationInterval:r,subscriber:this,scheduler:o};this.add(o.schedule(Ph,n,a)),this.add(o.schedule(Ch,r,c))}else{var u={subscriber:this,window:s,windowTimeSpan:n};this.add(o.schedule(Rh,n,u))}}return xh(t,e),t.prototype._next=function(e){for(var t=this.windows,n=t.length,r=0;r<n;r++){var i=t[r];i.closed||(i.next(e),i.numberOfNextedValues>=this.maxWindowSize&&this.closeWindow(i))}},t.prototype._error=function(e){for(var t=this.windows;t.length>0;)t.shift().error(e);this.destination.error(e)},t.prototype._complete=function(){for(var e=this.windows;e.length>0;){var t=e.shift();t.closed||t.complete()}this.destination.complete()},t.prototype.openWindow=function(){var e=new Ih;return this.windows.push(e),this.destination.next(e),e},t.prototype.closeWindow=function(e){e.complete();var t=this.windows;t.splice(t.indexOf(e),1)},t}(me.Subscriber);function Rh(e){var t=e.subscriber,n=e.windowTimeSpan,r=e.window;r&&t.closeWindow(r),e.window=t.openWindow(),this.schedule(e,n)}function Ch(e){var t=e.windowTimeSpan,n=e.subscriber,r=e.scheduler,i=e.windowCreationInterval,o=n.openWindow(),s=this,a={action:s,subscription:null},c={subscriber:n,window:o,context:a};a.subscription=r.schedule(Ph,t,c),s.add(a.subscription),s.schedule(e,i)}function Ph(e){var t=e.subscriber,n=e.window,r=e.context;r&&r.action&&r.subscription&&r.action.remove(r.subscription),t.closeWindow(n)}var Mh={windowTime:Ah};var jh={windowTime:function(e){var t=Pn.async,n=null,r=Number.POSITIVE_INFINITY;return Je.isScheduler(arguments[3])&&(t=arguments[3]),Je.isScheduler(arguments[2])?t=arguments[2]:Tn.isNumeric(arguments[2])&&(r=arguments[2]),Je.isScheduler(arguments[1])?t=arguments[1]:Tn.isNumeric(arguments[1])&&(n=arguments[1]),Mh.windowTime(e,n,r,t)(this)}};Se.Observable.prototype.windowTime=jh.windowTime;var qh=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Lh=function(e,t){return function(n){return n.lift(new Uh(e,t))}},Uh=function(){function e(e,t){this.openings=e,this.closingSelector=t}return e.prototype.call=function(e,t){return t.subscribe(new Vh(e,this.openings,this.closingSelector))},e}(),Vh=function(e){function t(t,n,r){e.call(this,t),this.openings=n,this.closingSelector=r,this.contexts=[],this.add(this.openSubscription=at.subscribeToResult(this,n,n))}return qh(t,e),t.prototype._next=function(e){var t=this.contexts;if(t)for(var n=t.length,r=0;r<n;r++)t[r].window.next(e)},t.prototype._error=function(t){var n=this.contexts;if(this.contexts=null,n)for(var r=n.length,i=-1;++i<r;){var o=n[i];o.window.error(t),o.subscription.unsubscribe()}e.prototype._error.call(this,t)},t.prototype._complete=function(){var t=this.contexts;if(this.contexts=null,t)for(var n=t.length,r=-1;++r<n;){var i=t[r];i.window.complete(),i.subscription.unsubscribe()}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){var e=this.contexts;if(this.contexts=null,e)for(var t=e.length,n=-1;++n<t;){var r=e[n];r.window.unsubscribe(),r.subscription.unsubscribe()}},t.prototype.notifyNext=function(e,t,n,r,i){if(e===this.openings){var o=this.closingSelector,s=ie.tryCatch(o)(t);if(s===ne.errorObject)return this.error(ne.errorObject.e);var a=new je.Subject,c=new ue.Subscription,u={window:a,subscription:c};this.contexts.push(u);var l=at.subscribeToResult(this,s,u);l.closed?this.closeWindow(this.contexts.length-1):(l.context=u,c.add(l)),this.destination.next(a)}else this.closeWindow(this.contexts.indexOf(e))},t.prototype.notifyError=function(e){this.error(e)},t.prototype.notifyComplete=function(e){e!==this.openSubscription&&this.closeWindow(this.contexts.indexOf(e.context))},t.prototype.closeWindow=function(e){if(-1!==e){var t=this.contexts,n=t[e],r=n.window,i=n.subscription;t.splice(e,1),r.complete(),i.unsubscribe()}},t}(tt.OuterSubscriber),Dh={windowToggle:Lh};var Fh={windowToggle:function(e,t){return Dh.windowToggle(e,t)(this)}};Se.Observable.prototype.windowToggle=Fh.windowToggle;var Bh=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Wh=function(e){return function(t){return t.lift(new Hh(e))}},Hh=function(){function e(e){this.closingSelector=e}return e.prototype.call=function(e,t){return t.subscribe(new Gh(e,this.closingSelector))},e}(),Gh=function(e){function t(t,n){e.call(this,t),this.destination=t,this.closingSelector=n,this.openWindow()}return Bh(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.openWindow(i)},t.prototype.notifyError=function(e,t){this._error(e)},t.prototype.notifyComplete=function(e){this.openWindow(e)},t.prototype._next=function(e){this.window.next(e)},t.prototype._error=function(e){this.window.error(e),this.destination.error(e),this.unsubscribeClosingNotification()},t.prototype._complete=function(){this.window.complete(),this.destination.complete(),this.unsubscribeClosingNotification()},t.prototype.unsubscribeClosingNotification=function(){this.closingNotification&&this.closingNotification.unsubscribe()},t.prototype.openWindow=function(e){void 0===e&&(e=null),e&&(this.remove(e),e.unsubscribe());var t=this.window;t&&t.complete();var n=this.window=new je.Subject;this.destination.next(n);var r=ie.tryCatch(this.closingSelector)();if(r===ne.errorObject){var i=ne.errorObject.e;this.destination.error(i),this.window.error(i)}else this.add(this.closingNotification=at.subscribeToResult(this,r))},t}(tt.OuterSubscriber),zh={windowWhen:Wh};var Jh={windowWhen:function(e){return zh.windowWhen(e)(this)}};Se.Observable.prototype.windowWhen=Jh.windowWhen;var Qh=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};var Yh=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return function(t){var n;"function"==typeof e[e.length-1]&&(n=e.pop());var r=e;return t.lift(new Kh(r,n))}},Kh=function(){function e(e,t){this.observables=e,this.project=t}return e.prototype.call=function(e,t){return t.subscribe(new Xh(e,this.observables,this.project))},e}(),Xh=function(e){function t(t,n,r){e.call(this,t),this.observables=n,this.project=r,this.toRespond=[];var i=n.length;this.values=new Array(i);for(var o=0;o<i;o++)this.toRespond.push(o);for(o=0;o<i;o++){var s=n[o];this.add(at.subscribeToResult(this,s,s,o))}}return Qh(t,e),t.prototype.notifyNext=function(e,t,n,r,i){this.values[n]=t;var o=this.toRespond;if(o.length>0){var s=o.indexOf(n);-1!==s&&o.splice(s,1)}},t.prototype.notifyComplete=function(){},t.prototype._next=function(e){if(0===this.toRespond.length){var t=[e].concat(this.values);this.project?this._tryProject(t):this.destination.next(t)}},t.prototype._tryProject=function(e){var t;try{t=this.project.apply(this,e)}catch(e){return void this.destination.error(e)}this.destination.next(t)},t}(tt.OuterSubscriber),$h={withLatestFrom:Yh};var Zh={withLatestFrom:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return $h.withLatestFrom.apply(void 0,e)(this)}};Se.Observable.prototype.withLatestFrom=Zh.withLatestFrom;var ed={zipProto:function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return Ar.zip.apply(void 0,e)(this)}};Se.Observable.prototype.zip=ed.zipProto;var td={zipAll:function(e){return function(t){return t.lift(new Ar.ZipOperator(e))}}};var nd={zipAll:function(e){return td.zipAll(e)(this)}};Se.Observable.prototype.zipAll=nd.zipAll;var rd={SubscriptionLog:function(e,t){void 0===t&&(t=Number.POSITIVE_INFINITY),this.subscribedFrame=e,this.unsubscribedFrame=t}},id={SubscriptionLoggable:function(){function e(){this.subscriptions=[]}return e.prototype.logSubscribedFrame=function(){return this.subscriptions.push(new rd.SubscriptionLog(this.scheduler.now())),this.subscriptions.length-1},e.prototype.logUnsubscribedFrame=function(e){var t=this.subscriptions,n=t[e];t[e]=new rd.SubscriptionLog(n.subscribedFrame,this.scheduler.now())},e}()};var od={applyMixins:function(e,t){for(var n=0,r=t.length;n<r;n++)for(var i=t[n],o=Object.getOwnPropertyNames(i.prototype),s=0,a=o.length;s<a;s++){var c=o[s];e.prototype[c]=i.prototype[c]}}},sd=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},ad=function(e){function t(t,n){e.call(this,(function(e){var t=this,n=t.logSubscribedFrame();return e.add(new ue.Subscription((function(){t.logUnsubscribedFrame(n)}))),t.scheduleMessages(e),e})),this.messages=t,this.subscriptions=[],this.scheduler=n}return sd(t,e),t.prototype.scheduleMessages=function(e){for(var t=this.messages.length,n=0;n<t;n++){var r=this.messages[n];e.add(this.scheduler.schedule((function(e){var t=e.message,n=e.subscriber;t.notification.observe(n)}),r.frame,{message:r,subscriber:e}))}},t}(Se.Observable),cd=ad;od.applyMixins(ad,[id.SubscriptionLoggable]);var ud={ColdObservable:cd},ld=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},pd=function(e){function t(t,n){e.call(this),this.messages=t,this.subscriptions=[],this.scheduler=n}return ld(t,e),t.prototype._subscribe=function(t){var n=this,r=n.logSubscribedFrame();return t.add(new ue.Subscription((function(){n.logUnsubscribedFrame(r)}))),e.prototype._subscribe.call(this,t)},t.prototype.setup=function(){for(var e=this,t=e.messages.length,n=0;n<t;n++)!function(){var t=e.messages[n];e.scheduler.schedule((function(){t.notification.observe(e)}),t.frame)}()},t}(je.Subject),fd=pd;od.applyMixins(pd,[id.SubscriptionLoggable]);var hd={HotObservable:fd},dd=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},bd=function(e){function t(t,n){var r=this;void 0===t&&(t=vd),void 0===n&&(n=Number.POSITIVE_INFINITY),e.call(this,t,(function(){return r.frame})),this.maxFrames=n,this.frame=0,this.index=-1}return dd(t,e),t.prototype.flush=function(){for(var e,t,n=this.actions,r=this.maxFrames;(t=n.shift())&&(this.frame=t.delay)<=r&&!(e=t.execute(t.state,t.delay)););if(e){for(;t=n.shift();)t.unsubscribe();throw e}},t.frameTimeFactor=10,t}(Cn.AsyncScheduler),vd=function(e){function t(t,n,r){void 0===r&&(r=t.index+=1),e.call(this,t,n),this.scheduler=t,this.work=n,this.index=r,this.active=!0,this.index=t.index=r}return dd(t,e),t.prototype.schedule=function(n,r){if(void 0===r&&(r=0),!this.id)return e.prototype.schedule.call(this,n,r);this.active=!1;var i=new t(this.scheduler,this.work);return this.add(i),i.schedule(n,r)},t.prototype.requestAsyncId=function(e,n,r){void 0===r&&(r=0),this.delay=e.frame+r;var i=e.actions;return i.push(this),i.sort(t.sortActions),!0},t.prototype.recycleAsyncId=function(e,t,n){},t.prototype._execute=function(t,n){if(!0===this.active)return e.prototype._execute.call(this,t,n)},t.sortActions=function(e,t){return e.delay===t.delay?e.index===t.index?0:e.index>t.index?1:-1:e.delay>t.delay?1:-1},t}(In.AsyncAction),md={VirtualTimeScheduler:bd,VirtualAction:vd},yd=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},gd={TestScheduler:function(e){function t(t){e.call(this,md.VirtualAction,750),this.assertDeepEqual=t,this.hotObservables=[],this.coldObservables=[],this.flushTests=[]}return yd(t,e),t.prototype.createTime=function(e){var n=e.indexOf("|");if(-1===n)throw new Error('marble diagram for time should have a completion marker "|"');return n*t.frameTimeFactor},t.prototype.createColdObservable=function(e,n,r){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r),o=new ud.ColdObservable(i,this);return this.coldObservables.push(o),o},t.prototype.createHotObservable=function(e,n,r){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var i=t.parseMarbles(e,n,r),o=new hd.HotObservable(i,this);return this.hotObservables.push(o),o},t.prototype.materializeInnerObservable=function(e,t){var n=this,r=[];return e.subscribe((function(e){r.push({frame:n.frame-t,notification:Ct.Notification.createNext(e)})}),(function(e){r.push({frame:n.frame-t,notification:Ct.Notification.createError(e)})}),(function(){r.push({frame:n.frame-t,notification:Ct.Notification.createComplete()})})),r},t.prototype.expectObservable=function(e,n){var r=this;void 0===n&&(n=null);var i,o=[],s={actual:o,ready:!1},a=t.parseMarblesAsSubscriptions(n).unsubscribedFrame;return this.schedule((function(){i=e.subscribe((function(e){var t=e;e instanceof Se.Observable&&(t=r.materializeInnerObservable(t,r.frame)),o.push({frame:r.frame,notification:Ct.Notification.createNext(t)})}),(function(e){o.push({frame:r.frame,notification:Ct.Notification.createError(e)})}),(function(){o.push({frame:r.frame,notification:Ct.Notification.createComplete()})}))}),0),a!==Number.POSITIVE_INFINITY&&this.schedule((function(){return i.unsubscribe()}),a),this.flushTests.push(s),{toBe:function(e,n,r){s.ready=!0,s.expected=t.parseMarbles(e,n,r,!0)}}},t.prototype.expectSubscriptions=function(e){var n={actual:e,ready:!1};return this.flushTests.push(n),{toBe:function(e){var r="string"==typeof e?[e]:e;n.ready=!0,n.expected=r.map((function(e){return t.parseMarblesAsSubscriptions(e)}))}}},t.prototype.flush=function(){for(var t=this.hotObservables;t.length>0;)t.shift().setup();e.prototype.flush.call(this);for(var n=this.flushTests.filter((function(e){return e.ready}));n.length>0;){var r=n.shift();this.assertDeepEqual(r.actual,r.expected)}},t.parseMarblesAsSubscriptions=function(e){if("string"!=typeof e)return new rd.SubscriptionLog(Number.POSITIVE_INFINITY);for(var t=e.length,n=-1,r=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,o=0;o<t;o++){var s=o*this.frameTimeFactor,a=e[o];switch(a){case"-":case" ":break;case"(":n=s;break;case")":n=-1;break;case"^":if(r!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");r=n>-1?n:s;break;case"!":if(i!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");i=n>-1?n:s;break;default:throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+a+"'.")}}return i<0?new rd.SubscriptionLog(r):new rd.SubscriptionLog(r,i)},t.parseMarbles=function(e,t,n,r){if(void 0===r&&(r=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var i=e.length,s=[],a=e.indexOf("^"),c=-1===a?0:a*-this.frameTimeFactor,u="object"!==o(t)?function(e){return e}:function(e){return r&&t[e]instanceof ud.ColdObservable?t[e].messages:t[e]},l=-1,p=0;p<i;p++){var f=p*this.frameTimeFactor+c,h=void 0,d=e[p];switch(d){case"-":case" ":break;case"(":l=f;break;case")":l=-1;break;case"|":h=Ct.Notification.createComplete();break;case"^":break;case"#":h=Ct.Notification.createError(n||"error");break;default:h=Ct.Notification.createNext(u(d))}h&&s.push({frame:l>-1?l:f,notification:h})}return s},t}(md.VirtualTimeScheduler)},_d=function(e){e.requestAnimationFrame?(this.cancelAnimationFrame=e.cancelAnimationFrame.bind(e),this.requestAnimationFrame=e.requestAnimationFrame.bind(e)):e.mozRequestAnimationFrame?(this.cancelAnimationFrame=e.mozCancelAnimationFrame.bind(e),this.requestAnimationFrame=e.mozRequestAnimationFrame.bind(e)):e.webkitRequestAnimationFrame?(this.cancelAnimationFrame=e.webkitCancelAnimationFrame.bind(e),this.requestAnimationFrame=e.webkitRequestAnimationFrame.bind(e)):e.msRequestAnimationFrame?(this.cancelAnimationFrame=e.msCancelAnimationFrame.bind(e),this.requestAnimationFrame=e.msRequestAnimationFrame.bind(e)):e.oRequestAnimationFrame?(this.cancelAnimationFrame=e.oCancelAnimationFrame.bind(e),this.requestAnimationFrame=e.oRequestAnimationFrame.bind(e)):(this.cancelAnimationFrame=e.clearTimeout.bind(e),this.requestAnimationFrame=function(t){return e.setTimeout(t,1e3/60)})},wd={RequestAnimationFrameDefinition:_d,AnimationFrame:new _d(X.root)},Od=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Ed={AnimationFrameAction:function(e){function t(t,n){e.call(this,t,n),this.scheduler=t,this.work=n}return Od(t,e),t.prototype.requestAsyncId=function(t,n,r){return void 0===r&&(r=0),null!==r&&r>0?e.prototype.requestAsyncId.call(this,t,n,r):(t.actions.push(this),t.scheduled||(t.scheduled=wd.AnimationFrame.requestAnimationFrame(t.flush.bind(t,null))))},t.prototype.recycleAsyncId=function(t,n,r){if(void 0===r&&(r=0),null!==r&&r>0||null===r&&this.delay>0)return e.prototype.recycleAsyncId.call(this,t,n,r);0===t.actions.length&&(wd.AnimationFrame.cancelAnimationFrame(n),t.scheduled=void 0)},t}(In.AsyncAction)},Sd=E&&E.__extends||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Td={animationFrame:new({AnimationFrameScheduler:function(e){function t(){e.apply(this,arguments)}return Sd(t,e),t.prototype.flush=function(e){this.active=!0,this.scheduled=void 0;var t,n=this.actions,r=-1,i=n.length;e=e||n.shift();do{if(t=e.execute(e.state,e.delay))break}while(++r<i&&(e=n.shift()));if(this.active=!1,t){for(;++r<i&&(e=n.shift());)e.unsubscribe();throw t}},t}(Cn.AsyncScheduler)}.AnimationFrameScheduler)(Ed.AnimationFrameAction)},xd=lc.audit,Ad=fc.auditTime,kd=Ti.buffer,Id=Ci.bufferCount,Nd=Bi.bufferTime,Rd=Qi.bufferToggle,Cd=eo.bufferWhen,Pd=so.catchError,Md=co.combineAll,jd=dt.combineLatest,qd=po.concat,Ld=$t.concatAll,Ud=bo.concatMap,Vd=mo.concatMapTo,Dd=Eo.count,Fd=jo.debounce,Bd=Bo.debounceTime,Wd=Qo.defaultIfEmpty,Hd=ts.delay,Gd=us.delayWhen,zd=Io.dematerialize,Jd=ms.distinct,Qd=Es.distinctUntilChanged,Yd=Ts.distinctUntilKeyChanged,Kd=ia.elementAt,Xd=Tc.every,$d=Ls.exhaust,Zd=Ws.exhaustMap,eb=Ks.expand,tb=la.filter,nb=va.finalize,rb=Ea.find,ib=Ta.findIndex,ob=Pa.first,sb=za.groupBy,ab=$a.ignoreElements,cb=ic.isEmpty,ub=yc.last,lb=Mr.map,pb=Cc.mapTo,fb=Uc.materialize,hb=Xc.max,db=Zc.merge,bb=Xt.mergeAll,vb=Yt.mergeMap,mb=Yt.mergeMap,yb=cu.mergeMapTo,gb=bu.mergeScan,_b=mu.min,wb=Pu.multicast,Ob=Vt.observeOn,Eb=$n.onErrorResumeNext,Sb=Fu.pairwise,Tb=Hu.partition,xb=Ju.pluck,Ab=Yu.publish,kb=Zu.publishBehavior,Ib=rl.publishLast,Nb=tl.publishReplay,Rb=ol.race,Cb=Kc.reduce,Pb=fl.repeat,Mb=yl.repeatWhen,jb=Sl.retry,qb=Nl.retryWhen,Lb=Eu.refCount,Ub=ql.sample,Vb=Wl.sampleTime,Db=Hc.scan,Fb=Zl.sequenceEqual,Bb=np.share,Wb=ip.shareReplay,Hb=lp.single,Gb=vp.skip,zb=Op.skipLast,Jb=kp.skipUntil,Qb=Mp.skipWhile,Yb=qp.startWith,Kb=tf.switchAll,Xb=ef.switchMap,$b=uf.switchMapTo,Zb=bf.take,ev=Yc.takeLast,tv=Of.takeUntil,nv=kf.takeWhile,rv=Rs.tap,iv=Nf.throttle,ov=Lf.throttleTime,sv=Gf.timeInterval,av=Zf.timeout,cv=oh.timeoutWith,uv=uh.timestamp,lv=fh.toArray,pv=yh.window,fv=Sh.windowCount,hv=Mh.windowTime,dv=Dh.windowToggle,bv=zh.windowWhen,vv=$h.withLatestFrom,mv=Ar.zip,yv=td.zipAll,gv={audit:xd,auditTime:Ad,buffer:kd,bufferCount:Id,bufferTime:Nd,bufferToggle:Rd,bufferWhen:Cd,catchError:Pd,combineAll:Md,combineLatest:jd,concat:qd,concatAll:Ld,concatMap:Ud,concatMapTo:Vd,count:Dd,debounce:Fd,debounceTime:Bd,defaultIfEmpty:Wd,delay:Hd,delayWhen:Gd,dematerialize:zd,distinct:Jd,distinctUntilChanged:Qd,distinctUntilKeyChanged:Yd,elementAt:Kd,every:Xd,exhaust:$d,exhaustMap:Zd,expand:eb,filter:tb,finalize:nb,find:rb,findIndex:ib,first:ob,groupBy:sb,ignoreElements:ab,isEmpty:cb,last:ub,map:lb,mapTo:pb,materialize:fb,max:hb,merge:db,mergeAll:bb,mergeMap:vb,flatMap:mb,mergeMapTo:yb,mergeScan:gb,min:_b,multicast:wb,observeOn:Ob,onErrorResumeNext:Eb,pairwise:Sb,partition:Tb,pluck:xb,publish:Ab,publishBehavior:kb,publishLast:Ib,publishReplay:Nb,race:Rb,reduce:Cb,repeat:Pb,repeatWhen:Mb,retry:jb,retryWhen:qb,refCount:Lb,sample:Ub,sampleTime:Vb,scan:Db,sequenceEqual:Fb,share:Bb,shareReplay:Wb,single:Hb,skip:Gb,skipLast:zb,skipUntil:Jb,skipWhile:Qb,startWith:Yb,switchAll:Kb,switchMap:Xb,switchMapTo:$b,take:Zb,takeLast:ev,takeUntil:tv,takeWhile:nv,tap:rv,throttle:iv,throttleTime:ov,timeInterval:sv,timeout:av,timeoutWith:cv,timestamp:uv,toArray:lv,window:pv,windowCount:fv,windowTime:hv,windowToggle:dv,windowWhen:bv,withLatestFrom:vv,zip:mv,zipAll:yv},_v=je.Subject,wv=je.AnonymousSubject,Ov=Se.Observable,Ev=ue.Subscription,Sv=me.Subscriber,Tv=Le.AsyncSubject,xv=bi.ReplaySubject,Av=$u.BehaviorSubject,kv=Nu.ConnectableObservable,Iv=Ct.Notification,Nv=ka.EmptyError,Rv=Zs.ArgumentOutOfRangeError,Cv=xe.ObjectUnsubscribedError,Pv=Qf.TimeoutError,Mv=se.UnsubscriptionError,jv=zf.TimeInterval,qv=uh.Timestamp,Lv=gd.TestScheduler,Uv=md.VirtualTimeScheduler,Vv=si.AjaxResponse,Dv=si.AjaxError,Fv=si.AjaxTimeoutError,Bv=Oe.pipe,Wv=gv,Hv={asap:Wp.asap,queue:pi.queue,animationFrame:Td.animationFrame,async:Pn.async},Gv={rxSubscriber:pe.rxSubscriber,observable:ge.observable,iterator:it.iterator},zv={Subject:_v,AnonymousSubject:wv,Observable:Ov,Subscription:Ev,Subscriber:Sv,AsyncSubject:Tv,ReplaySubject:xv,BehaviorSubject:Av,ConnectableObservable:kv,Notification:Iv,EmptyError:Nv,ArgumentOutOfRangeError:Rv,ObjectUnsubscribedError:Cv,TimeoutError:Pv,UnsubscriptionError:Mv,TimeInterval:jv,Timestamp:qv,TestScheduler:Lv,VirtualTimeScheduler:Uv,AjaxResponse:Vv,AjaxError:Dv,AjaxTimeoutError:Fv,pipe:Bv,operators:Wv,Scheduler:Hv,Symbol:Gv},Jv=sm.visitorId,Qv=function(){return Jv},Yv=new zv.Subject(1),Kv=function(){return Yv.asObservable().startWith(Qv())},Xv=function(){return sm.siteId},$v=new function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.publishInterval,n=void 0===t?3e3:t,r=e.maximumBatchSize,i=void 0===r?50:r,o=e.maximumBufferSize,s=void 0===o?1e3:o,a=e.maximumConsecutiveRetries,c=void 0===a?10:a,u=e.transports,l=void 0===u?[]:u,p=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.position;void 0===n&&(n=l.length),l.splice(n,0,e)},f={},h={},d=function e(t){var n=t.transports,r=t.payload;return 0===n.length?Promise.reject():n[0].process({payload:r}).catch((function(){return e({payload:r,transports:n.slice(1)})}))},b=function(e){return 0===Object.keys(e).length||F(e).every((function(e){return 0===e.length}))},v=function(){var e={};return Object.keys(f).forEach((function(t){e[t]=f[t].splice(0,i)})),b(e)?Promise.resolve():d({transports:l,payload:e}).then((function(){return Object.keys(h).forEach((function(e){return h[e]=0})),Promise.resolve()})).catch((function(){return Object.keys(e).forEach((function(t){h[t]++,h[t]<c?f[t]=e[t].concat(f[t]):h[t]=0})),Promise.reject()}))},m=!1,y=null,g=!1,_=function(){if(m)throw new Error("Publisher is already started");m=!0,y=setInterval((function(){g||(g=!0,v().then((function(){return g=!1}),(function(){return g=!1})))}),n),window.addEventListener("unload",v)},w=function(){m=!1,clearInterval(y)},O=function(e,t){f[e]||(h[e]||(h[e]=0),f[e]=[]),f[e].push(t),f[e].splice(s)};return{start:_,stop:w,addToBucket:O,flush:v,buckets:f,addTransport:p,transports:l}}({publishInterval:sm.conf.log_publish_interval_ms||3e3});$v.start(),$v.addTransport(new B.HttpTransport({url:sm.conf.client_logger_url,method:"POST",encode:function(e){var t=e.logs,n=e.stats;return JSON.stringify({logs:t||[],stats:n||[]})}}));sm.logger=new function e(t){var n=arguments,r=t.publisher,i=t.tags,o=void 0===i?{}:i,s=t.currentIsoDate,a=void 0===s?function(){return(new Date).toISOString()}:s,c=t.maxObjectDepth,u=void 0===c?3:c,l=t.maxArrayLength,p=void 0===l?10:l,f=t.windowConsole,h=void 0===f?window.console:f,d=t.localStorage,b=void 0===d?window.localStorage:d,v=t.liveLogsKey,m=void 0===v?"sm.live_logs":v,y=t.liveLogsEnabled,g=void 0!==y&&y,_=new q,w=function(e){return r.addToBucket("logs",e)},O=function(){return h&&(g||"1"===b[m])},E=function(e,t){for(var n=[],r=0;r<e.length;r++){if(r===p){var i=e[r-1];Array.isArray(i)?n.push(["-pruned-"]):i&&"object"===j(i)?n.push({pruned:!0}):n.push("-pruned-");break}n.push(x(e[r],t+1))}return n},S=function(e,t){if(u===t)return"-pruned-";var n={};return V(e,(function(r){n[r]=x(e[r],t+1)})),n},T=function(e){return{message:e.message,stack:e.stack}},x=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return-1!==D.indexOf(j(e))?e:"function"==typeof e?"<Function>":e instanceof Error?T(e):Array.isArray(e)?E(e,t):S(e,t)},A=function(e){return function(){if(O()){var t=h[e]||h.log;t.apply(t,arguments)}var n=Array.prototype.slice.call(arguments).map((function(e){return x(e,0)})).filter((function(e){return void 0!==e})),r=U(o);r=L(r,{level:e,attributes:n,timestamp:a()}),"error"===e?r=L(r,{breadcrumbs:_.list}):_.add(r),w(r)}},k=function(e){return e.filter((function(e){return e instanceof Error}))[0]};this.debug=A("debug"),this.log=A("info"),this.info=A("info"),this.warn=A("warn"),this.error=function(){var e=Array.prototype.slice.call(arguments),t=k(e);if(!t||!t._acked)return"string"!=typeof e[0]||t||(e[0]=new Error(e[0])),A("error").apply(null,e)},this.withTags=function(t){return new e(L(n[0],{tags:L(o,t)}))},this.enableLiveLogs=function(){return b[m]="1"}}({publisher:$v,tags:{actor:"visitor",site_id:sm.siteId,visitor_id:function(){return Qv()},tab_id:function(){return sm.tabId},user_agent:window.navigator.userAgent,url:function(){return String(window.location)},client_version:function(e){e||(e="visitor/bootstrapper-6dd946062.js");var t=e.split("-")[1];if(t)return t.slice(0,-3)}()}});var Zv,em=sm.logger,tm=new z(new function e(t){var n=t.publisher,r=t.globalTags,i=void 0===r?[]:r,o=function(e){return n.addToBucket("stats",e)},s=function(e,t,n,r){return r||(r=[]),{stat:e,params:[t,n,i.concat(r)]}};this.increment=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("increment",e,t,n))},this.decrement=function(e,t,n){isNaN(parseInt(t))&&(n=t,t=1),o(s("decrement",e,t,n))},this.gauge=function(e,t,n){o(s("gauge",e,t,n))},this.histogram=function(e,t,n){o(s("histogram",e,t,n))},this.timing=function(e,t,n){o(s("timing",e,t,n))},this.set=function(e,t,n){o(s("set",e,t,n))},this.withTags=function(t){return new e({publisher:n,globalTags:i.concat(t)})}}({publisher:$v,globalTags:["application:visitor","visitor_page_adaption:".concat(sm.conf.engagement.visitor_page_adaption),"site_id:".concat(sm.siteId)]}),(Zv={},{record:function(e){Zv[e]=Number(new Date)},currentLatencyFrom:function(e){var t=Zv[e];return t?Number(new Date)-t:-1}})),nm="sm.app.visitor_api.dynamic_import",rm="default"===sm.conf.communications.lib,im=function(e){return-1!==sm.conf.assets.server.indexOf("libs.")?"".concat(sm.conf.assets.server,"/").concat(e):[sm.conf.assets.server,sm.conf.assets.prepend||"/",e].join("")},om={Medra:{url:rm?"https://libs.salemove.com/medra-5.2.0.min.js":sm.conf.communications.lib,returning:function(){return sm.Medra},integrity:rm?P({name:"medra"}):null},Comms:{url:im("visitor_app/comms/app-6dd946062.js"),integrity:P({name:"comms"})},Cobra:{url:"".concat(sm.conf.cobra.lib.visitor,".js"),returning:function(){return sm.Cobra},integrity:P({name:"visitor_cobra"})},webcomponents:{url:im("visitor/webcomponents-6dd946062.js"),integrity:P({name:"webcomponents"})},webcomponents_es5:{url:im("visitor/webcomponents_es5-6dd946062.js"),integrity:P({name:"webcomponents_es5"})},legacy_webcomponents:{url:im("visitor/legacy_webcomponents-6dd946062.js"),integrity:P({name:"legacy_webcomponents"})}},am={},cm=function(e){var t,n=om,r=M,i=tm,o=am;"string"==typeof e?t=e:(t=e.target,e.loader&&(r=e.loader),e.possibleTargets&&(n=e.possibleTargets),e.stats&&(i=e.stats),e.loaded&&(o=e.loaded));var s=n[t];if(!s)return zv.Observable.throw("Invalid target");if(o[t]){if(s.returning){var a=s.returning();return void 0===a?zv.Observable.throw(new Error("An error occurred while loading ".concat(t,", as it is undefined"))):zv.Observable.of(a)}return zv.Observable.of(null)}return zv.Observable.create((function(e){r({fileUrl:s.url,integrity:s.integrity,onAttempt:function(){i.increment(nm,["action:attempted","module:".concat(t)])},onLoad:function(){if(o[t]=!0,s.returning){var n=s.returning();void 0===n?(i.increment(nm,["action:failed","module:".concat(t)]),e.error(new Error("An error occurred while loading ".concat(t,", as it is undefined")))):(i.increment(nm,["action:succeeded","module:".concat(t)]),e.next(n),e.complete())}else i.increment(nm,["action:succeeded","module:".concat(t)]),e.next(),e.complete()},onError:function(){i.increment(nm,["action:warning","module:".concat(t)])},onGiveUp:function(){i.increment(nm,["action:failed","module:".concat(t)]);var n=new Error("Loading ".concat(t," failed"));em.warn(n,{target:t}),n._acked=!0,e.error(n)},retryLimit:3,backoffDelay:500})}))},um={MSG:{PROACTIVE_REQUEST:"proactive_call:request",PROACTIVE_ACCEPT:"proactive_call:accept",PROACTIVE_DECLINE:"proactive_call:decline",REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT:"reactive_engagement_request_timeout",ENGAGEMENT_PREPARE:"engagement:prepare",ENGAGEMENT_CLEANUP:"engagement:cleanup",DISCONNECT:"connection_lost",RECONNECTED:"connection_restored",MEDIA_SELECTED:"media_selected",ENGAGEMENT_TRANSFERRED:"engagement:transferred",ENGAGEMENT_END_POPUP_CLOSED:"engagement:end:popup:closed",PUBLIC:{ENGAGEMENT_START:"sm:engagement:start",ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_GET_AUDIO_TYPE:"sm:engagement:get_audio_type",ENGAGEMENT_GET_UPGRADE_MEDIA_TYPE:"sm:engagement:get_upgrade_media_type",ENGAGEMENT_MEDIA_UPGRADE_REQUEST:"sm:engagement:media_upgrade_request",ENGAGEMENT_SELECT_MEDIA_TYPE:"sm:engagement:select_media_type"},WILL_ASK_MEDIA_PERMISSION:"engagement:media_permission:will_ask",SHOW_PERMISSION_ARROW:"communication:show_permission_arrow",HIDE_PERMISSION_ARROW:"communication:hide_permission_arrow",ALLOW_STREAM:"engagement:media_permission:allow",DENY_STREAM:"engagement:media_permission:_deny",IS_ENGAGED:"engagement:is_engaged",PHONE_STATUSES:{CONNECTED:"connected",CONNECTING:"connecting"},ENGAGEMENT_REMOVE_AUDIO:"engagement:remove_audio"}},lm=new zv.Subject;um.vent={trigger:function(e,t){lm.next({eventName:e,eventBody:t})},observable:function(e){return lm.filter((function(t){return t.eventName===e})).map((function(e){return e.eventBody}))}};var pm={};um.request=function(e,t){var n=pm[e];if(n)return n(t)},um.reqres={setHandler:function(e,t){pm[e]=t},removeHandler:function(e){delete pm[e]}};var fm=[],hm=null,dm=function(){(hm=document.createElement("SPAN")).id="cobrowsing-mouse-container",document.body.appendChild(hm);var e=new MutationObserver((function(){var e,t,n=document.body.childNodes[document.body.childNodes.length-1];n!==hm&&-1===fm.indexOf(n)&&(e=document.body,(t=e.childNodes[e.childNodes.length-1])!==hm&&(fm.push(t),setTimeout((function(){fm=[]}),1e4),e.appendChild(hm)))}));return e.observe(document.body,{childList:!0}),{unsubscribe:function(){e.disconnect()}}},bm=function(){function e(t){var n=t.duration;s(this,e),this.duration=n}return c(e,[{key:"perform",value:function(){um.vent.trigger("trigger_expand_reactive",{duration:this.duration})}}]),e}(),vm=function(){function e(t){var n=t.text,r=t.no_operators_online_text,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o}return c(e,[{key:"perform",value:function(){um.vent.trigger("trigger_reactive_callout",{text:this.text,noOperatorsOnlineText:this.noOperatorsOnlineText,duration:this.duration,priority:this.priority})}}]),e}(),mm=function(){function e(t){var n=t.text;s(this,e),this.text=n}return c(e,[{key:"perform",value:function(){um.vent.trigger("trigger_media_selection",{text:this.text,source:"callout"})}}]),e}(),ym=function(){function e(){s(this,e)}return c(e,[{key:"perform",value:function(){um.vent.trigger("reactive_bar:enable")}}]),e}(),gm=function(){function e(){s(this,e)}return c(e,[{key:"perform",value:function(){um.vent.trigger("reactive_bar:disable")}}]),e}(),_m=function(){function e(t){var n=t.vertical_offset,r=t.horizontal_offset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r}return c(e,[{key:"perform",value:function(){um.vent.trigger("reactive_bar:set_position",{verticalOffset:this.verticalOffset,horizontalOffset:this.horizontalOffset})}}]),e}(),wm=function(e){var t=e.category,n=e.action,r=e.label;em.info("Tracking Google Analytics Event",{category:t,action:n,label:r}),window._gaq&&window._gaq.push?window._gaq.push(["_trackEvent",t,n,r]):"function"==typeof window.ga&&window.ga("send","event",t,n,r)},Om=function(){function e(t){s(this,e),this.options=t}return c(e,[{key:"perform",value:function(){switch(this.options.provider){case"google":this.trackGoogle(this.options);break;case"omniture":this.trackOmniture(this.options);break;default:em.error("Unknown analytics provider",this.options.provider)}}},{key:"trackGoogle",value:function(e){var t=e.category,n=e.action,r=e.fields;wm({category:t,action:n,label:r?JSON.stringify(r):void 0})}},{key:"trackOmniture",value:function(e){!function(e){var t=e.tagFunction,n=e.tagId,r=e.params;em.info("Tracking Omniture Analytics Event",{tagFunction:t,tagId:n,params:r});try{"function"==typeof window[t]&&window[t](n,A.clone(r))}catch(e){em.warn("Client error occurred during Omniture event tracking",e)}}({tagFunction:e.tag_function,tagId:e.tag_id,params:e.fields})}}]),e}(),Em=function(e,t){var n=t.operator;return n&&-1!==n.teamNames.indexOf(e)},Sm=function(){function e(t){var n=t.operator_team;s(this,e),this.operatorTeam=n}return c(e,[{key:"perform",value:function(e){e.cobraObservable.filter(A.partial(Em,this.operatorTeam)).pluck("cobraSourceInitializer").subscribe((function(e){return e.block()}))}}]),e}(),Tm=function(){function e(t){var n=t.text,r=t.duration;s(this,e),this.text=n,this.duration=r}return c(e,[{key:"perform",value:function(){um.vent.trigger("show_engagement_invitation",{text:this.text,duration:this.duration})}}]),e}(),xm=A.compose(A.isEmpty,A.symmetricDifference);(sm.BusinessRules={}).ACTION_TYPES={SHOW_OPERATORS_IN_SELECTOR_V2:"show_operators_in_selector_v2"};var Am=function(e){var t=e.event,n=e.site_id,r=e.tab_id;return"business_rules"===t&&n===sm.siteId&&(!r||r===sm.tabId)},km=function(){function e(){s(this,e)}return c(e,[{key:"perform",value:function(){}}]),e}(),Im=function(){function e(t){s(this,e),this.expectedAction=t}return c(e,[{key:"perform",value:function(){throw new Error("No handler found for action ".concat(this.expectedAction))}}]),e}(),Nm={expand_operator_selector:bm,reactive_callout:vm,media_selection:mm,show_reactive_tab_only_when:ym,hide_reactive_tab:gm,set_reactive_tab_position:_m,show_operators_in_selector_v2:km,send_analytics_event:Om,hide_page_from_operators:Sm,show_engagement_invitation:Tm},Rm=new Pe,Cm=Rm.pipe(Nb());Cm.connect();var Pm=function(){function e(t){var n=t.volatileNotifications,r=t.cobraObservable,i=t.routingObservable;s(this,e),this._performAction=this._performAction.bind(this),this.cobraObservable=r,this.routingObservable=i,this.actionsObservable=Cm.pipe(db(n.pipe(tb(Am),lb(A.prop("payload"))))),this._routingUpdateTimeout=sm.conf.overseer.routing_update_timeout_in_milliseconds}return c(e,[{key:"start",value:function(){return this.actionsObservable.subscribe(this._performAction)}},{key:"_performAction",value:function(e){var t=e.type,n=e.rule_id,r=e.browser_event_conditions,i=this.cobraObservable,o=function(e,t){var n=Nm[e];return n?new n(t):new Im(e)}(t,e);(function(e){var t=e.expectedQueueIds,n=e.routingObservable,r=e.routingUpdateTimeout,i=e.loggerMetadata,o=void 0===i?{}:i,s=e.logger,a=void 0===s?em:s;return t?n.pipe(tb((function(e){var n=e.queue_ids;return!(!n||!t)&&xm(n,t)})),Zb(1),av(r),Pd((function(e){return"TimeoutError"===e.name?a.warn("In-browser business rule action not triggered, expected queue ids not received",A.merge(o,{queue_ids:t})):a.error("In-browser business rule action triggering error",e),on()}))):mt(null)})({expectedQueueIds:A.prop("queue_ids",r),routingUpdateTimeout:this._routingUpdateTimeout,routingObservable:this.routingObservable,loggerMetadata:{type:t,rule_id:n}}).subscribe((function(){return o.perform(i)}),(function(e){return em.error("Error from should trigger in-browser action subscription",e)}))}}],[{key:"triggerAction",value:function(e){Rm.next(e)}},{key:"actionTriggers",value:function(e,t){return Cm.pipe(db(e.pipe(tb(Am),lb(A.prop("payload")))),tb((function(e){return e.type===t})))}}]),e}();sm.BusinessRules.Controller=Pm;var Mm=function(e){return{element_text:e.textContent,element_id:e.id,element_tag_name:e.tagName,element_class_name:e.className}},jm=function(e){return!function(e){return 0===e.offsetWidth&&0===e.offsetHeight||e.style&&"none"===e.style.display}(e)},qm=function(e){for(var t=e.parentElement,n=[];null!==t;)n.push(t),t=t.parentElement;return n},Lm=function(e){return Array.prototype.slice.call(e)},Um=function(e,t){return(e.matches||e.msMatchesSelector).call(e,t)},Vm=1,Dm=10;function Fm(e){if(!e)return null;for(var t=[];e&&e.nodeType===Vm;e=e.parentNode){for(var n=0,r=e.previousSibling;r;r=r.previousSibling)r.nodeType!==Dm&&r.nodeName===e.nodeName&&++n;var i=(e.prefix?e.prefix+":":"")+e.localName,o="["+(n+1)+"]";t.splice(0,0,i+o)}return t.length?"/"+t.join("/"):null}var Bm=new RegExp(/\/([^/[]+)\[(\d+)\]/g),Wm=new RegExp(/:nth-of-type\(1\)/g);function Hm(e,t){if("/"===t)return e;if(t){var n=t.replace(Bm,"$1:nth-of-type($2) > ").slice(0,-2).replace(Wm,"");return e.querySelector(n)}return null}var Gm=function(e,t){return zv.Observable.fromEventPattern((function(n){return e.addEventListener(t,n)}),(function(n){return e.removeEventListener(t,n)}))},zm=function(e,t){return zv.Observable.fromEventPattern((function(n){return e.on(t,n)}),(function(n){return e.off(t,n)}))},Jm=function(e){return zv.Observable.create((function(t){var n=e.subscribe(t);return function(){return n.unsubscribe()}}))},Qm=function(e){return zv.Observable.create((function(t){var n=e.subscribe(t.next.bind(t),t.error.bind(t),t.complete.bind(t));return function(){return n.dispose()}}))},Ym=function(e){return e.flatMap((function(e){return zv.Observable.throw(e)}))},Km=function(e){return zv.Observable.create((function(t){e.connect(),e.subscribe(t)}))},Xm=function(e,t){var n=t.maxRetries,r=t.calculateDelay,i=t.shouldRetry,o=void 0===i?A.always(!0):i,s=t.scheduler,a=void 0===s?zv.Scheduler.asap:s;return e.retryWhen((function(e){return function(e,t){return e.scan((function(e,n){return u({count:e.count+1},t,n)}),{count:0})}(e,"error").flatMap((function(e){var t=e.count,i=e.error;return o(i)&&t<=n?zv.Observable.timer(r(t),a):zv.Observable.throw(i)}))}))},$m=function(e){var t=e.target,n=e.selector;return"function"==typeof t.msMatchesSelector?t.msMatchesSelector(n):"function"==typeof t.matches&&t.matches(n)},Zm=function(e){var t=e.pattern;return-1!==e.element.textContent.indexOf(t)},ey=function(e){return e&&e.nodeType===Vm},ty=function(e){var t=e.selector;return t&&-1!==t.indexOf(":contains")},ny=function(e){var t=e.selector,n=t.replace(/'/g,'"').match(/(.*):contains\("([^"]+)"/);if(A.isNil(n))throw new Error("Failed to match :contains selector - ".concat(t));var r=n[1].trim(),i=n[2].trim();if(A.isEmpty(r))throw new Error("The :contains selector has no tag to match");return{cssSelector:r,containsText:i}},ry=function(e){return ty({selector:e})?function(e){var t=e.selector,n=ny({selector:t}),r=n.cssSelector,i=n.containsText,o=Lm(document.querySelectorAll(r));return A.filter((function(e){return Zm({pattern:i,element:e})}),o)}({selector:e}):Lm(document.querySelectorAll(e))},iy=function(e,t){return Ln.apply(void 0,_(A.map((function(t){return Gm(t,e)}),t)))},oy=function(e){var t=e.elementSelector,n=e.eventName;return iy(n,ry(t))},sy=function(e){var t=e.target,n=e.selector;if(!ey(t))return!1;if(ty({selector:n})){var r=ny({selector:n}),i=r.cssSelector,o=r.containsText;return $m({target:t,selector:i})&&Zm({pattern:o,element:t})}return!A.isEmpty(n)&&$m({target:t,selector:n})},ay=function(){function e(t){var n=t.id,r=t.form_selector,i=t.input_selector,o=t.value;s(this,e),this.filteredValueOrFocusout=this.filteredValueOrFocusout.bind(this),this._valueMatching=this._valueMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.formSelector=r,this.inputSelector=i,this.value=o}return c(e,[{key:"track",value:function(){return Ln(this._trackTextFields(),this._trackChangeableFields(),this._trackCheckableFields()).pipe(lb(this._formatEvent))}},{key:"_trackTextFields",value:function(){var e;try{e=iy("keyup",this._getObservableFields("input[type=text], input:not([type]), textarea"))}catch(t){this._recordInvalidSelector(t),e=on()}return e.pipe(tb(this._valueChangingKey),lb(this._extractValueFromInput),Qd(A.equals),tb(this._valueMatching),Xb(this.filteredValueOrFocusout))}},{key:"_trackChangeableFields",value:function(){var e;try{e=iy("change",this._getObservableFields("select"))}catch(t){this._recordInvalidSelector(t),e=on()}return e.pipe(lb(this._extractValueFromOption),Qd(A.equals),tb(this._valueMatching))}},{key:"_trackCheckableFields",value:function(){var e;try{e=iy("change",this._getObservableFields("input[type=radio], input[type=checkbox]"))}catch(t){this._recordInvalidSelector(t),e=on()}return e.pipe(lb(this._extractValueFromInput),tb(this._valueMatching))}},{key:"_getObservableFields",value:function(e){if(this.inputSelector)return Lm(document.querySelectorAll(this.inputSelector)).filter((function(t){return sy({target:t,selector:e})}));if(this.formSelector){var t=Lm(document.querySelectorAll("form"+this.formSelector));return A.unnest(A.map((function(t){return Lm(t.querySelectorAll(e))}),t))}return Lm(document.body.querySelectorAll(e))}},{key:"filteredValueOrFocusout",value:function(e){return this.value?mt(e):Gm(e.target,"focusout").pipe(pb(e))}},{key:"_valueChangingKey",value:function(e){return e.keyCode>=45}},{key:"_valueMatching",value:function(e){var t=e.target.value;return!this.value||t.match(new RegExp(this.value))}},{key:"_extractValueFromInput",value:function(e){return{target:e.target,value:e.target.value}}},{key:"_extractValueFromOption",value:function(e){var t=A.find((function(e){return e.selected}),Lm(e.target.querySelectorAll("option")));return{target:e.target,value:t&&t.value}}},{key:"_formatEvent",value:function(e){var t=e.target,n=e.value;return{id:this.id,type:"form_filling",source_attributes:A.merge(Mm(t),{value:n})}}},{key:"_recordInvalidSelector",value:function(e){tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:form_filling","reason:invalid_selector"]),em.warn("Failed to track form filling. Invalid selector",{error:e,form_selector:this.formSelector,input_selector:this.inputSelector,source_id:this.id})}}]),e}(),cy="clicking",uy=function(){function e(t){var n=t.id,r=t.element_selector,i=t.element_tag,o=t.number,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:em,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:500;s(this,e),this._isTargetElementsOrItsChild=this._isTargetElementsOrItsChild.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.elementTag=i,this.number=o,this.logger=a,this.throttleTime=c}return c(e,[{key:"track",value:function(){var e,t,n=this,r=(e=document,t="click",zv.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!0)}),(function(n){return e.removeEventListener(t,n,!0)}))).pipe(tb((function(e){return n._isTargetElementsOrItsChild(e.target)}))),i=this.number||1;return function(e,t){var n=e.events,r=e.throttleTime,i=e.numberToTrigger;return n.pipe(ov(r,t),Gb(i-1))}({events:r,throttleTime:this.throttleTime,numberToTrigger:i}).map(this._formatEvent)}},{key:"_isTargetElementsOrItsChild",value:function(e){var t=this._getElementsSelector();try{var n=ry(t);return A.intersection(n,function(e){for(var t=[];e;)t.push(e),e=e.parentElement;return t}(e)).length>0}catch(e){return tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(cy),"reason:invalid_selector"]),this.logger.warn(e,"Failed to query DOM element",{elementSelector:t}),!1}}},{key:"_getElementsSelector",value:function(){return this._tagConstraint()+this._selectorConstraint()}},{key:"_tagConstraint",value:function(){return this.elementTag||""}},{key:"_selectorConstraint",value:function(){return this.elementSelector?"".concat(this.elementSelector):""}},{key:"_formatEvent",value:function(e){return{id:this.id,type:cy,source_attributes:Mm(e.target)}}}]),e}();var ly=function(){function e(t){var n=t.source_id;s(this,e),this.saveNavigationEvent=this.saveNavigationEvent.bind(this),this.clear=this.clear.bind(this),this._getHistory=this._getHistory.bind(this),this._formatHistory=this._formatHistory.bind(this),this.key="sm_navigations-"+n,this.storage=window.sessionStorage}return c(e,[{key:"saveNavigationEvent",value:function(e){this.storage.setItem(this.key,this._formatHistory(e))}},{key:"anyMatch",value:function(e){return A.any((function(t){return t.match(e)}))(this._getHistory())}},{key:"clear",value:function(){this.storage.removeItem(this.key)}},{key:"_getHistory",value:function(){try{return JSON.parse(this.storage.getItem(this.key))||[]}catch(e){return sm.logger.error("Unexpected format for navigation history in sessionStorage",{error:e}),this.clear(),[]}}},{key:"_formatHistory",value:function(e){var t=A.takeLast(2,A.append(e,this._getHistory()));return JSON.stringify(t)}}]),e}();var py=!1;try{var fy=Object.defineProperty({},"passive",{get:function(){return py=!0}});window.addEventListener("sm-passive-test",null,fy),window.removeEventListener("sm-passive-test",null,fy)}catch(e){}var hy=function(e,t){return zv.Observable.fromEventPattern((function(n){return e.addEventListener(t,n,!!py&&{passive:!0})}),(function(n){return e.removeEventListener(t,n)}))},dy={getStream:function(e){var t,n=A.map((function(e){return hy(document,e)}),e);return zv.Observable.merge((t=zv.Observable).merge.apply(t,_(n)),hy(window,"focus"),hy(window,"pageshow"))}};sm.PeriodicalActivityTracker=dy;var by=function(){var e=g(void 0!==document.hidden?["hidden","visibilitychange"]:void 0!==document.mozHidden?["mozHidden","mozvisibilitychange"]:void 0!==document.msHidden?["msHidden","msvisibilitychange"]:["webkitHidden","webkitvisibilitychange"],2),t=e[0],n=e[1];if(void 0===document.addEventListener||void 0===t)return zv.Observable.of({focused:void 0});var r=function(){return{visible:!document[t]}};return hy(document,n).map(r).startWith(r())},vy=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},my=function(e){return"object"===o(e)&&Boolean(e&&e.messageName)},yy=function(e,t,n){var r={messageName:e,payload:t};return n&&(r.options=n),r};function gy(e){var t=this,n=new _y({allowedSource:e});["on","off","start","stop","respondTo"].forEach((function(e){t[e]=n[e].bind(n)})),this.observable=function(e){return zm(n,e)},this.emit=function(t,n,r){e.postMessage(yy(t,n,r),"*")},this.request=function(e,n,r){var i=e+":response",o=vy();t.on(i,(function e(n,s,a,c){c&&c.requestId===o&&(t.off(i,e),r(n,s,a))})),t.emit(e,n,{requestId:o})}}function _y(e){var t=this,n=e.allowAnySource,r=e.allowedSource;if(n&&r)throw new Error("Pass allowedSource or allowAnySource, not both");if(!n&&!r)throw new Error("Pass allowedSource or allowAnySource");var i=function(e){if((n||e.source===r)&&my(e.data)){var i=e.data,o=i.messageName,s=i.payload,a=i.options;return t.emitEvent(o,[s,e.source,e.origin,a])}};this.start=function(){window.addEventListener("message",i)},this.stop=function(){window.removeEventListener("message",i),t.removeEvent()},this.respondTo=function(e,n){var r=function(t,r,i,o){n(t,(function(t){return r.postMessage(yy(e+":response",t,o),i)}),r,i)};return t.on(e,r),function(){return t.off(e,r)}}}_y.prototype=Object.create(x.prototype);var wy=null,Oy=function(){if(!wy){var e=dy.getStream(["scroll","keyup","mousemove","touchstart","orientationchange"]).share(),t=new _y({allowAnySource:!0});t.start();var n=zm(t,"activity_from_cobrowsable_iframe"),r=by().filter(A.propEq("visible",!0));(wy=zv.Observable.merge(e,n,r).publish()).connect()}return wy};var Ey=function(e){return e?parseFloat(e.replace(/[^\d\.]+/,"")):null},Sy="number",Ty=function(){function e(t){var n=t.id,r=t.element_selector,i=t.minimum_value;s(this,e),this._elementValues=this._elementValues.bind(this),this._numberMatching=this._numberMatching.bind(this),this._formatEvent=this._formatEvent.bind(this),this.id=n,this.elementSelector=r,this.minimumValue=i}return c(e,[{key:"track",value:function(){return jn(100).pipe(mb(this._elementValues),tb(this._numberMatching),lb(this._formatEvent),Zb(1))}},{key:"_elementValues",value:function(){var e;try{e=Lm(document.querySelectorAll(this.elementSelector))}catch(t){tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(Sy),"reason:invalid_selector"]),em.warn("Failed to track number. Invalid selector",{error:t,element_selector:this.elementSelector,source_id:this.id}),e=[]}return Bt(A.flatten(e.map(this._elementValue)))}},{key:"_elementValue",value:function(e){return[{element:e,value:Ey(e.innerHTML)},{element:e,value:Ey(e.value)}]}},{key:"_numberMatching",value:function(e){var t=e.value;return"number"==typeof t&&t>=this.minimumValue}},{key:"_formatEvent",value:function(e){var t=e.element,n=e.value;return{id:this.id,type:Sy,source_attributes:A.merge(Mm(t),{value:n})}}}]),e}();var xy={attributes:!0,characterData:!1,childList:!1,subtree:!1,attributeOldValue:!1,characterDataOldValue:!1};var Ay={text:"chat",audio:"voice",phone:"phone",video:"video"};var ky=function(){function e(){s(this,e)}return c(e,[{key:"track",value:function(){return on()}}]),e}(),Iy={form_filling:ay,clicking:uy,time_on_page:function(e){var t=e.id,n=e.seconds,r=function(){return{id:t,type:"time_on_page",source_attributes:{}}};this.track=function(){return dr(1e3*n).pipe(lb(r))}},mouse_in:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_in",source_attributes:Mm(e.target)}};this.track=function(){try{return oy({elementSelector:n,eventName:"mouseenter"}).pipe(lb(r))}catch(e){return tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_in","reason:invalid_selector"]),em.warn("Failed to track mouse in. Invalid selector",{error:(null==e?void 0:e.message)||e,element_selector:n,source_id:t}),on()}}},mouse_out:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"mouse_out",source_attributes:Mm(e.target)}};this.track=function(){try{return oy({elementSelector:n,eventName:"mouseleave"}).pipe(lb(r))}catch(e){return tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:mouse_out","reason:invalid_selector"]),em.warn("Failed to track mouse out. Invalid selector",{error:e,element_selector:n,source_id:t}),on()}}},scrolling:function(e){var t=e.id,n=e.percentage,r=function(){return{id:t,type:"scrolling",source_attributes:{}}},i=function(){var e=window.pageYOffset,t=window.innerHeight;return e/(document.documentElement.scrollHeight-t)*100>n};this.track=function(){return Gm(window,"scroll").pipe(tb(i),lb(r),Zb(1))}},navigation:function(e){var t=e.id,n=e.path,r=function(){return{id:t,type:"navigation",source_attributes:{}}};this.track=function(){var e=new RegExp(n,"i");return sm.hrefObservable.pipe(tb((function(t){return t.match(e)})),lb(r))}},activity:function(e){var t=e.id,n=function(){return{id:t,type:"activity",source_attributes:{}}};this.track=function(){return dr(6e4).pipe(yb(Oy()),Zb(1),Pb(),lb(n))}},number:Ty,element_created:function(e){var t=e.id,n=e.element_selector,r=e.on_page_load;this.track=function(e){var i=e.options;return n?i.initialLoad&&!r?on():mt({id:t,type:"element_created",source_attributes:{}}):on()}},element_changed:function(e){var t=e.id,n=e.element_selector,r=function(e){return{id:t,type:"element_changed",source_attributes:Mm(e.target)}};this.track=function(e){var i=e.options,o=i.triggerObservable,s=i.mutationObserver;try{ry(n).forEach((function(e){s.observe(e,xy)}))}catch(e){tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:element_changed","reason:invalid_selector"]),em.warn("Failed to observe element changes. Invalid selector",{error:e,element_selector:n,source_id:t})}return o.pipe(lb(r))}},transfer:function(e){var t=e.id,n=function(e){return{id:t,type:"transfer",source_attributes:{operator_id:e.operatorId,operator_name:e.operatorName,starting_media:e.startingMedia}}};this.track=function(){return um.vent.observable(um.MSG.ENGAGEMENT_TRANSFERRED).pipe(lb(n))}},proactive_accept:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_accept",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return um.vent.observable(um.MSG.PROACTIVE_ACCEPT).pipe(Jd(A.prop("engagement_request_id")),lb(n))}},proactive_decline:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"proactive_decline",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return um.vent.observable(um.MSG.PROACTIVE_DECLINE).pipe(lb(n))}},engagement_start:function(e){var t=e.id,n=function(e){var n=e.operator,r=e.startingMedia,i=e.engagementId,o=e.type;return{id:t,type:"engagement_start",source_attributes:{operator_id:n.id,operator_name:n.name,proactive_or_reactive:o,engagement_media:Ay[r],engagement_id:i}}};this.track=function(){return vn(sm.getApi({version:"v1"})).pipe(mb((function(e){return e.observable(e.EVENTS.ENGAGEMENT_START)})),tb(A.complement(A.prop("isReestablishing"))),lb(n))}},reactive_engagement_request_timeout:function(e){var t=e.id,n=function(e){var n=e.operator;return{id:t,type:"reactive_engagement_request_timeout",source_attributes:{operator_id:n.id,operator_name:n.name}}};this.track=function(){return um.vent.observable(um.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT).pipe(lb(n))}},consecutive_navigation:function(e,t){var n=e.id,r=e.to,i=e.from,o=t||new ly({source_id:n}),s=function(){return o.anyMatch(new RegExp(i,"i"))},a=function(){return{id:n,type:"consecutive_navigation",source_attributes:{}}};this.track=function(){return sm.hrefObservable.pipe(tb((function(e){return e.match(new RegExp(i,"i"))}))).subscribe(o.saveNavigationEvent),sm.hrefObservable.pipe(tb(A.both((function(e){return e.match(new RegExp(r,"i"))}),s)),rv(o.clear),lb(a))}},enqueued:function(e){var t=e.id;this.track=function(e){var n=e.internalVisitorStateObservable,r=["enqueued","request_sent"],i=A.propEq("site_id",sm.siteId),o=A.compose(A.filter(i),A.pathOr([],["omniq","queue_tickets"])),s=A.compose(A.nth(0),A.filter((function(e){var t=A.lensPath(["visitor","browser_tab_id"]);return A.compose(A.equals(sm.tabId),A.view(t))(e)})),A.filter((function(e){return-1!==r.indexOf(e.state)})),o);return n.pipe(lb(s),tb(A.identity),Qd(null,A.prop("id")),lb((function(e){return{id:t,type:"enqueued",source_attributes:{ticket_id:e.id}}})))}}},Ny={buildObservable:A.curry((function(e,t,n){var r=function(e){var t=e.sources,n=e.internalVisitorStateObservable,r=e.options;return 0===Object.keys(t).length?on():new(Iy[t.type]||ky)(t).track({internalVisitorStateObservable:n,options:r})}({sources:t.sources,internalVisitorStateObservable:e,options:n});return t.url_matcher?r.pipe(vv(function(e){var t=new RegExp(e,"i");return sm.hrefObservable.pipe(lb((function(e){return e.match(t)})),Qd(A.equals))}(t.url_matcher),(function(e,t){return{value:e,isMatching:t}})),tb(A.prop("isMatching")),lb(A.prop("value"))):r}))},Ry=function(){function e(){s(this,e)}return c(e,null,[{key:"observable",value:function(e,t){var n=this._selectorsToObserveOnElementCreated(e.sources);return n.length>0?this._trackCreatedElements(e,n,t):mt({})}},{key:"_trackCreatedElements",value:function(e,t,n){var r=this._initiateSourceAttributes(e.sources);return n.pipe(lb((function(e){return{target:e,initialLoad:!1}})),Yb({target:document.body,initialLoad:!0}),tb(this._filterBySourceType({source:e.sources,selectors:t,rawRule:e})),lb(A.pick(["initialLoad"])),lb(A.merge(r)))}},{key:"_filterBySourceType",value:function(e){var t=this,n=e.source,r=e.selectors,i=e.rawRule;return function(e){var o=e.target;return!(!e.initialLoad||"element_created"===n.type)||t._targetMatchesAny(o,r,i,n)}}},{key:"_initiateSourceAttributes",value:function(e){switch(e.type){case"element_changed":return this._getElementChangedAttributes(e);default:return{}}}},{key:"_getElementChangedAttributes",value:function(e){var t=new Pe,n=new MutationObserver((function(n){return A.forEach((function(n){if(sy({target:n.target,selector:e.desired_selector}))return t.next(n)}),n)}));return{triggerObservable:t.asObservable(),mutationObserver:n}}},{key:"_selectorsToObserveOnElementCreated",value:function(e){switch(e.type){case"form_filling":return[e.form_selector,e.input_selector];case"mouse_in":case"mouse_out":case"element_changed":case"element_created":return[e.element_selector];default:return[]}}},{key:"_targetMatchesAny",value:function(e,t,n,r){return A.any((function(t){try{return sy({target:e,selector:t})||function(e){var t=e.target,n=e.selector;return!(!ey(t)||!t.hasChildNodes())&&A.any((function e(t){var r=sy({target:t,selector:n});return!r&&t.hasChildNodes()?A.any(e,t.childNodes):r}),t.childNodes)}({target:e,selector:t})}catch(e){return tm.increment("sm.app.visitor.business_rules.tracker",["action:failed","type:".concat(r.type),"reason:invalid_selector"]),em.warn("Failed to track element. Invalid selector",{error:e&&e.message,selector:t,source_type:r.type,rule_id:n.id}),!1}}),t)}}]),e}();function Cy(e){return(Cy="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Py(e){return function(e){if(Array.isArray(e))return My(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return My(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return My(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function My(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var jy,qy=function(e,t,n){var r={};for(var i in n)r[i]=n[i];return r[e]=t,r},Ly=function(e){return function t(n){return 0===arguments.length?t:e.apply(this,arguments)}},Uy=Ly((function(e){return null===e||"object"!==Cy(e)?e:Array.isArray(e)?e.map((function(e){return Uy(e)})):Object.keys(e).reduce((function(t,n){return qy(function(e){var t=e.split("_");return[t[0]].concat(Py(t.slice(1).map((function(e){return function(e){return"".concat(e.slice(0,1).toUpperCase()).concat(e.slice(1).toLowerCase())}(e)})))).join("")}(n),Uy(e[n]),t)}),{})})),Vy=Ly((function(e){return null===e||"object"!==Cy(e)?e:Array.isArray(e)?e.map((function(e){return Vy(e)})):Object.keys(e).reduce((function(t,n){return qy(n.replace(/\W+/g," ").split(RegExp(" |\\B(?=[A-Z])")).map((function(e){return e.toLowerCase()})).join("_"),Vy(e[n]),t)}),{})})),Dy=(jy=function(e,t){return Object.keys(t).reduce((function(n,r){var i=e[r];if(Array.isArray(i)){var o=t[r];if(!o||"object"!==Cy(o))throw new Error("Nested value should be an object");return qy(i[0]||r,Dy(i[1],o),n)}return qy(i||r,t[r],n)}),{})},function e(t,n){return 0===arguments.length?e:1===arguments.length?Ly((function(e){return jy(t,e)})):jy(t,n)}),Fy=function e(t){var n=t.status,r=t.medias;s(this,e),this.status=n,this.medias=r};Fy.prototype.STATUSES={OPEN:"open",CLOSED:"closed",FULL:"full",UNSTAFFED:"unstaffed"};var By=function(e){return"opened"===e?Fy.prototype.STATUSES.OPEN:e},Wy=function e(t){var n=t.id,r=t.name,i=t.status,o=t.medias;s(this,e),this.id=n,this.name=r,this.state=new Fy({status:i,medias:o})},Hy={SALEMOVE:{ALREADY_QUEUED:"already queued",INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed",FILE_TOO_LARGE:"file too large"}},Gy=5e3,zy=["text","phone","audio","video"],Jy=[502,503],Qy=[400,413,422],Yy="sm_change_element_attributes",Ky="omnicore",Xy="omnibrowse",$y={"content-type":"application/json",accept:"application/vnd.salemove.v1+json"},Zy=["af","al","dz","as","ad","ao","ai","ag","ar","am","aw","au","at","az","bs","bh","bd","bb","by","be","bz","bj","bm","bt","bo","ba","bw","br","io","vg","bn","bg","bf","bi","kh","cm","ca","cv","bq","ky","cf","td","cl","cn","cx","cc","co","km","cd","cg","ck","cr","ci","hr","cu","cw","cy","cz","dk","dj","dm","do","ec","eg","sv","gq","er","ee","et","fk","fo","fj","fi","fr","gf","pf","ga","gm","ge","de","gh","gi","gr","gl","gd","gp","gu","gt","gg","gn","gw","gy","ht","hn","hk","hu","is","in","id","ir","iq","ie","im","il","it","jm","jp","je","jo","kz","ke","ki","xk","kw","kg","la","lv","lb","ls","lr","ly","li","lt","lu","mo","mk","mg","mw","my","mv","ml","mt","mh","mq","mr","mu","yt","mx","fm","md","mc","mn","me","ms","ma","mz","mm","na","nr","np","nl","nc","nz","ni","ne","ng","nu","nf","kp","mp","no","om","pk","pw","ps","pa","pg","py","pe","ph","pl","pt","pr","qa","re","ro","ru","rw","bl","sh","kn","lc","mf","pm","vc","ws","sm","st","sa","sn","rs","sc","sl","sg","sx","sk","si","sb","so","za","kr","ss","es","lk","sd","sr","sj","sz","se","ch","sy","tw","tj","tz","th","tl","tg","tk","to","tt","tn","tr","tm","tc","tv","vi","ug","ua","ae","gb","us","uy","uz","vu","va","ve","vn","wf","eh","ye","zm","zw","ax"],eg=A.compose(A.chain(A.values),A.values)(Hy),tg=function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(s(this,e),this.cause=n.cause,n.message&&(this.message=n.message),this.cause&&A.contains(this.cause,eg))||(this.cause=Hy.SALEMOVE.INTERNAL_ERROR,(t=sm.logger).error.apply(t,["Incorrect Error usage"].concat(Array.prototype.slice.call(arguments))))},ng=function(e){var t=String(e);if(0===t.indexOf("[object "))try{t=JSON.stringify(e)}catch(e){t=e instanceof TypeError?"Unable to parse param: ".concat(e.message):"Unexpected parse error ".concat(e)}return t},rg=function(e,t){t||(t={});var n,r=t.logger||em;return n=e.cause,A.contains(n,A.values(Hy.SALEMOVE))?e:function(e,t){if(e||(e={}),t||(t=em),A.contains(e.status,Jy))return new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR});if(0===e.status||0===e.readyState)return new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT});var n="Uncaught error in 'public' observable. Wrapping as an internal error.";return e.details&&(n+=" Details: ".concat(ng(e.details),".")),e.error&&(n+=" Error: ".concat(ng(e.error),".")),e.debug_message&&(n+=" Debug message: ".concat(ng(e.debug_message),".")),e.message&&(n+=" Message: ".concat(ng(e.message))),t.error(n.substr(0,1e3),e),new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR})}(e,r)},ig=function(e){return e||(e={}),zv.Observable.throw(rg(e))},og=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e instanceof tg)return zv.Observable.throw(e);var n=function(){return A.contains(e.status,Qy)?new tg({cause:Hy.SALEMOVE.INVALID_INPUT}):409===e.status?new tg({cause:Hy.SALEMOVE.CONFLICT}):e.cause===Hy.SALEMOVE.NETWORK_TIMEOUT?e:rg(e)},r=n();return t.allowedCauses&&r.cause!==Hy.SALEMOVE.INTERNAL_ERROR&&!A.contains(r.cause,t.allowedCauses)?(em.error("Unhandled error treated as internal error",{status:e.status,message:e.message,debug_message:e.debugMessage}),zv.Observable.throw(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR}))):zv.Observable.throw(r)},sg="queue:multi",ag={channelObservable:null,topicNotifications:{}},cg=function(e){var t=e.queueId,n=e.name,r=e.state,i=e.medias;return new Wy({id:t,name:n,status:By(r),medias:i})},ug=function(e){var t=e.pubsub,n=e.cache;n||(n=ag);var r=n.channelObservable,i=n.topicNotifications||{};return function(e){var o=A.map(A.concat("queue:"),e);return zv.Observable.create((function(s){if(r){!function(e){var t=e.queueIds,n=e.observer;t.forEach((function(e){var t=i[e];if(t)return n.next(t)}))}({queueIds:e,observer:s}),r.flatMap((function(e){return e.watchNewTopics(o)})).toPromise().catch((function(e){return em.warn("Unable to update queue pubsub channel topics ",e)}))}else(r=t.joinChannel(sg,{topics:o}).do((function(){return em.info("Joined ".concat(sg," topic"))})).publishReplay(1)).connect(),n.channelObservable=r;return r.flatMap((function(e){return e.observable("change")})).map(Dy({queue_id:"queueId"})).filter((function(t){var n=t.queueId;return-1!==e.indexOf(n)})).map(cg).do((function(e){i[e.id]=e})).subscribe(s)}))}},lg=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).scan((function(e,t){var n=A.findIndex(A.propEq("id",t.id))(e);return-1===n?A.append(t,e):A.equals(A.find(A.propEq("id",t.id))(e),t)?e:A.update(n,t,e)}),[]).distinctUntilChanged((function(e,t){return e===t}))};var pg=function(e){var t=e.queueIds;return(0,e.observeQueueStateUpdates)(t).groupBy(A.prop("id")).flatMap((function(e){return e.distinctUntilChanged()}))},fg=function(e,t){if(!e)throw new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is undefined"});if(A.isEmpty(e))throw new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Queue IDs list is empty"});if(!t)throw new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Listener is undefined"})},hg=function(e){var t=e.enabled,n=e.createQueueStateObservable,r=e.createQueueStateAccumulateObservable,i=e.pubsub;r||(r=lg),n||(n=pg);var o=function(e){var n=e.queueIds,o=e.listener;if(t){var s=new zv.Subscription;fg(n,o);try{var a=r({queueIds:n,observeQueueStateUpdates:ug({pubsub:i})});s.add(a.subscribe(o,em.error.bind(em,"Failed to receive queue state list updates")))}catch(e){em.error("Failed subscribe to queue state list updates",e)}return s}};return{subscribe:function(e,r){if(t){var o=new zv.Subscription;fg(e,r);try{var s=n({queueIds:e,observeQueueStateUpdates:ug({pubsub:i})}).publish();o.add(s.subscribe(r,em.error.bind(em,"Failed to receive queue state updates"))),o.add(function(e,t){var n=new zv.Subscription;return n.add(t.bufferCount(e.length).take(1).subscribe((function(e){return em.info("Received initial queue states",{queue_states:A.map((function(e){return{id:e.id,status:e.state.status}}),e)})}))),n.add(t.skip(e.length).subscribe((function(e){return em.info("Received queue state update",{queue_id:e.id,queue_status:e.state.status})}))),n}(e,s)),o.add(s.connect())}catch(e){em.error("Failed subscribe to queue state updates",e)}}},subscribeToList:o,subscribeToListAsObservable:function(e){var t=e.queueIds,n=e.subscribeToListFn;return n||(n=o),t?zv.Observable.create((function(e){return n({queueIds:t,listener:e.next.bind(e)})})):zv.Observable.empty()}}},dg=function(){function e(){s(this,e)}return c(e,[{key:"start",value:function(e,t){var n=t.routingObservable;return this.ruleTracker(t,e).pipe(mb((function(r){var i,o=t.queuesAvailabilityObservable.debounceTime(100,i);return bt(t.currentStatusObservable,o).pipe(Zb(1),lb((function(t){var i=g(t,2),o=i[0],s=i[1];return{overseerApi:e,bufferedEvents:r,currentStatus:o,queuesState:s,routingObservable:n}})))}))).subscribe(this.actUponRules,(function(e){return em.error("Error from business rule subscription: ".concat(A.prop("message",e)||e),e)}))}},{key:"ruleTracker",value:function(t,n,r){var i=t.rules,o=t.domInsertObservable,s=t.buildRuleObservable,a=jn(e.BUFFER_TIME,r).pipe(Jb(n.connectedObservable.pipe(tb(A.equals(!0)),Zb(1))));return Bt(i).pipe(mb(vg),mb(function(e){var t=e.domInsertObservable,n=e.buildRuleObservable;return function(e){return Ry.observable(e,t).pipe(Xb((function(t){return n(e,t)})),lb((function(t){return A.merge({attrs:t},e)})))}}({domInsertObservable:o,buildRuleObservable:s})),pv(a),vb((function(e){return e.toArray()})),mv(a,(function(e,t){return e})),tb((function(e){return e.length>0})))}},{key:"actUponRules",value:function(e){var t=e.overseerApi,n=e.currentStatus,r=e.queuesState,i=e.bufferedEvents,o=e.controller,s=void 0===o?Pm:o,a=["visitor_status"];r&&a.push("queues_availability"),i=A.map((function(e){var t=A.map(A.prop("type"),e.conditions);return!A.isEmpty(A.difference(t,a))?A.merge(e,{actions:[],send_to_server:!0}):e}),i);var c=A.filter((function(e){return function(e){var t=e.event,n=e.currentStatus,r=e.queuesState,i=A.all((function(e){return function(e,t,n){return"visitor_status"===e.type?-1!==e.status.indexOf(t):"queues_availability"!==e.type||function(e,t){var n=g(A.partition(A.pathEq(["state","status"],"open"))(t),2),r=n[0],i=n[1],o=function(t){var n=t.id;return A.contains(n,e.queueIds)};if("can_enqueue"===e.compareType)return A.any(o,r);if("cannot_enqueue"===e.compareType)return A.any(o,i)}(Dy({queue_ids:"queueIds",compare_type:"compareType"},e),n)}(e,n,r)}),t.conditions);i&&em.log("Business rule source matched: ",A.mergeAll([{rule_name:A.prop("name",t)},A.pick(["send_to_server"],t),A.pick(["type","source_attributes"],t.attrs),{url:window.location.href,source_id:t.attrs.id,rule_id:t.id}]));return i}({event:e,currentStatus:n,queuesState:r})}),i),u=A.groupBy((function(e){return e.send_to_server?"serverEvents":"browserEvents"}))(c),l=u.serverEvents||[],p=u.browserEvents||[];c.forEach((function(e){var t=e.actions,n=e.attrs,r=e.id,i=e.name,o=e.browser_event_conditions;if(!A.isEmpty(t))return function(e,t,n,r,i,o){e.forEach((function(e){var s={rule_id:n,rule_name:r,browser_event_conditions:o},a=A.merge(s,function(e,t){t||(t={});if(e.fields){var n=function(e,t){var n={};return t.forEach((function(t){var r=t.key,i=t.value,o=t.custom_value,s="custom"===i?o:e[i];n[r]=s})),n}(A.merge({visitor_id:Qv(),site_id:Xv(),url:window.location.href},t),e.fields);return A.merge(e,{fields:n})}return e}(e,t));!function(e){var t={rule_id:A.prop("rule_id",e),rule_name:A.prop("rule_name",e),action_attributes:A.omit(["rule_id","rule_name"])(e)};em.log("In-browser business rule action triggered",t)}(a),i.triggerAction(a)}))}(t,n.source_attributes,r,i,s,o)})),A.isEmpty(l)||function(e,t,n){e.sourcesTriggered({events:n,resolvedConditions:t,tabId:sm.tabId})}(t,a,A.map((function(e){var t=e.attrs,n=e.id;return A.assoc("rule_id",n,t)}))(l));var f=A.filter((function(e){var t=e.actions;return!A.isEmpty(t)}),p),h=A.map((function(e){var t=e.actions;return{ruleId:e.id,actionTypes:A.pluck("type",t)}}),f);A.isEmpty(h)||function(e){var t=e.overseerApi,n=e.browserEvents;t.actionsShortcircuited({browserEvents:n})}({overseerApi:t,browserEvents:h})}}],[{key:"init",value:function(t,n){var r=n.currentStatusObservable,i=n.internalVisitorStateObservable,o=n.rules,s=n.queuesAvailabilityObservable,a=n.routingObservable,c=Ee.create((function(e){var t=new MutationObserver((function(t){return A.forEach((function(t){return A.forEach((function(t){if(t instanceof HTMLElement)return e.next(t)}),t.addedNodes)}),t)}));return t.observe(document.body,{attributes:!1,characterData:!1,childList:!0,subtree:!0,attributeOldValue:!1,characterDataOldValue:!1}),function(){return t.disconnect()}})),u=Ny.buildObservable(i);return(new e).start(t,{currentStatusObservable:r,queuesAvailabilityObservable:s,rules:o,domInsertObservable:c,buildRuleObservable:u,routingObservable:a})}}]),e}();function bg(e){return e.operator?bg(e.left).concat(bg(e.right)):[e]}function vg(e){var t;t=Array.isArray(e.sources)?e.sources:bg(e.sources);var n=A.map((function(t){return A.assoc("sources",t,e)}),t);return Bt(n)}dg.BUFFER_TIME=100;var mg=function(e){return{response:(t=e,t instanceof XMLHttpRequest?e.response:e)};var t},yg=function(e){var t=e.stats,n=e.protocol,r=e.failureTagProperty,i=e.timeout,o=e.timeoutError,s=e.logResponse,a=e.scheduler;return function(e,c){var u=e.resource,l=e.method,p=t.statApiUsage({protocol:n,resource:u})(l).attempted();return c().do(p.succeeded,A.compose(p.failed,A.prop(r))).timeoutWith(i,o.do(null,p.timedOut),a).do((function(e){var t={};!1!==s&&(t=mg(e)),em.log("Successfully executed '".concat(l,"' on resource ").concat(u),t)}),(function(e){return em.warn("Failed to execute '".concat(l,"' on resource ").concat(u),mg(e))})).finally((function(){if(!p.isFinished())return p.failed("aborted")}))}},gg=new Error({cause:"Internal error"});function _g(e,t){var n=e.wsProxy,r=e.stats,i=yg({stats:r,protocol:"rest",failureTagProperty:"message",timeout:5e3,timeoutError:lr(gg),scheduler:t}),o=function(){return{visitor_id:Qv(),site_id:Xv(),url:window.location.href}};return{sourcesTriggered:function(e){var t=e.events,r=e.tabId,s=e.resolvedConditions;return i({resource:"overseer",method:"sources_triggered"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/sources_triggered"),payload:A.merge(o(),{events:t,tab_id:r,resolved_conditions:s}),headers:{"content-type":"application/json"}})})).subscribe((function(){}),(function(){}))},actionsShortcircuited:function(e){var t=e.browserEvents,r={browser_events:A.map((function(e){return{rule_id:e.ruleId,action_types:e.actionTypes}}),t)};return i({resource:"overseer",method:"actions_shortcircuited"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/overseer/actions_shortcircuited"),payload:A.merge(o(),r),headers:{"content-type":"application/json"}})})).subscribe((function(){}),(function(){}))},connectedObservable:n.connectedObservable}}var wg=function(e){var t=function(e){return A.compose(A.reject(A.isNil),A.chain(A.prop("queue_ids")),A.chain(A.prop("conditions")))(e)}(e)||[],n=function(e){return A.compose(A.reject(A.isNil),A.chain(A.path(["browser_event_conditions","queue_ids"])))(e)}(e)||[],r=t.concat(n);return A.uniq(r)},Og=function(e){return A.filter(A.compose(A.or(A.isEmpty,A.isNil),A.chain(A.propOr([],"queue_ids")),A.prop("conditions")))(e)},Eg=function(e){return A.filter(A.compose(A.isEmpty,A.pathOr([],["browser_event_conditions","queue_ids"])))(e)};function Sg(e){var t=e.cobraObservable,n=e.internalVisitorStateObservable,r=e.volatileNotifications,i=e.stats,o=e.wsProxy,s=e.currentStatusObservable,a=e.queuesStateUpdatesObservable,c=e.routingObservable;new Pm({volatileNotifications:r,cobraObservable:t,routingObservable:c}).start();var u=new _g({wsProxy:o,stats:i}),l=sm.conf.overseer.rules,p=sm.conf.omniq.omniq_enabled?l:function(e){return A.compose(Og,Eg)(e)}(l),f=wg(p),h=function(){if(A.not(A.isEmpty(f))){var e=new zv.ReplaySubject(1);return a.subscribeToList({queueIds:f,listener:e.next.bind(e)}),e}return zv.Observable.of(null)}();dg.init(u,{currentStatusObservable:s.startWith("available"),internalVisitorStateObservable:n,queuesAvailabilityObservable:h,rules:p,routingObservable:c})}function Tg(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=!1!==r.rethrow;return function(){try{return n.apply(this,arguments)}catch(n){if(tm.clientHandlerError(t),em.warn(e,n),i)throw n;console.error(n)}}}var xg=A.curryN(2,(function(e,t){return A.compose(A.forEach((function(t){var n=g(t,2),r=n[0],i=n[1];return e(r,i)})),A.toPairs)(t)})),Ag=function(){var e={},t=function(e,t){return Tg("Event handler for ".concat(e," threw an error"),e,t,{rethrow:!1})},n=function(n,r){var i=(e[n]||{}).listenerEntries||[],o=A.compose(A.map((function(e){var i=e.listener;return{listener:i,subscription:r.subscribe(t(n,i),em.error)}})),A.forEach((function(e){return e.subscription.unsubscribe()})))(i);e[n]={observable:r,listenerEntries:o}};return{observable:function(t){return e[t].observable},addEventListener:function(n,r){var i=e[n]||{},o=i.listenerEntries||[],s=i.observable;if(!A.any(A.propEq("listener",r),o)){var a=s?s.subscribe(t(n,r),em.error):zv.Subscription.EMPTY,c=A.append({listener:r,subscription:a},o);return e[n]={listenerEntries:c,observable:s},null}},removeEventListener:function(t,n){var r=e[t]||{},i=r.listenerEntries||[],o=r.observable,s=A.find(A.propEq("listener",n))(i);if(s){s.subscription.unsubscribe();var a=A.without([s])(i);e[t]={observable:o,listenerEntries:a}}return null},proxy:n,proxyAll:xg(n),eventWithoutListenerObservable:function(t){return(e[t]||{}).observable.filter((function(){return!function(t){var n=(e[t]||{}).listenerEntries||[];return A.not(A.isEmpty(n))}(t)}))},stop:function(){A.compose(A.forEach((function(e){return e.unsubscribe()})),A.map(A.prop("subscription")),A.chain(A.prop("listenerEntries")),A.values)(e),e={}}}},kg=function(){var e=new zv.Subscription,t=Ag(),n=function(n,r){var i=r.publishReplay(1);e.add(i.connect()),t.proxy(n,i)};return{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener,eventWithoutListenerObservable:t.eventWithoutListenerObservable,proxy:n,proxyAll:xg(n),stop:function(){e.unsubscribe(),t.stop()},observable:t.observable}};function Ig(e){var t=kg();return t.proxy("change",e),{addEventListener:t.addEventListener,removeEventListener:t.removeEventListener}}var Ng=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:sm.tracker;return Ig(e.getUserIsActiveTabObservable())},Rg=function(){return Ig(zv.Observable.of(!0))};function Cg(e){var t=e.channelObservable,n=e.logger.withTags({feature:"cobra"}),r=t.flatMap((function(e){var t=e.channel,n=e.operator;return cm("Cobra").map((function(e){return{Cobra:e,channel:t,operator:n}}))})).distinctUntilChanged(null,(function(e){return e.channel.url})).switchMap((function(e){var t=e.Cobra,r=e.channel,i=e.operator,o=new t.SourceInitializer(r,Ng(),i.id,n),s=o.initialize(),a=function(){return o.stop()};return r.addDestroyListener((function(){return a()})),zv.Observable.create((function(e){return e.next({cobraSourceInitializer:o,cobraSource:s,operator:i}),function(){return a()}}))})).do((function(e){var t=e.operator;return n.info("Cobra: Started successfully",{operator_id:t.id})}),n.error.bind(n,"Cobra: Failed to start"),(function(){return n.info("Cobra: Stopped and will not start again")})),i=r.publishReplay(1);return sm.cobraSubscription=i.connect(),{cobraObservable:r=i.filter(A.pathEq(["cobraSource","status"],"started"))}}var Pg={UNKNOWN:"unknown",NESTED_COBROWSABLE_IFRAME:"nested_cobrowsable_visitor",ENGAGEMENT_IFRAME:"main_visitor"};function Mg(e,t){var n=t.visitor_api.iframe_identity_detection_timeout||5e3,r=t.visitor_api.iframe_identity_validity_check_timeout||3e4,i=function(){var t=e.getCurrentContext();return t.parent.visitor_page?Pg.NESTED_COBROWSABLE_IFRAME:t.parent.visitor_browser?Pg.ENGAGEMENT_IFRAME:void 0};return{detect:i,identityObservable:function(t){var o=zv.Observable.interval(200,t).take(Math.round(n/200)).do((function(t){if(!t)return e.request()})).map(i).startWith(i()).filter((function(e){return Boolean(e)})).take(1).defaultIfEmpty(Pg.UNKNOWN).share(),s=o.filter((function(e){return e===Pg.UNKNOWN})).flatMap((function(){return zv.Observable.interval(r/2,t).take(2).do((function(t){t||e.request()})).map(i).filter((function(e){return Boolean(e)})).take(1)}));return o.merge(s)},IDENTITIES:Pg}}var jg=function(){var e,t,n=new zv.Subject;e=window.history,(t=e?e.pushState:void 0)&&(e.pushState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i}),function(){var e=window.history,t=e?e.replaceState:void 0;t&&(e.replaceState=function(r){var i=t.apply(e,arguments);return n.next({state:r}),i})}(),Gm(window,"popstate").subscribe(n);var r=n.startWith({}).map((function(){return window.location.href})).distinctUntilChanged();sm.hrefObservable=r},qg=S(T((function(e,t){e.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==o(e)&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){function r(e){return function(e){if(Array.isArray(e))return c(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||a(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e){return(i="function"==typeof Symbol&&"symbol"==o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw o}}return n}}(e,t)||a(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){if(e){if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),e}n.r(t),n.d(t,"Channel",(function(){return M})),n.d(t,"Serializer",(function(){return j})),n.d(t,"Socket",(function(){return q})),n.d(t,"LongPoll",(function(){return L})),n.d(t,"Ajax",(function(){return U})),n.d(t,"Presence",(function(){return V}));var f="undefined"!=typeof self?self:null,h="undefined"!=typeof window?window:null,d=f||h||void 0,b=0,v=1,m=2,y=3,g="closed",_="errored",w="joined",O="joining",E="leaving",S="phx_close",T="phx_error",x="phx_join",A="phx_reply",k="phx_leave",I=[S,T,x,A,k],N="longpoll",R="websocket",C=function(e){return"function"==typeof e?e:function(){return e}},P=function(){function e(t,n,r,i){u(this,e),this.channel=t,this.event=n,this.payload=r||function(){return{}},this.receivedResp=null,this.timeout=i,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}return p(e,[{key:"resend",value:function(e){this.timeout=e,this.reset(),this.send()}},{key:"send",value:function(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}},{key:"receive",value:function(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}},{key:"reset",value:function(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}},{key:"matchReceive",value:function(e){var t=e.status,n=e.response;e.ref,this.recHooks.filter((function(e){return e.status===t})).forEach((function(e){return e.callback(n)}))}},{key:"cancelRefEvent",value:function(){this.refEvent&&this.channel.off(this.refEvent)}},{key:"cancelTimeout",value:function(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}},{key:"startTimeout",value:function(){var e=this;this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,(function(t){e.cancelRefEvent(),e.cancelTimeout(),e.receivedResp=t,e.matchReceive(t)})),this.timeoutTimer=setTimeout((function(){e.trigger("timeout",{})}),this.timeout)}},{key:"hasReceived",value:function(e){return this.receivedResp&&this.receivedResp.status===e}},{key:"trigger",value:function(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}}]),e}(),M=function(){function e(t,n,r){var i=this;u(this,e),this.state=g,this.topic=t,this.params=C(n||{}),this.socket=r,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new P(this,x,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new D((function(){i.socket.isConnected()&&i.rejoin()}),this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError((function(){return i.rejoinTimer.reset()}))),this.stateChangeRefs.push(this.socket.onOpen((function(){i.rejoinTimer.reset(),i.isErrored()&&i.rejoin()}))),this.joinPush.receive("ok",(function(){i.state=w,i.rejoinTimer.reset(),i.pushBuffer.forEach((function(e){return e.send()})),i.pushBuffer=[]})),this.joinPush.receive("error",(function(){i.state=_,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.onClose((function(){i.rejoinTimer.reset(),i.socket.hasLogger()&&i.socket.log("channel","close ".concat(i.topic," ").concat(i.joinRef())),i.state=g,i.socket.remove(i)})),this.onError((function(e){i.socket.hasLogger()&&i.socket.log("channel","error ".concat(i.topic),e),i.isJoining()&&i.joinPush.reset(),i.state=_,i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.joinPush.receive("timeout",(function(){i.socket.hasLogger()&&i.socket.log("channel","timeout ".concat(i.topic," (").concat(i.joinRef(),")"),i.joinPush.timeout),new P(i,k,C({}),i.timeout).send(),i.state=_,i.joinPush.reset(),i.socket.isConnected()&&i.rejoinTimer.scheduleTimeout()})),this.on(A,(function(e,t){i.trigger(i.replyEventName(t),e)}))}return p(e,[{key:"join",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}},{key:"onClose",value:function(e){this.on(S,e)}},{key:"onError",value:function(e){return this.on(T,(function(t){return e(t)}))}},{key:"on",value:function(e,t){var n=this.bindingRef++;return this.bindings.push({event:e,ref:n,callback:t}),n}},{key:"off",value:function(e,t){this.bindings=this.bindings.filter((function(n){return!(n.event===e&&(void 0===t||t===n.ref))}))}},{key:"canPush",value:function(){return this.socket.isConnected()&&this.isJoined()}},{key:"push",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.timeout;if(!this.joinedOnce)throw new Error("tried to push '".concat(e,"' to '").concat(this.topic,"' before joining. Use channel.join() before pushing events"));var r=new P(this,e,(function(){return t}),n);return this.canPush()?r.send():(r.startTimeout(),this.pushBuffer.push(r)),r}},{key:"leave",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=E;var n=function(){e.socket.hasLogger()&&e.socket.log("channel","leave ".concat(e.topic)),e.trigger(S,"leave")},r=new P(this,k,C({}),t);return r.receive("ok",(function(){return n()})).receive("timeout",(function(){return n()})),r.send(),this.canPush()||r.trigger("ok",{}),r}},{key:"onMessage",value:function(e,t,n){return t}},{key:"isLifecycleEvent",value:function(e){return I.indexOf(e)>=0}},{key:"isMember",value:function(e,t,n,r){return!(this.topic!==e||r&&r!==this.joinRef()&&this.isLifecycleEvent(t)&&(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:n,joinRef:r}),1))}},{key:"joinRef",value:function(){return this.joinPush.ref}},{key:"sendJoin",value:function(e){this.state=O,this.joinPush.resend(e)}},{key:"rejoin",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.timeout;this.isLeaving()||this.sendJoin(e)}},{key:"trigger",value:function(e,t,n,r){var i=this.onMessage(e,t,n,r);if(t&&!i)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");for(var o=this.bindings.filter((function(t){return t.event===e})),s=0;s<o.length;s++)o[s].callback(i,n,r||this.joinRef())}},{key:"replyEventName",value:function(e){return"chan_reply_".concat(e)}},{key:"isClosed",value:function(){return this.state===g}},{key:"isErrored",value:function(){return this.state===_}},{key:"isJoined",value:function(){return this.state===w}},{key:"isJoining",value:function(){return this.state===O}},{key:"isLeaving",value:function(){return this.state===E}}]),e}(),j={encode:function(e,t){var n=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(n))},decode:function(e,t){var n=s(JSON.parse(e),5);return t({join_ref:n[0],ref:n[1],topic:n[2],event:n[3],payload:n[4]})}},q=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};u(this,e),this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=r.timeout||1e4,this.transport=r.transport||d.WebSocket||L,this.defaultEncoder=j.encode,this.defaultDecoder=j.decode,this.closeWasClean=!1,this.unloaded=!1,this.binaryType=r.binaryType||"arraybuffer",this.transport!==L?(this.encode=r.encode||this.defaultEncoder,this.decode=r.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder),h&&h.addEventListener&&h.addEventListener("unload",(function(e){n.conn&&(n.unloaded=!0,n.abnormalClose("unloaded"))})),this.heartbeatIntervalMs=r.heartbeatIntervalMs||3e4,this.rejoinAfterMs=function(e){return r.rejoinAfterMs?r.rejoinAfterMs(e):[1e3,2e3,5e3][e-1]||1e4},this.reconnectAfterMs=function(e){return n.unloaded?100:r.reconnectAfterMs?r.reconnectAfterMs(e):[10,50,100,150,200,250,500,1e3,2e3][e-1]||5e3},this.logger=r.logger||null,this.longpollerTimeout=r.longpollerTimeout||2e4,this.params=C(r.params||{}),this.endPoint="".concat(t,"/").concat(R),this.vsn=r.vsn||"2.0.0",this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new D((function(){n.teardown((function(){return n.connect()}))}),this.reconnectAfterMs)}return p(e,[{key:"protocol",value:function(){return location.protocol.match(/^https/)?"wss":"ws"}},{key:"endPointURL",value:function(){var e=U.appendParams(U.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return"/"!==e.charAt(0)?e:"/"===e.charAt(1)?"".concat(this.protocol(),":").concat(e):"".concat(this.protocol(),"://").concat(location.host).concat(e)}},{key:"disconnect",value:function(e,t,n){this.closeWasClean=!0,this.reconnectTimer.reset(),this.onConnClose("disconnect"),this.teardown(e,t,n)}},{key:"connect",value:function(e){var t=this;e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=C(e)),this.conn||(this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=function(){return t.onConnOpen()},this.conn.onerror=function(e){return t.onConnError(e)},this.conn.onmessage=function(e){return t.onConnMessage(e)},this.conn.onclose=function(e){return t.onConnClose(e)})}},{key:"log",value:function(e,t,n){this.logger(e,t,n)}},{key:"hasLogger",value:function(){return null!==this.logger}},{key:"onOpen",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}},{key:"onClose",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}},{key:"onError",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}},{key:"onMessage",value:function(e){var t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}},{key:"onConnOpen",value:function(){this.hasLogger()&&this.log("transport","connected to ".concat(this.endPointURL())),this.unloaded=!1,this.closeWasClean=!1,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach((function(e){return(0,s(e,2)[1])()}))}},{key:"resetHeartbeat",value:function(){var e=this;this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((function(){return e.sendHeartbeat()}),this.heartbeatIntervalMs))}},{key:"teardown",value:function(e,t,n){this.conn&&(this.conn.onclose=function(){},t?this.conn.close(t,n||""):this.conn.close(),this.conn=null),e&&e()}},{key:"onConnClose",value:function(e){this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),clearInterval(this.heartbeatTimer),this.closeWasClean||this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach((function(t){return(0,s(t,2)[1])(e)}))}},{key:"onConnError",value:function(e){this.hasLogger()&&this.log("transport",e),this.triggerChanError(),this.stateChangeCallbacks.error.forEach((function(t){return(0,s(t,2)[1])(e)}))}},{key:"triggerChanError",value:function(){this.channels.forEach((function(e){e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(T)}))}},{key:"connectionState",value:function(){switch(this.conn&&this.conn.readyState){case b:return"connecting";case v:return"open";case m:return"closing";default:return"closed"}}},{key:"isConnected",value:function(){return"open"===this.connectionState()}},{key:"remove",value:function(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter((function(t){return t.joinRef()!==e.joinRef()}))}},{key:"off",value:function(e){for(var t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter((function(t){var n=s(t,1)[0];return-1===e.indexOf(n)}))}},{key:"channel",value:function(e){var t=new M(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},this);return this.channels.push(t),t}},{key:"push",value:function(e){var t=this;if(this.hasLogger()){var n=e.topic,r=e.event,i=e.payload,o=e.ref,s=e.join_ref;this.log("push","".concat(n," ").concat(r," (").concat(s,", ").concat(o,")"),i)}this.isConnected()?this.encode(e,(function(e){return t.conn.send(e)})):this.sendBuffer.push((function(){return t.encode(e,(function(e){return t.conn.send(e)}))}))}},{key:"makeRef",value:function(){var e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}},{key:"sendHeartbeat",value:function(){if(this.isConnected()){if(this.pendingHeartbeatRef)return this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),void this.abnormalClose("heartbeat timeout");this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef})}}},{key:"abnormalClose",value:function(e){this.closeWasClean=!1,this.conn.close(1e3,e)}},{key:"flushSendBuffer",value:function(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach((function(e){return e()})),this.sendBuffer=[])}},{key:"onConnMessage",value:function(e){var t=this;this.decode(e.data,(function(e){var n=e.topic,r=e.event,i=e.payload,o=e.ref,a=e.join_ref;o&&o===t.pendingHeartbeatRef&&(t.pendingHeartbeatRef=null),t.hasLogger()&&t.log("receive","".concat(i.status||""," ").concat(n," ").concat(r," ").concat(o&&"("+o+")"||""),i);for(var c=0;c<t.channels.length;c++){var u=t.channels[c];u.isMember(n,r,i,a)&&u.trigger(r,i,o,a)}for(var l=0;l<t.stateChangeCallbacks.message.length;l++)(0,s(t.stateChangeCallbacks.message[l],2)[1])(e)}))}}]),e}(),L=function(){function e(t){u(this,e),this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(t),this.readyState=b,this.poll()}return p(e,[{key:"normalizeEndpoint",value:function(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+R),"$1/"+N)}},{key:"endpointURL",value:function(){return U.appendParams(this.pollEndpoint,{token:this.token})}},{key:"closeAndRetry",value:function(){this.close(),this.readyState=b}},{key:"ontimeout",value:function(){this.onerror("timeout"),this.closeAndRetry()}},{key:"poll",value:function(){var e=this;this.readyState!==v&&this.readyState!==b||U.request("GET",this.endpointURL(),"application/json",null,this.timeout,this.ontimeout.bind(this),(function(t){if(t){var n=t.status,r=t.token,i=t.messages;e.token=r}else n=0;switch(n){case 200:i.forEach((function(t){return e.onmessage({data:t})})),e.poll();break;case 204:e.poll();break;case 410:e.readyState=v,e.onopen(),e.poll();break;case 0:case 500:e.onerror(),e.closeAndRetry();break;default:e.onerror({status:n}),e.close()}}))}},{key:"send",value:function(e){var t=this;U.request("POST",this.endpointURL(),"application/json",e,this.timeout,this.onerror.bind(this,"timeout"),(function(e){e&&200===e.status||(t.onerror(e&&e.status),t.closeAndRetry())}))}},{key:"close",value:function(e,t){this.readyState=y,this.onclose()}}]),e}(),U=function(){function e(){u(this,e)}return p(e,null,[{key:"request",value:function(e,t,n,r,i,o,s){if(d.XDomainRequest){var a=new XDomainRequest;this.xdomainRequest(a,e,t,r,i,o,s)}else{var c=new d.XMLHttpRequest;this.xhrRequest(c,e,t,n,r,i,o,s)}}},{key:"xdomainRequest",value:function(e,t,n,r,i,o,s){var a=this;e.timeout=i,e.open(t,n),e.onload=function(){var t=a.parseJSON(e.responseText);s&&s(t)},o&&(e.ontimeout=o),e.onprogress=function(){},e.send(r)}},{key:"xhrRequest",value:function(e,t,n,r,i,o,s,a){var c=this;e.open(t,n,!0),e.timeout=o,e.setRequestHeader("Content-Type",r),e.onerror=function(){a&&a(null)},e.onreadystatechange=function(){if(e.readyState===c.states.complete&&a){var t=c.parseJSON(e.responseText);a(t)}},s&&(e.ontimeout=s),e.send(i)}},{key:"parseJSON",value:function(e){if(!e||""===e)return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}},{key:"serialize",value:function(e,t){var n=[];for(var r in e)if(e.hasOwnProperty(r)){var o=t?"".concat(t,"[").concat(r,"]"):r,s=e[r];"object"===i(s)?n.push(this.serialize(s,o)):n.push(encodeURIComponent(o)+"="+encodeURIComponent(s))}return n.join("&")}},{key:"appendParams",value:function(e,t){if(0===Object.keys(t).length)return e;var n=e.match(/\?/)?"&":"?";return"".concat(e).concat(n).concat(this.serialize(t))}}]),e}();U.states={complete:4};var V=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};u(this,e);var i=r.events||{state:"presence_state",diff:"presence_diff"};this.state={},this.pendingDiffs=[],this.channel=t,this.joinRef=null,this.caller={onChange:null,onJoin:null,onLeave:null,onSync:function(){}},this.channel.on(i.state,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.joinRef=n.channel.joinRef(),o||s?e.syncState(n.state,t,o,s):e.synchronizeState(n.state,t,i),n.pendingDiffs.forEach((function(t){o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i)})),n.pendingDiffs=[],a()})),this.channel.on(i.diff,(function(t){var r=n.caller,i=r.onChange,o=r.onJoin,s=r.onLeave,a=r.onSync;n.inPendingSyncState()?n.pendingDiffs.push(t):(o||s?e.syncDiff(n.state,t,o,s):e.synchronizeDiff(n.state,t,i),a())}))}return p(e,[{key:"onJoin",value:function(e){console&&console.warn&&console.warn("onJoin is deprecated, use onChange instead"),this.caller.onJoin=e}},{key:"onLeave",value:function(e){console&&console.warn&&console.warn("onLeave is deprecated, use onChange instead"),this.caller.onLeave=e}},{key:"onChange",value:function(e){this.caller.onChange=e}},{key:"onSync",value:function(e){this.caller.onSync=e}},{key:"list",value:function(t){return e.list(this.state,t)}},{key:"inPendingSyncState",value:function(){return!this.joinRef||this.joinRef!==this.channel.joinRef()}}],[{key:"synchronizeState",value:function(e,t,n){var r={},i={};return this.map(e,(function(e,n){t[e]||(i[e]=n)})),this.map(t,(function(t,n){var o=e[t];if(o){var s=n.metas.map((function(e){return e.phx_ref})),a=o.metas.map((function(e){return e.phx_ref})),c=n.metas.filter((function(e){return a.indexOf(e.phx_ref)<0})),u=o.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));c.length>0&&(r[t]=n,r[t].metas=c),u.length>0&&(c.length>0?i[t]={metas:u}:(i[t]=n,i[t].metas=u))}else r[t]=n})),this.synchronizeDiff(e,{joins:r,leaves:i},n)}},{key:"syncState",value:function(e,t,n,r){var i=this,o=this.clone(e),s={},a={};return this.map(o,(function(e,n){t[e]||(a[e]=n)})),this.map(t,(function(e,t){var n=o[e];if(n){var r=t.metas.map((function(e){return e.phx_ref})),c=n.metas.map((function(e){return e.phx_ref})),u=t.metas.filter((function(e){return c.indexOf(e.phx_ref)<0})),l=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0}));u.length>0&&(s[e]=t,s[e].metas=u),l.length>0&&(a[e]=i.clone(n),a[e].metas=l)}else s[e]=t})),this.syncDiff(o,{joins:s,leaves:a},n,r)}},{key:"synchronizeDiff",value:function(e,t,n){var r=t.joins,i=t.leaves,o={};return this.map(r,(function(e,t){o[e]={joinedMetas:t.metas,leftMetas:[],update:t}})),this.map(i,(function(e,t){o[e]?o[e].leftMetas=t.metas:o[e]={joinedMetas:[],leftMetas:t.metas,update:t}})),this.map(o,(function(t,r){var i=r.joinedMetas,o=r.leftMetas,s=r.update,a=i.map((function(e){return e.phx_ref})),c=o.map((function(e){return e.phx_ref})),u=e[t],l={metas:u?u.metas:[]};l.metas=l.metas.filter((function(e){return-1===a.indexOf(e.phx_ref)})).concat(i).filter((function(e){return-1===c.indexOf(e.phx_ref)})),Object.keys(s).forEach((function(e){"metas"!==e&&(l[e]=s[e])})),0===l.metas.length?delete e[t]:e[t]=l,n&&n(t,u,l)})),e}},{key:"syncDiff",value:function(e,t,n,i){var o=t.joins,s=t.leaves,a=this.clone(e);return n||(n=function(){}),i||(i=function(){}),this.map(o,(function(e,t){var i=a[e];if(a[e]=t,i){var o,s=a[e].metas.map((function(e){return e.phx_ref})),c=i.metas.filter((function(e){return s.indexOf(e.phx_ref)<0}));(o=a[e].metas).unshift.apply(o,r(c))}n(e,i,t)})),this.map(s,(function(e,t){var n=a[e];if(n){var r=t.metas.map((function(e){return e.phx_ref}));n.metas=n.metas.filter((function(e){return r.indexOf(e.phx_ref)<0})),i(e,n,t),0===n.metas.length&&delete a[e]}})),a}},{key:"list",value:function(e,t){return t||(t=function(e,t){return t}),this.map(e,(function(e,n){return t(e,n)}))}},{key:"map",value:function(e,t){return Object.getOwnPropertyNames(e).map((function(n){return t(n,e[n])}))}},{key:"clone",value:function(e){return JSON.parse(JSON.stringify(e))}}]),e}(),D=function(){function e(t,n){u(this,e),this.callback=t,this.timerCalc=n,this.timer=null,this.tries=0}return p(e,[{key:"reset",value:function(){this.tries=0,clearTimeout(this.timer)}},{key:"scheduleTimeout",value:function(){var e=this;clearTimeout(this.timer),this.timer=setTimeout((function(){e.tries=e.tries+1,e.callback()}),this.timerCalc(this.tries+1))}}]),e}()}])}))),Lg="sm.app.visitor_api.pubsub",Ug="".concat(Lg,".connection"),Vg="".concat(Lg,".push"),Dg=2147483647,Fg=function(e){return e?function(e,t,n){return em.info("[Pubsub] ".concat(e,": ").concat(t),{pubsub_data:n})}:function(){}},Bg=function(){return"hidden"===document.visibilityState},Wg=function(){return navigator.onLine},Hg=function(e){return e===window.WebSocket?"WebSocket":e===qg.LongPoll?"LongPoll":"unknown"},Gg=!1,zg=function(e){return Gg?qg.LongPoll:window.WebSocket?Wg()?e.transport===window.WebSocket?qg.LongPoll:window.WebSocket:e.transport:qg.LongPoll},Jg=function(e){var t=e.server,n=e.socket,r=e.stats,i=e.logsEnabled,s=e.getAccessToken,a=e.visitorIdObservable,c=void 0===a?Kv():a,u=e.reconnectConf,l=void 0===u?{}:u,p=e.getVisitorPriority,f=e.renewAccessToken,h=null;l={initialDelay:l.initialDelay||3e3,maxDelay:l.maxDelay||6e4,delayFactor:l.delayFactor||1.5};var d=0,b=I(l.initialDelay,l.maxDelay,l.delayFactor);n||(n=new qg.Socket("".concat(t,"/notifications"),{logger:Fg(i),params:function(){return{access_token:s(),priority:p()}},reconnectAfterMs:function(e){return b(d)}}));var v=new zv.ReplaySubject(1),m=!1,y=0,g=!1,_=sm.conf.engagement.api_timeout_milliseconds||1e4,w=function(e){return A.merge({transport:Hg(n.transport),online:Wg(),visibility_state:document.visibilityState,error_count:y},e)},O=function(e,t){t||(t={});var r=t.transport;return A.concat(["transport:".concat(r||Hg(n.transport)),"online:".concat(Wg())],e)};n.onOpen((function(){v.next(!0),g=!0,r.increment(Ug,O(["action:connected"])),em.info("PubSub socket opened",w({}))})),n.onClose((function(e){var t,i,o;v.next(!1),d+=1,e?(o=Hg(window.WebSocket),t=w({reason:e.reason,type:e.type,code:e.code&&e.code.toString(),transport:o}),i=O(["action:disconnected","type:".concat(e.type),"code:".concat(e.code)],{transport:o}),e.wasClean?(r.increment(Ug,A.concat(i,["reason:closed"])),em.info("PubSub connection disconnected cleanly",t)):Bg()?(r.increment(Ug,A.concat(i,["reason:closed"])),em.info("PubSub connection disconnected while tab was hidden",t)):(r.increment(Ug,A.concat(i,["reason:closed"])),em.info("PubSub connection disconnected",t))):(o=Hg(qg.LongPoll),t=w({reason:"unknown",type:"unknown",code:"unknown",transport:o}),i=O(["action:disconnected","type:unknown","reason:unknown","code:unknown"],{transport:o}),r.increment(Ug,i),em.info("Pubsub connection disconnected",t)),h&&n.disconnect()})),n.onError((function(e){v.next(!1);var t=e&&e.type||"unknown";y+=1;var i=e&&e.target?w({type:t}):w({type:t,error:e});if(Bg())em.info("PubSub connection error while tab was hidden",i);else if(Wg()){if(e&&e.status)switch(e.status){case 403:em.info("Detected likely pubsub authentication error, reconnecting after max delay"),b.setNextDelayMinimum(l.maxDelay);break;case 503:var o=l.maxDelay/2;em.info("PubSub unavailable, postponing reconnecting for at least ".concat(o," ms")),b.setNextDelayMinimum(o);break;default:return em.error("Received unhandled pubsub error status ".concat(e.status,", stopping reconnecting")),void n.disconnect()}var s=zg(n);i=A.merge(i,{new_transport:Hg(s)}),1!==y||g?(r.increment(Ug,O(["action:error"])),em.warn("PubSub socket connection error",i)):em.info("PubSub socket connection error while attempting to establish the connection first time",i),n.transport=s}else em.info("PubSub connection error while user was offline",i)}));var E=function(e){return"object"===o(e)?null==e?void 0:e.reason:e},S=function(){var e=function(e){Gg=!0,n.disconnect((function(){var t=qg.LongPoll;em.info("Failed to connect to Pubsub with initial transport",w({new_transport:Hg(t),error:E(e)})),n.transport=t,n.connect()}))};if(!m){r.increment(Ug,O(["action:connect"]));try{n.connect(),n.conn.readyState===WebSocket.CLOSED&&e()}catch(t){e(t)}m=!0,function(e){setInterval((function(){if("open"===e.connectionState()&&e.transport===qg.LongPoll){var t=zg(e.transport);if(e.transport!==t)return e.transport=t,e.disconnect((function(){return e.connect()}))}}),6e5)}(n)}},T=function(e,t,i,o){var s=function(e){if("function"==typeof e)return e.modify=function(){throw new Error("Cannot modify channel params because it is a closure already")},e;var t=A.clone(e||{}),n=function(){return t};return n.modify=function(e,n){t[e]=n(t[e])},n}(t);o||(o={}),i||(i=[]);var a=zv.Observable.create((function(a){var c=!1,u=(t||{}).timeout||Dg,l=n.channel(e,s);return l.join(u).receive("ok",(function(){c=!0,a.next(function(e,t){var n=function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=i.disableStats,s=i.timeout;s||(s=_);var a=function(e,t){o||r.increment(e,t)};return zv.Observable.create((function(r){return e.push(t,n,s).receive("ok",(function(e){r.next(e),r.complete()})).receive("error",(function(e){a(Vg,["action:error"]),r.error({type:"error",error:e})})).receive("timeout",(function(){a(Vg,["action:timeout"]),r.error({type:"timeout"})})),function(){}}))};return{observable:function(t,n){return n||(n={}),zv.Observable.create((function(r){var i=e.on(t,(function(e){return r.next(e)}));return function(){e.off(t,i),n.leaveChannelOnDispose&&e.leave()}}))},push:n,phoenixChannel:e,leave:function(){return e.leave()},watchNewTopics:function(e){return t.modify("topics",(function(t){return(t||[]).concat(e)})),n("watch",{topics:e},{timeout:Dg})}}}(l,s)),a.complete()})).receive("error",(function(t){t&&"join crashed"===t.reason?em.info("Joining Pubsub channel failed with crash, retrying",{reason:"error",error:E(t),topic:e}):t&&"overload"===t.reason?em.info("Joining Pubsub channel failed because of overload, retrying",{topic:e}):(t&&-1!==i.indexOf(t.reason)?em.info("Joining Pubsub channel failed with expected reason",{reason:"error",error:E(t),topic:e}):em.warn("Joining Pubsub channel failed",{reason:"error",error:E(t),topic:e}),a.error({type:"error",error:t}))})).receive("timeout",(function(){return em.warn("Joining Pubsub channel failed",{reason:"timeout",topic:e})})),function(){c&&!o.leaveChannelOnDispose||l.leave()}}));return zv.Observable.defer((function(){return S(),zv.Observable.of({})})).flatMapTo(v).filter(A.equals(!0)).take(1).flatMapTo(a)},x=c.switchMap((function(e){return T("visitor_volatile:".concat(e))})).publishReplay(1);x.connect(),x.flatMap((function(e){return e.observable("system:avoid_reconnection")})).subscribe((function(e){var t,r,i=e.duration_in_seconds;r=.5,i=(t=i)+Math.floor(Math.random()*r*t),em.info("Disabling reconnections to pubsub",{duration_in_seconds:i}),h&&clearTimeout(h),h=setTimeout((function(){em.info("Enabling reconnections to pubsub"),h=null,n.connect()}),1e3*i)}));var k=function(){return n.disconnect((function(){return n.connect()}))};return{joinChannel:T,volatileChannelObservable:x,connectedObservable:v.distinctUntilChanged(),disconnect:n.disconnect.bind(n),connect:n.connect.bind(n),reconnect:k,renewTokenAndReconnect:function(e){var t=e.newAccessToken;return f({newAccessToken:t}).do((function(){return k()}))},allowReconnection:function(){return null===h}}};function Qg(e,t){var n=t.visitorId,r=t.visitorIdObservable,o=t.tabId,s=t.idleTimeoutSeconds,a=t.visitorMetadata;n=n||Qv(),r=r||Kv();var c="JOIN_NOT_REQUESTED",u="JOINING_ALLOW_REJECTION",l="JOINING_ALLOW_REJECTION_BUT_NO_REJECTION_REQUESTED",p="JOINING_NO_REJECTION",f="JOIN_REJECTED",h="JOINED",d="JOIN_ERROR",b="JOIN_REQUESTED_ALLOW_REJECTION",v="JOIN_REJECTED",m="JOIN_ERROR",y="JOIN_SUCCESSFUL",_="JOIN_REQUESTED_NO_REJECTION",w="VISITOR_ID_CHANGED",O="too_many_tracked",E=new zv.ReplaySubject(1),S=function(t,n,r){var i="visitor_presence:".concat(t),c=n?[O]:[],u=!1;e.joinChannel(i,(function(){return{tab_id:o,page_url:location.href,page_description:document.title,idle_timeout_seconds:s,visitor_metadata:A.pick(["location"],a),allow_rejection:n&&!u}}),c).take(1).map((function(e){var t=e.phoenixChannel,n=e.leave;return[new qg.Presence(t),n]})).subscribe((function(e){var t=g(e,2),n=t[0],i=t[1];u=!0,r(y,{presence:n,leavePresence:i})}),(function(e){A.pathEq(["error","reason"],O,e)?r(v):r(m)}))},T={joinState:c,visitorId:n},x=function e(t,n){var r=g(function(e,t,n){switch(t){case b:switch(e.joinState){case c:return[i(i({},e),{},{joinState:u}),function(t){return S(e.visitorId,!0,t)}];default:return[e]}case _:switch(e.joinState){case c:case f:return[i(i({},e),{},{joinState:p}),function(t){return S(e.visitorId,!1,t)}];case u:return[i(i({},e),{},{joinState:l})];default:return[e]}case v:switch(e.joinState){case l:return[i(i({},e),{},{joinState:p}),function(t){return S(e.visitorId,!1,t)}];case u:return[i(i({},e),{},{joinState:f})];case p:return em.error("Request to join visitor presence channel was rejected, although we did not allow rejection"),[i(i({},e),{},{joinState:f})];default:return em.error("Received join rejection while we were not joining channel",{currentState:e}),[e]}case m:switch(e.joinState){case u:case p:case l:return[i(i({},e),{},{joinState:d})];default:return em.error("Received join error while we were not joining channel",{currentState:e}),[e]}case y:switch(e.joinState){case u:case p:case l:return[i(i({},e),{},{joinState:h,leavePresence:n.leavePresence}),function(){return E.next(n.presence)}];default:return em.error("Received join successful while we were not joining channel",{currentState:e}),[e]}case w:var r=n;if(r===e.visitorId)return[e];switch(e.joinState){case u:case p:case l:var o=e.joinState===u;return[i(i({},e),{},{visitorId:r}),function(e){return S(r,o,e)}];case h:return[i(i({},e),{},{visitorId:r,joinState:p}),function(t){e.leavePresence(),S(r,!1,t)}];default:return em.info("Visitor ID changed, but not joining visitor presence"),[e]}default:return em.error("Received invalid action",{action:t}),[e]}}(T,t,n),2),o=r[0],s=r[1];T=o,s&&s(e)};r.subscribe((function(e){return x(w,e)}),em.error.bind(em,"Error from visitor ID subscription in visitor presence channel")),this.requestJoin=function(){x(_)},this.requestJoinAllowRejection=function(){x(b)},this.getPresenceObservable=function(){return E.asObservable()};var k=E.switchMap((function(e){return zv.Observable.create((function(t){e.onSync((function(){var n=e.list();n[0]?A.any(A.equals(void 0),n[0].metas)?em.warn("Visitor Presence metas included undefined value"):t.next(n[0].metas):t.next([])}))}))})).publishReplay(1);k=Km(k),this.getSameVisitorConnections=function(){return k}}var Yg="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Kg(e,t){return e(t={exports:{}},t.exports),t.exports}var Xg=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,$g=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],Zg=function(e){var t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));for(var i=Xg.exec(e||""),o={},s=14;s--;)o[$g[s]]=i[s]||"";return-1!=n&&-1!=r&&(o.source=t,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o},e_="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)},t_=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n_=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r_=1e3,i_=60*r_,o_=60*i_,s_=24*o_,a_=365.25*s_,c_=function(e,t){t=t||{};var n,r=void 0===e?"undefined":e_(e);if("string"===r&&e.length>0)return function(e){if((e=String(e)).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*a_;case"days":case"day":case"d":return n*s_;case"hours":case"hour":case"hrs":case"hr":case"h":return n*o_;case"minutes":case"minute":case"mins":case"min":case"m":return n*i_;case"seconds":case"second":case"secs":case"sec":case"s":return n*r_;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}(e);if("number"===r&&!1===isNaN(e))return t.long?u_(n=e,s_,"day")||u_(n,o_,"hour")||u_(n,i_,"minute")||u_(n,r_,"second")||n+" ms":function(e){if(e>=s_)return Math.round(e/s_)+"d";if(e>=o_)return Math.round(e/o_)+"h";if(e>=i_)return Math.round(e/i_)+"m";if(e>=r_)return Math.round(e/r_)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))};function u_(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var l_=Kg((function(e,t){(t=e.exports=o.debug=o).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/[\\^$+?.()|[\]{}]/g,"\\$&").replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=c_,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}function o(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());for(var a=new Array(arguments.length),c=0;c<a.length;c++)a[c]=arguments[c];a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var u=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;u++;var i=t.formatters[r];if("function"==typeof i){var o=a[u];n=i.call(e,o),a.splice(u,1),u--}return n})),a=t.formatArgs.apply(e,a);var l=o.log||t.log||console.log.bind(console);l.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}})),p_=Kg((function(e,t){function n(){try{return t.storage.debug}catch(e){}if("undefined"!=typeof process&&"env"in process)return process.env.DEBUG}(t=e.exports=l_).log=function(){return"object"===("undefined"==typeof console?"undefined":e_(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"undefined"!=typeof document&&"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())})),f_=Zg,h_=p_("socket.io-client:url"),d_=function(e,t){var n=e;t=t||Yg.location,null==e&&(e=t.protocol+"//"+t.host);"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(h_("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),h_("parse %s",e),n=f_(e));n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443"));n.path=n.path||"/";var r=-1!==n.host.indexOf(":")?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+r+":"+n.port,n.href=n.protocol+"://"+r+(t&&t.port===n.port?"":":"+n.port),n};var b_=1e3,v_=6e4,m_=60*v_,y_=24*m_,g_=365.25*y_,__=function(e,t){return t=t||{},"string"==typeof e?function(e){if((e=""+e).length>1e4)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*g_;case"days":case"day":case"d":return n*y_;case"hours":case"hour":case"hrs":case"hr":case"h":return n*m_;case"minutes":case"minute":case"mins":case"min":case"m":return n*v_;case"seconds":case"second":case"secs":case"sec":case"s":return n*b_;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n}}(e):t.long?w_(n=e,y_,"day")||w_(n,m_,"hour")||w_(n,v_,"minute")||w_(n,b_,"second")||n+" ms":function(e){return e>=y_?Math.round(e/y_)+"d":e>=m_?Math.round(e/m_)+"h":e>=v_?Math.round(e/v_)+"m":e>=b_?Math.round(e/b_)+"s":e+"ms"}(e);var n};function w_(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var O_=Kg((function(e,t){(t=e.exports=function(e){function r(){}function o(){var e=o,r=+new Date,s=r-(n||r);e.diff=s,e.prev=n,e.curr=r,n=r,null==e.useColors&&(e.useColors=t.useColors()),null==e.color&&e.useColors&&(e.color=i());var a=Array.prototype.slice.call(arguments);a[0]=t.coerce(a[0]),"string"!=typeof a[0]&&(a=["%o"].concat(a));var c=0;a[0]=a[0].replace(/%([a-z%])/g,(function(n,r){if("%%"===n)return n;c++;var i=t.formatters[r];if("function"==typeof i){var o=a[c];n=i.call(e,o),a.splice(c,1),c--}return n})),"function"==typeof t.formatArgs&&(a=t.formatArgs.apply(e,a));var u=o.log||t.log||console.log.bind(console);u.apply(e,a)}r.enabled=!1,o.enabled=!0;var s=t.enabled(e)?o:r;return s.namespace=e,s}).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e);for(var n=(e||"").split(/[\s,]+/),r=n.length,i=0;i<r;i++)n[i]&&("-"===(e=n[i].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=__,t.names=[],t.skips=[],t.formatters={};var n,r=0;function i(){return t.colors[r++%t.colors.length]}})),E_=Kg((function(e,t){function n(){var e;try{e=t.storage.debug}catch(e){}return e}(t=e.exports=O_).log=function(){return"object"===("undefined"==typeof console?"undefined":e_(console))&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(){var e=arguments,n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,(function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))})),e.splice(o,0,r),e},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){return JSON.stringify(e)},t.enable(n())})),S_=Kg((function(e,t){
/*! JSON v3.3.2 | http://bestiejs.github.io/json3 | Copyright 2012-2014, Kit Cambridge | http://kit.mit-license.org */
(function(){var n={function:!0,object:!0},r=n.object&&t&&!t.nodeType&&t,i=n["undefined"==typeof window?"undefined":e_(window)]&&window||this,o=r&&n.object&&e&&!e.nodeType&&"object"==e_(Yg)&&Yg;function s(e,t){e||(e=i.Object()),t||(t=i.Object());var r=e.Number||i.Number,o=e.String||i.String,a=e.Object||i.Object,c=e.Date||i.Date,u=e.SyntaxError||i.SyntaxError,l=e.TypeError||i.TypeError,p=e.Math||i.Math,f=e.JSON||i.JSON;"object"==(void 0===f?"undefined":e_(f))&&f&&(t.stringify=f.stringify,t.parse=f.parse);var h,d,b,v=a.prototype,m=v.toString,y=new c(-0xc782b5b800cec);try{y=-109252==y.getUTCFullYear()&&0===y.getUTCMonth()&&1===y.getUTCDate()&&10==y.getUTCHours()&&37==y.getUTCMinutes()&&6==y.getUTCSeconds()&&708==y.getUTCMilliseconds()}catch(e){}function g(e){if(g[e]!==b)return g[e];var n;if("bug-string-char-index"==e)n="a"!="a"[0];else if("json"==e)n=g("json-stringify")&&g("json-parse");else{var i,s='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==e){var a=t.stringify,u="function"==typeof a&&y;if(u){(i=function(){return 1}).toJSON=i;try{u="0"===a(0)&&"0"===a(new r)&&'""'==a(new o)&&a(m)===b&&a(b)===b&&a()===b&&"1"===a(i)&&"[1]"==a([i])&&"[null]"==a([b])&&"null"==a(null)&&"[null,null,null]"==a([b,m,null])&&a({a:[i,!0,!1,null,"\0\b\n\f\r\t"]})==s&&"1"===a(null,i)&&"[\n 1,\n 2\n]"==a([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==a(new c(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==a(new c(864e13))&&'"-000001-01-01T00:00:00.000Z"'==a(new c(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==a(new c(-1))}catch(e){u=!1}}n=u}if("json-parse"==e){var l=t.parse;if("function"==typeof l)try{if(0===l("0")&&!l(!1)){var p=5==(i=l(s)).a.length&&1===i.a[0];if(p){try{p=!l('"\t"')}catch(e){}if(p)try{p=1!==l("01")}catch(e){}if(p)try{p=1!==l("1.")}catch(e){}}}}catch(e){p=!1}n=p}}return g[e]=!!n}if(!g("json")){var _="[object Function]",w="[object Number]",O="[object String]",E="[object Array]",S=g("bug-string-char-index");if(!y)var T=p.floor,x=[0,31,59,90,120,151,181,212,243,273,304,334],A=function(e,t){return x[t]+365*(e-1970)+T((e-1969+(t=+(t>1)))/4)-T((e-1901+t)/100)+T((e-1601+t)/400)};if((h=v.hasOwnProperty)||(h=function(e){var t,n={};return(n.__proto__=null,n.__proto__={toString:1},n).toString!=m?h=function(e){var t=this.__proto__,n=e in(this.__proto__=null,this);return this.__proto__=t,n}:(t=n.constructor,h=function(e){var n=(this.constructor||t).prototype;return e in this&&!(e in n&&this[e]===n[e])}),n=null,h.call(this,e)}),d=function(e,t){var r,i,o,s=0;for(o in(r=function(){this.valueOf=0}).prototype.valueOf=0,i=new r)h.call(i,o)&&s++;return r=i=null,s?d=2==s?function(e,t){var n,r={},i=m.call(e)==_;for(n in e)i&&"prototype"==n||h.call(r,n)||!(r[n]=1)||!h.call(e,n)||t(n)}:function(e,t){var n,r,i=m.call(e)==_;for(n in e)i&&"prototype"==n||!h.call(e,n)||(r="constructor"===n)||t(n);(r||h.call(e,n="constructor"))&&t(n)}:(i=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],d=function(e,t){var r,o,s=m.call(e)==_,a=!s&&"function"!=typeof e.constructor&&n[e_(e.hasOwnProperty)]&&e.hasOwnProperty||h;for(r in e)s&&"prototype"==r||!a.call(e,r)||t(r);for(o=i.length;r=i[--o];a.call(e,r)&&t(r));}),d(e,t)},!g("json-stringify")){var k={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},I=function(e,t){return("000000"+(t||0)).slice(-e)},N=function(e){for(var t='"',n=0,r=e.length,i=!S||r>10,o=i&&(S?e.split(""):e);n<r;n++){var s=e.charCodeAt(n);switch(s){case 8:case 9:case 10:case 12:case 13:case 34:case 92:t+=k[s];break;default:if(s<32){t+="\\u00"+I(2,s.toString(16));break}t+=i?o[n]:e.charAt(n)}}return t+'"'},R=function e(t,n,r,i,o,s,a){var c,u,p,f,v,y,g,_,S,x,k,R,C,P,M,j;try{c=n[t]}catch(e){}if("object"==(void 0===c?"undefined":e_(c))&&c)if("[object Date]"!=(u=m.call(c))||h.call(c,"toJSON"))"function"==typeof c.toJSON&&(u!=w&&u!=O&&u!=E||h.call(c,"toJSON"))&&(c=c.toJSON(t));else if(c>-1/0&&c<1/0){if(A){for(v=T(c/864e5),p=T(v/365.2425)+1970-1;A(p+1,0)<=v;p++);for(f=T((v-A(p,0))/30.42);A(p,f+1)<=v;f++);v=1+v-A(p,f),g=T((y=(c%864e5+864e5)%864e5)/36e5)%24,_=T(y/6e4)%60,S=T(y/1e3)%60,x=y%1e3}else p=c.getUTCFullYear(),f=c.getUTCMonth(),v=c.getUTCDate(),g=c.getUTCHours(),_=c.getUTCMinutes(),S=c.getUTCSeconds(),x=c.getUTCMilliseconds();c=(p<=0||p>=1e4?(p<0?"-":"+")+I(6,p<0?-p:p):I(4,p))+"-"+I(2,f+1)+"-"+I(2,v)+"T"+I(2,g)+":"+I(2,_)+":"+I(2,S)+"."+I(3,x)+"Z"}else c=null;if(r&&(c=r.call(n,t,c)),null===c)return"null";if("[object Boolean]"==(u=m.call(c)))return""+c;if(u==w)return c>-1/0&&c<1/0?""+c:"null";if(u==O)return N(""+c);if("object"==(void 0===c?"undefined":e_(c))){for(P=a.length;P--;)if(a[P]===c)throw l();if(a.push(c),k=[],M=s,s+=o,u==E){for(C=0,P=c.length;C<P;C++)R=e(C,c,r,i,o,s,a),k.push(R===b?"null":R);j=k.length?o?"[\n"+s+k.join(",\n"+s)+"\n"+M+"]":"["+k.join(",")+"]":"[]"}else d(i||c,(function(t){var n=e(t,c,r,i,o,s,a);n!==b&&k.push(N(t)+":"+(o?" ":"")+n)})),j=k.length?o?"{\n"+s+k.join(",\n"+s)+"\n"+M+"}":"{"+k.join(",")+"}":"{}";return a.pop(),j}};t.stringify=function(e,t,r){var i,o,s,a;if(n[void 0===t?"undefined":e_(t)]&&t)if((a=m.call(t))==_)o=t;else if(a==E){s={};for(var c,u=0,l=t.length;u<l;c=t[u++],((a=m.call(c))==O||a==w)&&(s[c]=1));}if(r)if((a=m.call(r))==w){if((r-=r%1)>0)for(i="",r>10&&(r=10);i.length<r;i+=" ");}else a==O&&(i=r.length<=10?r:r.slice(0,10));return R("",((c={})[""]=e,c),o,s,i,"",[])}}if(!g("json-parse")){var C,P,M=o.fromCharCode,j={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"},q=function(){throw C=P=null,u()},L=function(){for(var e,t,n,r,i,o=P,s=o.length;C<s;)switch(i=o.charCodeAt(C)){case 9:case 10:case 13:case 32:C++;break;case 123:case 125:case 91:case 93:case 58:case 44:return e=S?o.charAt(C):o[C],C++,e;case 34:for(e="@",C++;C<s;)if((i=o.charCodeAt(C))<32)q();else if(92==i)switch(i=o.charCodeAt(++C)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:e+=j[i],C++;break;case 117:for(t=++C,n=C+4;C<n;C++)(i=o.charCodeAt(C))>=48&&i<=57||i>=97&&i<=102||i>=65&&i<=70||q();e+=M("0x"+o.slice(t,C));break;default:q()}else{if(34==i)break;for(i=o.charCodeAt(C),t=C;i>=32&&92!=i&&34!=i;)i=o.charCodeAt(++C);e+=o.slice(t,C)}if(34==o.charCodeAt(C))return C++,e;q();default:if(t=C,45==i&&(r=!0,i=o.charCodeAt(++C)),i>=48&&i<=57){for(48==i&&((i=o.charCodeAt(C+1))>=48&&i<=57)&&q(),r=!1;C<s&&((i=o.charCodeAt(C))>=48&&i<=57);C++);if(46==o.charCodeAt(C)){for(n=++C;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==C&&q(),C=n}if(101==(i=o.charCodeAt(C))||69==i){for(43!=(i=o.charCodeAt(++C))&&45!=i||C++,n=C;n<s&&((i=o.charCodeAt(n))>=48&&i<=57);n++);n==C&&q(),C=n}return+o.slice(t,C)}if(r&&q(),"true"==o.slice(C,C+4))return C+=4,!0;if("false"==o.slice(C,C+5))return C+=5,!1;if("null"==o.slice(C,C+4))return C+=4,null;q()}return"$"},U=function e(t){var n,r;if("$"==t&&q(),"string"==typeof t){if("@"==(S?t.charAt(0):t[0]))return t.slice(1);if("["==t){for(n=[];"]"!=(t=L());r||(r=!0))r&&(","==t?"]"==(t=L())&&q():q()),","==t&&q(),n.push(e(t));return n}if("{"==t){for(n={};"}"!=(t=L());r||(r=!0))r&&(","==t?"}"==(t=L())&&q():q()),","!=t&&"string"==typeof t&&"@"==(S?t.charAt(0):t[0])&&":"==L()||q(),n[t.slice(1)]=e(L());return n}q()}return t},V=function(e,t,n){var r=D(e,t,n);r===b?delete e[t]:e[t]=r},D=function(e,t,n){var r,i=e[t];if("object"==(void 0===i?"undefined":e_(i))&&i)if(m.call(i)==E)for(r=i.length;r--;)V(i,r,n);else d(i,(function(e){V(i,e,n)}));return n.call(e,t,i)};t.parse=function(e,t){var n,r;return C=0,P=""+e,n=U(L()),"$"!=L()&&q(),C=P=null,t&&m.call(t)==_?D(((r={})[""]=n,r),"",t):n}}}return t.runInContext=s,t}if(!o||o.global!==o&&o.window!==o&&o.self!==o||(i=o),r)s(i,r);else{var a=i.JSON,c=i.JSON3,u=!1,l=s(i,i.JSON3={noConflict:function(){return u||(u=!0,i.JSON=a,i.JSON3=c,a=c=null),l}});i.JSON={parse:l.parse,stringify:l.stringify}}}).call(Yg)})),T_=x_;function x_(e){if(e)return function(e){for(var t in x_.prototype)e[t]=x_.prototype[t];return e}(e)}x_.prototype.on=x_.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},x_.prototype.once=function(e,t){var n=this;function r(){n.off(e,r),t.apply(this,arguments)}return this._callbacks=this._callbacks||{},r.fn=t,this.on(e,r),this},x_.prototype.off=x_.prototype.removeListener=x_.prototype.removeAllListeners=x_.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks[e];if(!r)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},x_.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},x_.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},x_.prototype.hasListeners=function(e){return!!this.listeners(e).length};var A_=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)},k_=function(e){return Yg.Buffer&&Yg.Buffer.isBuffer(e)||Yg.ArrayBuffer&&e instanceof ArrayBuffer};var I_=A_,N_=k_,R_={deconstructPacket:function(e){var t=[],n=e.data;var r=e;return r.data=function e(n){if(!n)return n;if(N_(n)){var r={_placeholder:!0,num:t.length};return t.push(n),r}if(I_(n)){for(var i=new Array(n.length),o=0;o<n.length;o++)i[o]=e(n[o]);return i}if("object"==(void 0===n?"undefined":e_(n))&&!(n instanceof Date)){i={};for(var s in n)i[s]=e(n[s]);return i}return n}(n),r.attachments=t.length,{packet:r,buffers:t}},reconstructPacket:function(e,t){return e.data=function e(n){if(n&&n._placeholder)return t[n.num];if(I_(n)){for(var r=0;r<n.length;r++)n[r]=e(n[r]);return n}if(n&&"object"==(void 0===n?"undefined":e_(n))){for(var i in n)n[i]=e(n[i]);return n}return n}(e.data),e.attachments=void 0,e},removeBlobs:function(e,t){var n=0,r=e;!function e(i,o,s){if(!i)return i;if(Yg.Blob&&i instanceof Blob||Yg.File&&i instanceof File){n++;var a=new FileReader;a.onload=function(){s?s[o]=this.result:r=this.result,--n||t(r)},a.readAsArrayBuffer(i)}else if(I_(i))for(var c=0;c<i.length;c++)e(i[c],c,i);else if(i&&"object"==(void 0===i?"undefined":e_(i))&&!N_(i))for(var u in i)e(i[u],u,i)}(r),n||t(r)}},C_=Kg((function(e,t){var n=E_("socket.io-parser"),r=S_,i=T_,o=R_,s=k_;function a(){}function c(e){var i="",o=!1;return i+=e.type,t.BINARY_EVENT!=e.type&&t.BINARY_ACK!=e.type||(i+=e.attachments,i+="-"),e.nsp&&"/"!=e.nsp&&(o=!0,i+=e.nsp),null!=e.id&&(o&&(i+=",",o=!1),i+=e.id),null!=e.data&&(o&&(i+=","),i+=r.stringify(e.data)),n("encoded %j as %s",e,i),i}function u(){this.reconstructor=null}function l(e){this.reconPack=e,this.buffers=[]}function p(e){return{type:t.ERROR,data:"parser error"}}t.protocol=4,t.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],t.CONNECT=0,t.DISCONNECT=1,t.EVENT=2,t.ACK=3,t.ERROR=4,t.BINARY_EVENT=5,t.BINARY_ACK=6,t.Encoder=a,t.Decoder=u,a.prototype.encode=function(e,r){(n("encoding packet %j",e),t.BINARY_EVENT==e.type||t.BINARY_ACK==e.type)?function(e,t){function n(e){var n=o.deconstructPacket(e),r=c(n.packet),i=n.buffers;i.unshift(r),t(i)}o.removeBlobs(e,n)}(e,r):r([c(e)])},i(u.prototype),u.prototype.add=function(e){var i;if("string"==typeof e)i=function(e){var i={},o=0;if(i.type=Number(e.charAt(0)),null==t.types[i.type])return p();if(t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type){for(var s="";"-"!=e.charAt(++o)&&(s+=e.charAt(o),o!=e.length););if(s!=Number(s)||"-"!=e.charAt(o))throw new Error("Illegal attachments");i.attachments=Number(s)}if("/"==e.charAt(o+1))for(i.nsp="";++o;){if(","==(c=e.charAt(o)))break;if(i.nsp+=c,o==e.length)break}else i.nsp="/";var a=e.charAt(o+1);if(""!==a&&Number(a)==a){for(i.id="";++o;){var c;if(null==(c=e.charAt(o))||Number(c)!=c){--o;break}if(i.id+=e.charAt(o),o==e.length)break}i.id=Number(i.id)}e.charAt(++o)&&(i=function(e,t){try{e.data=r.parse(t)}catch(e){return p()}return e}(i,e.substr(o)));return n("decoded %s as %j",e,i),i}(e),t.BINARY_EVENT==i.type||t.BINARY_ACK==i.type?(this.reconstructor=new l(i),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",i)):this.emit("decoded",i);else{if(!s(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(i=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,this.emit("decoded",i))}},u.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},l.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length==this.reconPack.attachments){var t=o.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null},l.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}})),P_=Kg((function(e){try{e.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){e.exports=!1}})),M_=function(e){var t=e.xdomain,n=e.xscheme,r=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||P_))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&r)return new XDomainRequest}catch(e){}if(!t)try{return new(Yg[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}},j_=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t},q_=A_,L_=function(e){return function e(t){if(!t)return!1;if(Yg.Buffer&&Yg.Buffer.isBuffer&&Yg.Buffer.isBuffer(t)||Yg.ArrayBuffer&&t instanceof ArrayBuffer||Yg.Blob&&t instanceof Blob||Yg.File&&t instanceof File)return!0;if(q_(t)){for(var n=0;n<t.length;n++)if(e(t[n]))return!0}else if(t&&"object"==(void 0===t?"undefined":e_(t)))for(var r in t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),t)if(Object.prototype.hasOwnProperty.call(t,r)&&e(t[r]))return!0;return!1}(e)};var U_=function(e,t,n){var r=e.byteLength;if(t=t||0,n=n||r,e.slice)return e.slice(t,n);if(t<0&&(t+=r),n<0&&(n+=r),n>r&&(n=r),t>=r||t>=n||0===r)return new ArrayBuffer(0);for(var i=new Uint8Array(e),o=new Uint8Array(n-t),s=t,a=0;s<n;s++,a++)o[a]=i[s];return o.buffer},V_=function(e,t,n){var r=!1;return n=n||D_,i.count=e,0===e?t():i;function i(e,o){if(i.count<=0)throw new Error("after called too many times");--i.count,e?(r=!0,t(e),t=n):0!==i.count||r||t(null,o)}};function D_(){}var F_=Kg((function(e,t){
/*! https://mths.be/wtf8 v1.0.0 by @mathias */
!function(n){var r=t,i=e&&e.exports==r&&e,o="object"==e_(Yg)&&Yg;o.global!==o&&o.window!==o||(n=o);var s,a,c,u=String.fromCharCode;function l(e){for(var t,n,r=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function p(e,t){return u(e>>t&63|128)}function f(e){if(0==(4294967168&e))return u(e);var t="";return 0==(4294965248&e)?t=u(e>>6&31|192):0==(4294901760&e)?(t=u(e>>12&15|224),t+=p(e,6)):0==(4292870144&e)&&(t=u(e>>18&7|240),t+=p(e,12),t+=p(e,6)),t+=u(63&e|128)}function h(){if(c>=a)throw Error("Invalid byte index");var e=255&s[c];if(c++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function d(){var e,t;if(c>a)throw Error("Invalid byte index");if(c==a)return!1;if(e=255&s[c],c++,0==(128&e))return e;if(192==(224&e)){if((t=(31&e)<<6|h())>=128)return t;throw Error("Invalid continuation byte")}if(224==(240&e)){if((t=(15&e)<<12|h()<<6|h())>=2048)return t;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=(15&e)<<18|h()<<12|h()<<6|h())>=65536&&t<=1114111)return t;throw Error("Invalid WTF-8 detected")}var b={version:"1.0.0",encode:function(e){for(var t=l(e),n=t.length,r=-1,i="";++r<n;)i+=f(t[r]);return i},decode:function(e){s=l(e),a=s.length,c=0;for(var t,n=[];!1!==(t=d());)n.push(t);return function(e){for(var t,n=e.length,r=-1,i="";++r<n;)(t=e[r])>65535&&(i+=u((t-=65536)>>>10&1023|55296),t=56320|1023&t),i+=u(t);return i}(n)}};if(r&&!r.nodeType)if(i)i.exports=b;else{var v={}.hasOwnProperty;for(var m in b)v.call(b,m)&&(r[m]=b[m])}else n.wtf8=b}(Yg)})),B_=Kg((function(e,t){!function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256),r=0;r<e.length;r++)n[e.charCodeAt(r)]=r;t.encode=function(t){var n,r=new Uint8Array(t),i=r.length,o="";for(n=0;n<i;n+=3)o+=e[r[n]>>2],o+=e[(3&r[n])<<4|r[n+1]>>4],o+=e[(15&r[n+1])<<2|r[n+2]>>6],o+=e[63&r[n+2]];return i%3==2?o=o.substring(0,o.length-1)+"=":i%3==1&&(o=o.substring(0,o.length-2)+"=="),o},t.decode=function(e){var t,r,i,o,s,a=.75*e.length,c=e.length,u=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var l=new ArrayBuffer(a),p=new Uint8Array(l);for(t=0;t<c;t+=4)r=n[e.charCodeAt(t)],i=n[e.charCodeAt(t+1)],o=n[e.charCodeAt(t+2)],s=n[e.charCodeAt(t+3)],p[u++]=r<<2|i>>4,p[u++]=(15&i)<<4|o>>2,p[u++]=(3&o)<<6|63&s;return l}}()})),W_=Yg.BlobBuilder||Yg.WebKitBlobBuilder||Yg.MSBlobBuilder||Yg.MozBlobBuilder,H_=function(){try{return 2===new Blob(["hi"]).size}catch(e){return!1}}(),G_=H_&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(e){return!1}}(),z_=W_&&W_.prototype.append&&W_.prototype.getBlob;function J_(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.buffer instanceof ArrayBuffer){var r=n.buffer;if(n.byteLength!==r.byteLength){var i=new Uint8Array(n.byteLength);i.set(new Uint8Array(r,n.byteOffset,n.byteLength)),r=i.buffer}e[t]=r}}}function Q_(e,t){t=t||{};var n=new W_;J_(e);for(var r=0;r<e.length;r++)n.append(e[r]);return t.type?n.getBlob(t.type):n.getBlob()}function Y_(e,t){return J_(e),new Blob(e,t||{})}var K_=H_?G_?Yg.Blob:Y_:z_?Q_:void 0,X_=Kg((function(e,t){var n,r=j_,i=L_,o=U_,s=V_,a=F_;Yg&&Yg.ArrayBuffer&&(n=B_);var c="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),u="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),l=c||u;t.protocol=3;var p=t.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},f=r(p),h={type:"error",data:"parser error"},d=K_;function b(e,t,n){for(var r=new Array(e.length),i=s(e.length,n),o=function(e,n,i){t(n,(function(t,n){r[e]=n,i(t,r)}))},a=0;a<e.length;a++)o(a,e[a],i)}t.encodePacket=function(e,n,r,i){"function"==typeof n&&(i=n,n=!1),"function"==typeof r&&(i=r,r=null);var o=void 0===e.data?void 0:e.data.buffer||e.data;if(Yg.ArrayBuffer&&o instanceof ArrayBuffer)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=e.data,o=new Uint8Array(i),s=new Uint8Array(1+i.byteLength);s[0]=p[e.type];for(var a=0;a<o.length;a++)s[a+1]=o[a];return r(s.buffer)}(e,n,i);if(d&&o instanceof Yg.Blob)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);if(l)return function(e,n,r){if(!n)return t.encodeBase64Packet(e,r);var i=new FileReader;return i.onload=function(){e.data=i.result,t.encodePacket(e,n,!0,r)},i.readAsArrayBuffer(e.data)}(e,n,r);var i=new Uint8Array(1);i[0]=p[e.type];var o=new d([i.buffer,e.data]);return r(o)}(e,n,i);if(o&&o.base64)return function(e,n){var r="b"+t.packets[e.type]+e.data.data;return n(r)}(e,i);var s=p[e.type];return void 0!==e.data&&(s+=r?a.encode(String(e.data)):String(e.data)),i(""+s)},t.encodeBase64Packet=function(e,n){var r,i="b"+t.packets[e.type];if(d&&e.data instanceof Yg.Blob){var o=new FileReader;return o.onload=function(){var e=o.result.split(",")[1];n(i+e)},o.readAsDataURL(e.data)}try{r=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(t){for(var s=new Uint8Array(e.data),a=new Array(s.length),c=0;c<s.length;c++)a[c]=s[c];r=String.fromCharCode.apply(null,a)}return i+=Yg.btoa(r),n(i)},t.decodePacket=function(e,n,r){if(void 0===e)return h;if("string"==typeof e){if("b"==e.charAt(0))return t.decodeBase64Packet(e.substr(1),n);if(r&&!1===(e=function(e){try{e=a.decode(e)}catch(e){return!1}return e}(e)))return h;var i=e.charAt(0);return Number(i)==i&&f[i]?e.length>1?{type:f[i],data:e.substring(1)}:{type:f[i]}:h}i=new Uint8Array(e)[0];var s=o(e,1);return d&&"blob"===n&&(s=new d([s])),{type:f[i],data:s}},t.decodeBase64Packet=function(e,t){var r=f[e.charAt(0)];if(!n)return{type:r,data:{base64:!0,data:e.substr(1)}};var i=n.decode(e.substr(1));return"blob"===t&&d&&(i=new d([i])),{type:r,data:i}},t.encodePayload=function(e,n,r){"function"==typeof n&&(r=n,n=null);var o=i(e);if(n&&o)return d&&!l?t.encodePayloadAsBlob(e,r):t.encodePayloadAsArrayBuffer(e,r);if(!e.length)return r("0:");b(e,(function(e,r){t.encodePacket(e,!!o&&n,!0,(function(e){r(null,function(e){return e.length+":"+e}(e))}))}),(function(e,t){return r(t.join(""))}))},t.decodePayload=function(e,n,r){if("string"!=typeof e)return t.decodePayloadAsBinary(e,n,r);var i;if("function"==typeof n&&(r=n,n=null),""==e)return r(h,0,1);for(var o,s,a="",c=0,u=e.length;c<u;c++){var l=e.charAt(c);if(":"!=l)a+=l;else{if(""==a||a!=(o=Number(a)))return r(h,0,1);if(a!=(s=e.substr(c+1,o)).length)return r(h,0,1);if(s.length){if(i=t.decodePacket(s,n,!0),h.type==i.type&&h.data==i.data)return r(h,0,1);if(!1===r(i,c+o,u))return}c+=o,a=""}}return""!=a?r(h,0,1):void 0},t.encodePayloadAsArrayBuffer=function(e,n){if(!e.length)return n(new ArrayBuffer(0));b(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){return n(null,e)}))}),(function(e,t){var r=t.reduce((function(e,t){var n;return e+(n="string"==typeof t?t.length:t.byteLength).toString().length+n+2}),0),i=new Uint8Array(r),o=0;return t.forEach((function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),s=0;s<e.length;s++)r[s]=e.charCodeAt(s);n=r.buffer}i[o++]=t?0:1;var a=n.byteLength.toString();for(s=0;s<a.length;s++)i[o++]=parseInt(a[s]);i[o++]=255;for(r=new Uint8Array(n),s=0;s<r.length;s++)i[o++]=r[s]})),n(i.buffer)}))},t.encodePayloadAsBlob=function(e,n){b(e,(function(e,n){t.encodePacket(e,!0,!0,(function(e){var t=new Uint8Array(1);if(t[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),i=0;i<e.length;i++)r[i]=e.charCodeAt(i);e=r.buffer,t[0]=0}var o=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),s=new Uint8Array(o.length+1);for(i=0;i<o.length;i++)s[i]=parseInt(o[i]);if(s[o.length]=255,d){var a=new d([t.buffer,s.buffer,e]);n(null,a)}}))}),(function(e,t){return n(new d(t))}))},t.decodePayloadAsBinary=function(e,n,r){"function"==typeof n&&(r=n,n=null);for(var i=e,s=[],a=!1;i.byteLength>0;){for(var c=new Uint8Array(i),u=0===c[0],l="",p=1;255!=c[p];p++){if(l.length>310){a=!0;break}l+=c[p]}if(a)return r(h,0,1);i=o(i,2+l.length),l=parseInt(l);var f=o(i,0,l);if(u)try{f=String.fromCharCode.apply(null,new Uint8Array(f))}catch(e){var d=new Uint8Array(f);f="";for(p=0;p<d.length;p++)f+=String.fromCharCode(d[p])}s.push(f),i=o(i,l)}var b=s.length;s.forEach((function(e,i){r(t.decodePacket(e,n,!0),i,b)}))}})),$_=Kg((function(e){function t(e){if(e)return function(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}(e)}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return this},t.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}})),Z_=X_,ew=tw;function tw(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.forceNode=e.forceNode,this.extraHeaders=e.extraHeaders,this.localAddress=e.localAddress}$_(tw.prototype),tw.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},tw.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},tw.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},tw.prototype.send=function(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)},tw.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},tw.prototype.onData=function(e){var t=Z_.decodePacket(e,this.socket.binaryType);this.onPacket(t)},tw.prototype.onPacket=function(e){this.emit("packet",e)},tw.prototype.onClose=function(){this.readyState="closed",this.emit("close")};var nw,rw={encode:function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t},decode:function(e){for(var t={},n=e.split("&"),r=0,i=n.length;r<i;r++){var o=n[r].split("=");t[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}return t}},iw=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e},ow="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),sw={},aw=0,cw=0;function uw(e){var t="";do{t=ow[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function lw(){var e=uw(+new Date);return e!==nw?(aw=0,nw=e):e+"."+uw(aw++)}for(;cw<64;cw++)sw[ow[cw]]=cw;lw.encode=uw,lw.decode=function(e){var t=0;for(cw=0;cw<e.length;cw++)t=64*t+sw[e.charAt(cw)];return t};var pw=lw,fw=ew,hw=rw,dw=X_,bw=iw,vw=pw,mw=p_("engine.io-client:polling"),yw=_w,gw=null!=new M_({xdomain:!1}).responseType;function _w(e){var t=e&&e.forceBase64;gw&&!t||(this.supportsBinary=!1),fw.call(this,e)}bw(_w,fw),_w.prototype.name="polling",_w.prototype.doOpen=function(){this.poll()},_w.prototype.pause=function(e){var t=this;function n(){mw("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(mw("we are currently polling - waiting to pause"),r++,this.once("pollComplete",(function(){mw("pre-pause polling complete"),--r||n()}))),this.writable||(mw("we are currently writing - waiting to pause"),r++,this.once("drain",(function(){mw("pre-pause writing complete"),--r||n()})))}else n()},_w.prototype.poll=function(){mw("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},_w.prototype.onData=function(e){var t=this;mw("polling got data %s",e);dw.decodePayload(e,this.socket.binaryType,(function(e,n,r){if("opening"===t.readyState&&t.onOpen(),"close"===e.type)return t.onClose(),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():mw('ignoring poll - transport state "%s"',this.readyState))},_w.prototype.doClose=function(){var e=this;function t(){mw("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(mw("transport open - closing"),t()):(mw("transport not open - deferring close"),this.once("open",t))},_w.prototype.write=function(e){var t=this;this.writable=!1;var n=function(){t.writable=!0,t.emit("drain")};dw.encodePayload(e,this.supportsBinary,(function(e){t.doWrite(e,n)}))},_w.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=vw()),this.supportsBinary||e.sid||(e.b64=1),e=hw.encode(e),this.port&&("https"===t&&443!==Number(this.port)||"http"===t&&80!==Number(this.port))&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e};var ww=M_,Ow=yw,Ew=$_,Sw=iw,Tw=p_("engine.io-client:polling-xhr"),xw=Iw,Aw=Nw;function kw(){}function Iw(e){if(Ow.call(this,e),this.requestTimeout=e.requestTimeout,Yg.location){var t="https:"===location.protocol,n=location.port;n||(n=t?443:80),this.xd=e.hostname!==Yg.location.hostname||n!==e.port,this.xs=e.secure!==t}else this.extraHeaders=e.extraHeaders}function Nw(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!==e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.requestTimeout=e.requestTimeout,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}function Rw(){for(var e in Nw.requests)Nw.requests.hasOwnProperty(e)&&Nw.requests[e].abort()}Sw(Iw,Ow),Iw.prototype.supportsBinary=!0,Iw.prototype.request=function(e){return(e=e||{}).uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.requestTimeout=this.requestTimeout,e.extraHeaders=this.extraHeaders,new Nw(e)},Iw.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),i=this;r.on("success",t),r.on("error",(function(e){i.onError("xhr post error",e)})),this.sendXhr=r},Iw.prototype.doPoll=function(){Tw("xhr poll");var e=this.request(),t=this;e.on("data",(function(e){t.onData(e)})),e.on("error",(function(e){t.onError("xhr poll error",e)})),this.pollXhr=e},Ew(Nw.prototype),Nw.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new ww(e),n=this;try{Tw("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var r in t.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.extraHeaders[r])}catch(e){}if(this.supportsBinary&&(t.responseType="arraybuffer"),"POST"===this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.requestTimeout&&(t.timeout=this.requestTimeout),this.hasXDR()?(t.onload=function(){n.onLoad()},t.onerror=function(){n.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?n.onLoad():setTimeout((function(){n.onError(t.status)}),0))},Tw("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout((function(){n.onError(e)}),0)}Yg.document&&(this.index=Nw.requestsCount++,Nw.requests[this.index]=this)},Nw.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Nw.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},Nw.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},Nw.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=kw:this.xhr.onreadystatechange=kw,e)try{this.xhr.abort()}catch(e){}Yg.document&&delete Nw.requests[this.index],this.xhr=null}},Nw.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}if("application/octet-stream"===t)e=this.xhr.response||this.xhr.responseText;else if(this.supportsBinary)try{e=String.fromCharCode.apply(null,new Uint8Array(this.xhr.response))}catch(t){for(var n=new Uint8Array(this.xhr.response),r=[],i=0,o=n.length;i<o;i++)r.push(n[i]);e=String.fromCharCode.apply(null,r)}else e=this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},Nw.prototype.hasXDR=function(){return void 0!==Yg.XDomainRequest&&!this.xs&&this.enablesXDR},Nw.prototype.abort=function(){this.cleanup()},Nw.requestsCount=0,Nw.requests={},Yg.document&&(Yg.attachEvent?Yg.attachEvent("onunload",Rw):Yg.addEventListener&&Yg.addEventListener("beforeunload",Rw,!1)),xw.Request=Aw;var Cw,Pw=yw,Mw=Uw,jw=/\n/g,qw=/\\n/g;function Lw(){}function Uw(e){Pw.call(this,e),this.query=this.query||{},Cw||(Yg.___eio||(Yg.___eio=[]),Cw=Yg.___eio),this.index=Cw.length;var t=this;Cw.push((function(e){t.onData(e)})),this.query.j=this.index,Yg.document&&Yg.addEventListener&&Yg.addEventListener("beforeunload",(function(){t.script&&(t.script.onerror=Lw)}),!1)}iw(Uw,Pw),Uw.prototype.supportsBinary=!1,Uw.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Pw.prototype.doClose.call(this)},Uw.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)}),100)},Uw.prototype.doWrite=function(e,t){var n=this;if(!this.form){var r,i=document.createElement("form"),o=document.createElement("textarea"),s=this.iframeId="eio_iframe_"+this.index;i.className="socketio",i.style.position="absolute",i.style.top="-1000px",i.style.left="-1000px",i.target=s,i.method="POST",i.setAttribute("accept-charset","utf-8"),o.name="d",i.appendChild(o),document.body.appendChild(i),this.form=i,this.area=o}function a(){c(),t()}function c(){if(n.iframe)try{n.form.removeChild(n.iframe)}catch(e){n.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+n.iframeId+'">';r=document.createElement(e)}catch(e){(r=document.createElement("iframe")).name=n.iframeId,r.src="javascript:0"}r.id=n.iframeId,n.form.appendChild(r),n.iframe=r}this.form.action=this.uri(),c(),e=e.replace(qw,"\\\n"),this.area.value=e.replace(jw,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===n.iframe.readyState&&a()}:this.iframe.onload=a};var Vw,Dw={},Fw=Object.freeze({default:Dw}),Bw=Fw&&Dw||Fw,Ww=ew,Hw=X_,Gw=rw,zw=iw,Jw=pw,Qw=p_("engine.io-client:websocket"),Yw=Yg.WebSocket||Yg.MozWebSocket;if("undefined"==typeof window)try{Vw=Bw}catch(e){}var Kw=Yw;Kw||"undefined"!=typeof window||(Kw=Vw);var Xw=$w;function $w(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,this.usingBrowserWebSocket=Yw&&!e.forceNode,this.usingBrowserWebSocket||(Kw=Vw),Ww.call(this,e)}zw($w,Ww),$w.prototype.name="websocket",$w.prototype.supportsBinary=!0,$w.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t={agent:this.agent,perMessageDeflate:this.perMessageDeflate};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(t.headers=this.extraHeaders),this.localAddress&&(t.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket?new Kw(e):new Kw(e,void 0,t)}catch(e){return this.emit("error",e)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},$w.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},$w.prototype.write=function(e){var t=this;this.writable=!1;for(var n=e.length,r=0,i=n;r<i;r++)!function(e){Hw.encodePacket(e,t.supportsBinary,(function(r){if(!t.usingBrowserWebSocket){var i={};if(e.options&&(i.compress=e.options.compress),t.perMessageDeflate)("string"==typeof r?Yg.Buffer.byteLength(r):r.length)<t.perMessageDeflate.threshold&&(i.compress=!1)}try{t.usingBrowserWebSocket?t.ws.send(r):t.ws.send(r,i)}catch(e){Qw("websocket closed before onclose event")}--n||o()}))}(e[r]);function o(){t.emit("flush"),setTimeout((function(){t.writable=!0,t.emit("drain")}),0)}},$w.prototype.onClose=function(){Ww.prototype.onClose.call(this)},$w.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},$w.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"===t&&443!==Number(this.port)||"ws"===t&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=Jw()),this.supportsBinary||(e.b64=1),(e=Gw.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},$w.prototype.check=function(){return!(!Kw||"__initialize"in Kw&&this.name===$w.prototype.name)};var Zw=M_,eO=xw,tO=Mw;var nO={polling:function(e){var t=!1,n=!1,r=!1!==e.jsonp;if(Yg.location){var i="https:"===location.protocol,o=location.port;o||(o=i?443:80),t=e.hostname!==location.hostname||o!==e.port,n=e.secure!==i}if(e.xdomain=t,e.xscheme=n,"open"in new Zw(e)&&!e.forceJSONP)return new eO(e);if(!r)throw new Error("JSONP disabled");return new tO(e)},websocket:Xw},rO=[].indexOf,iO=function(e,t){if(rO)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1},oO=/^[\],:{}\s]*$/,sO=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,aO=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,cO=/(?:^|:|,)(?:\s*\[)+/g,uO=/^\s+/,lO=/\s+$/,pO=nO,fO=$_,hO=p_("engine.io-client:socket"),dO=iO,bO=X_,vO=Zg,mO=function(e){return"string"==typeof e&&e?(e=e.replace(uO,"").replace(lO,""),Yg.JSON&&JSON.parse?JSON.parse(e):oO.test(e.replace(sO,"@").replace(aO,"]").replace(cO,""))?new Function("return "+e)():void 0):null},yO=rw,gO=_O;function _O(e,t){if(!(this instanceof _O))return new _O(e,t);t=t||{},e&&"object"===(void 0===e?"undefined":e_(e))&&(t=e,e=null),e?(e=vO(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=vO(t.host).host),this.secure=null!=t.secure?t.secure:Yg.location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||(Yg.location?location.hostname:"localhost"),this.port=t.port||(Yg.location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=yO.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized?null:t.rejectUnauthorized,this.forceNode=!!t.forceNode;var n="object"===e_(Yg)&&Yg;n.global===n&&(t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),t.localAddress&&(this.localAddress=t.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}_O.priorWebsocketSuccess=!1,fO(_O.prototype),_O.protocol=bO.protocol,_O.Socket=_O,_O.Transport=ew,_O.transports=nO,_O.parser=X_,_O.prototype.createTransport=function(e){hO('creating transport "%s"',e);var t=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}(this.query);return t.EIO=bO.protocol,t.transport=e,this.id&&(t.sid=this.id),new pO[e]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:t,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized,perMessageDeflate:this.perMessageDeflate,extraHeaders:this.extraHeaders,forceNode:this.forceNode,localAddress:this.localAddress})},_O.prototype.open=function(){var e;if(this.rememberUpgrade&&_O.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout((function(){t.emit("error","No transports available")}),0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},_O.prototype.setTransport=function(e){hO("setting transport %s",e.name);var t=this;this.transport&&(hO("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",(function(){t.onDrain()})).on("packet",(function(e){t.onPacket(e)})).on("error",(function(e){t.onError(e)})).on("close",(function(){t.onClose("transport close")}))},_O.prototype.probe=function(e){hO('probing transport "%s"',e);var t=this.createTransport(e,{probe:1}),n=!1,r=this;function i(){if(r.onlyBinaryUpgrades){var i=!this.supportsBinary&&r.transport.supportsBinary;n=n||i}n||(hO('probe transport "%s" opened',e),t.send([{type:"ping",data:"probe"}]),t.once("packet",(function(i){if(!n)if("pong"===i.type&&"probe"===i.data){if(hO('probe transport "%s" pong',e),r.upgrading=!0,r.emit("upgrading",t),!t)return;_O.priorWebsocketSuccess="websocket"===t.name,hO('pausing current transport "%s"',r.transport.name),r.transport.pause((function(){n||"closed"!==r.readyState&&(hO("changing transport and sending upgrade packet"),l(),r.setTransport(t),t.send([{type:"upgrade"}]),r.emit("upgrade",t),t=null,r.upgrading=!1,r.flush())}))}else{hO('probe transport "%s" failed',e);var o=new Error("probe error");o.transport=t.name,r.emit("upgradeError",o)}})))}function o(){n||(n=!0,l(),t.close(),t=null)}function s(n){var i=new Error("probe error: "+n);i.transport=t.name,o(),hO('probe transport "%s" failed because of error: %s',e,n),r.emit("upgradeError",i)}function a(){s("transport closed")}function c(){s("socket closed")}function u(e){t&&e.name!==t.name&&(hO('"%s" works - aborting "%s"',e.name,t.name),o())}function l(){t.removeListener("open",i),t.removeListener("error",s),t.removeListener("close",a),r.removeListener("close",c),r.removeListener("upgrading",u)}_O.priorWebsocketSuccess=!1,t.once("open",i),t.once("error",s),t.once("close",a),this.once("close",c),this.once("upgrading",u),t.open()},_O.prototype.onOpen=function(){if(hO("socket open"),this.readyState="open",_O.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){hO("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},_O.prototype.onPacket=function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(hO('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(mO(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else hO('packet received with socket readyState "%s"',this.readyState)},_O.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},_O.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout((function(){"closed"!==t.readyState&&t.onClose("ping timeout")}),e||t.pingInterval+t.pingTimeout)},_O.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout((function(){hO("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)}),e.pingInterval)},_O.prototype.ping=function(){var e=this;this.sendPacket("ping",(function(){e.emit("ping")}))},_O.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},_O.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(hO("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},_O.prototype.write=_O.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},_O.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){(n=n||{}).compress=!1!==n.compress;var i={type:e,data:t,options:n};this.emit("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}},_O.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var e=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?r():t()})):this.upgrading?r():t()}function t(){e.onClose("forced close"),hO("socket closing - telling transport to close"),e.transport.close()}function n(){e.removeListener("upgrade",n),e.removeListener("upgradeError",n),t()}function r(){e.once("upgrade",n),e.once("upgradeError",n)}return this},_O.prototype.onError=function(e){hO("socket error %j",e),_O.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},_O.prototype.onClose=function(e,t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){hO('socket close with reason: "%s"',e);clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0}},_O.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~dO(this.transports,e[n])&&t.push(e[n]);return t};var wO=gO,OO=X_;wO.parser=OO;var EO=wO,SO=function(e,t){for(var n=[],r=(t=t||0)||0;r<e.length;r++)n[r-t]=e[r];return n};var TO=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}};var xO=[].slice,AO=function(e,t){if("string"==typeof t&&(t=e[t]),"function"!=typeof t)throw new Error("bind() requires a function");var n=xO.call(arguments,2);return function(){return t.apply(e,n.concat(xO.call(arguments)))}},kO=Kg((function(e,t){var n=C_,r=$_,i=SO,o=TO,s=AO,a=p_("socket.io-client:socket"),c=L_;e.exports=p;var u={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},l=r.prototype.emit;function p(e,t,n){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}r(p.prototype),p.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[o(e,"open",s(this,"onopen")),o(e,"packet",s(this,"onpacket")),o(e,"close",s(this,"onclose"))]}},p.prototype.open=p.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},p.prototype.send=function(){var e=i(arguments);return e.unshift("message"),this.emit.apply(this,e),this},p.prototype.emit=function(e){if(u.hasOwnProperty(e))return l.apply(this,arguments),this;var t=i(arguments),r=n.EVENT;c(t)&&(r=n.BINARY_EVENT);var o={type:r,data:t,options:{}};return o.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(a("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),o.id=this.ids++),this.connected?this.packet(o):this.sendBuffer.push(o),delete this.flags,this},p.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},p.prototype.onopen=function(){a("transport is open - connecting"),"/"!==this.nsp&&(this.query?this.packet({type:n.CONNECT,query:this.query}):this.packet({type:n.CONNECT}))},p.prototype.onclose=function(e){a("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},p.prototype.onpacket=function(e){if(e.nsp===this.nsp)switch(e.type){case n.CONNECT:this.onconnect();break;case n.EVENT:case n.BINARY_EVENT:this.onevent(e);break;case n.ACK:case n.BINARY_ACK:this.onack(e);break;case n.DISCONNECT:this.ondisconnect();break;case n.ERROR:this.emit("error",e.data)}},p.prototype.onevent=function(e){var t=e.data||[];a("emitting event %j",t),null!=e.id&&(a("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?l.apply(this,t):this.receiveBuffer.push(t)},p.prototype.ack=function(e){var t=this,r=!1;return function(){if(!r){r=!0;var o=i(arguments);a("sending ack %j",o);var s=c(o)?n.BINARY_ACK:n.ACK;t.packet({type:s,id:e,data:o})}}},p.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(a("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):a("bad ack %s",e.id)},p.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},p.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)l.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},p.prototype.ondisconnect=function(){a("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},p.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},p.prototype.close=p.prototype.disconnect=function(){return this.connected&&(a("performing disconnect (%s)",this.nsp),this.packet({type:n.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},p.prototype.compress=function(e){return this.flags=this.flags||{},this.flags.compress=e,this}})),IO=NO;function NO(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}NO.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},NO.prototype.reset=function(){this.attempts=0},NO.prototype.setMin=function(e){this.ms=e},NO.prototype.setMax=function(e){this.max=e},NO.prototype.setJitter=function(e){this.jitter=e};var RO=EO,CO=kO,PO=$_,MO=C_,jO=TO,qO=AO,LO=p_("socket.io-client:manager"),UO=iO,VO=IO,DO=Object.prototype.hasOwnProperty,FO=BO;function BO(e,t){if(!(this instanceof BO))return new BO(e,t);e&&"object"===(void 0===e?"undefined":e_(e))&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new VO({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[],this.encoder=new MO.Encoder,this.decoder=new MO.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}BO.prototype.emitAll=function(){for(var e in this.emit.apply(this,arguments),this.nsps)DO.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},BO.prototype.updateSocketIds=function(){for(var e in this.nsps)DO.call(this.nsps,e)&&(this.nsps[e].id=this.engine.id)},PO(BO.prototype),BO.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},BO.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},BO.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},BO.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},BO.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},BO.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},BO.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},BO.prototype.open=BO.prototype.connect=function(e,t){if(LO("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;LO("opening %s",this.uri),this.engine=RO(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var i=jO(n,"open",(function(){r.onopen(),e&&e()})),o=jO(n,"error",(function(t){if(LO("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",t),e){var n=new Error("Connection error");n.data=t,e(n)}else r.maybeReconnectOnOpen()}));if(!1!==this._timeout){var s=this._timeout;LO("connect attempt will timeout after %d",s);var a=setTimeout((function(){LO("connect attempt timed out after %d",s),i.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",s)}),s);this.subs.push({destroy:function(){clearTimeout(a)}})}return this.subs.push(i),this.subs.push(o),this},BO.prototype.onopen=function(){LO("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(jO(e,"data",qO(this,"ondata"))),this.subs.push(jO(e,"ping",qO(this,"onping"))),this.subs.push(jO(e,"pong",qO(this,"onpong"))),this.subs.push(jO(e,"error",qO(this,"onerror"))),this.subs.push(jO(e,"close",qO(this,"onclose"))),this.subs.push(jO(this.decoder,"decoded",qO(this,"ondecoded")))},BO.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},BO.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},BO.prototype.ondata=function(e){this.decoder.add(e)},BO.prototype.ondecoded=function(e){this.emit("packet",e)},BO.prototype.onerror=function(e){LO("error",e),this.emitAll("error",e)},BO.prototype.socket=function(e,t){var n=this.nsps[e];if(!n){n=new CO(this,e,t),this.nsps[e]=n;var r=this;n.on("connecting",i),n.on("connect",(function(){n.id=r.engine.id})),this.autoConnect&&i()}function i(){~UO(r.connecting,n)||r.connecting.push(n)}return n},BO.prototype.destroy=function(e){var t=UO(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},BO.prototype.packet=function(e){LO("writing packet %j",e);var t=this;e.query&&0===e.type&&(e.nsp+="?"+e.query),t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,(function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()})))},BO.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},BO.prototype.cleanup=function(){LO("cleanup");for(var e=this.subs.length,t=0;t<e;t++){this.subs.shift().destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},BO.prototype.close=BO.prototype.disconnect=function(){LO("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},BO.prototype.onclose=function(e){LO("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},BO.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)LO("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();LO("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout((function(){e.skipReconnect||(LO("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open((function(t){t?(LO("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(LO("reconnect success"),e.onreconnect())})))}),t);this.subs.push({destroy:function(){clearTimeout(n)}})}},BO.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)};var WO=Kg((function(e,t){var n=d_,r=C_,i=FO,o=p_("socket.io-client");e.exports=t=a;var s=t.managers={};function a(e,t){"object"===(void 0===e?"undefined":e_(e))&&(t=e,e=void 0),t=t||{};var r,a=n(e),c=a.source,u=a.id,l=a.path,p=s[u]&&l in s[u].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||p?(o("ignoring socket cache for %s",c),r=i(c,t)):(s[u]||(o("new io instance for %s",c),s[u]=i(c,t)),r=s[u]),a.query&&!t.query?t.query=a.query:t&&"object"===e_(t.query)&&(t.query=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}(t.query)),r.socket(a.path,t)}t.protocol=r.protocol,t.connect=a,t.Manager=FO,t.Socket=kO})),HO=function(e,t){return void 0===t?e:t},GO=function(){function e(){t_(this,e)}return n_(e,null,[{key:"establish",value:function(e){var t=e.url,n=e.id,r=e.isActiveTab,i=e.options;e.logger.info("Establishing Kluster connection via Channel lib;");var o=function(e,t){return e+(e.split("?")[1]?"&":"?")+t}(t,"id="+n+"&tags="+function(e){var t=e?[{name:"cobrowse",unique:!0}]:[];return encodeURIComponent(JSON.stringify(t))}(r));return WO.connect(o,{"force new connection":!0,timeout:HO(15e3,i.timeout),reconnectionDelay:HO(1e3,i.reconnectionDelay),reconnectionDelayMax:HO(1e3,i.reconnectionDelayMax),randomizationFactor:HO(0,i.randomizationFactor),reconnectionAttempts:HO(Infinity,i.reconnectionAttempts),upgrade:HO(undefined,i.upgrade)})}}]),e}(),zO=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t_(this,e),this.emit=this.emit.bind(this),this.socket=t,this.stopped=null===this.socket,this.tags=n,this.childEmitters=[]}return n_(e,[{key:"stop",value:function(){return this.stopped=!0,this.socket=null,this.childEmitters.map((function(e){return e.stop()}))}},{key:"in",value:function(e){var t=new this.constructor(this.socket,[e],this);return this.childEmitters.push(t),t}},{key:"emit",value:function(e,t){if(!this.stopped){var n={"channel:event_name":e,"channel:event_data":t,"channel:tags":this.tags};return this.socket.emit("announce",n)}}},{key:"authorize",value:function(e){if(!this.stopped)return this.socket.emit("authorize",{token:e})}}]),e}(),JO=function(){function e(t){var n=t.id,r=t.socketId,i=t.tags;t_(this,e),this.id=n,this.socketId=r,this.tags=i}return n_(e,null,[{key:"build",value:function(t){var n=t.tags.map((function(e){return e._name}));return new e({id:t.id,socketId:t.socketId,tags:n})}}]),e}(),QO="channel:meta",YO="current-participants",KO="authorization-response",XO=function(e){return function(t){if(t.type===YO){var n=t.participants.map(JO.build);e(n)}}},$O=function(){function e(t){var n=this,r=t.socket,i=t.url,o=t.id,s=t.logger;t_(this,e),this.url=i,this.id=o,this.socket=r,this.logger=s,this._stopped=!1,this._destroyListeners=[],this.emitter=new zO(this.socket),this.emitAll=this.emitter.emit,this.emit=this.emitter.emit,["on","once"].forEach((function(e){n[e]=function(t,r){if(n._stopped)n.logger.warn("Tried to add eventHandler to stopped channel",{eventType:t});else{if(t===QO)throw new Error("Don't set meta message listeners directly, use specialized functions");n.socket[e](t,r)}}}))}return n_(e,null,[{key:"join",value:function(t){var n=t.url,r=t.id,i=t.isInitiallyActive,o=t.options,s=t.callback,a=t.logger;a=a||sm.logger;var c=GO.establish({url:n,id:r,isActiveTab:i,options:o,logger:a}),u=new e({socket:c,url:n,id:r,logger:a});u.start(),function(e,t,n){var r=void 0,i=void 0,o=function(){e.off("connect",r),e.off("connect_error",i)};r=function(){o(),t()},i=function(e){o(),n()},e.on("connect",r),e.on("connect_error",i)}(c,(function(){s(null,u)}),(function(e){u.cleanUp();var t=new Error("Engagement.Kluster: Could not establish channel");t.channelUrl=n,t.reason=e,s(t,null)}))}}]),n_(e,[{key:"off",value:function(e,t){this.socket.off(e,t)}},{key:"removeAllListeners",value:function(e){this.socket.removeAllListeners(e)}},{key:"onParticipantState",value:function(e){var t=this;if(!this._stopped){this._lastKnownParticipantState&&e(this._lastKnownParticipantState);var n=XO(e);return this.socket.on(QO,n),function(){return t.socket.off(QO,n)}}this.logger.warn("Tried to add eventHandler to stopped channel",{eventType:QO})}},{key:"authorize",value:function(e,t){var n=this,r=function e(r){r.type===KO&&(n.socket.off(QO,e),r.success?(n.logger.info("Engagement.Kluster: Channel authorization succeeded",{url:n.url}),t&&t(!0)):(n.logger.warn("Engagement.Kluster: Channel authorization failed",{url:n.url}),t&&t(!1)))},i=function(){n.socket.on(QO,r),n.emitter.authorize(e())};return this.socket.on("reconnect",i),i(),function(){n.socket.off(QO,r),n.socket.off("reconnect",i)}}},{key:"toTag",value:function(e){return this.emitter.in(e)}},{key:"start",value:function(){var e=this;this.socket.on(QO,XO((function(t){e._lastKnownParticipantState=t}))),this.socket.on("disconnect",(function(t){e.logger.info("Engagement.Kluster: Channel disconnected",{url:e.url,reason:t})})),this.socket.on("connect_error",(function(t){e.logger.warn("Engagement.Kluster: Channel connection error",{url:e.url,error:t})}))}},{key:"destroy",value:function(){null===this.socket||this._stopped||this.socket.emit("close_channel"),this.close()}},{key:"close",value:function(){var e=this;return ZO(this.emitter,(function(e){return e.stop()})),null===this.socket||this._stopped||(this._stopped=!0,setTimeout((function(){return e.socket.disconnect()}),50)),this.cleanUp(),ZO(this.socket,(function(e){return e.removeAllListeners()}))}},{key:"addDestroyListener",value:function(e){return this._destroyListeners.push(e)}},{key:"registerTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t}])}},{key:"registerUniqueTag",value:function(e){var t=e.name;this.socket.emit("register_tags",[{name:t,unique:!0}])}},{key:"cleanUp",value:function(){this._destroyListeners.forEach((function(e){e.call()})),this._destroyListeners=[]}},{key:"isStopped",value:function(){return this._stopped}}]),e}();function ZO(e,t){return null!=e?t(e):void 0}var eE=function(){},tE={},nE=function(e){return tE[e]?tE[e].promise:void 0},rE=function(e,t){nE(t)===e&&function(e){delete tE[e]}(t)},iE=function(e,t,n){n.then((function(e){e.addDestroyListener((function(){return rE(n,e.otherId)}))}),eE),tE[e]={promise:n,url:t}},oE=nE,sE="Engagement.Kluster",aE=function(e){var t=e.isActiveTab,n=e.participantId,r=e.operatorId,i=e.channelUrl,o=e.getAccessToken,s=e.stats,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$O,c=s.withTags(["protocol:websocket"]).instrument({namespace:"join-channel"}).attempted(),u={operator_id:r,channel_url:i,is_active_tab:t};em.log("".concat(sE,": Channel join started"),u);var l=new Promise((function(e,r){var s={timeout:3e4,reconnectionAttempts:30,upgrade:!0};a.join({url:i,id:n,isInitiallyActive:t,options:s,callback:function(t,n){t?(em.warn("".concat(sE,": Channel join failed"),A.merge(u,{error:t})),c.failed(),r(t)):(n.authorize(o),em.info("".concat(sE,": Channel join succeeded"),u),c.succeeded(),n.observable=function(e){return zm(n,e)},e(n))}})}));return iE(r,i,l),zv.Observable.fromPromise(l)},cE=["scroll","keyup","mousemove"];function uE(e){var t=e.getAccessToken,n=e.stats,r=e.start,i=e.stop,o=e.hideMouse,s=e.createChannelObservable,a=e.dynamicImport;s||(s=aE),a||(a=cm);var c=r.distinctUntilChanged().switchMap((function(e){return s({channelUrl:e,participantId:"source",isActiveTab:!0,getAccessToken:t,stats:n})})).publishReplay(1).refCount();this.sourceObservable=c.flatMap((function(e){return a("Cobra").map((function(t){return{Cobra:t,channel:e}}))})).map((function(e){var t=e.Cobra,n=e.channel;return new t.SourceInitializer(n,Rg()).initialize()})).publishReplay().refCount(),this.stopSourceObservable=this.sourceObservable.switchMap((function(e){return i.take(1).map((function(){return e}))})).catch((function(){return zv.Observable.empty()})),this.hideMouseObservable=c.switchMap((function(e){return o.takeUntil(i).map((function(){return e}))})).catch((function(){return zv.Observable.empty()}))}var lE,pE,fE=function(){function e(t,n,r,i){s(this,e),this._sendActivityFromCobrowsableIframe=this._sendActivityFromCobrowsableIframe.bind(this),this.windowMessenger=t,this.channelUrl=n,this.getAccessToken=r,this.stats=i}return c(e,[{key:"boot",value:function(){this._activityObservable().subscribe(this._sendActivityFromCobrowsableIframe);var e=new uE({getAccessToken:this.getAccessToken,stats:this.stats,start:this._startObservable(),stop:this._stopObservable(),hideMouse:this._hideMouseObservable()});e.sourceObservable.subscribe((function(){return em.log("Source started for cobrowsable iframe")}),(function(e){return em.error("Couldn't start visitor cobrowsable iframe ".concat(e))})),e.stopSourceObservable.subscribe((function(e){return e.stop()}),em.error.bind(em,"cobra stop subscription error")),e.hideMouseObservable.subscribe((function(e){return e.toTag("cobrowse").emit("cobra:hide_mouse")}),em.error.bind(em,"cobra hide mouse subscription error")),em.info("Started for visitor Nested CoBrowsable iFrame")}},{key:"_startObservable",value:function(){var e=this.channelUrl?zv.Observable.of(this.channelUrl):zv.Observable.empty();return this._cobrowsableFrameInviteObservable(this.windowMessenger).share().merge(e)}},{key:"_stopObservable",value:function(){return this.windowMessenger.observable("cobra:cobrowsable_iframe:stop")}},{key:"_hideMouseObservable",value:function(){return this.windowMessenger.observable("cobra:hide_mouse")}},{key:"_activityObservable",value:function(){return sm.PeriodicalActivityTracker.getStream(cE)}},{key:"_cobrowsableFrameInviteObservable",value:function(e){return zv.Observable.create((function(t){return e.respondTo("cobra:cobrowsable_iframe:join_channel_and_cobrowse",(function(e,n){var r=e.url;return n(),t.next(r)}))}))}},{key:"_sendActivityFromCobrowsableIframe",value:function(){return this.windowMessenger.emit("activity_from_cobrowsable_iframe")}}]),e}(),hE=new Error("Tried to connect internal visitor state subscription after already connected"),dE=null,bE=A.compose(A.map(A.pick(["id","site_id","operator_id"])),A.pathOr([],["engagement","observations"])),vE=A.compose(A.map(A.pick(["id","site_id","operator_id","outcome"])),A.pathOr([],["engagement","requests"])),mE=A.compose(A.map(A.pick(["id","site_id","status","sub_engagement_id"])),A.pathOr([],["engagement","engagements"])),yE=A.compose(A.map(A.pick(["id","site_id","state"])),A.pathOr([],["omniq","queue_tickets"])),gE=function(e){return em.info("Received internal visitor state",{observations:bE(e),engagement_requests:vE(e),engagements:mE(e),queue_tickets:yE(e)})},_E=sm.logger,wE=function(e){var t=e.status,n=e.body,r=e.error;if(t>=200&&t<300)return zv.Observable.of(n);var i=A.find(A.compose(A.not,A.isNil),[r,n,"unknown"]);return A.is(String,i)?zv.Observable.throw({status:t,reason:i}):zv.Observable.throw(A.merge({status:t},i))},OE=function(e){return A.is(Object,e)&&"timeout"===e.type?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT})):zv.Observable.throw(e)},EE=A.propEq("persisted",!0);A.has("onpagehide",window)?(lE=zv.Observable.fromEvent(window,"pageshow").share(),pE=zv.Observable.fromEvent(window,"pagehide").share()):(lE=zv.Observable.fromEvent(window,"load").share(),pE=zv.Observable.fromEvent(window,"unload").share());var SE={unloadMaybeToPageCache:pE,loadFromPageCache:lE.filter(EE)},TE=new RegExp("sm."),xE=function(e){return"sm.".concat(e)},AE={set:function(e,t){sessionStorage.setItem(xE(e),function(e){return JSON.stringify(e)}(t))},get:function(e){return function(e){try{return JSON.parse(e)}catch(e){return null}}(sessionStorage.getItem(xE(e)))},remove:function(e){sessionStorage.removeItem(xE(e))},removeAll:function(){for(var e=0;e<sessionStorage.length;e++){var t=sessionStorage.key(e);TE.test(t)&&sessionStorage.removeItem(t)}}},kE=function(){function e(t){var n=t.urlParams,r=t.storage,i=t.unloadMaybeToPageCache,o=t.loadFromPageCache,a=t.windowNameStorage,c=t.sessionContext,u=t.tabIdFromConfiguration;s(this,e),this.markAsAlive=this.markAsAlive.bind(this),this.markAsUnloaded=this.markAsUnloaded.bind(this),this.urlParams=n,this.storage=r,this.unloadMaybeToPageCache=i,this.loadFromPageCache=o,this.windowNameStorage=a,this.sessionContext=c,this.tabIdFromConfiguration=u}return c(e,[{key:"init",value:function(){this.localTabId=this._createOrReuseId(),this.markAsAlive(),this.unloadMaybeToPageCache.subscribe(this.markAsUnloaded,sm.logger.error),this.loadFromPageCache.subscribe(this.markAsAlive,sm.logger.error)}},{key:"markAsAlive",value:function(){this._changeTabStatus("alive")}},{key:"markAsUnloaded",value:function(){this._changeTabStatus("unloaded")}},{key:"getId",value:function(){return this.localTabId}},{key:"_createOrReuseId",value:function(){var e;if(e=this.tabIdFromConfiguration||this._findIdFromSessionContext()||this._findIdFromWindowName()||this._findIdFromUrlParams()||this._findIdFromStorage())return e;var t=Math.random().toString(36).substring(2);return sm.logger.info("No existing tab ID found, generated new tab ID",{new_tab_id:t}),t}},{key:"_changeTabStatus",value:function(e){var t=this.storage.get("tab_ids")||{};return t[this.localTabId]=e,this.storage.set("tab_ids",t),this.windowNameStorage.setItem("tab_ids",t)}},{key:"_findIdFromStorage",value:function(){var e;return(e=this._findIdFromTabIds(this.storage.get("tab_ids")||{}))?(sm.logger.info("Found tab ID from session storage",{found_tab_id:e}),e):null}},{key:"_findIdFromSessionContext",value:function(){return this.sessionContext?this.sessionContext.tab_id:null}},{key:"_findIdFromWindowName",value:function(){var e,t=this.windowNameStorage.getItem("tab_ids")||{};return(e=this._anyFromTabIds(t))?(sm.logger.info('Found tab ID from "window.name"',{window_name:window.name,found_tab_id:e}),e):null}},{key:"_findIdFromTabIds",value:function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n];if("unloaded"===e[r])return r}}},{key:"_anyFromTabIds",value:function(e){return Object.keys(e)[0]}},{key:"_findIdFromUrlParams",value:function(){var e;return(e=this.urlParams.tabId)?(sm.logger.info("Found tab ID from url params",{found_tab_id:e}),e):null}}],[{key:"setup",value:function(t,n){var r=n.sessionContext,i=n.tabIdFromConfiguration,o=new e({urlParams:sm.urlParams,storage:AE,windowNameStorage:t,unloadMaybeToPageCache:SE.unloadMaybeToPageCache,loadFromPageCache:SE.loadFromPageCache,sessionContext:r,tabIdFromConfiguration:i});return o.init(),o}}]),e}(),IE=function(e){return function(e){var t=A.propEq("site_id",sm.siteId),n=A.compose(A.any(A.propEq("id",sm.siteId)),A.propOr([],"transferrable_sites")),r=A.pathOr([],["engagement","engagements"],e);try{return A.compose(A.complement(A.isEmpty),A.filter(A.either(t,n)))(r)}catch(t){return void em.error("Engagements were undefined in state",{state:e,engagements:r})}}(e)?"engaged":function(e){return A.compose(A.complement(A.isEmpty),A.filter(A.propEq("site_id",sm.siteId)),A.pathOr([],["engagement","observations"]))(e)}(e)?"observed":"available"},NE=function(e){return e.map(IE).distinctUntilChanged()},RE="high",CE="low",PE="visitor_priority",ME=A.pathOr([],["omniq","queue_tickets"]),jE=A.pathOr([],["engagement","requests"]),qE=A.pathOr([],["engagement","engagements"]),LE=function(e){return function(e){return ME(e).length>0||jE(e).length>0||qE(e).length>0}(e)?RE:CE},UE=function(e,t){var n=e.indexOf(t);return n>-1?[e.substring(0,n),e.substring(n+1)]:[e]},VE=function(e,t,n){n||(n="");var r=g(UE(e,"#"),2),i=r[0],o=r[1],s=g(UE(i,"?"),2),a=s[0],c=s[1],u=A.compose(A.join("&"),A.map(A.concat(n)),A.map(A.join("=")),A.map(A.map(encodeURIComponent)),A.toPairs)(t),l=c?"".concat(a,"?").concat(c,"&").concat(u):"".concat(a,"?").concat(u);return o?"".concat(l,"#").concat(o):l},DE=function(e){try{var t=function(e){var t=e.split(".")[1],n=decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""));return JSON.parse(n)}(e);return(t.exp-t.iat)/2*1e3}catch(e){return em.warn("Fetching interval from access token failed",e),864e5}},FE=function(e){return e?function(){if("function"!=typeof window.getGliaContext)return Promise.resolve({sessionId:null});var e=window.getGliaContext();return"function"!=typeof e.then&&(e=Promise.resolve(e)),e.then((function(e){return Promise.resolve(i(i({},{sessionId:null}),e))}))}().then((function(e){var t=e.sessionId;return t?"external_session_id=".concat(t):""})):Promise.resolve("")},BE=function(e){var t=e.priority,n=e.accessToken,r=e.url,i=e.tabId,o=e.detectVisitorByExternalSessionTokenEnabled;return r||(r=sm.visitorConfigUrl),r=VE(r,{priority:t,tab_id:i}),zv.Observable.create((function(e){var t=new XMLHttpRequest;return t.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){var n=JSON.parse(t.responseText);e.next(n.access_token),e.complete()}else e.error({responseText:t.responseText,status:t.status})},Promise.all([Promise.resolve("access_token=".concat(n)),FE(o)]).then((function(e){t.open("POST",r,!0),t.withCredentials=!0,t.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var n=e.filter(A.identity).join("&");t.send(n)})),function(){return t.abort()}}))},WE=[sm.conf.api_url,"libs.salemove.com","libs.glia.com","visitor.local.dev"],HE=function(e){return A.any((function(t){return A.contains(t,e)}),WE)},GE=function(e){if("string"!=typeof e&&(t=e,n=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i"),!Boolean(n.test(t))))return em.warn("Invalid URL provided",{rawUrl:e}),!1;var t,n;try{var r=new window.URL(e);return HE(r.origin)}catch(t){try{var i=e.trim();return Boolean(i)&&i.length>2&&HE(i)}catch(t){return em.warn("Error validating URL",{rawUrl:e,error:t}),!1}}},zE=A.pick(["response","status","statusText","readyState","responseURL"]),JE=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.onSuccess,c=e.onError,u=new XMLHttpRequest;if(u.open(t,n,!0),o){var l=o();Object.keys(l).forEach((function(e){var t=l[e];u.setRequestHeader(e,t)}))}return u.responseType=i,u.onreadystatechange=function(){if(4===u.readyState)if(u.status>=200&&u.status<300)if("json"===i&&"string"==typeof u.response)try{var e=A.assoc("response",u.response.length>0?JSON.parse(u.response):"",u);a(e)}catch(e){em.error("Could not parse response json in IE11",{error:e,server_response:u.response}),c(u)}else a(u);else c(u)},s&&u.upload.addEventListener("progress",(function(e){e.lengthComputable&&s({loaded:e.loaded,total:e.total})}),!1),GE(n)?u.send("GET"===t?void 0:r):(em.error("Trying to fetch from invalid URL",{rawUrl:n}),c(u)),function(){return u.abort()}},QE=function(e){var t=e.method,n=e.url,r=e.payload,i=e.responseType,o=e.getRequestHeaders,s=e.onUploadProgress,a=e.sendRequest,c=e.contentType;return GE(n)?(t=t||"GET",i=i||"json",a=a||JE,o||(o=function(){return{Accept:"application/vnd.salemove.private+json",Authorization:"Bearer "+sm.accessToken}}),Ee.create((function(e){return a({method:t,url:n,payload:r,responseType:i,getRequestHeaders:c?function(){return A.merge(o(),{"Content-Type":c})}:o,onUploadProgress:s,onSuccess:function(t){e.next(t),e.complete()},onError:function(t){return e.error(zE(t))}})}))):(em.error("Trying to fetch from invalid URL",{rawUrl:n}),lr(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR,message:"Request URL is invalid"})))},YE=function(e){var t=e.url,n=e.method,r=e.payload,i=e.responseType,o=e.contentType,s=e.getRequestHeaders,a=e.calculateAttemptDelay,c=e.retryLimit,u=void 0===c?5:c,l=e.onSuccess,p=e.onError,f=void 0===p?function(){}:p,h=e.onAttempt,d=void 0===h?function(){}:h,b=e.onAttemptError,v=void 0===b?function(){}:b,m=e.shouldRetry,y=void 0===m?function(){return!0}:m;R({calculateAttemptDelay:a,attempt:function(e){var a=e.repeat;d(),JE({method:n,url:t,payload:r,responseType:i,getRequestHeaders:o?function(){return A.merge(s(),{"Content-Type":o})}:s,onError:function(e){var t=y(e.status);v(t),(t?a:f)(e)},onSuccess:l})},onGiveUp:f,retryLimit:u})},KE=function(e,t){var n=e.url,r=e.assetKey,i=e.onError,o=e.onSuccess,s=e.identifier,a={method:"GET",responseType:"json",onSuccess:function(e){t.increment("sm.assets.load",["action:succeeded","asset:".concat(r)]),o(e)},onAttempt:function(){t.increment("sm.assets.load",["action:attempted","asset:".concat(r)])},onAttemptError:function(e){em.warn("Failed fetching ".concat(r).concat(e?", retrying":""),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:warning","asset:".concat(r)])},onError:function(){em.warn("Error fetching ".concat(r),{asset_url:n,identifier:s}),t.increment("sm.assets.load",["action:failed","asset:".concat(r)]),"function"==typeof i&&i()}};YE(A.merge(a,e))},XE=function(){function e(t){s(this,e),this.attributes=A.clone(t),this.id=this.attributes.id}return c(e,[{key:"get",value:function(e){return this.attributes[e]}},{key:"set",value:function(e){var t=this;Object.keys(e).forEach((function(n){var r=e[n];t.attributes[n]=r}))}},{key:"getId",value:function(){return this.get("id")}},{key:"getName",value:function(){return this.get("name")}},{key:"getFormattedName",value:function(){return this.get("formattedName")}},{key:"getMediaType",value:function(){return this.get("media_type")}},{key:"isOnline",value:function(){return!this.isUnavailable()}},{key:"currentlyAvailable",value:function(){return!this.currentlyUnavailable()}},{key:"currentlyUnavailable",value:function(){return this.isEngaged()||this.isUnavailable()}},{key:"isEngaged",value:function(){return"engaged"===this.get("status")}},{key:"mediaRank",value:function(){switch(this.getMediaType()){case"text":return.8;case"audio":return.9;case"video":return 1;default:return 0}}},{key:"getPictureUrl",value:function(){var e=this.get("picture")&&this.get("picture").url,t=sm.conf.visitor_app.always_use_default_operator_picture,n=sm.conf.visitor_app.default_operator_picture.url;if(!n||!t&&e){var r=-1!==sm.conf.assets.server.indexOf("libs.")?"/":sm.conf.assets.prepend;return e||[sm.conf.assets.server,r||"/","default_operator_picture-6dd946062.png"].join("")}return n}},{key:"isUnavailable",value:function(){return!1===this.get("available")}}]),e}(),$E=function(e){return A.filter(A.contains(A.__,["video"]),e)};function ZE(e){return/iPad|iPhone|iPod/.test(e)&&!window.MSStream}function eS(e){return/^((?!CriOS|Chrome|Android).)+Safari/.test(e)}function tS(e){return 0===e.length}function nS(e,t){return-1!==t.indexOf(e)}function rS(e){var t=e.match(/OS ((\d+_?){2,3})\s/);if(!t)return!1;var n=t[1].split("_"),r=n[0]+"."+n[1];return parseFloat(r)>=11.3}function iS(e){if(ZE(e))return rS(e);var t=function(e){var t=e.match(/Version\/([0-9]+\.[0-9]*)/);return t&&parseFloat(t[1],10)}(e);return!!t&&t>=11}function oS(){return[{name:"RTCPeerConnection",pass:Boolean(window.RTCPeerConnection)},{name:"RTCIceCandidate",pass:Boolean(window.RTCIceCandidate)},{name:"AudioContext",pass:Boolean(window.AudioContext)||Boolean(window.webkitAudioContext)},{name:"MediaStream",pass:Boolean(window.MediaStream)}]}function sS(){return[].concat(_(oS()),[{name:"getUserMedia",pass:Boolean(window.navigator.mediaDevices)&&Boolean(window.navigator.mediaDevices.getUserMedia)}])}var aS={video:"camera",audio:"microphone"};function cS(e,t,n){if(null==n)return!0;var r=aS[t];return!!nS(r,n)&&(!eS(e)||!nS("".concat(r," *"),n))}function uS(){var e=window.navigator.userAgent;return!(eS(e)&&ZE(e)&&!rS(e))&&tS(oS().filter((function(e){return!e.pass})))}function lS(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.media,n=e.iframeAllow,r=window.navigator.userAgent;if(!cS(r,t,n))return!1;if(eS(r)&&!iS(r))return!1;var i=sS().filter((function(e){return!e.pass}));return tS(i)}var pS=Object.freeze({__proto__:null,canReceiveMedia:uS,canSendMedia:lS}),fS="none",hS="receiver",dS="duplex",bS=function(){return uS()?lS()?dS:hS:fS},vS=["video","audio"],mS={video:["video","audio","phone","text"],audio:["audio","phone","text"],phone:["phone","text"],text:["text"]},yS=A.lensPath(["state","medias"]),gS=A.lensPath(["state","oneWayMedias"]),_S=function(e,t){var n=A.difference(e.state[t],vS);return A.assocPath(["state",t],n,e)},wS=A.curry((function(e,t){return e===dS||e===hS?t:_S(t,"oneWayMedias")})),OS=A.curry((function(e,t){return e===dS?t:_S(t,"medias")})),ES=function(e){return A.assocPath(["state","media"],e.state.medias,e)},SS=A.curry((function(e,t){var n,r=e.enabledMediaType,i=e.webRtcMode;return A.compose(ES,wS(i),OS(i),(n=r,A.over(gS,A.intersection($E(mS[n])))),function(e){return A.over(yS,A.intersection(mS[e]))}(r))(t)})),TS=function e(t){var n=t.id,r=t.name,i=t.formattedName,o=t.picture,a=t.state;s(this,e),this.id=n,this.name=r,this.formattedName=i||(null==r?void 0:r.split(" ")[0]),this.picture=o,this.state=a,this.assignment={type:"direct"}},xS=function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return c(n,[{key:"serialize",value:function(){return new TS({id:this.getId(),name:this.getName(),formattedName:this.getFormattedName(),picture:this._getPicture(),state:this._getState()})}},{key:"_getPicture",value:function(){return{url:this.getPictureUrl()}}},{key:"_getState",value:function(){var e=mS[this.getMediaType()];return{available:this.currentlyAvailable(),medias:e,oneWayMedias:$E(e)}}}]),n}(XE),AS=A.curry((function(e,t){var n=e.enabledMediaType,r=e.webRtcMode,i=new xS(t.attributes).serialize();return SS({enabledMediaType:n,webRtcMode:r},i)})),kS=function(e){var t=e.id,n=e.name,r=e.formattedName,i=e.picture,o=e.mediaType,s=e.webRtcMode,a=e.enabledMediaType,c=new xS({id:t,name:n,formattedName:r,picture:i,media_type:o});return AS({enabledMediaType:a,webRtcMode:s},c)},IS=function(e){var t=e.enabledMediaLevel,n=e.webRtcMode,r=function(e,t){return{operator:e,isVisible:void 0!==e.state.available&&e.reactiveEnabled&&(A.isEmpty(t)||!A.isEmpty(A.intersection(e.teamIds,t)))}};return{fromPresence:function(e,i,o){var s=i.state,a=A.pathOr("operator",["operator_information","name"],s),c=A.pathOr(null,["operator_information","picture","url"],s),u=A.pathOr([],["operator_information","teams"],s),l=A.map(A.prop("id"),u),p=A.pathOr(!0,["operator_information","reactive_enabled"],s),f=A.pathOr([],["engagement","media"],s),h=A.has("engagement",s);-1!==f.indexOf("audio")&&f.push("phone");var d={id:e,name:a,picture:{url:c},state:{available:h?!A.isEmpty(f):void 0,media:f,medias:f,oneWayMedias:f},teamIds:l,reactiveEnabled:p};return d=SS({enabledMediaType:t,webRtcMode:n},d),r(d,o)},updateVisibility:r}},NS=function e(t,n){t||(t={}),n||(n={});return{omit:function(r){return e(A.dissoc(r,t),A.dissoc(r,n))},set:function(r){var i=r.operator,o=r.isVisible?A.assoc(i.id,i,n):A.dissoc(i.id,n);return e(A.assoc(i.id,i,t),o)},forEach:function(e){return A.values(t).forEach(e)},immutableFacade:function(){return{get:function(e){var t=n[e];return t?new TS(t):t},values:function(){return A.map(A.construct(TS),A.values(n))}}}}},RS=function(e){var t=e.presence,n=e.presenceMapper,r=e.visibleTeamsObservable,i=e.onChange,o=NS(),s=[],a=r.subscribe((function(e){s=e,o.forEach((function(e){var t=n.updateVisibility(e,s),r=t.operator,i=t.isVisible;o=o.set({operator:r,isVisible:i})})),i(o.immutableFacade())}));t.list((function(e,t){return n.fromPresence(e,t,s)})).forEach((function(e){var t=e.operator,n=e.isVisible;o=o.set({operator:t,isVisible:n})})),i(o.immutableFacade()),t.onChange((function(e,t,r){if(r.metas.length>0){var a=n.fromPresence(e,r,s),c=a.operator,u=a.isVisible;o=o.set({operator:c,isVisible:u})}else o=o.omit(e);i(o.immutableFacade())}));return{stop:function(){return a.unsubscribe()}}},CS="salemove",PS=function(e){try{return JSON.parse(e.name)||{}}catch(e){return{}}},MS=function(e){return""===e.name},jS=function(e){return MS(e)||function(e){return PS(e).hasOwnProperty(CS)}(e)},qS=function(e){return A.lensPath([CS,e])},LS=[void 0,null,"javascript:;",""],US=!1,VS=function(e,t){if(t||(t=sm.conf.navigatable_hostnames),A.contains(e,LS))return!0;var n=US?t.engaged:t.available;return A.any((function(t){return e.indexOf(t)>-1}))(n)},DS={isInEngagement:US,setEngagedStatus:function(e){US=e},extractLinkFromEvent:function(e){try{var t=e.target;return t&&(t=function(e,t){t=t.toUpperCase();do{if(e.nodeName===t)return e}while(e=e.parentNode);return null}(t,"a")),t}catch(e){return null}},isAllowedToNavigate:VS},FS=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.isAllowed,n=void 0===t?VS:t;Lm(document.querySelectorAll('a[target="_blank"]')).filter((function(e){return"javascript:void(0)"!==e.href})).filter((function(e){return n(e.hostname)})).forEach((function(e){return e.setAttribute("target","_self")}))},BS=["target","defaultPrevented","ctrlKey","shiftKey","metaKey","button"],WS=function(e){var t=e.getCurrentUrl,n=e.linkHandler,r=e.clicks,i=e.navigate,o={},s=function(e){var t=e.event,n=e.link;try{var r=n.href;sm.logger.info("XDomainUrlStorage: adding params to URL",{params:o});var s=VE(r,o,"__sm.");sm.logger.info("XDomainUrlStorage: navigating to modified URL",{original_url:r,modified_url:s}),t.preventDefault(),i(s)}catch(e){sm.logger.error("XDomainUrlStorage: error trying to store values in URL",e)}},a=function(e){return"_blank"!==e.link.target},c=function(e){var t=e.link;return!A.isEmpty(t.href)&&!A.isNil(t.href)&&A.contains(t.protocol,["http:","https:"])},u=function(e){var n=e.link;return!A.contains(n.hostname,t())},l=function(e){var t=e.link;return n.isAllowedToNavigate(t.hostname)},p=function(e){var t=e.event;return!(t.ctrlKey||t.shiftKey||t.metaKey)},f=function(e){return 0===e.event.button},h=function(e){try{return BS.forEach((function(t){return e[t]})),!0}catch(e){return!1}},d=function(e){return!e.defaultPrevented},b=function(e){for(var t=e.target;t&&t.nodeName&&"a"!==t.nodeName.toLowerCase();)t=t.parentElement;return t};return{start:function(){return r.filter((function(){return!A.isEmpty(o)})).filter(h).filter(d).map((function(e){return{event:e,link:b(e)}})).filter(A.where({link:A.complement(A.isNil)})).filter(c).filter(a).filter(u).filter(p).filter(f).filter(l).subscribe(s,(function(e){return sm.logger.error("XDomainUrlStorage: error while filtering user click event",e)}),(function(){return sm.logger.error("XDomainUrlStorage: clicks observable was completed")}))},setItem:function(e,t){o=A.assoc(e,t,o)},getItem:function(e){return sm.urlParams?sm.urlParams[e]:void 0}}},HS=function(){return{getItem:function(e){return window.localStorage.getItem("sm."+e)},setItem:function(e,t){return window.localStorage.setItem("sm."+e,t)}}},GS=function(){var e,t,n=(e=window,{getItem:function(t){if(!MS(e))return A.view(qS(t),PS(e))},setItem:function(t,n){if(jS(e)){var r=PS(e),i=A.set(qS(t),n,r);e.name=JSON.stringify(i)}}}),r=(t=zv.Observable.merge(Gm(document,"click"),Gm(document,"mousedown")),new WS({getCurrentUrl:function(){return window.location.href},linkHandler:DS,clicks:t,navigate:function(e){window.location.href=e}})),i=sm.conf.visitor_api,o=i.persist_session_in_url_on_xdomain_navigation,s=i.persist_visitor_session_in_url;(o||s)&&r.start();var a,c=new HS;return{bestEffortXDomainStorage:(a={prioritizedStorages:[n,r,c]}.prioritizedStorages,{getItem:function(e){return function(e,t){for(var n=0;n<e.length;n++){var r=e[n].getItem(t);if(null!=r)return r}}(a,e)},setItem:function(e,t){return a.forEach((function(n){return n.setItem(e,t)}))}}),windowNameStorage:n,xDomainUrlStorage:r,localStorage:c}},zS=function(e){var t=e.internalVisitorStateObservable,n=e.defaultQueues;return t.map((function(e){return function(e,t){var n=A.pathOr({},["routing",sm.siteId,sm.tabId],e);return A.has("queues",n)?{queue_ids:n.queues}:t.length>0?{queue_ids:t.map((function(e){return e.id}))}:{}}(e,n)})).distinctUntilChanged(A.equals)},JS="sm.app.visitor_api.custom_code",QS=function(e){var t=e.stats,n=e.loadCustomCodeScript,r=sm.conf.customCodeFile?sm.conf.customCodeFile.url:void 0;return r?(n||(n=M),new Promise((function(e,i){var o={integrity:C()?sm.conf.customCodeFile.sri:null,fileUrl:r,beforeLoad:function(){return e({ignored:!1})},onAttempt:function(){return t.increment(JS,["action:attempted"])},onLoad:function(){return t.increment(JS,["action:succeeded"])},onError:function(){return t.increment(JS,["action:warning"])},onGiveUp:function(){return t.increment(JS,["action:failed"]),sm.logger.warn(new Error("Failed to load custom code"),{custom_code_url:r})}};return n(o)}))):Promise.resolve({ignored:!0})};function YS(e,t){var n=t.targetWindow,r=t.logger,i="__sm.",o=n.location.search,s=n.location.href;try{var a=o.replace("?","").split("&").filter((function(e){return e.indexOf(i)>-1})),c=a.map((function(e){return e.split("=")})).map((function(e){var t=g(e,2),n=t[0],r=t[1];return{key:n.replace(i,""),value:r}})).map((function(e){var t=e.key,n=e.value;return{key:decodeURIComponent(t),value:decodeURIComponent(n)}})).reduce((function(e,t){var n=t.key,r=t.value;return e[n]=r,e}),{}),u=a.reduce((function(e,t){return e.replace(new RegExp("[\\?|&]".concat(t)),"")}),s);return u!==s&&(r.info("Found sm params in URL",{params:c,url_length:s.length}),(n.history?n.history.replaceState:void 0)&&(r.info("Replacing page URL",{original_url:s,new_url:u}),n.history.replaceState(n.history.state,n.document.title,u))),function(t){return Object.keys(e).filter((function(e){return Boolean(t[e])})).map((function(n){return{key:n,value:t[n],regex:e[n]}})).reduce((function(e,t){var n=t.key,i=t.value,o=t.regex;return i.match(o)?e[n]=i:r.error("URL query param does no satisfy provided regex",{param_key:n,param_value:i,regex:o}),e}),{})}(c)}catch(e){return r.error("Error reading sm params from URL",e),{}}}var KS=function(){return void 0!==window.MutationObserver||void 0!==window.WebKitMutationObserver||void 0!==window.MozMutationObserver},XS=function(e){return/android/i.test(e.userAgent)},$S=Object.freeze({__proto__:null,domMutationsSupported:KS,screenCapturingSupported:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.navigator;return Boolean(A.path(["mediaDevices","getDisplayMedia"],e))&&!XS(e)}});function ZS(e,t){var n,r=t.salemovePresentInParent,i=function(){var t={url:e.location.href,page_title:e.title};if(r)return window.parent.postMessage(JSON.stringify({"sm-xdr-url":t.url}),"*")};this.start=function(){n=new zv.Subscription;var e=sm.hrefObservable.skip(1);return n.add(e.subscribe(i,em.error))},this.stop=function(){n&&n.unsubscribe()}}var eT=function(e){return new zv.Subscription((function(){return e.stop()}))},tT=function(e){return A.reduce(A.maxBy(A.prop("activity_at")),e[0],e)},nT=function(e,t){return t?!e||e.activity_at<t.activity_at?t:e:(em.warn("New active tab is not defined",{new_active_tab:t}),e)};function rT(e,t,n){var r=this,i=t.salemovePresentInParent,o=t.renewFrequency,s=t.visitorPresenceChannel,a=t.tabId,c=void 0===a?sm.tabId:a;this.onStart=n;var u,l=1e3*o,p=zv.Observable.timer(1e4).mapTo({tab_id:c,page_url:location.href}).do((function(){return em.warn("Defaulting active tab to true, multi-tab cobrowsing can misbehave")})),f=s.getSameVisitorConnections().filter(A.complement(A.isEmpty)),h=new _y({allowAnySource:!0}),d=zm(h,"sm:iframe_tab_id").startWith([]).scan((function(e,t){return A.union([t],e)})).distinctUntilChanged(A.equals),b=f.map(tT).scan(nT).merge(p.takeUntil(f)).publishReplay(1),v=b.combineLatest(d).map((function(e){var t=g(e,2),n=t[0],r=t[1];return n.tab_id===c||A.contains(n.tab_id,r)})).distinctUntilChanged(A.equals),m=new ZS(e,{salemovePresentInParent:i}),y=Oy(),_=v.switchMap((function(e){var t=e?l:1500;return y.throttleTime(t)})).map((function(e){return{value:e,timestamp:Date.now()}})).share(),w=function(){return s.getPresenceObservable().take(1).switchMap((function(e){return b.take(1).map((function(t){return{presence:e,activeTab:t}}))})).subscribe((function(t){var n=t.presence,r=t.activeTab,i={page_description:e.title};return r.tab_id!==c&&(i.set_active_tab=!0,i.page_url=location.href),r.tab_id===c&&r.page_url!==location.href&&(i.page_url=location.href),n.channel.push("activity",i,5e3).receive("error",(function(e){return em.warn("Unable to send activity update to presence",e)})).receive("timeout",(function(){}))}),(function(e){return em.warn("Unable to send activity update to presence",{error:e})}))},O=function(){if(!r.started){r.started=!0,em.info("Starting activity tracker"),h.start(),m.start(),_.skip(1).subscribe((function(){return w()}),em.error);var e=new zv.Subscription([b.connect(),eT(h),eT(m)]);r.onStart(e)}};this.requestStart=function(){s.requestJoin(),s.getPresenceObservable().take(1).subscribe((function(){return O()}))},this.requestStartWhenSpaceAvailable=function(){s.requestJoinAllowRejection(),s.getPresenceObservable().take(1).subscribe((function(){return O()}))},this.getUserIsActiveTabObservable=function(){return r.requestStart(),v},this.avoidGoingIdle=function(){r.requestStart(),u&&clearInterval(u),u=setInterval(w,5e3)}}rT.NavigationUpdater=ZS;var iT=function(){},oT=A.propEq("site_id",sm.siteId),sT=A.compose(A.any(A.propEq("id",sm.siteId)),A.propOr([],"transferrable_sites")),aT=A.compose(A.nth(0),A.filter(A.either(oT,sT)),A.pathOr([],["engagement","engagements"])),cT=A.compose(A.nth(0),A.filter((function(e){return!e.outcome})),A.filter(oT),A.pathOr([],["engagement","requests"])),uT=A.compose(A.nth(0),A.filter(A.propEq("site_id",sm.siteId)),A.pathOr([],["engagement","observations"])),lT=function(e){var t=e.visitor;if(t)return{name:t.name,email:t.email}},pT=function(e){var t=e.operator,n=A.map(A.prop("name"),t.teams);return{id:t.id,teamNames:n}},fT=function(e){var t,n,r;return(t=aT(e))?{interaction:"engagement",channelUrl:t.channel_url,operator:pT(t),visitor:lT(t)}:(n=cT(e))?{interaction:"engagement",channelUrl:n.channel_url,operator:pT(n),visitor:lT(n)}:(r=uT(e))?{interaction:"observation",channelUrl:r.channel_url,operator:pT(r),visitor:lT(r)}:{}},hT=function(e){var t=g(e,2),n=t[0],r=t[1],i=n.operator?n.operator.id:void 0,o=n.channelUrl,s=r.channelUrl;if(i&&o&&o!==s){var a=oE(i);if(a)return a.then((function(e){return e.destroy()}),iT)}},dT=function(e){var t,n,r,i=e.internalVisitorStateObservable,o=e.getAccessToken,s=e.stats,a=e.visitorPresenceChannel,c=e.salemovePresentInParent;if(sm.trackerSubscription=new zv.Subscription,sm.tracker=t=new rT(document,{renewFrequency:(n=sm.conf.engagement.visitor_time_to_inactive_sec,r=sm.conf.engagement.renew_freq_muliplier||.8,Math.max(10,Math.round(n*r))),salemovePresentInParent:c,stats:s,visitorPresenceChannel:a},(function(e){return sm.trackerSubscription.add(e)})),sm.conf.visitor_api.visitor_presence_join_limited){var u=A.pathOr([],["engagement","observations"]),l=A.pathOr([],["engagement","requests"]),p=A.pathOr([],["engagement","engagements"]),f=A.pathOr([],["omniq","queue_tickets"]),h=function(e){return u(e).length>0||l(e).length>0||p(e).length>0||f(e).length>0};i.filter(h).take(1).subscribe((function(){return t.requestStart()})),i.take(1).filter(A.complement(h)).subscribe((function(){return t.requestStartWhenSpaceAvailable()}))}else t.requestStart();var d,b=(d={internalVisitorStateObservable:i},d.internalVisitorStateObservable.map(fT).distinctUntilChanged(A.equals).startWith({}).bufferCount(2,1).do(hT).map((function(e){var t=g(e,2);return t[0],t[1]})).startWith({})).publishReplay(1);b.subscribe((function(e){DS.setEngagedStatus("engagement"===e.interaction)}));var v=function(e,t,n,r){return e.distinctUntilChanged(null,(function(e){return e.channelUrl})).do(null,em.warn.bind(em,"Failed to setup channel observable")).filter((function(e){return Boolean(e.interaction)})).switchMap((function(e){return t.getUserIsActiveTabObservable().take(1).map((function(t){return{status:e,isActiveTab:t}}))})).switchMap((function(e){var t=e.status,i=e.isActiveTab;return aE({channelUrl:t.channelUrl,participantId:"visitor",operatorId:t.operator.id,isActiveTab:i,getAccessToken:n,stats:r}).catch((function(){return zv.Observable.empty()})).map((function(e){return{channel:e,operator:t.operator}}))})).share()}(b,t,o,s).publishReplay(1);return sm.channelSubscription=v.connect(),b.connect(),{statusObservable:b,channelObservable:v.filter((function(e){var t=e.channel,n=e.operator;return!t.isStopped()||(em.warn("Filtering out stopped channel in channelObservable",{channelUrl:t.url,operator:n,siteId:sm.siteId}),!1)})),tracker:t}},bT={get:function(e){return e.checked},set:function(e,t){e.checked=t}},vT={select:{get:function(e){return A.compose(A.fromPairs,A.map((function(e){return[e.index,e.selected]})))(e.options)},set:function(e,t){A.forEach((function(e){e.selected=t[e.index]}))(e.options)}},option:{get:function(e){return e.selected},set:function(e,t){e.selected=t}},radio:bT,checkbox:bT,default:{get:function(e){return e.value},set:function(e,t){if("function"==typeof Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(e,"value")&&Object.getOwnPropertyDescriptor(e,"value").set)try{return Object.getOwnPropertyDescriptor(e.constructor.prototype,"value").set.call(e,t)}catch(n){e.value=t}else e.value=t}}},mT=function(e){var t=vT[e.type]||vT[e.nodeName&&e.nodeName.toLowerCase()]||vT.default,n=t.get,r=t.set;return{get:function(){return n(e)},set:function(t){r(e,t)}}},yT="sm_engagement_serialized_inputs",gT=function(e,t){return A.compose(A.forEach((function(t){var n=t.destInput,r=t.value;return t.hook.set(r),function(e,t){var n=e.createEvent("HTMLEvents");return n.initEvent("change",!0,!1),t.dispatchEvent(n)}(e,n)})),A.filter((function(e){var t=e.hook,n=e.value;return!A.equals(t.get(),n)})),A.map((function(e){var t=e.destInput;return{destInput:t,value:e.value,hook:mT(t)}})),A.filter((function(e){var t=e.destInput;return Boolean(t)})),A.map((function(t){var n=t.value,r=t.xpath;return{value:n,destInput:Hm(e,r)}})))(t)},_T=function(e){var t=A.compose((function(e){return Array.prototype.slice.call(e)}),(function(t){return e.getElementsByTagName(t)})),n=A.chain(t,["INPUT","TEXTAREA","SELECT","PASSWORD","CHECKBOX","RADIO"]);return A.map((function(e){return{value:mT(e).get(),xpath:Fm(e)}}),n)},wT=[A.ifElse(A.path(["state","available"]),A.always(1),A.always(0)),A.compose(A.length,A.path(["state","media"]))],OT=A.reduce(A.maxBy((function(e){return A.ap(wT,[e])})),null),ET=function(e){return sm.conf.api_url+e},ST=function(e){return function(e){return e.filter(A.propEq("connected",!1))}(e).switchMap((function(){return e.filter(A.propEq("connected",!0)).take(1)}))},TT=function(e,t){t||(t=QE);return t({url:ET("/engagements/".concat(e,"/chat_transcript?_=").concat(Date.now()))}).pipe(lb(A.prop("response")),lb(A.filter((function(e){var t=e.sender.type;return A.contains(t,["operator","visitor"])}))),Pd((function(t){return em.warn("Failed to fetch chat history",{error:t,engagement_id:e}),mt([])})))},xT=function(e){var t=e.engagementId,n=e.connectionStatusObservable,r=e.requestAsObservable;return ST(n).pipe(mb((function(){return TT(t,r)})),Bb())},AT=zv.Observable.throw(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR})).do(null,(function(){return em.warn("Operators observable timed out!")})),kT=function(e,t){t||(t=[]);return e.increment("engagement.flow",["entrypoint:reactive-request"].concat(t))},IT=function(e,t,n,r){r||(r=zv.Scheduler.asap);var i=t||{},o=i.operatorId,s=i.phoneNumber,a=i.phoneExtension,c=i.source,u=i.oneWay,l=i.siteId;l||(l=sm.siteId);var p=n.api,f=n.operatorsObservable,h=n.serverResponseTimeout,d=n.engagementCoreObservable,b=n.mediaValidation,v=n.statsClient;em.info("Engagement: Reactive request initiated",{media:e,options:t});var m=o?A.find(A.propEq("id",o)):OT,y=f.timeoutWith(h,AT,r).map(m).flatMap((function(e){return e?zv.Observable.of(e):zv.Observable.throw(new tg({cause:Hy.SALEMOVE.OPERATOR_UNAVAILABLE}))}));return zv.Observable.combineLatest(y,d).flatMap((function(n){return function(n){var i=n.state.medias,o=n.state.oneWayMedias;return zv.Observable.fromPromise(b({media:e,options:t,availableMediaTypes:i,availableOneWayMediaTypes:o}),r).map(A.always(n))}(g(n,1)[0])})).flatMap((function(t){var n={phoneNumber:s,phoneExtension:a,oneWay:u};return kT(v,["action:reach","stage:create-request"]),p.create({operatorId:t.id,siteId:l,media:e,source:c,mediaOptions:n}).map((function(r){return A.merge(r,{operator:t,media:e,mediaOptions:n})}))}))},NT=function(e,t){t||(t=zv.Scheduler.asap);var n=e.media,r=e.mediaOptions,i=e.mediaValidation,o=e.api,s=e.notifyOfTimeout,a=e.operatorsObservable,c=e.engagementCoreObservable,u=e.cobraObservable,l=e.channelObservable,p=e.serverResponseTimeout,f=e.communicationLib,h=e.engagementApi,d=e.webRtcMode,b=e.enabledMediaLevel,v=e.statsClient,m=IT(n,r,{api:o,operatorsObservable:a,serverResponseTimeout:p,engagementCoreObservable:c,mediaValidation:i,statsClient:v},t).publishReplay(),y=m.connect();kT(v,["action:begin"]);var g=m.flatMap((function(e){var n=e.engagementRequestId,r=e.acknowledgeTimeoutSeconds,i=e.operator;return kT(v,["action:reach","stage:requested"]),zv.Observable.combineLatest(o.acceptedObservable,u,l,(function(e,t){return A.merge(e,{cobra:t})})).timeoutWith(1e3*r+p,function(e,t){return zv.Observable.throw(new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT})).do(null,(function(){return em.warn("Engagement request timed out! Some internal listener must be missing.")})).do(null,(function(){return e.notifyOfReactiveFailure({id:t})}))}(o,n),t).merge(Ym(function(e){return zv.Observable.merge(o.declinedObservable.map(A.always(new tg({cause:Hy.SALEMOVE.OPERATOR_DECLINED}))),o.timedOutObservable.do((function(){return s({operator:e})})).map(A.always(new tg({cause:Hy.SALEMOVE.TIMEOUT}))))}(i))).take(1)})).do(null,A.ifElse(A.propEq("cause",Hy.SALEMOVE.INTERNAL_ERROR),em.warn.bind(em,"Engagement: Reactive request failed"),em.info.bind(em,"Engagement: Reactive request failed"))).do(null,(function(e){return kT(v,["action:end"].concat(function(e){return e&&e.cause===Hy.SALEMOVE.OPERATOR_UNAVAILABLE?["stage:pre-request","expected:true","reason:target-unavailable"]:e&&e.cause===Hy.SALEMOVE.INVALID_INPUT?["stage:pre-request","reason:invalid-input"]:e&&e.cause===Hy.SALEMOVE.INTERNAL_ERROR?["stage:create-request","reason:internal-error"]:e&&e.cause===Hy.SALEMOVE.TIMEOUT?["stage:requested","expected:true","reason:accept-timeout"]:e&&e.cause===Hy.SALEMOVE.OPERATOR_DECLINED?["stage:requested","expected:true","reason:decline"]:e&&e.cause===Hy.SALEMOVE.NETWORK_TIMEOUT?["stage:create-request","reason:network-error"]:["stage:pre-request","reason:script-load-error"]}(e)))})).map((function(e){var t,r,i,o,s,a,c,u,p,v;i=e.engagementId,v=e.subEngagementId,t=e.cobra,n=e.media,s=e.operatorId,c=e.operatorName,u=e.operatorFormattedName,p=e.operatorPicture,a=e.operatorMediaType,o=e.entrypoint,r=e.createdAt;var m=kS({id:s,name:c,formattedName:u,picture:p,mediaType:a,webRtcMode:d,enabledMediaType:b});return em.info("Engagement: Reactive request accepted",{engagementId:i,subEngagementId:v,operator:m}),{engagementId:i,subEngagementId:v,startingMedia:n,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:TT(i),operator:m,communicationLib:f,cobra:t,channelObservable:l,engagementApi:h,entrypoint:o,createdAt:r}})).take(1).finally((function(){return y.unsubscribe()}));return{requestObservable:m,resultObservable:g}},RT=function e(t){var n=t.id,r=t.content,i=t.status,o=t.attachment,a=t.created_at;if(s(this,e),this.id=n,this.content=r,this.sender="visitor",this.sender_details={type:"visitor"},this.status=null,this.attachment=o,this.created_at=a,i){if(!A.find(A.equals(i),A.values(this.STATUSES)))throw new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR,message:"Unknown status ".concat(i)});this.status=i}};RT.prototype.STATUSES={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},RT.prototype.ATTACHMENT_RESPONSE_TYPES={SINGLE_CHOICE_RESPONSE:"single_choice_response",FILES:"files"};var CT=function e(t){var n=t.id,r=t.content,i=t.attachment,o=t.metadata,a=t.created_at,c=t.sender,u=void 0===c?{}:c;s(this,e),this.id=n,this.content=r,this.sender="operator",this.sender_details={type:"operator",name:u.name,picture:u.picture?u.picture.url:"",id:u.id},this.attachment=i,this.metadata=o,this.created_at=a};CT.prototype.ATTACHMENT_TYPES={SINGLE_CHOICE:"single_choice",FILES:"files"};var PT=sm.conf.visitor_app_option,MT=function(e,t){return e===t},jT=function(e,t){var n=A.differenceWith(A.eqProps("id"),e,t);return 0===n.length?t:A.concat(n,t)},qT=function(e,t,n){var r=e.pipe(db(t),Db((function(e,t){var n=A.findIndex(A.propEq("id",t.id),e);return-1!==n?A.update(n,t,e):A.prepend(t,e)}),[]),Yb([]));return bt(r,n,jT).pipe(Qd(MT))},LT=function(e){var t=e.chatHistoryObservable,n=e.ownMessages,r=e.operatorMessages,i=e.statsClient,o=e.SENDERS,s=e.fetchExtraOperatorInfo,a=n.pipe(lb((function(e){var t=e.id,n=e.content,r=e.attachment;return new RT({id:t,content:n,attachment:r,status:null})}))),c=n.pipe(mb((function(e){var t=e.id,n=e.content,r=e.status,i=e.attachment;return r.pipe(lb((function(e){return new RT({id:t,content:n,attachment:i,status:e})})))})));r=r.pipe(Jd(A.prop("id")),mb((function(e){var t=e.sender.id;return s(t).pipe(lb((function(t){return A.evolve({sender:A.merge(t)})(e)})))})),lb((function(e){var t=e.id,n=e.content,r=e.attachment,i=e.metadata,o=e.sender;return new CT({id:t,content:n,attachment:r,metadata:i,sender:o})})));var u=t.map(A.reverse).map(A.map((function(e){var t=e.id,n=e.sender,r=e.message,i=e.attachment,s=e.metadata,a=n.type;return a===o.VISITOR?new RT({id:t,content:r,attachment:i,status:RT.prototype.STATUSES.DELIVERED}):a===o.OPERATOR?new CT({id:t,content:r,attachment:i,metadata:s,sender:n}):void 0}))),l=qT(c,r,u).pipe(rv((function(){i.increment("sm.app.visitor_api.chat.messages",["action:emitted","visitor_app:".concat(PT)])})));return{messages:qT(a,r,u),messagesWithStatusUpdates:l}},UT=function e(t){var n=t.typing;s(this,e),this.typing=n},VT="visitor";function DT(e){this.recordChatMessageSent=function(t){1===t?e.increment("sm.".concat(VT,".communication.chat.message.sent")):e.increment("sm.".concat(VT,".communication.chat.message.retry"))},this.recordChatMessageDeliveryFailed=function(){e.increment("sm.".concat(VT,".communication.chat.message.delivery_failed"))},this.recordChatMessageDelivered=function(){e.increment("sm.".concat(VT,".communication.chat.message.delivered"))}}var FT={SENDING:"sending",DELIVERED:"delivered",FAILED:"failed"},BT="Chat",WT=function(){function e(t){var n=t.chatApi,r=t.messagesToSend,i=t.previewToSend,o=t.deliveryTimeout,a=void 0===o?sm.conf.chat_message_send_timeout_ms||15e3:o,c=t.history,u=t.guid,l=void 0===u?vy:u,p=t.stats,f=t.logger;s(this,e),this._chatApi=n,this._previewToSend=i,this._history=c,this._generateGuid=l,this._messagesToSend=r,this._deliveryTimeout=a,this.stats=p,this.logger=f,this._messengerStoppedSubject=new Pe,this._sentMessages=new Pe,this._deliveryEvents=this._chatEvents("deliveredMessages"),this._receivedMessageIds=[],this._subscription=new ae}return c(e,[{key:"start",value:function(){var e=this;this._subscription.add(this._messagesToSend.subscribe(this._sendMessage.bind(this),this.logger.error)),this._subscription.add(this._previewToSend.subscribe((function(t){return e._chatApi.sendPreview({content:t})}),this.logger.error)),this._subscription.add(this._messagesReceivedFromHistory().subscribe(this._acceptReceivedMessage("history"),(function(t){return e.logger.warn("".concat(BT,": Failed to fetch chat history"),t)})))}},{key:"stop",value:function(){this._chatApi.stop(),this._messengerStoppedSubject.next(),this._subscription.unsubscribe()}},{key:"observables",value:function(){return{ownMessages:this._sentMessages.pipe(db(this._receivedVisitorMessages())),operatorMessages:this._receivedOperatorMessages(),operatorTypingIndicator:this._chatApi.operatorTypingIndicator}}},{key:"_chatEvents",value:function(e){return this._chatApi[e].pipe(tv(this._messengerStoppedSubject))}},{key:"_receivedVisitorMessages",value:function(){return this._chatEvents("receivedVisitorMessages").pipe(lb(A.merge({status:mt(FT.DELIVERED)})))}},{key:"_sendMessageAndWaitForAcknowledgement",value:function(e){var t=this,n=e.message,r=this._deliveryEvents.pipe(tb((function(e){return A.equals(n.id,e.id)})),Zb(1),Bb()),i=r.subscribe(A.always);return this._chatApi.sendMessage(n).pipe($b(r.pipe(pb(FT.DELIVERED),cv(this._deliveryTimeout,lr("".concat(BT,": Message timed out before being delivered to other participant"))))),Pd((function(e){return t.logger.info("".concat(BT,": Message delivery failed with error"),{error:e,message_id:n.id}),mt(FT.FAILED)})),Zb(1),nb(i.unsubscribe))}},{key:"_sendMessage",value:function(e){var t,n,r,i,o,s,a=this,c=(t=e,n=this._generateGuid,r=t.content,i=t.options,o=i?i.attachment:void 0,s=i?i.metadata:void 0,{id:n(),content:r,attachment:o,metadata:s}),u=new hi(1).distinctUntilChanged();return u.next(FT.SENDING),this._sentMessages.next(A.merge(c,{status:u})),this._addToReceived(c),this._subscription.add(this._sendMessageAndWaitForAcknowledgement({message:c}).subscribe((function(e){u.next(e),e===FT.DELIVERED&&(u.complete(),a.stats.recordChatMessageDelivered(),a.logger.info("".concat(BT,": Message delivered to other participant"),{message_id:c.id})),e===FT.FAILED&&a.stats.recordChatMessageDeliveryFailed()}),this.logger.error))}},{key:"_acceptReceivedMessage",value:function(e){var t=this;return function(n){t.logger.info("".concat(BT,": Message received"),{message_id:n.id,source:e}),t._addToReceived(n),t._chatApi.markMessageAsDelivered(n.id)}}},{key:"_receivedOperatorMessages",value:function(){var e=this;return this._chatEvents("receivedOperatorMessages").pipe(tb((function(t){return e._messageNotReceived(t)})),mb((function(t){return mt(t).pipe(rv(e._acceptReceivedMessage("participant")),Pd((function(){return mt(t)})))})),Bb())}},{key:"_messagesReceivedFromHistory",value:function(){var e=this;return this._history.pipe(tb((function(t){return e._messageNotReceived(t)})),mb((function(e){return Bt(e)})))}},{key:"_messageNotReceived",value:function(e){return!A.contains(e.id,this._receivedMessageIds)}},{key:"_addToReceived",value:function(e){this._receivedMessageIds=A.append(e.id,this._receivedMessageIds)}}]),e}();WT.STATUSES=FT;var HT=n.default.visitor_api.own_typing_duration||5e3;var GT="engagement.chat.message",zT="engagement.chat.message_status",JT="engagement.chat.typing_indicator.operator",QT="engagement:chat_message:preview_update",YT="Chat",KT={retryLimit:5,initialDelay:1e3,maxDelay:void 0,factor:1.5},XT=function(e){return 0===e||421===e||429===e||e>=500},$T=function(){},ZT=function(e){var t,n,r=e.engagementId,i=e.visitorId,o=e.logger,s=e.stats,a=e.channelObservable,c=e.xhrWithRetry,u=void 0===c?YE:c,l=e.getRequestHeaders,p=e.siteVisitorNotifications,f=new Pe,h=function(e){return e.attachment?{content:e.content,attachment:e.attachment}:{content:e.content}},d=(t=f.map(A.prop("content")),t.pipe(Xb((function(e){return""===e?Ov.of(!1):Ov.merge(Ov.of(!0),Ov.timer(HT,n).map((function(){return!1})))})),ov(50,n,{leading:!0,trailing:!0}),Qd())).subscribe((function(e){JE({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/typing_indicator"),payload:JSON.stringify({typing:e}),responseType:"json",getRequestHeaders:function(){return A.merge(l?l():{},{"Content-Type":"application/json"})},onSuccess:$T,onError:function(e){return o.warn("Could not set typing indicator",e)},onAttempt:$T,shouldRetry:function(){return!1}})})),b=f.startWith({content:""}).combineLatest(a).subscribe((function(e){var t=g(e,2),n=t[0];t[1].emit(QT,{engagement_id:r,content:n.content,visitor_id:i})}),o.error.bind(o,"".concat(YT,": Error sending chat preview"))),v=A.compose(A.merge({type:"user"}),A.pick(["id","engagement_id","content","attachment","metadata","sender"]),A.prop("message")),m=A.compose(A.pick(["id","engagement_id"]),A.prop("message")),y=A.propEq("event_type",GT),_=A.propEq("event_type",zT),w=A.pathEq(["message","engagement_id"],r),O=["message","sender","type"],E=A.pathEq(O,"operator"),S=A.pathEq(O,"visitor"),T=A.pathEq(["message","status"],"delivered"),x=p.pipe(tb(A.allPass([y,w]))),k=x.pipe(tb(E),lb(v)),N=x.pipe(tb(S),lb(v)),R=p.pipe(tb(A.allPass([_,w,T])),lb(m)),C=A.propEq("event_type",JT),P=A.pathEq(["typing_indicator","engagement_id"],r);return{stop:function(){b.unsubscribe(),d.unsubscribe()},sendMessage:function(e){var t=e.id;return Ee.create((function(n){var i=0;u({method:"PUT",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(t),payload:JSON.stringify(h(e)),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:I(KT.initialDelay,KT.maxDelay,KT.factor),retryLimit:KT.retryLimit,onSuccess:function(t){o.info("".concat(YT,": Message sent to system, waiting for it to be delivered to other participant"),{message_id:e.id}),n.next(t),n.complete()},onError:function(e){var r=e.status,i=e.statusText,s="".concat(YT,": Failed to send message to system");o.warn(s,{message_id:t,status:r,status_text:i}),n.error(s)},onAttempt:function(){++i>1&&o.info("Chat: Send message request failed, retrying",{message_id:t,attempt:i}),s.recordChatMessageSent(i)},shouldRetry:XT})})).pipe(Zb(1))},sendPreview:function(e){return f.next(e)},markMessageAsDelivered:function(e,t,n){u({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(r,"/chat_messages/").concat(e),payload:JSON.stringify({status:"delivered"}),responseType:"json",contentType:"application/json",getRequestHeaders:l,calculateAttemptDelay:I(KT.initialDelay,KT.maxDelay,KT.factor),retryLimit:KT.retryLimit,onSuccess:function(){o.info("".concat(YT,": Marked message as delivered"),{message_id:e}),"function"==typeof t&&t()},onError:function(t){var r=t.status,i=t.statusText;o.warn("".concat(YT,": Failed to mark message as delivered"),{message_id:e,status:r,status_text:i}),"function"==typeof n&&n()},shouldRetry:XT})},receivedOperatorMessages:k,receivedVisitorMessages:N,deliveredMessages:R,operatorTypingIndicator:p.pipe(tb(A.allPass([C,P])),lb(A.prop("typing_indicator")),Db((function(e,t){return t.clock>e.clock?t:e})),lb(A.pick(["typing"])),Qd(A.equals))}},ex=function(e,t){for(var n,r=[];n=t.exec(e);)r.push(n[1]);return r},tx=function(e,t,n){return t&&A.forEach((function(t){var r=t.split("").join(".*?");e=e.replace(new RegExp(r),n)}),t),e},nx=function(e){var t=!0;return e.split("").reduceRight((function(e,n){return n=parseInt(n,10),(t=!t)&&(n*=2),n>9&&(n-=9),e+n}),0)%10==0},rx=A.compose((function(e){var t=new RegExp(/(?:^|\D)(\d{3}(-| )\d{2}(-| )\d{4})(?=\D|$)/g),n=ex(e,t);return tx(e,n,"***Social Security Number Not Allowed***")}),(function(e){var t=new RegExp("(\\d{".concat(12,",})"),"g"),n=ex(function(e){var t=new RegExp("([a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12})|([^(a-zA-Z0-9)])","gm");return e.replace(t,"$1")}(e),t),r=A.filter(nx,n);return tx(e,r,"***Credit Card Number Not Allowed***")})),ix=function(e){var t=e.content,n=e.options;return{content:rx(t),options:n}},ox=function(e){return e.replace(/[0-9]/g,"*")},sx=function(){function e(t){var n=t.channelObservable,r=t.historyObservable,i=t.getRequestHeaders,o=t.logger,a=t.statsClient,c=t.engagementId,u=t.visitorId,l=t.siteVisitorNotifications;s(this,e);var p=new DT(a);this._messagesToSend=new Pe,this._previewToSend=new Pe,this.chatApi=new ZT({engagementId:c,visitorId:u,logger:o,stats:p,channelObservable:n,getRequestHeaders:i,siteVisitorNotifications:l}),this.messenger=new WT({chatApi:this.chatApi,stats:p,logger:o,messagesToSend:this._messagesToSend.pipe(lb(ix)),previewToSend:this._previewToSend.pipe(lb(ox)),history:r}),this.messenger.start()}return c(e,[{key:"sendMessage",value:function(e,t){this._messagesToSend.next({content:e,options:t})}},{key:"sendMessagePreview",value:function(e){this._previewToSend.next(e)}},{key:"stop",value:function(){this.messenger.stop()}},{key:"observables",value:function(){return this.messenger.observables()}}]),e}(),ax=function(){function e(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.observeChatMessages,o=t.statsClient,a=t.chatController,c=t.fetchExtraOperatorInfo;s(this,e);var u=new ae,l=Ag(),p=a.observables(),f=p.operatorMessages,h=p.ownMessages,d=p.operatorTypingIndicator,b=i({chatHistoryObservable:n,operatorMessages:f,ownMessages:h,statsClient:o,fetchExtraOperatorInfo:c,SENDERS:this.SENDERS}),v=b.messages.pipe(Nb(1)),m=b.messagesWithStatusUpdates.pipe(Nb(1));u.add(v.connect()),u.add(m.connect());var y=d.pipe(lb(A.construct(UT)),Yb(new UT({typing:!1})),Nb(1));u.add(y.connect());var g=function(){l.stop(),u.unsubscribe()},_=A.fromPairs([[this.EVENTS.MESSAGES,v],[this.EVENTS.MESSAGES_WITH_STATUS_UPDATES,m],[this.EVENTS.OPERATOR_TYPING_STATUS_UPDATE,y]]);l.proxyAll(_),this.addEventListener=l.addEventListener,this.removeEventListener=l.removeEventListener,this.observable=function(e){return _[e]},this.sendMessage=function(e,t){a.sendMessage(e,t),a.sendMessagePreview("")},this.sendMessagePreview=function(e){a.sendMessagePreview(e)},r.subscribe((function(){}),g,g)}return c(e,null,[{key:"create",value:function(t){var n=t.chatHistoryObservable,r=t.engagementEndObservable,i=t.statsClient,o=t.engagementId,s=t.getRequestHeaders,a=t.siteVisitorNotifications,c=um.vent.observable(um.MSG.PUBLIC.ENGAGEMENT_START),u=Ee.defer((function(){return um.request("get:engagement_observables").engagementObservable})),l=function(e){var t=e.getRequestHeaders,n=e.xhrWithRetry,r=void 0===n?YE:n,i=e.takeUntilNotifier,o={},s={},a=i||new zv.Subject;return function(e){return o[e]?mt(o[e]):Ee.create((function(n){if(s[e])s[e].push(n);else{s[e]=[n];var i=function(e){return function(){s[e]&&(s[e].forEach((function(e){e.next(),e.complete()})),delete s[e])}}(e);r({method:"GET",url:"".concat(sm.conf.api_url,"/operators/").concat(e,"?include_engagements=false"),responseType:"json",contentType:"application/json",getRequestHeaders:t,onSuccess:function(t){o[e]=t.response,s[e]&&(s[e].forEach((function(e){e.next(t.response),e.complete()})),delete s[e]),delete s[e]},onError:i,shouldRetry:function(){return!1}})}})).pipe(tv(a))}}({getRequestHeaders:s}),p=function(e){var t=e.chatHistoryObservable,n=e.engagementStartObservable,r=e.engagementObservables,i=e.siteVisitorNotifications,o=e.getRequestHeaders,s=e.statsClient,a=e.engagementId,c=n.pipe(yb(r),xb("channel"),Nb(1)),u=c.connect(),l=new sx({channelObservable:c,historyObservable:t,getRequestHeaders:o,statsClient:s,logger:sm.logger.withTags({engagement_id:a,site_id:sm.siteId}),engagementId:a,visitorId:Qv(),siteVisitorNotifications:i});return{chatController:l,stopChat:function(){l.stop(),u.unsubscribe()}}}({chatHistoryObservable:n,engagementStartObservable:c,siteVisitorNotifications:a,engagementObservables:u,statsClient:i,engagementId:o,getRequestHeaders:s}),f=p.chatController,h=p.stopChat;return{chat:new e({chatHistoryObservable:n,engagementEndObservable:r,observeChatMessages:LT,statsClient:i,chatController:f,fetchExtraOperatorInfo:l}),stopChat:h}}}]),e}();ax.prototype.EVENTS={MESSAGES:"messages",MESSAGES_WITH_STATUS_UPDATES:"messages-with-status-updates",OPERATOR_TYPING_STATUS_UPDATE:"operator-typing-status-update"},ax.prototype.SENDERS={VISITOR:"visitor",OPERATOR:"operator"};var cx={OBSERVATION:"OBSERVATION",ENGAGEMENT:"ENGAGEMENT",POINTER:"POINTER"},ux=function(){function e(t,n){s(this,e),this.mode=t,this.session=n}return c(e,null,[{key:"createObservation",value:function(){return new this(cx.OBSERVATION,null)}},{key:"createActive",value:function(e){return new this(e.mode,e.session)}}]),e}(),lx=function(){function e(t){var n=t.cobra;s(this,e),this.stop=function(){return n.switchToObservation()}}return c(e,[{key:"stop",value:function(){}}]),e}(),px=function(){function e(t){var n=t.operator,r=t.channel;s(this,e),this.operator=n,this.allow=function(){return r.emitAll("engagement:offer_cobrowsing:allow"),em.info("Visitor accepted cobrowsing request"),null},this.decline=function(){return r.emitAll("engagement:offer_cobrowsing:deny"),em.info("Visitor declined cobrowsing request"),null}}return c(e,[{key:"allow",value:function(){}},{key:"decline",value:function(){}}]),e}(),fx=function e(t){var n=this,r=t.cobra,i=t.operator,o=t.channelObservable,a=t.fromRxJs4,c=void 0===a?Qm:a;s(this,e);var u=o.switchMap((function(e){var t=e.channel;return t.emitAll("engagement:offer_cobrowsing:ready"),t.observable("engagement:offer_cobrowsing:offer_cobrowsing").do((function(){return t.emitAll("engagement:offer_cobrowsing:ack")})).map(A.always({channel:t}))})).do((function(){return em.info("Received cobrowsing request")})).share().map((function(e){var t=e.channel;return new px({operator:i,channel:t})})),l=c(r.modeObservable.pluck("name").map((function(e){return e===n.MODES.OBSERVATION?ux.createObservation():ux.createActive({mode:e,session:new lx({cobra:r})})}))),p=A.fromPairs([[this.EVENTS.COBROWSING_REQUEST,u],[this.EVENTS.MODE_CHANGE,l]]),f=kg(),h=Ag();h.proxyAll(p),f.proxyAll(p),this.resendPage=function(){"function"==typeof r.resendPage&&r.resendPage()},this.addUnbufferedEventListener=h.addEventListener,this.removeUnbufferedEventListener=h.removeEventListener,this.addBufferedEventListener=f.addEventListener,this.removeBufferedEventListener=f.removeEventListener,this.observable=function(e){return h.observable(e)},this.bufferedObservable=function(e){return f.observable(e)}};fx.prototype.EVENTS={COBROWSING_REQUEST:"cobrowsing_request",MODE_CHANGE:"cobrowser_mode_change"},fx.prototype.MODES=cx;var hx=function(e){return"browser"===e?"audio":"phone"},dx=function(e){var t=e.upgradeRequest,n=e.currentMediaState,r={audio:A.path(["audio","direction"],n),video:A.path(["video","direction"],n)},i=A.pick(["audio","video"],t),o=A.invert(r).two_way||[],s=A.invert(i).two_way||[];return!A.isEmpty(A.difference(s,o))},bx="two_way",vx="one_way",mx=function(e,t){return A.maxBy((function(e){return e===bx?2:e===vx?1:0}),e,t)},yx=function(e){if(e){if(e.video)return"video";if(e.audio&&"browser"===e.audio.type)return"audio";if(e.audio&&"phone"===e.audio.type)return"phone"}return"text"},gx=function(e){return e.stateObservable.bufferCount(2,1).filter((function(e){var t=g(e,2),n=t[0],r=t[1];return n.sub_engagement_id!==r.sub_engagement_id})).do(em.log.bind(em,"Detect sub_engagement change")).map((function(e){var t=g(e,2);t[0];return t[1]})).map((function(e){var t=new XE({id:e.operator.id,name:e.operator.name||"Operator",formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},media_type:e.operator.media_type}),n={id:e.id,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,mediaState:e.media_state,operatorId:t.getId(),operatorName:t.getName(),operatorFormattedName:t.getFormattedName(),operatorPicture:t.getPictureUrl(),operatorMedia:t.getMediaType()};return n=A.assoc("startingMedia",yx(n),n)})).map(A.pick(["operatorId","operatorName","operatorFormattedName","operatorPicture","operatorMedia","startingMedia","subEngagementId","id"])).map(A.merge({isReestablishing:!1,isTransfer:!0})).do(em.log.bind(em,"Engagement transferred"))},_x=function(e){var t,n=e.engagement,r=e.transfers,i=e.channelObservable,o=e.webRtcMode,s=e.statusObservable,a={id:n.engagementId,subEngagementId:n.subEngagementId,startingMedia:n.startingMedia,isReestablishing:n.isReestablishing,operatorId:n.operator.id,operatorName:n.operator.name,operatorFormattedName:n.operator.formattedName,operatorPicture:n.operator.picture?n.operator.picture.url:void 0,operatorMedia:(t=n.operator.state.medias,A.findLast(A.contains(A.__,t),zy)),observable:n.observable.bind(n),EVENTS:n.EVENTS},c=s.filter(A.propEq("interaction","engagement")).map(A.prop("channelUrl")).take(1),u=i.switchMap((function(e){var t=e.channel;return c.map((function(e){return{channel:t,engagementChannelUrl:e}}))})).filter((function(e){var t=e.channel,n=e.engagementChannelUrl;return t.url===n})).take(1);return zv.Observable.of(a).merge(r).switchMap((function(e){return u.map((function(t){var n=t.channel;return A.merge({channel:n},e)}))})).map(A.evolve({startingMedia:A.when(A.isNil,A.always(n.startingMedia))})).map((function(e){return A.merge(e,{webRtcMode:o})}))};function wx(e){return A.reduce((function(e,t){return e.then((function(e){return t.then((function(t){return A.append(t,e)}))}))}),Promise.resolve([]),e)}var Ox=A.compose(A.join(", "),A.map((function(e){return"'".concat(e,"'")}))),Ex=/^\+?[1-9]\d{1,14}$/,Sx=function(e){return new Promise((function(t,n){return function(e){return Boolean(e&&e.phoneNumber)}(e)?(r=e.phoneNumber,Ex.test(r)?void t():n(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Invalid phone number: '".concat(e.phoneNumber,"'! Make sure that country code is present in the number and it has plus sign (+) prefix")}))):n(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"'phone' was specified as the media but the 'phoneNumber' option is missing!"}));var r}))},Tx=function(e){return new Promise((function(t,n){if(function(e){return e&&e.hasOwnProperty("phoneExtension")}(e)&&(null!==(r=e.phoneExtension)&&!r.match(/^(,*\d,*){1,7}$/)))return n(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Invalid phone extension: '".concat(e.phoneExtension,"'! The phone extension can only contain commas and up to 7 digits.")}));var r;t()}))},xx=function(e){var t=e.media,n=e.options,r=e.availableMediaTypes,i=e.availableOneWayMediaTypes,o=e.visitorUpgradesAllowed,s=e.highestAllowedMediaType,a=[],c=!1===o?A.drop(r.indexOf(s),r):r;return a.push(function(e,t,n,r,i){return new Promise((function(o,s){if(i.oneWay){if(!1===r)return s(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if(!A.contains(e,n))return s(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(Ox(n),"!")}))}if(!i.oneWay&&!A.contains(e,t))return s(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Media must be one of: ".concat(Ox(t),"!")}));o()}))}(t,c,i,o,n||{})),"phone"===t&&(a.push(Sx(n)),a.push(Tx(n))),wx(a)},Ax=function(e){var t=e.options,n=e.availableMediaTypes,r=e.availableOneWayMediaTypes,i=e.visitorUpgradesAllowed,o=e.highestAllowedMediaType,s=[],a=!1===i?A.drop(n.indexOf(o),n):n;return s.push(function(e,t,n,r){return new Promise((function(i,o){if(e.audio){var s=["browser","phone"];if(!A.contains(e.audio,s))return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Audio must be one of: ".concat(Ox(s),"!")}));if(!A.contains("audio",t)&&!A.contains("phone",t))return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Audio is not supported!"}))}if(e.video){var a=["one_way","two_way"];if(!A.contains(e.video,a))return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Video must be one of: ".concat(Ox(a),"!")}));if("one_way"===e.video&&!1===r)return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"This site does not support 'one-way' option!"}));if("one_way"===e.video&&!A.contains("video",n))return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"One-way video is not supported!"}));if("two_way"===e.video&&!A.contains("video",t))return o(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Video is not supported!"}))}i()}))}(t,a,r,i)),"phone"===t.audio&&(s.push(Sx(t)),s.push(Tx(t))),wx(s)},kx=function e(t){var n=this;s(this,e);var r=t.visitor,i=t.operator;this.visitor=A.compose(A.evolve({phoneStatus:function(e){switch(e){case um.MSG.PHONE_STATUSES.CONNECTED:return n.PHONE_STATUSES.CONNECTED;case um.MSG.PHONE_STATUSES.CONNECTING:return n.PHONE_STATUSES.CONNECTING;default:return n.PHONE_STATUSES.UNUSED}}}),A.pickAll(["media","audioMuted","videoMuted","phoneStatus"]))(r),this.operator=A.pickAll(["media","audioMuted","videoMuted"],i)};kx.prototype.PHONE_STATUSES={CONNECTED:"connected",CONNECTING:"connecting",UNUSED:"unused"};var Ix=function e(t){var n=t.id,r=t.label,i=t.is_default,o=t.position;if(s(this,e),this.id=n,this.label=r,this.is_default=i,this.position=o,!this.id||!this.label)throw em.error("Survey choice missing parameters",{parameters:{id:n,label:r,is_default:i,position:o}}),new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR,message:"Survey choice is missing required parameters"})},Nx=function e(t){var n=this,r=t.id,i=t.text,o=t.name,a=t.type,c=t.required,u=t.position,l=t.options;s(this,e),this.id=r,this.text=i,this.name=o,this.type=a,this.required=c,this.position=u,this.options=l;var p=function(){return n.options&&Array.isArray(n.options)&&!A.isEmpty(n.options)};if("single_choice"===this.type&&p()&&(this.options=this.options.map((function(e){return new Ix(e)}))),"single_choice"!==this.type||p()||em.warn("Single choice survey question missing options",{parameters:arguments[0]}),!(this.id&&this.text&&this.name&&this.type))throw em.error("Survey question missing parameters",{parameters:arguments[0]}),new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR,message:"Survey question is missing required parameters"})},Rx=function e(t,n){var r=this,i=t.survey;s(this,e),this.id=i.id,this.description=i.description,this.title=i.title,this.type=i.type,this.name=i.name,this.questions=i.questions.map((function(e){return new Nx(e)})).filter((function(e){return!(e.type===r.QUESTION_TYPES.SINGLE_CHOICE&&A.isEmpty(e.options))})),this.answer=function(e){return n({surveyId:i.id,answers:Vy(e)})}};Rx.prototype.QUESTION_TYPES={BOOLEAN:"boolean",SCALE:"scale",TEXT:"text",SINGLE_CHOICE:"single_choice"};var Cx=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),Px=["#inner-page",".socketio","script[src*='".concat(n.default.assets.server,"']"),"#cobrowsing-mouse-container","style[data-page-iframer='keep']"],Mx=n.default.visitor_app.is_custom_theme?["body > link","head > link"]:["link[href*='".concat(n.default.assets.server,"']"),"link[href*='".concat(n.default.api_url,"']"),"link[href*='https://uploads.salemove.com']"],jx=Px.concat(Mx),qx=function(){function e(t,n){s(this,e),this._retainedElementsBySelector=this._retainedElementsBySelector.bind(this),this._document=t,n||(n=[]),this._filters=n}return c(e,[{key:"clean",value:function(){this._removeAccordingToFiltersLeavingTopLevelInPlace(),this._cleanHtmlElementOfUnnecessaryAttributes(),this._overrideBodyInlineStyles(),this._hideParentsOfKeptHiddenElements()}},{key:"_removeAccordingToFiltersLeavingTopLevelInPlace",value:function(){var e=A.chain(this._retainedElementsBySelector,this._filters),t=Lm(this._document.head.querySelectorAll("*")).concat(Lm(this._document.body.querySelectorAll("*")));return A.differenceWith(A.identical,t,e).filter((function(e){return"title"!==e.localName})).map((function(e){return e.parentNode.removeChild(e)}))}},{key:"_retainedElementsBySelector",value:function(e){var t=Lm(this._document.querySelectorAll(e));return A.chain((function(e){return Lm(e.querySelectorAll("*")).concat([e]).concat(qm(e))}),t)}},{key:"_cleanHtmlElementOfUnnecessaryAttributes",value:function(){var e=this._document.querySelector("html");Lm(e.attributes).filter((function(e){return"lang"!==e.name})).forEach((function(t){return e.removeAttribute(t.name)}))}},{key:"_overrideBodyInlineStyles",value:function(){this._document.body.removeAttribute("style")}},{key:"_hideParentsOfKeptHiddenElements",value:function(){if(this._filters.length>0){var e=Lm(this._document.body.querySelectorAll("*")).filter(jm),t=Lm(this._document.body.querySelectorAll(this._filters.join(","))),n=A.chain((function(e){var t=Lm(e.querySelectorAll("*")).concat([e]);return jm(e)?t.concat(qm(e)):t}),t);A.differenceWith(A.identical,e,n).forEach((function(e){e.style.display="none"}))}}}]),e}(),Lx=sm.conf.visitor_app.css_prefix||"sm-",Ux={id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:[]},Vx=function(){function e(t){s(this,e);var n=A.merge(Ux,t);this._id=n.id,this._targetUrl=n.getTargetUrl(),this._targetDocument=n.document||window.document,this._iframeElement=this._createIframeElement(this._targetDocument);var r=(n.nonRemoved||[]).concat(["#".concat(this._id)]).concat(jx);this._cleaner=new qx(this._targetDocument,r),this._iframeTargetPointer=n.targetId,this._wrapIframe=n.wrapIframe}return c(e,[{key:"putIntoIframe",value:function(){var e=this;return new Promise((function(t,n){var r=_T(e._targetDocument);return e._iframeElement.style.visibility="hidden",e._callWhenIframeLoaded((function(){return e._iframeElement.style.visibility="",gT(e._iframeElement.contentDocument,r),e._clearCurrentDom(),t({iframe:e._iframeElement})})),e._insertIframe()}))}},{key:"_clearCurrentDom",value:function(){return this._cleaner.clean()}},{key:"_createIframeElement",value:function(e){var t=e.createElement("iframe");return t.setAttribute("id",this._id),t}},{key:"_insertIframe",value:function(){var e;this._iframeElement.src=this._targetUrl,this._ensureBodyExists();var t=this._iframeSiblingElement();if(this._wrapIframe){var n=this._targetDocument.createElement("div");n.setAttribute("id","".concat(Lx,"inner-page-wrapper")),n.appendChild(this._iframeElement),e=n}else e=this._iframeElement;t?this._targetDocument.body.insertBefore(e,this._iframeSiblingElement()):this._targetDocument.body.appendChild(e),this._iframeElement.contentWindow.location.href=this._targetUrl}},{key:"_iframeSiblingElement",value:function(){if(this._iframeTargetPointer)return this._targetDocument.getElementById(this._iframeTargetPointer)}},{key:"_callWhenIframeLoaded",value:function(e){return this._iframeElement.addEventListener("load",(function t(n){return n.target.removeEventListener("load",t),e()}))}},{key:"_ensureBodyExists",value:function(){if(!this._targetDocument.body){var e=this._targetDocument.createElement("body");return this._targetDocument.appendChild(e)}}}]),e}(),Dx="sm-wrapped-page",Fx=function(){function e(t){var n=t.document,r=t.nonRemoved;s(this,e),this.wrap=this.wrap.bind(this),this.unwrap=this.unwrap.bind(this),this.document=n,this.nonRemoved=(r||[]).concat(["#".concat(this._id)]).concat(jx)}return c(e,[{key:"wrap",value:function(){var e=this._createWrappingDiv(),t=this.nonRemoved.join(", ");Lm(this.document.body.children).forEach((function(n){Um(n,t)||Um(n,"iframe")&&"none"===window.getComputedStyle(n).display||e.appendChild(n)}));var n=this.document.body.children[0];this.document.body.insertBefore(e,n)}},{key:"unwrap",value:function(){var e=this.document.getElementById(Dx);e&&(Lm(e.children).forEach((function(t){e.parentNode.appendChild(t)})),e.parentNode.removeChild(e))}},{key:"_createWrappingDiv",value:function(){var e=this.document.createElement("div");return e.id=Dx,e.className=Dx,e}}]),e}(),Bx=function e(t){var n=t.media,r=t.medias;s(this,e),this.media=n,this.medias=r},Wx=function(e,t){"iframe"===e?document.querySelector("#inner-page").contentWindow.location.assign(t):window.location.href=t},Hx=function(e){var t=e.volatileNotifications,n=e.visitorPageAdaption;return t.filter(A.both(A.propEq("site_id",sm.siteId),A.propEq("event","navigation_to_url"))).map(A.prop("payload")).subscribe(Wx.bind(this,n),em.error.bind(em,"Unable to navigate to url"))},Gx=function e(t){var n=t.medraStream;s(this,e),this.stream=n.getWebMediaStream()},zx=function(){function e(t){var n=t.medraStream,r=t.connection;s(this,e),n.getWebMediaStream().getVideoTracks()[0].onended=function(){return r.stop()},this.stopSharing=function(){return r.stop(),null}}return c(e,[{key:"stopSharing",value:function(){}}]),e}(),Jx=function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r};Jx.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Qx=function e(t){var n=t.status,r=t.screen;s(this,e),this.status=n,this.screen=r};Qx.prototype.STATUSES={SHARING:"sharing",NOT_SHARING:"not_sharing"};var Yx=function e(t){var n=t.onAccept,r=t.onDecline;s(this,e),this.accept=function(){return n().then((function(){return{}}))},this.decline=function(){r()}},Kx=function(){return{mediaDevices:navigator.mediaDevices}},Xx=function(e){var t,n=e.conf,r=e.channelObservable,i=e.namespace,o=e.videoProvider;return cm("Medra").map(A.prop("default")).map((function(e){return new e({webRTC:{iceServers:n.communications.webrtc_server,videoProvider:o}})})).flatMap((function(e){return r.do((function(){t&&(sm.logger.info("Stopping Medra connection due to new channel"),t.stop())})).flatMap((function(t){var n=t.channel;return Jm(e.connect(n,{namespace:i}))})).do((function(e){t=e}))}))},$x=function(){function e(t){var n=t.adapter,r=t.operatorScreenSharedObservable,i=t.visitorScreenSharedObservable,o=t.screenShareRequestedObservable;s(this,e),this.EVENTS={OPERATOR_STATE_UPDATE:"operator_state_update",VISITOR_STATE_UPDATE:"visitor_state_update",SCREEN_SHARING_REQUEST:"screen_sharing_request"};var a=A.fromPairs([[this.EVENTS.OPERATOR_STATE_UPDATE,r],[this.EVENTS.VISITOR_STATE_UPDATE,i],[this.EVENTS.SCREEN_SHARING_REQUEST,o]]);n.proxyAll(a),this.addBufferedEventListener=n.addEventListener,this.removeBufferedEventListener=n.removeEventListener}return c(e,null,[{key:"start",value:function(t){var n,r,i=t.conf,o=t.channelObservable,s=t.connectMedra,a=t.fromRxJs5,c=t.scheduler,u=t.videoProvider,l=t.isReestablishing,p=t.stats;a||(a=Jm),s||(s=Xx);var f=new zv.Subscription,h=new zv.Subject,d=new zv.Subject;u||(u=function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:Kx()).mediaDevices;return{getStream:function(){return new Promise((function(r,i){t.next(new Yx({onAccept:function(){em.info("Requesting screen capture");var t=e.statScreenShareUsage({stage:"capture",resource:"visitor_api.screen_sharing"}).attempted();return n.getDisplayMedia({video:!0}).then((function(e){r(e),t.succeeded(),em.info("Screen capture successful")})).catch((function(e){return i(e),"NotAllowedError"===e.name?(em.info("Screen capture permissions denied",e),t.failed("canceled"),Promise.reject(new tg({cause:Hy.SALEMOVE.CANCEL}))):(t.failedUnknown(),Promise.reject(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR})))}))},onDecline:function(){sm.logger.info("Screen sharing request declined"),i({name:"NotAllowedError"})}}))}))}}}(p,d));var b=new zv.Subject,v=b.switchMap((function(){return s({conf:i,channelObservable:o,namespace:"visitor-screensharing",videoProvider:u})})).publishReplay(1);if(f.add(v.connect()),b.next({}),v.switchMap((function(e){return a(e.communicationRequest).map((function(t){return{proposal:t,connection:e}}))})).subscribe((function(e){var t=e.proposal,n=e.connection,r=p.statScreenShareUsage({stage:"sharing",resource:"visitor_api.screen_sharing"}).attempted();return t.accept({video:{type:"browser"}}).then((function(e){var t=e.localVideoStream;r.succeeded(),sm.logger.info("Screen sharing succeeded"),h.next({connection:n,localVideoStream:t})})).catch((function(e){e&&e.cause===n.ERRORS.PERMISSIONS_DENIED?(r.failed("canceled"),sm.logger.info("Screen sharing canceled")):e&&e.cause===n.ERRORS.DEVICE_ACCESS_ERROR?(r.failed("device_access_error"),sm.logger.warn("Screen sharing failed due to device access error",e)):(r.failedUnknown(),sm.logger.warn("Screen sharing failed",e))}))}),sm.logger.error.bind(sm.logger,"Failed to receive screen sharing request")),l){f.add(v.take(1).subscribe((function(e){return e.reestablish().then((function(t){var n=t.localVideoStream;if(n)return h.next({connection:e,localVideoStream:n})}))}),sm.logger.error.bind(sm.logger,"Failed to reestablish visitor screen")))}var m=new Jx({status:Jx.prototype.STATUSES.NOT_SHARING}),y=(n=s({conf:i,channelObservable:o,namespace:"operator-screensharing"}).switchMap((function(e){var t=a(e.communicationRequest).flatMap((function(t){return zv.Observable.fromPromise(t.accept({})).catch((function(t){return t&&t.cause===e.ERRORS.REMOTE_PARTICIPANT_ERROR?sm.logger.info("Failed to receive operator screen due to error on operator side",t):sm.logger.warn("Failed to receive operator screen",t),zv.Observable.empty()}))}));return l?zv.Observable.merge(zv.Observable.fromPromise(e.reestablish()),t).filter((function(e){var t=e.remoteVideoStream;return!A.isNil(t)})):t})).do((function(){return sm.logger.info("Remote screen sharing stream received")})).flatMap((function(e){var t=e.remoteVideoStream,n=zv.Observable.defer((function(){var e="playing"===t.getMediaState()?Jx.prototype.STATUSES.SHARING:Jx.prototype.STATUSES.NOT_SHARING;return zv.Observable.of(new Jx({screen:new Gx({medraStream:t}),status:e}))})),r=a(t.observe(t.EVENTS.DISCONNECTED)).map((function(){return m}));return zv.Observable.merge(n,r)}))).startWith.apply(n,_([m,c].filter(A.identity))),g=new Qx({status:Qx.prototype.STATUSES.NOT_SHARING}),w=null,O=(r=h.do((function(){return sm.logger.info("Screen sharing request accepted")})).switchMap((function(e){var t=e.localVideoStream,n=e.connection;w=new zx({medraStream:t,connection:n});var r=zv.Observable.of(new Qx({screen:w,status:Qx.prototype.STATUSES.SHARING})),i=a(t.observe(t.EVENTS.DISCONNECTED)).do((function(){return b.next({})})).map((function(){return g}));return zv.Observable.merge(r,i)}))).startWith.apply(r,_([g,c].filter(A.identity))).share(),E=kg();return{screenSharing:new e({adapter:E,operatorScreenSharedObservable:y,visitorScreenSharedObservable:O,screenShareRequestedObservable:d}),stopScreenSharing:function(){w&&w.stopSharing(),E.stop(),f.unsubscribe()}}}}]),e}(),Zx=function e(t){var n=t.id,r=t.properties;s(this,e),this.id=n,this.properties=r},eA=function(){return"iframe"===sm.conf.visitor_app.visitor_page_adaption},tA=function(){return eA()?document.getElementById("inner-page").contentWindow.document:document},nA=function(e){try{var t=tA();return eA()?t.body.querySelector(e):t.querySelector(e)}catch(e){return em.info("Target element not found",{error:e}),null}},rA="virtual_assistant_cobrowsing_cursor",iA="virtual_assistant_cobrowsing_cursor_label",oA=function(e,t){var n=nA("#"+rA);if(!n){var r=function(){var e=tA().createElement("div");return e.setAttribute("id",rA),e.style.display="none",e.style.opacity="0",e.style.position="absolute",e.style.zIndex="10",e.style.top="0",e.style.left="0",e.style.width="20px",e.style.height="20px",e.style.backgroundRepeat="no-repeat",e.style.backgroundImage="url('data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAwAAAARCAYAAADpPU2iAAAAAXNSR0IArs4c6QAAAiNJREFUKBV1kl9oUlEcx39eR21JEAwEHQQ9OKcr2mDoemgsfV5vSdFLqzEu9NSo6MHF8iUIevRBtJfyrdjbarVQF8un7ELWnKUiNzFw88+qqyL3evoe22LG/MGHe87vfL+/37nnHGprWpLtRSKROE9EAugdrVZL8ly+yhYX7zNN01rRaHQa6t6mRqPxaWraxSBi0dg6U1W1GQgEzvQ0wbApijc7Bm56tfqaIbfj9XpPYa4D3dFsNtPXb8z/M2CVRSIxpiiK7Ha7BzHvNsGQ/d8ADUsmP7NqtSrBYDjYQtDpdIf8ICOnc5JKpe2xWq0Wg2Fg38TFffuTg996/Tc5HA4qFn9MVCqVVaz183Vu0PPBYbG7WyO73UbfMtmpQqHwFJr+PuFvdOkFvZ4eLPkI90Ky/J0aikJDZvOlcql0gm8H8EMiWli4Tfl8npaXX9Ds7DVaW3uTbbfVejaXPappKplNpkHCRVUsVjsTBH3ngZR3yp0jttlsLBgMbqEO30oQBMBDgRjT37t7h95vbJAoih9WXq7knJPnKJVK0bBl2OrxeH5B+G6PNLXRgpf2+/2bSD43Go3hjwmp08U6YmOyLOeQHwMmMER4cSyXychcDB6DOVT/Mjp6umMKhZ4wn88nIn8ckPA2Erl1dnz8GcbbIAHWw+Hwo1AwRAPHDCRJErlcrivIG4EAyALmwRwYAUfAyXg8Hi0Wiq2vW+mfF2dmeMELwPAHu44LBYcnDWwAAAAASUVORK5CYII=')",e}(),i=function(e,t){var n=tA().createElement("div");return n.setAttribute("id",iA),n.style.display="inline-block",n.style.color="#ffffff",n.style.fontSize="13px",n.style.padding="2px 12px",n.style.margin="18px 0 0 14px",n.style.boxShadow="1px 1px 4px rgba(50, 50, 50, 0.75)",n.style.border="1px solid #ffffff",n.style.borderRadius="4px",n.style.backgroundColor="#232323",n.style.whiteSpace="nowrap",n.innerText=t,n}(0,t);r.appendChild(i),n=tA().body.appendChild(r)}return n.style.display="block",zv.Observable.of({cursor:n})},sA=function(e){return function(t){var n=t.interval.value+1;e.style.left=function(e,t){return(t=e.cursorInitialPosLeft-e.cursorDistanceDiffLeft*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px",e.style.top=function(e,t){return(t=e.cursorInitialPosTop-e.cursorDistanceDiffTop*t/e.totalCircleSteps).toFixed(0)}(t,n)+"px"}},aA=function(e,t){var n=10*t;e.style.left=function(e,t){return(e+3*Math.cos(t*Math.PI/180)).toFixed(0)}(e.offsetLeft,n)+"px",e.style.top=function(e,t){return(e-3*Math.sin(t*Math.PI/180)).toFixed(0)}(e.offsetTop,n)+"px"},cA=function(e){return e||(e={moveCursorToPosition:sA,moveFrequency:20}),function(t){var n,r,i,o=t.cursor.offsetLeft,s=t.cursor.offsetTop,a=(n=t.targetElement,r=n.getBoundingClientRect(),i=r.top+tA().documentElement.scrollTop,{left:r.left+tA().documentElement.scrollLeft+n.offsetWidth/2,top:i+n.offsetHeight/2}),c=o-a.left,u=s-a.top,l=Math.abs((c+u)/50).toFixed(0),p=l>0?l:1;return zv.Observable.interval(e.moveFrequency).timeInterval().map((function(e){return{cursorInitialPosLeft:o,cursorInitialPosTop:s,cursorDistanceDiffLeft:c,cursorDistanceDiffTop:u,totalCircleSteps:l,interval:e}})).do(e.moveCursorToPosition(t.cursor)).skip(p-1).take(1).mapTo(t)}},uA=function(e){return e||(e={moveCursorCirclePosition:aA,circleFrequency:50}),function(t){return zv.Observable.interval(e.circleFrequency).timeInterval().do((function(n){return e.moveCursorCirclePosition(t.cursor,n.value)})).skip(107).take(1).mapTo(t)}},lA=function(e,t){e.style.opacity=t>=1?1:(parseFloat(t)+.1).toFixed(1)},pA=function(e,t){t<=.1?(e.style.opacity=0,e.style.display="none"):e.style.opacity=(parseFloat(t)-.1).toFixed(1)},fA=function(e,t,n){return zv.Observable.interval(t.stepDuration).do((function(){var r=e.cursor.style.opacity;"in"===n&&t.fadeInStep(e.cursor,r),"out"===n&&t.fadeOutStep(e.cursor,r)})).skip(9).take(1).mapTo(e)},hA=function(e){return e||(e={fadeInStep:lA,stepDuration:20}),function(t){return fA(t,e,"in")}},dA=function(e){return e||(e={fadeOutStep:pA,stepDuration:120}),function(t){return fA(t,e,"out")}},bA=new(function(){function e(t){s(this,e),this.key=t;var n=localStorage.getItem(this.key);this.items=n?JSON.parse(n):[]}return c(e,[{key:"asArray",value:function(){return this.items}},{key:"add",value:function(e){return this.items.push(e),this._persist()}},{key:"top",value:function(){return this.items[0]||null}},{key:"purge",value:function(){var e=JSON.parse(localStorage.getItem(this.key));this.includesItems(e)&&(localStorage.removeItem(this.key),this.items=[])}},{key:"includesItems",value:function(e){return Array.isArray(e)&&e.length}},{key:"removeTop",value:function(){return this.items.shift(),this._persist()}},{key:"_persist",value:function(){return localStorage.setItem(this.key,JSON.stringify(this.items))}}]),e}())("custom_commands"),vA=function(e){return e?(bA.add(e),[e]):bA.asArray()},mA=function(){return bA.removeTop()},yA=function(e){var t=e.targetElement;mA(),t.click()},gA="virtual_assistant_cobrowsing",_A="point",wA="scroll",OA="click",EA="navigate",SA=[wA,_A,OA],TA=[OA],xA=function(e){return e.targetElement.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})},AA=function(e,t){e.operatorName;var n=e.operatorFormattedName;return function(e){var t,r,i=e.properties[gA];if(t=i.target,!((r=i.type)===EA?t&&t.length:A.contains(r,SA)?Boolean(nA(t)):(em.info("Invalid Virtual Assistant Cobrowsing action type",{type:r}),0)))return zv.Observable.of(e);switch(i.type){case _A:return oA(0,n).map(A.assoc("targetElement",nA(i.target))).do(xA).flatMap(hA()).flatMap(cA()).flatMap(uA()).flatMap(dA()).mapTo(e);case OA:return oA(0,n).map(A.assoc("targetElement",nA(i.target))).do(xA).flatMap(hA()).flatMap(cA()).flatMap(uA()).do(yA).flatMap(dA()).mapTo(e);case wA:return oA(0,n).map(A.assoc("targetElement",nA(i.target))).do(xA).flatMap(hA()).flatMap(cA()).mapTo(e);case EA:return function(e){return eA()?document.getElementById("inner-page").contentWindow.location.assign(e):window.location.href=e,zv.Observable.of({})}(i.target).mapTo(e);default:throw new Error("Unknown action: ".concat(i.type))}}},kA="custom_command",IA=function(e){return A.has(gA,e.properties)},NA=function e(t){var n=this,r=t.media,i=t.medias,o=t.onAccept,a=t.onDecline,c=t.validateMedia;s(this,e),this.media=r,this.medias=i,c=c||xx;this.select=function(e,t){return c({options:t,availableMediaTypes:n.medias,availableOneWayMediaTypes:[],media:e}).then((function(){return function(e,t){return o({media:e,options:t})}(e,t)}))},this.decline=a},RA=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),CA=function(e){var t=e.visitorId,r=e.engagementId,i=e.volatileNotifications,o=e.engagementStateObservable,s=e.wsProxy,a=e.apiTimeoutMilliseconds,c=e.stats,u=yg({stats:c,protocol:"rest",failureTagProperty:"message",timeout:a,timeoutError:zv.Observable.throw(RA)});return{mediaUpgradeRequestObservable:function(e,t){var n=A.propEq("event_type","engagement.media_upgrade_request"),r=A.pathEq(["media_upgrade_request","engagement_id"],e),i=A.pathEq(["media_upgrade_request","target"],"visitor"),o=A.compose(A.pick(["id","audio","video"]),A.prop("media_upgrade_request"));return t.filter(A.allPass([n,r,i])).map(o)}(r,i),mediaStateObservable:function(e){return e.filter(A.identity).map(A.prop("media")).distinctUntilChanged(A.equals)}(o),requestMediaUpgrade:function(e){var t=e.mediaUpgradeRequest;return u({resource:"media-upgrade-request",method:"create"},(function(){return s.request({method:"POST",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests"),payload:t,headers:$y}).catch((function(e){return og(e,{allowedCauses:[Hy.SALEMOVE.INVALID_INPUT,Hy.SALEMOVE.NETWORK_TIMEOUT,Hy.SALEMOVE.CONFLICT]})}))})).toPromise()},acceptUpgradeRequest:function(e,t){return u({resource:"media-upgrade-request",method:"accept"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:A.merge(t,{action:"accept"}),headers:$y}).catch((function(e){return og(e,{allowedCauses:[Hy.SALEMOVE.INVALID_INPUT,Hy.SALEMOVE.NETWORK_TIMEOUT,Hy.SALEMOVE.CONFLICT]})}))})).toPromise()},declineUpgradeRequest:function(e){return u({resource:"media-upgrade-request",method:"decline"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/media_upgrade_requests/").concat(e.id),payload:{action:"decline"},headers:$y}).catch((function(e){return og(e,{allowedCauses:[Hy.SALEMOVE.INVALID_INPUT,Hy.SALEMOVE.NETWORK_TIMEOUT,Hy.SALEMOVE.CONFLICT]})}))})).toPromise()},removeVideo:function(){return u({resource:"engagement-participant",method:"remove video"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_video"},headers:$y}).catch(og)})).map((function(){return{}})).toPromise()},removeAudio:function(){return u({resource:"engagement-participant",method:"remove audio"},(function(){return s.request({method:"PATCH",url:"".concat(n.default.api_url,"/engagements/").concat(r,"/participants/").concat(t),payload:{action:"remove_audio"},headers:$y}).catch(og)})).map((function(){return{}})).toPromise()}}},PA=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:pS,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$S,n=e.canReceiveMedia()?["browser"]:[],r=e.canSendMedia()?["browser"]:[];return{canReceive:{video:n,audio:n.concat(["phone"])},canSend:{video:r,audio:r.concat(["phone"])},canShareScreen:t.screenCapturingSupported()&&e.canSendMedia()}},MA=function(e,t){return t.filter(dx).map((function(t){var n=t.upgradeRequest,r=t.currentMediaState,i=function(e,t){if("two_way"===e.video)return{media:"video",medias:["video"]};if("two_way"===e.audio)return{media:"audio",medias:t.canSend.audio.map(hx)};throw new Error("Tried to create upgrade offer for one way media")}(n,PA());return new NA(A.merge(i,{onAccept:function(t){return e.acceptUpgradeRequest(n,function(e,t){var n=(e.options?e.options.phoneNumber:void 0)||A.path(["audio","phone_number"],t),r=(e.options?e.options.phoneExtension:void 0)||A.path(["audio","phone_extension"],t);return{audio_type:"video"===e.media?A.path(["audio","type"],t)||"browser":"phone"===e.media?"phone":"browser",phone_number:n,phone_extension:r}}(t,r)).then(A.always({}))},onDecline:function(){return e.declineUpgradeRequest(n).then(A.always({}))}}))})).share()},jA=function(e){var t,n=e.commsApi||CA(A.pick(["engagementId","visitorId","volatileNotifications","engagementStateObservable","wsProxy","apiTimeoutMilliseconds","stats"],e)),r=new zv.Subscription,i=n.mediaUpgradeRequestObservable.switchMap((t=e.channelObservable,function(e){return t.take(1).do((function(t){return t.channel.emit("comms:media_upgrade_request:ack",{id:e.id})})).mapTo(e)})).withLatestFrom(n.mediaStateObservable).map(A.zipObj(["upgradeRequest","currentMediaState"])).share();r.add(function(e,t){return t.filter(A.complement(dx)).do((function(e){var t=e.upgradeRequest;return em.info("Accepting media request automatically",{upgrade_request:t})})).switchMap((function(t){var n=t.upgradeRequest,r=t.currentMediaState;return e.acceptUpgradeRequest(n,{audio_type:A.path(["audio","type"],r),phone_number:A.path(["audio","phone_number"],r),phone_extension:A.path(["audio","phone_extension"],r)})})).catch((function(){return zv.Observable.empty()})).subscribe((function(){}))}(n,i));return r.add(um.vent.observable(um.MSG.ENGAGEMENT_REMOVE_AUDIO).subscribe(n.removeAudio,em.error.bind(em,"Error removing visitor's audio"))),{removeVideo:n.removeVideo.bind(n),mediaUpgradeOffers:MA(n,i),mediaStateObservable:n.mediaStateObservable,requestMediaUpgrade:function(e){return n.mediaStateObservable.take(1).switchMap((function(t){var r=function(e){var t=e.options,n=e.currentMediaState,r=A.path(["audio","direction"],n),i=A.path(["video","direction"],n),o=t.audio?bx:null,s=t.video?t.video:null,a=mx(o,r),c=mx(s,i),u=A.path(["audio","phone_number"],n)||t.phoneNumber||null,l=A.path(["audio","phone_extension"],n)||t.phoneExtension||null;return{audio:a,video:c,audio_type:A.path(["audio","type"],n)||t.audio||null,phone_number:u,phone_extension:l}}({options:e,currentMediaState:t});return n.requestMediaUpgrade({mediaUpgradeRequest:r})})).toPromise().then(A.always({}))},stop:function(){r.unsubscribe()}}},qA=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),LA=function(e){return e instanceof DOMException?rg(e):e instanceof tg?e:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(0===e)return new tg({cause:Hy.SALEMOVE.CONNECTION_LOST});var o=A.equals(e,404)?Hy.SALEMOVE.RESOURCE_NOT_FOUND:A.contains(e,Qy)?Hy.SALEMOVE.INVALID_INPUT:A.equals(e,429)?Hy.SALEMOVE.TOO_MANY_REQUESTS:401===e||403===e?Hy.SALEMOVE.FORBIDDEN:(em.warn("An INTERNAL_ERROR error from XHR occurred. Can we expose this error as non-internal?",i({status:e,message:n,responseText:t},r)),Hy.SALEMOVE.INTERNAL_ERROR),s=function(){try{return JSON.parse(t).message}catch(e){}};return n||(n=t?s():void 0),new tg(n?{cause:o,message:n}:{cause:o})}(e.status,e.response&&e.response.text&&e.response.text(),e.response?e.response.message:void 0,e)},UA=function(){function e(t,n){var r=this,i=t.id,o=t.securityScanningRequired,a=t.url;if(s(this,e),this.id=i,this.securityScanningRequired=o,this.url=a,this.securityScanningRequired){var c=A.pathEq(["security_scan_result","file_id"],this.id);this.scanResultObservable=n.find(c).map(A.path(["security_scan_result","result"])).map((function(e){return{result:e,file:r}}))}}return c(e,[{key:"getScanResult",value:function(){return this.securityScanningRequired?this.scanResultObservable.toPromise():Promise.reject("Security scanning is not required")}}]),e}(),VA=function(e,t,n,r,i){var o=n.onUploadProgress,s=n.getRequestHeaders,a=new FormData;a.append("content",t);var c=ET("/engagements/".concat(e,"/files"));return A.contains(t.type,i)?t.size>25e6?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.FILE_TOO_LARGE,message:"File exceeds the maximum file size"})):function(e){var t=e.method,n=e.url,r=e.payload,i=e.onUploadProgress,o=e.getRequestHeaders;return QE({method:t,url:n,payload:r,responseType:"json",onUploadProgress:i,getRequestHeaders:o})}({url:c,method:"POST",payload:a,getRequestHeaders:s,onUploadProgress:o}).map((function(e){var t=e.response;return new UA({id:t.file_id,securityScanningRequired:t.security_scanning_required,url:c},r)})).catch((function(e){return zv.Observable.throw(LA(e))})):zv.Observable.throw(new tg({cause:Hy.SALEMOVE.FILE_CONTENT_TYPE_NOT_ALLOWED,message:"File content type is not allowed"}))},DA=function(){function e(t){var n=t.iframe;s(this,e),this.iframe=n}return c(e,[{key:"deframe",value:function(){um.vent.trigger("visit:restore_url")}}]),e}(),FA=function e(t){var n=t.unwrap;s(this,e),this.unwrap=n},BA=function e(){s(this,e),this.responsePromise=zv.Observable.merge(um.vent.observable(um.MSG.ALLOW_STREAM).map(A.always("allowed")),um.vent.observable(um.MSG.DENY_STREAM).map(A.always("denied"))).take(1).toPromise()},WA=function e(t){var n=t.status,r=t.authenticated;s(this,e),this.status=n,this.authenticated=r};WA.prototype.STATUSES={ENGAGED:"engaged",TRANSFERRING:"transferring"};var HA=function e(t){var n=t.text;s(this,e),this.text=n},GA=function(){function e(t){var n=this;s(this,e),this.startSalemoveViews=this.startSalemoveViews.bind(this);var r=t.engagementId,i=t.subEngagementId,o=t.startingMedia,a=t.type,c=t.isReestablishing,u=t.chat,l=t.stopChat,p=t.webRtcMode,f=t.enabledMediaLevel,h=t.channelObservable,d=t.operator,b=t.operatorFocusObservable,v=t.communicationWidget,m=t.createEngagementObservable,y=t.mediaStateObservable,g=t.backend,_=t.platform,w=t.startScreenSharing,O=t.stateObservable,E=t.statsClient,S=t.entrypoint,T=t.volatileNotifications,x=t.statusObservable,k=t.comms,I=t.events,N=t.surveyApi,R=t.getRequestHeaders,C=t.siteVisitorNotifications,P=t.createdAt,M=t.cobrowser;this.engagementId=r,this.chat=u,this.mediaState=null,this.isReestablishing=c,this.createdAt=P,this.subEngagementId=i,this.startingMedia=o,this.type=a,this.operator=d,this.cobrowser=M,this.allowFileSending=sm.conf.communications.allow_file_sending,this.allowedFileContentTypes=sm.conf.communications.allowed_file_content_types;var j=w({conf:sm.conf,channelObservable:h,isReestablishing:this.isReestablishing,stats:E}),q=j.screenSharing,L=j.stopScreenSharing;this.screenSharing=q;var U=new zv.Subscription,V=t.engagementEndObservable.map(A.always({})).take(1);y=y.publishReplay(1).refCount(),b=b.map((function(e){return"chat"===e?n.FOCUS_TARGETS.CHAT:"cobrowse"===e?n.FOCUS_TARGETS.COBROWSER:(em.error("Unexpected focus target!",e),"")}));var D=um.vent.observable(um.MSG.PUBLIC.ENGAGEMENT_MEDIA_UPGRADE_REQUEST).map(A.construct(Bx)),F=um.vent.observable(um.MSG.WILL_ASK_MEDIA_PERMISSION).map(A.construct(BA)),B=function(e){return e.filter(A.propEq("event",kA)).map((function(e){var t=e.payload,n=e.custom_command_id;return A.construct(Zx)({properties:t,id:n})})).filter((function(e){return A.not(IA(e))})).distinct(A.prop("id")).do((function(e){return em.info("Custom Command: received",{custom_command_id:e.id})}))}(T),W=function(e){return e.filter(A.propEq("event",kA)).map((function(e){var t=e.payload,n=e.custom_command_id;return A.construct(Zx)({properties:t,id:n})})).filter((function(e){return IA(e)})).distinct(A.prop("id")).do((function(e){return em.info("Virtual CoBrowsing Command: received",{custom_command_id:e.id})})).startWith(null).flatMap((function(e){var t=vA(e);return zv.Observable.from(t)})).do((function(e){return em.info("Virtual CoBrowsing Command: processing",{custom_command_id:e.id})}))}(T).concatMap(AA({operatorName:d.name,operatorFormattedName:d.formattedName})).do((function(e){(function(e){var t=e.properties[gA].type;return!A.contains(t,TA)})(e)&&mA()})).subscribe((function(){}),em.error),H=Ag(),G=O.distinctUntilChanged(A.equals,(function(e){return e.capabilities})).map((function(e){return new HA(e.capabilities)})),z=A.fromPairs([[this.EVENTS.END,V],[this.EVENTS.STATE_CHANGE,O.map((function(e){var t=e.status,n=e.visitor;return{status:t,authenticated:A.propOr(!1,"authenticated")(n)}})).map(A.construct(WA))],[this.EVENTS.CAPABILITIES,G],[this.EVENTS.MEDIA_UPGRADE_OFFER,k.mediaUpgradeOffers],[this.EVENTS.FOCUS,b],[this.EVENTS.MEDIA_STATE_CHANGE,y],[this.EVENTS.MEDIA_PERMISSION_REQUEST,F],[this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST,D],[this.EVENTS.CUSTOM_COMMAND,B]]);H.proxyAll(z),this.addEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.addUnbufferedEventListener(fx.prototype.EVENTS.COBROWSING_REQUEST,t):H.addEventListener(e,t)},this.removeEventListener=function(e,t){e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.removeUnbufferedEventListener(fx.prototype.EVENTS.COBROWSING_REQUEST,t):H.removeEventListener(e,t)},this.recordEvent=function(e){return I.recordEvent(e)};var J=A.propEq("event_type","engagement.files.security_scan_result"),Q=C.filter(J).publishReplay(this.SCAN_EVENT_REPLAY_COUNT);U.add(Q.connect()),this.uploadFile=function(e,t){t||(t={});var n=t.onUploadProgress;return VA(this.engagementId,e,{onUploadProgress:n,getRequestHeaders:R},Q,this.allowedFileContentTypes).toPromise()},this.getChatTranscript=function(){return g.chatTranscript().then((function(e){return Promise.resolve(A.map((function(e){var t=e.id,n=e.message,r=e.sender,i=e.attachment,o=e.metadata,s=e.created_at,a=r.type;return"operator"===a?new CT({id:t,content:n,attachment:i,metadata:o,created_at:s,sender:r}):"visitor"===a?new RT({id:t,content:n,status:RT.prototype.STATUSES.DELIVERED,attachment:i,created_at:s}):null}),e))}))},this.observable=function(e){return e===this.EVENTS.COBROWSING_REQUEST?this.cobrowser.observable(fx.prototype.EVENTS.COBROWSING_REQUEST):H.observable(e)};var Y=function(){return setTimeout((function(){return H.stop()}))};V.subscribe((function(){}),Y,Y),this.iframePage=function(e){e||(e={});var t=e.keptElementSelectors;em.info("Engagement: Iframe page started");var n=new Vx({id:"inner-page",getTargetUrl:function(){return window.location.href},document:window.document,nonRemoved:t||[]});return sm.contextNotifyingMessenger&&sm.contextNotifyingMessenger.stop(),sm.trackerSubscription.unsubscribe(),sm.cobraSubscription.unsubscribe(),n.putIntoIframe().then((function(e){var t=e.iframe;return em.info("Engagement: Iframe page finished"),Promise.resolve(new DA({iframe:t}))}))},this.wrapPage=function(e){e||(e={});var t=e.keptElementSelectors;em.info("Engagement: Wrap page started");var n=new Fx({document:window.document,nonRemoved:t||[]});return n.wrap(),em.info("Engagement: Wrap page finished"),Promise.resolve(new FA({unwrap:n.unwrap}))};var K=gx({stateObservable:O}).share();U.add(Hx({volatileNotifications:T,visitorPageAdaption:sm.conf.visitor_app.visitor_page_adaption})),this.getSurvey=function(){return N.fetchSurvey()};var X=H.eventWithoutListenerObservable(this.EVENTS.WIDGET_MEDIA_UPGRADE_REQUEST);U.add(X.subscribe((function(){console.warn("No listener set for the Engagement WIDGET_MEDIA_UPGRADE_REQUEST event. See 'WidgetMediaUpgradeRequest' documentation for how to add the listener to enable media upgrades from the sm-engaged-visitor widget."),em.warn("Listener is not set for WIDGET_MEDIA_UPGRADE_REQUEST")}),em.error));U.add(y.subscribe((function(e){n.mediaState=e}),em.error));var $=m({engagement:this,transfers:K,channelObservable:h,webRtcMode:p,statusObservable:x});v.start($),this.communicationWidget=v;var Z=function(){return v.stop(),k.stop(),l(),L(),function(e){var t=e.cursorIdentifier,n=e.onRemove;if(!eA()){var r=nA(t||"#"+rA);if(r&&(tA().body.removeChild(r),n))n()}}({}),em.info("Triggering ENGAGEMENT_END event"),um.vent.trigger(um.MSG.PUBLIC.ENGAGEMENT_END,n),U.unsubscribe()};this.start=function(){var e;n.isReestablishing||(e=["action:reach","stage:establish-engagement"],E.increment("engagement.flow",["entrypoint:".concat(S)].concat(e)));var t,r=um.vent.trigger.bind(um.vent,um.MSG.ENGAGEMENT_TRANSFERRED);n.isReestablishing||bA.purge(),t={engagementObservable:$},um.reqres.setHandler("get:engagement_observables",A.always(t)),U.add(K.subscribe((function(e){return function(e){n.operator=kS({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:{url:e.operatorPicture},mediaType:e.operatorMedia,webRtcMode:p,enabledMediaType:f})}(e),r(e)}),em.error)),U.add(V.subscribe(Z,em.error)),um.vent.trigger(um.MSG.PUBLIC.ENGAGEMENT_START,n)},this.upgrade=function(e){if(_===Xy)return Promise.reject(new tg({cause:Hy.SALEMOVE.NOT_SUPPORTED,message:"Unsupported functionality for OmniBrowse engagement"}));var t=n.operator.state.media,r=n.operator.state.oneWayMedias,i=sm.conf.communications.allow_upgrade_requests,o=n.mediaState.operator.media,s="phone"===o?"audio":o;return em.info("Initiating media upgrade",{audio_type:e.audio,video_type:e.video,caller:(e?e.caller:void 0)||"client_integrator"}),Ax({options:e,availableMediaTypes:t,availableOneWayMediaTypes:r,visitorUpgradesAllowed:i,highestAllowedMediaType:s}).then((function(){return k.requestMediaUpgrade(e)}))},this.end=function(){return Z(),g.end().then(A.always({})).catch((function(e){return 422===(e?e.status:void 0)?em.warn("Engagement already ended",{error:e,engagement_id:n.engagementId}):A.isNil(e.status)?em.warn("Engagement end failed. No message-hub connection",{error:e,engagement_id:n.engagementId}):em.error("Engagement end failed",{error:e,engagement_id:n.engagementId}),Promise.reject(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR}))}))};var ee=new zv.Subject;this.notifyOfFocusChange=function(e){return ee.next(e)};var te=ee.asObservable().distinctUntilChanged().withLatestFrom(h,(function(e,t){return{target:e,channel:t.channel}})).subscribe((function(e){var t=e.target;return e.channel.emitAll("visitor:focus_changed",t)}),em.error);U.add(te),U.add(W)}return c(e,[{key:"start",value:function(){}},{key:"upgrade",value:function(e){return null}},{key:"iframePage",value:function(e){return null}},{key:"wrapPage",value:function(e){}},{key:"getSurvey",value:function(){return null}},{key:"end",value:function(){return null}},{key:"notifyOfFocusChange",value:function(){return null}},{key:"startSalemoveViews",value:function(){em.error("Private/undocumented Engagement#startSalemoveViews was used"),console.error("Usage of Engagement#startSalemoveViews is not supported")}},{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}},{key:"recordEvent",value:function(e){return null}},{key:"uploadFile",value:function(e,t){return null}},{key:"getChatTranscript",value:function(){return null}}],[{key:"create",value:function(t){var n=t.engagementId,r=t.subEngagementId,i=t.startingMedia,o=t.mediaState,s=t.type,a=t.isReestablishing,c=t.initialChatHistoryObservable,u=t.operator,l=t.statsClient,p=t.cobra,f=t.channelObservable,h=t.platform,d=t.engagementApi,b=t.connectionStatusObservable,v=t.getRequestHeaders,m=t.internalVisitorStateObservable,y=t.entrypoint,g=t.volatileNotifications,_=t.statusObservable,w=t.pubsub,O=t.wsProxy,E=t.createdAt,S=m.map(A.compose(A.find(A.propEq("id",n)),A.pathOr([],["engagement","engagements"]))),T=S.filter(A.identity).take(1),x=T.flatMap((function(){return S.filter(A.complement(A.identity)).take(1)})),k=um.vent.observable("engagement:disengage"),I=zv.Observable.merge(x,k).take(1),N=f.switchMap((function(e){return e.channel.observable("visitor:state_changed")})),R=T.map(A.prop("transferrable_sites")),C=Qv(),P=R.flatMap((function(e){var t=e.map((function(e){return"site_visitor:".concat(C,":").concat(e.id)}));return w.joinChannel("site_visitor:".concat(C),{topics:t})})).flatMap((function(e){return(0,e.observable)("message",{leaveChannelOnDispose:!0})})).filter(A.identity).publishReplay(50).refCount(),M=sm.conf.engagement.api_timeout_milliseconds||Gy,j=jA({visitorId:sm.visitorId,engagementId:n,volatileNotifications:g,engagementStateObservable:S,apiTimeoutMilliseconds:M,wsProxy:O,stats:l,channelObservable:f});em.info("Starting medra communication controller");var q=um.request("comms:create_controller",{requestHeaders:v(),visitorAppConf:sm.conf.visitor_app,statsClient:l,volatileNotifications:g,comms:j,pubsub:w,localCapabilities:PA(),onMediaUpgrade:function(e){return d.createMediaUpgrade(e).subscribe(em.log.bind(em,"Media upgrade successfully created"),em.warn.bind(em,"Failed to create media upgrade"))}}),L=function(e){var t=e.mediaState,n=e.mediaStateChanges,r=t?zv.Observable.of(t):zv.Observable.of(new kx({visitor:{media:"text",audioMuted:!1,videoMuted:!1},operator:{media:"text",audioMuted:!1,videoMuted:!1}}));return n.merge(r).map(A.construct(kx))}({mediaState:o,mediaStateChanges:q.mediaStateChanges()}),U=zv.Observable.merge(c,xT({engagementId:n,connectionStatusObservable:b})),V=ax.create({chatHistoryObservable:U,engagementEndObservable:I,engagementId:n,statsClient:l,getRequestHeaders:v,siteVisitorNotifications:P}),D=V.chat,F=V.stopChat,B={end:function(){return d.endEngagement({engagementId:n}).toPromise()},chatTranscript:function(){return d.getChatTranscript(n).map(A.filter((function(e){var t=e.sender.type;return A.contains(t,["operator","visitor"])}))).toPromise()}},W=bS(),H=sm.conf.communications.enabled_media_level,G=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=yg({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:zv.Observable.throw(qA)});return{recordEvent:function(e){return o({resource:"record-event",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/events"),payload:e,headers:$y}).catch(og,{allowedCauses:[Hy.SALEMOVE.INVALID_INPUT,Hy.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}}({engagementId:n,wsProxy:O,apiTimeoutMilliseconds:M,stats:l}),z=function(e){var t=e.engagementId,n=e.wsProxy,r=e.apiTimeoutMilliseconds,i=e.stats,o=yg({stats:i,protocol:"rest",failureTagProperty:"message",timeout:r,timeoutError:zv.Observable.throw(Cx)}),s=function(e){switch(e.status){case 409:return em.warn("Survey was not accepted because at least some answers were not unique for engagement. This could happen when survey was answered twice for the same engagement.",{engagement_id:t}),zv.Observable.throw(new tg({cause:Hy.SALEMOVE.CONFLICT}));default:return og(e)}},a=function(e){var r=e.surveyId,i=e.answers;return o({resource:"survey-answers-post",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/surveys/").concat(r,"/answers"),payload:{engagement_id:t,answers:i},headers:$y}).catch(s)})).toPromise()};return{fetchSurvey:function(){return o({resource:"survey-request",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/survey"),payload:null,headers:$y}).catch(og)})).map((function(e){return new Rx(e,a)})).toPromise()},saveSurveyAnswers:a}}({engagementId:n,wsProxy:O,apiTimeoutMilliseconds:M,stats:l}),J=new fx({cobra:p,operator:u,channelObservable:f});return i&&(u=function(e,t){var n=e.media,r=e.enabledMediaType,i=e.webRtcMode;if(A.indexOf(n,t.state.medias)>-1)return t;var o=mS[n];return A.compose(SS({enabledMediaType:r,webRtcMode:i}),A.set(gS,o),A.set(yS,o))(t)}({media:i,enabledMediaType:H,webRtcMode:W},u)),new e({engagementId:n,subEngagementId:r,engagementEndObservable:I,startingMedia:i,type:s,isReestablishing:a,chatHistoryObservable:U,chat:D,stopChat:F,webRtcMode:W,enabledMediaLevel:H,channelObservable:f,operator:u,operatorFocusObservable:N,communicationWidget:q,createEngagementObservable:_x,mediaStateObservable:L,cobra:p,backend:B,platform:h,startScreenSharing:$x.start,stateObservable:S.filter(A.identity).distinctUntilChanged(A.equals),statsClient:l,entrypoint:y,volatileNotifications:g,statusObservable:_,comms:j,events:G,surveyApi:z,getRequestHeaders:v,siteVisitorNotifications:P,createdAt:E,cobrowser:J})}}]),e}();GA.prototype.SCAN_EVENT_REPLAY_COUNT=100,GA.prototype.EVENTS={END:"end",STATE_CHANGE:"state_change",CAPABILITIES:"capabilities",MEDIA_UPGRADE_OFFER:"media_upgrade_offer",FOCUS:"focus",MEDIA_STATE_CHANGE:"media_state_change",COBROWSING_REQUEST:"cobrowsing_request",MEDIA_PERMISSION_REQUEST:"media_permission_request",WIDGET_MEDIA_UPGRADE_REQUEST:"widget_media_upgrade_request",CUSTOM_COMMAND:"custom_command"},GA.prototype.FOCUS_TARGETS={CHAT:"chat",COBROWSER:"cobrowse"},GA.prototype.MEDIA_TYPES={TEXT:"text",AUDIO:"audio",PHONE:"phone",VIDEO:"video"};var zA=function(e){var t,n,r=e.api,i=e.conf,o=e.operatorsObservable,s=e.media,a=e.options,c=e.statsClient,u=e.cobraObservable,l=e.channelObservable,p=e.engagementApi,f=e.webRtcMode,h=e.enabledMediaLevel,d=e.connectionStatusObservable,b=e.getRequestHeaders,v=e.internalVisitorStateObservable,m=e.volatileNotifications,y=e.statusObservable,g=e.pubsub,_=e.wsProxy,w=e.dynamicImport,O=new zv.AsyncSubject,E=NT({media:s,mediaOptions:a,mediaValidation:xx,api:r,notifyOfTimeout:um.vent.trigger.bind(um.vent,um.MSG.REACTIVE_ENGAGEMENT_REQUEST_TIMEOUT),operatorsObservable:o,engagementCoreObservable:w("Comms"),cobraObservable:u,channelObservable:l,serverResponseTimeout:Gy,communicationLib:i.communications.lib,engagementApi:p,webRtcMode:f,enabledMediaLevel:h,statsClient:c}),S=E.requestObservable,T=E.resultObservable,x=Ym(O),k=T.merge(x).take(1).map((function(e){return A.merge(e,{statsClient:c,connectionStatusObservable:d,getRequestHeaders:b,internalVisitorStateObservable:v,volatileNotifications:m,statusObservable:y,pubsub:g,wsProxy:_})})).map(GA.create).do(A.invoker(0,"start")).catch(ig);return{operatorObservable:(t=S,n=x,t.map(A.prop("operator")).merge(n).take(1)).catch(ig),engagementObservable:k,cancelEngagementRequest:function(){return function(e){var t=e.api,n=e.requestObservable,r=e.resultErrorSubject,i=e.statsClient;return n.catch((function(){return zv.Observable.of({requestNotCreated:!0})})).flatMap((function(e){var n=e.engagementRequestId;return e.requestNotCreated?zv.Observable.of({}):t.cancel({id:n}).do((function(){return r.next(new tg({cause:Hy.SALEMOVE.CANCEL}))})).do((function(){return i.increment("engagement.flow",["entrypoint:reactive-request","action:end","stage:requested","expected:true","reason:cancel"])}))}))}({statsClient:c,api:r,requestObservable:S,resultErrorSubject:O}).toPromise()},engagementRequestTimeout:1e3*i.engagement.reactive_call_timeout}},JA=function e(t){var n=t.timeout,r=t.engagementPromise,i=t.cancel,o=t.operatorPromise;s(this,e),this.timeout=n,this.engagementPromise=r,this.cancel=i,this.operatorPromise=o},QA=function(e){l(n,e);var t=m(n);function n(){var e;return s(this,n),(e=t.call(this))._currentSubscription=ae.EMPTY,e}return c(n,[{key:"add",value:function(e){if(!this.closed)return"function"==typeof e&&(e=new ae(e)),this._currentSubscription&&(this.remove(this._currentSubscription),this._currentSubscription.unsubscribe(),this._currentSubscription=null),y(p(n.prototype),"add",this).call(this,this._currentSubscription=e),this}}]),n}(ae),YA=function e(t,n){s(this,e),this.code=t,this.validDuration=n},KA=function(){function e(t){s(this,e);var n=t.incomingEngagementRequestObservable,r=t.setOmnibrowseReestablishHandler,i=t.statsClient,o=t.wsProxy,a=new QA,c=n.filter(A.propEq("platform",Xy)).map(A.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){return a.add(c.subscribe(e,em.error))},this.setEngagementReestablishHandler=r,this.getVisitorCode=function(){return yg({stats:i,protocol:"rest",failureTagProperty:"error",timeout:Gy,timeoutError:zv.Observable.throw(new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}))})({resource:"omnibrowse",method:"get"},(function(){return o.request({method:"GET",url:"".concat(sm.conf.api_url,"/omnibrowse/sites/").concat(Xv(),"/visitor_code/").concat(Qv()),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).map((function(e){var t=Date.parse(e.expires_at)-new Date;return new YA(e.code,t)})).catch(A.compose(zv.Observable.throw,A.unless(A.is(tg),A.always(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR}))))).do(null,(function(e){return em.warn("Fetching visitor code failed",{site_id:sm.siteId,err:e})})).toPromise()}}return c(e,[{key:"setIncomingEngagementRequestHandler",value:function(e){}},{key:"setEngagementReestablishHandler",value:function(e){}},{key:"getVisitorCode",value:function(){return null}}]),e}(),XA=function e(t){var n=t.text,r=t.noOperatorsOnlineText,i=t.duration,o=t.priority;s(this,e),this.text=n,this.noOperatorsOnlineText=r,this.duration=i,this.priority=o},$A=function e(t){s(this,e),this.duration=t},ZA=function e(t){var n=t.verticalOffset,r=t.horizontalOffset;s(this,e),this.verticalOffset=n,this.horizontalOffset=r},ek=function e(t){s(this,e),this.text=t},tk=function e(t,n){s(this,e),this.text=t,this.duration=n},nk=function e(t){var n=t.operatorListReady,r=t.isOmniqEnabled,i=t.queueStateReady,o=t.routingObservable;s(this,e);var a=function(e){return r?e.flatMap((function(e){return zv.Observable.combineLatest(o,i).take(1).mapTo(e)})):e.flatMap((function(e){return n.mapTo(e)}))},c=um.vent.observable("reactive_bar:enable").map(A.always({})),u=um.vent.observable("reactive_bar:disable").map(A.always({})),l=um.vent.observable("reactive_bar:set_position").map((function(e){return new ZA(e)})),p=um.vent.observable("trigger_expand_reactive").map((function(e){return new $A(e.duration)})),f=um.vent.observable("trigger_media_selection").map((function(e){return new ek(e.text)})),h=um.vent.observable("trigger_reactive_callout").map((function(e){return new XA({text:e.text,noOperatorsOnlineText:e.noOperatorsOnlineText,duration:e.duration,priority:e.priority})})),d=um.vent.observable("show_engagement_invitation").map((function(e){return new tk(e.text,e.duration)})),b=A.fromPairs([[this.EVENTS.REACTIVE_ENABLE,c],[this.EVENTS.REACTIVE_DISABLE,u],[this.EVENTS.REACTIVE_SET_POSITION,l],[this.EVENTS.REACTIVE_EXPAND,a(p)],[this.EVENTS.MEDIA_SELECTION_START,a(f)],[this.EVENTS.REACTIVE_CALLOUT_START,a(h)],[this.EVENTS.ENGAGEMENT_INVITATION_SHOW,a(d)]]),v=Ag();v.proxyAll(b);var m=kg();m.proxyAll(b),this.addUnbufferedEventListener=v.addEventListener,this.removeUnbufferedEventListener=v.removeEventListener,this.addBufferedEventListener=m.addEventListener,this.removeBufferedEventListener=m.removeEventListener,this.observable=function(e){return v.observable(e)},this.bufferedObservable=function(e){return m.observable(e)}};nk.prototype.EVENTS={REACTIVE_ENABLE:"overseer:reactive_enable",REACTIVE_DISABLE:"overseer:reactive_disable",REACTIVE_SET_POSITION:"overseer:reactive_set_position",REACTIVE_EXPAND:"overseer:reactive_expand",MEDIA_SELECTION_START:"overseer:media_selection_start",REACTIVE_CALLOUT_START:"overseer:reactive_callout_start",ENGAGEMENT_INVITATION_SHOW:"overseer:engagement_invitation_show"};var rk,ik=function(){function e(){s(this,e),this.EVENTS={ENGAGEMENT_REQUEST:"omnicall:engagement_request",PHONE_NUMBER_AVAILABLE:"omnicall:phone_number_available"};var t=A.fromPairs([[this.EVENTS.ENGAGEMENT_REQUEST,zv.Observable.never()],[this.EVENTS.PHONE_NUMBER_AVAILABLE,zv.Observable.never()]]),n=Ag();n.proxyAll(t),this.addEventListener=n.addEventListener,this.removeEventListener=n.removeEventListener,this.observable=function(e){return t[e]}}return c(e,[{key:"addEventListener",value:function(e,t){}},{key:"removeEventListener",value:function(e,t){}}]),e}(),ok=function e(){s(this,e),this.url=sm.conf.visitor_app.site_logo.url},sk=function(){function e(){s(this,e),this.visibleOperatorCount=sm.conf.visitor_app.reactive_tab.visible_operator_count,this.backColor=sm.conf.visitor_app.reactive_tab.back_color,this.fontSize=sm.conf.visitor_app.reactive_tab.font_size,this.format=sm.conf.visitor_app.reactive_tab.format,this.frontColor=sm.conf.visitor_app.reactive_tab.front_color,this.iconType=this._iconClassToType(sm.conf.visitor_app.reactive_tab.icon_class),this.placement=sm.conf.visitor_app.reactive_tab.placement,this.size=sm.conf.visitor_app.reactive_tab.size,this.text=sm.conf.visitor_app.reactive_tab.text,this.verticalOffset=sm.conf.visitor_app.reactive_tab.vertical_offset}return c(e,[{key:"_iconClassToType",value:function(e){switch(e){case"ico-voice":return"audio";case"ico-video":return"video";case"ico-text":return"text";default:return em.error("Unknown icon class of the reactive tab",e),"video"}}}]),e}(),ak=function e(){s(this,e),this.apiUrl=sm.conf.api_url,this.alwaysUseDefaultOperatorPicture=sm.conf.visitor_app.always_use_default_operator_picture,this.visitorPageAdaption=sm.conf.visitor_app.visitor_page_adaption,this.engagementMode=function(e){switch(e.visitor_app.visitor_page_adaption){case"div":return"iframeless";case"iframe":return"iframed";case"style":return"nowrap";default:return"iframeless"}}(sm.conf),this.externalButtonHtml=sm.conf.visitor_app.external_button.button_html,this.offlineMessagesEnabled=sm.conf.visitor_app.reactive_tab.contact_when_unstaffed,this.reactiveTabEnabled=sm.conf.visitor_app.reactive_tab.enabled,this.widgetMode=sm.conf.visitor_app.widget_mode,this.showReactiveTabWhenOperatorsUnavailable=sm.conf.visitor_app.reactive_tab.show_unavailable,this.theme=sm.conf.visitor_app.theme,this.isCustomTheme=sm.conf.visitor_app.is_custom_theme,this.locale=sm.conf.visitor_app.visitor_app_default_locale,this.reactiveTabVisuals=new sk,this.siteLogo=new ok,this.queuingEnabled=sm.conf.omniq.omniq_enabled,this.panelPosition=sm.conf.visitor_app.reactive_tab.position,this.phoneExtensionEnabled=sm.conf.visitor_app.phone_extension_enabled,this.phoneNumberDefaultCountry=sm.conf.visitor_app.phone_number_default_country,this.hideVisitorInfo=sm.conf.visitor_app.hide_visitor_info_in_visitor_app,this.enableVisitorTranscriptDownload=sm.conf.visitor_app.enable_visitor_transcript_download,this.watchForNewContactOperatorIntegrations=!1!==sm.conf.visitor_app.watch_for_new_contact_operator_integrations},ck=function(e,t,n,r){e||(e={}),n||(n=[]),r||(r=zv.Scheduler.asap);var i=e,o=i.phone,s=i.email;if(!o&&!s)return zv.Observable.throw({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Either phone or email must be specified"});var a=t.createApiRequestObservable,c=t.serverResponseTimeout;return a(A.pick(A.concat(["name","phone","email","message"],n),e)).map((function(){return{}})).catch((function(e){return zv.Observable.throw(LA(e))})).timeoutWith(c,zv.Observable.throw(new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT,message:"Leave message request timed out"})),r).do(null,A.ifElse(A.propEq("cause",Hy.SALEMOVE.TOO_MANY_REQUESTS),em.warn.bind(em,"Leaving a message failed: too many requests"),em.info.bind(em,"Leaving a message failed"))).take(1)},uk=function(e,t){return function(e,t){return QE({method:"GET",url:e,responseType:"blob",getRequestHeaders:t})}(e,t).map((function(e){return e.response})).catch((function(e){return zv.Observable.throw(LA(e))})).do(null,A.ifElse(A.propEq("cause",Hy.SALEMOVE.TOO_MANY_REQUESTS),em.warn.bind(em,"Requesting asset failed: too many requests"),em.info.bind(em,"Requesting asset failed"))).take(1)},lk=function(){function e(t){var n=t.id,r=t.api,i=t.operator,o=t.restrictedOperator,a=t.cobraObservable,c=t.channelObservable,u=t.message,l=t.logoUrl,p=t.platform,f=t.timeout,h=t.engagementApi,d=t.statsClient,b=t.communicationLib,v=t.notifyOfAccept,m=t.notifyOfDecline,y=t.createEngagement,g=t.cobraLoadTimeout,_=t.connectionStatusObservable,w=t.getRequestHeaders,O=t.internalVisitorStateObservable,E=t.volatileNotifications,S=t.statusObservable,T=t.pubsub,x=t.wsProxy;s(this,e),this.message=u,this.timeout=f,this.operator=o,this.logo={url:l};var k=new zv.AsyncSubject,I=k.merge(Ym(zv.Observable.merge(r.canceledObservable.map(A.always(new tg({cause:Hy.SALEMOVE.CANCEL}))),r.timedOutObservable.map(A.always(new tg({cause:Hy.SALEMOVE.TIMEOUT})))))).take(1).flatMap((function(e){return a.map((function(t){return A.merge({cobra:t},e)})).take(1).timeoutWith(g,zv.Observable.throw(new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR,message:"Cobra load timeout exceeded"})).do(null,(function(e){return em.warn("Cobra loading timed out",{error:e})}))).do(null,(function(t){return em.warn("Loading cobra failed, ending engagement",{error:t}),h.endEngagement({engagementId:e.engagementId,reason:"error",subReason:"visitor_cobra_load_failure"}).take(1).subscribe(em.log.bind(em,"Successfully ended engagement after cobra load failure"),em.warn.bind(em,"Failed to end engagement after cobra load failure"))})).map((function(e){var t=e.engagementId,n=e.subEngagementId,r=e.media,o=e.cobra,s=e.createdAt;return y({operator:i,engagementId:t,subEngagementId:n,startingMedia:r,type:"proactive",isReestablishing:!1,initialChatHistoryObservable:TT(t),communicationLib:b,statsClient:d,cobra:o,channelObservable:c,platform:p,engagementApi:h,connectionStatusObservable:_,getRequestHeaders:w,internalVisitorStateObservable:O,entrypoint:"proactive-request",volatileNotifications:E,statusObservable:S,pubsub:T,wsProxy:x,createdAt:s})})).do((function(e){return e.start()})).catch(ig)}));this.engagementPromise=I.toPromise(),this.accept=function(){return r.acknowledge({id:n}).do((function(){return v({engagement_request_id:n,operator:i})})).do((function(){return em.info("Engagement: Proactive request accepted",{operator:i})})).mapTo({}).catch(ig).toPromise()},this.selectMedia=function(e,t){if(p===Xy&&"text"!==e)return Promise.reject(new tg({cause:Hy.SALEMOVE.NOT_SUPPORTED,message:"OmniBrowse engagements only support text media."}));var s=o.state.medias,a=$E(o.state.oneWayMedias),c=t||{},u=c.phoneNumber,l=c.phoneExtension,f=c.oneWay;return xx({options:t,availableMediaTypes:s,availableOneWayMediaTypes:a,media:e}).then((function(){return v({engagement_request_id:n,operator:i}),r.accept({id:n,selectedMedia:e,mediaOptions:{phoneNumber:u,phoneExtension:l,oneWay:f}}).do((function(){sm.logger.info("Engagement: Proactive request media selected",arguments[0])})).map((function(t){return A.merge(t,{media:e})})).do(k).mapTo({}).catch(ig).toPromise()}))},this.decline=function(){return r.decline({id:n}).do((function(){return m({operator:i})})).do((function(){return k.error(new tg({cause:Hy.SALEMOVE.DECLINE}))})).do((function(){return sm.logger.info("Engagement, Proactive request declined",arguments[0])})).mapTo({}).catch(ig).toPromise()}}return c(e,null,[{key:"create",value:function(t){var n=t.api,r=t.id,i=t.operator,o=t.restrictedOperator,s=t.message,a=t.logoUrl,c=t.platform,u=t.timeout,l=t.statsClient,p=t.cobraObservable,f=t.channelObservable,h=t.engagementApi,d=t.connectionStatusObservable,b=t.getRequestHeaders,v=t.internalVisitorStateObservable,m=t.volatileNotifications,y=t.statusObservable,g=t.pubsub,_=t.wsProxy;return new e({api:n,id:r,statsClient:l,communicationLib:sm.conf.communications.lib,createEngagement:GA.create,cobraObservable:p,operator:i,restrictedOperator:o,platform:c,timeout:u,message:s,logoUrl:a,cobraLoadTimeout:1e4,notifyOfAccept:um.vent.trigger.bind(um.vent,um.MSG.PROACTIVE_ACCEPT),notifyOfDecline:um.vent.trigger.bind(um.vent,um.MSG.PROACTIVE_DECLINE),channelObservable:f,engagementApi:h,connectionStatusObservable:d,getRequestHeaders:b,internalVisitorStateObservable:v,volatileNotifications:m,statusObservable:y,pubsub:g,wsProxy:_})}}]),e}(),pk=["engagement","engagements"],fk=["engagement","requests"],hk=["visitor","browser_tab_id"],dk=function(e){return A.any(A.propEq("id",sm.siteId),e.transferrable_sites)},bk=function(e){var t=A.pathOr([],pk,e);try{return A.filter(dk,t)[0]}catch(n){return void em.error("Engagement was undefined in internalVisitorState",{internalVisitorState:e,engagements:t})}},vk=function(e){return dk(e)&&A.path(hk,e)===sm.tabId},mk=A.compose(A.nth(0),A.filter(vk),A.pathOr([],pk)),yk=A.compose(A.nth(0),A.filter(A.complement(vk)),A.pathOr([],pk)),gk=A.compose(A.nth(0),A.filter(A.allPass([dk,A.propEq("outcome",null),A.propEq("type","reactive")])),A.pathOr([],fk)),_k=function(e,t){return t.filter((function(t){var n=function(e,t){return A.compose(A.find(A.propEq("id",e)),A.pathOr([],fk))(t)}(e.id,t);return Boolean(n.outcome)})).take(1).map((function(t){var n=mk(t);return n&&n.operator.id===e.operator.id?n:null})).filter(A.identity)},wk=function(e){var t=e.channelObservable,n=e.internalVisitorStateObservable,r=e.statusObservable,i=e.webRtcMode,o=e.enabledMediaLevel,s=e.statsClient,a=e.cobraObservable,c=e.isEngagedObservable,u=e.engagementApi,l=e.connectionStatusObservable,p=e.getRequestHeaders,f=e.volatileNotifications,h=e.pubsub,d=e.wsProxy,b=e.dynamicImport;return function(e){var t=e.reestablishRequestObservable,n=e.channelObservable,r=e.statusObservable,i=e.cobraObservable,o=e.isEngagedObservable;return t.switchMap((function(e){var t=r.filter(A.equals({})),o=n.filter(A.compose(A.propEq("id",e.operatorId),A.prop("operator"))).take(1).mapTo(e).takeUntil(t),s=i.filter(A.pathEq(["operator","id"],e.operatorId)).pluck("cobraSource").take(1);return zv.Observable.combineLatest(o,s,(function(e,t){return A.merge(e,{cobra:t})}))})).withLatestFrom(o,(function(e,t){return{engagementReestablishMessage:e,isEngaged:t}})).do((function(e){e.isEngaged?em.info("Found an ongoing engagement during engagement reestablishing, skipping"):em.info("Reestablishing ongoing engagement")})).filter((function(e){return!e.isEngaged})).map((function(e){return e.engagementReestablishMessage}))}({reestablishRequestObservable:function(e){var t=e.bufferCount(2,1).map((function(e){var t=g(e,2),n=t[0],r=t[1],i=yk(n),o=mk(r);return o&&(i||n.visitor_id!==r.visitor_id)?o:null})).filter(A.identity);return e.take(1).flatMap((function(t){var n=zv.Observable.of(t).map(mk).filter(A.identity),r=gk(t),i=r?_k(r,e):zv.Observable.empty();return zv.Observable.merge(n,i)})).merge(t).map((function(e){return{id:e.id,platform:e.platform,subEngagementId:e.sub_engagement_legacy_id,channelUrl:e.channel_url,operatorId:e.operator.id,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorMediaType:e.operator.media_type,operatorPicture:{url:e.operator.picture_url},entrypoint:e.entrypoint,createdAt:e.start_time}}))}(n),channelObservable:t,statusObservable:r,cobraObservable:a,isEngagedObservable:c}).flatMap((function(e){return b("Comms").mapTo(e)})).map((function(e){var a=kS({id:e.operatorId,name:e.operatorName,formattedName:e.operatorFormattedName,picture:e.operatorPicture,mediaType:e.operatorMediaType,webRtcMode:i,enabledMediaType:o}),c=GA.create({engagementId:e.id,subEngagementId:e.subEngagementId,initialChatHistoryObservable:TT(e.id),operator:a,isReestablishing:!0,mediaState:e.mediaState,platform:e.platform,communicationLib:sm.conf.communications.lib,statsClient:s,cobra:e.cobra,channelObservable:t,engagementApi:u,connectionStatusObservable:l,getRequestHeaders:p,internalVisitorStateObservable:n,entrypoint:e.entrypoint,volatileNotifications:f,statusObservable:r,pubsub:h,wsProxy:d,createdAt:e.createdAt});return c.start(),{engagement:c,platform:e.platform}}))},Ok=function(e){var t=e.replayedReestablishObservable,n=e.defaultHandler,r=e.storeKey,i=e.platform,o=e.sessionStore,s=e.timeout,a=new QA,c=t.filter(A.propEq("platform",i)).map(A.prop("engagement")),u=function(e){return a.add(c.subscribe(e,em.error))},l=new zv.Subject;return u((function(e){return o.get(r)?zv.Observable.timer(s).takeUntil(l).subscribe((function(){return o.remove(r),em.error("Waited for custom reestablish handler to be set, but it wasn't set before timeout."),l.subscribe((function(){return em.error("Custom reestablish handler was set, but after timeout."),console.error("Salemove#setEngagementReestablishHandler() was called too late!"+" Glia waits ".concat(Math.round(15)," seconds after page load")+" for the custom reestablish handler to be set. Executing the handler anyway, although the default handler has already been called.")})),n(e)})):n(e)})),function(e){u(e),l.next(e),o.set(r,!0)}},Ek=function e(t){var n=t.engaged,r=t.name,i=t.email;s(this,e),this.engaged=n,this.name=r,this.email=i},Sk=function e(t){var n=t.connected;s(this,e),this.connected=n},Tk="__sm_mutation_event_trigger_flip__",xk=new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR}),Ak=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds;t||(t=zv.Scheduler.asap);var o=yg({stats:r,protocol:"rest",failureTagProperty:"message",timeout:i,timeoutError:zv.Observable.throw(xk),scheduler:t});return{createMediaUpgrade:function(e){var t=e.engagementId,r=e.media;return o({resource:"media-upgrade",method:"create"},(function(){return n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagements/").concat(t,"/media_upgrades"),payload:{media:r},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},getChatTranscript:function(e){return o({resource:"chat-transcript",method:"fetch"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/engagements/").concat(e,"/chat_transcript"),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))},endEngagement:function(e){var t=e.engagementId,r=A.compose(A.assoc("action","end"),Dy({subReason:"sub_reason"}),A.pick(["reason","subReason"]))(e);return o({resource:"engagement",method:"end"},(function(){return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagements/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}}},kk=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),Ik={"'operator_id' Operator is not available to be engaged":Hy.SALEMOVE.OPERATOR_UNAVAILABLE,"Operator cannot be engaged":Hy.SALEMOVE.OPERATOR_UNAVAILABLE,"Visitor cannot be engaged":Hy.SALEMOVE.ALREADY_ENGAGED,"'engagement_request_id' already failed":Hy.SALEMOVE.CONFLICT,"'engagement_request_id' already accepted":Hy.SALEMOVE.CONFLICT,"'engagement_request_id' already acknowledged":Hy.SALEMOVE.CONFLICT},Nk=(u(rk={},403,Hy.SALEMOVE.FORBIDDEN),u(rk,409,Hy.SALEMOVE.CONFLICT),rk),Rk=["'engagement_request_id' already failed","'engagement_request_id' already accepted","'engagement_request_id' already acknowledged"],Ck=function(e,t,n){var r=A.merge(n,{error:e});e&&A.contains(e.message,Rk)||e instanceof tg?em.warn("Failed to ".concat(t," engagement request"),r):em.error("Failed to ".concat(t," engagement request"),r)},Pk=function(e){var t=Ik[e&&e.message]||Nk[e&&e.status]||Hy.SALEMOVE.INTERNAL_ERROR;return new tg({cause:t})},Mk=function(e,t){var n=e.wsProxy,r=e.stats,i=e.apiTimeoutMilliseconds,o=e.visitorMetadata,s=e.internalVisitorStateObservable;t||(t=zv.Scheduler.asap);var a=yg({stats:r,protocol:"rest",failureTagProperty:"cause",timeout:i,timeoutError:zv.Observable.throw(kk),scheduler:t}),c=function(e){var t=e.id,r=e.data;return n.request({method:"PATCH",url:"".concat(sm.conf.api_url,"/engagement_requests/").concat(t),payload:r,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})},u=function(e){r.increment("engagement.flow",["entrypoint:proactive-request","stage:requested","action:end"].concat(e))},l=s.map(bk).bufferCount(2,1).filter((function(e){var t=g(e,2),n=t[0],r=t[1];return!n&&Boolean(r)})).map((function(e){var t=g(e,2);t[0];return t[1]})),p=l.filter(vk).do((function(e){var t=e.id;return em.info("Found new accepted engagement",{engagement_id:t})})).map((function(e){return{engagementId:e.id,subEngagementId:e.sub_engagement_legacy_id,operatorId:e.operator.id,operatorMediaType:e.operator.media_type,operatorName:e.operator.name,operatorFormattedName:e.operator.formatted_name,operatorPicture:{url:e.operator.picture_url},media:yx(e.media),entrypoint:e.entrypoint,platform:e.platform,createdAt:e.start_time}})),f=l.filter(A.complement(vk)).mapTo({}),h=function(e){var t=A.propEq("site_id",sm.siteId);return A.compose(A.filter(t),A.pathOr([],["engagement","requests"]))(e)},d=A.compose(A.nth(0),A.filter(A.propEq("outcome",null)),h),b=function(e){return A.compose(A.nth(0),A.filter(A.propEq("id",e)),h)},v=s.map(d).filter(A.identity),m=A.curry((function(e,t){return s.map(b(t.id)).filter(A.identity).filter((function(t){return A.contains(t.outcome,e)})).take(1).takeUntil(function(e,t){return s.map(b(e.id)).filter(A.identity).filter((function(e){return!A.contains(e.outcome,t)}))}(t,A.append(null,e)))})),y=v.flatMap(m(["operator_cancel","operator_left"])).mapTo({}),_=zv.Observable.merge(f,y),w=v.flatMap(m(["timed_out"])).mapTo({});return{create:function(e){var t=e.operatorId,r=e.siteId,i=e.media,s=e.source,c=e.mediaOptions,u={operator_id:t,site_id:r,media:i,source:s||"sdk",visitor_metadata:o,media_options:{phone_number:c.phoneNumber,phone_extension:c.phoneExtension,one_way:c.oneWay}};return em.info("Engagement: Sending reactive request",u),a({resource:"engagement-request",method:"create"},(function(){return(e=u,n.request({method:"POST",url:"".concat(sm.conf.api_url,"/engagement_requests"),payload:e,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}})).map((function(e){var t=e.timeout;return{engagementRequestId:e.id,acknowledgeTimeoutSeconds:t}})).catch((function(e){var n={error:e,operator_id:t,site_id:r,media:i,source:s,media_options:c};return e instanceof tg?(em.info("Failed to create engagement request",n),zv.Observable.throw(e)):(403===(e&&e.status)?em.info("Visitor forbidden to create engagement request",n):422===(e&&e.status)?em.info("Operator is not available to be engaged",n):409===(e&&e.status)?em.info("Operator cannot be engaged",n):em.error("Failed to create engagement request",n),zv.Observable.throw(Pk(e)))}));var e}))},cancel:function(e){var t=e.id,n="cancel";return a({resource:"engagement-request",method:n},(function(){return c({id:t,data:{action:n}}).catch((function(e){return Ck(e,n,{engagement_request_id:t}),zv.Observable.throw(Pk(e))}))}))},acknowledge:function(e){var t=e.id,n="acknowledge";return a({resource:"engagement-request",method:n},(function(){return c({id:t,data:{action:n}}).catch((function(e){return Ck(e,n,{engagement_request_id:t}),zv.Observable.throw(Pk(e))})).do(null,(function(e){e.cause===Hy.SALEMOVE.INTERNAL_ERROR?u(["reason:internal-error"]):e.cause!==Hy.SALEMOVE.CONFLICT&&u(["reason:unknown"])}))}))},accept:function(e){var t=e.id,n=e.selectedMedia,r=e.mediaOptions,i="accept";return a({resource:"engagement-request",method:i},(function(){return c({id:t,data:{action:i,media:n,media_options:{phone_number:r.phoneNumber,phone_extension:r.phoneExtension,one_way:r.oneWay},visitor_metadata:o}}).catch((function(e){return Ck(e,i,{engagement_request_id:t,media:n,media_options:r}),zv.Observable.throw(Pk(e))})).do(null,(function(e){e.cause===Hy.SALEMOVE.INTERNAL_ERROR?u(["reason:internal-error"]):e.cause!==Hy.SALEMOVE.CONFLICT&&u(["reason:unknown"])})).map(Dy({engagement_id:"engagementId",sub_engagement_id:"subEngagementId",created_at:"createdAt"}))}))},decline:function(e){var t=e.id,n="decline";return a({resource:"engagement-request",method:n},(function(){return c({id:t,data:{action:n}}).catch((function(e){return Ck(e,n,{engagement_request_id:t}),zv.Observable.throw(Pk(e))}))}))},notifyOfReactiveFailure:function(e){var t=e.id;return a({resource:"engagement-request",method:"cancel-due-to-error"},(function(){return c({id:t,data:{action:"cancel",reason:"error"}}).catch((function(e){return zv.Observable.throw(Pk(e))})).do(null,em.warn.bind(em,"Failed to cancel reactive engagement request due to error"))}))},acceptedObservable:p,declinedObservable:v.flatMap(m(["rejected"])).mapTo({}),canceledObservable:_,timedOutObservable:w}},jk=["name","email","phone","note","customAttributes","customAttributesUpdateMethod"],qk={customAttributes:"custom_attributes",customAttributesUpdateMethod:"custom_attributes_update_method"},Lk={setTimeout:setTimeout,clearTimeout:clearTimeout},Uk=function(e,t,n){var r,i,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Lk,s=o.setTimeout,a=o.clearTimeout,c=function(e){return r=e,i&&a(i),i=s((function(){r=void 0}),t),e};return function(){return r?(n(r),Promise.resolve(r)):e().then(c)}},Vk=function e(t){var n=t.state,r=t.medias,i=t.transitionReason,o=t.ticket,a=t.activeTicket;s(this,e),this.state=n,this.medias=r,this.transitionReason=i,this.ticket=o,this.activeTicket=a};Vk.prototype.QUEUE_STATES={CAN_QUEUE:"can_queue",CANNOT_QUEUE:"cannot_queue",QUEUED:"queued"},Vk.prototype.TRANSITION_REASONS={ENGAGED:"engaged",CANCELED:"canceled",UNSTAFFED:"unstaffed",CLOSED:"closed",DISCONNECTED:"disconnected",FAILED:"failed",ALREADY_QUEUED:"already_queued",FORBIDDEN:"forbidden"};var Dk,Fk=function e(t){var n=t.averageDurationInSeconds;s(this,e),this.averageDurationInSeconds=n},Bk=new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR}),Wk=new tg({cause:Hy.SALEMOVE.CANCEL}),Hk=function(e,t){return e.increment("engagement.flow",["entrypoint:queue-request"].concat(t))},Gk=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.ticket_id;return function(e,t){return yg({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:zv.Observable.throw(Bk)})}(n,r)({resource:"queue_tickets",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/queue_tickets/").concat(i),payload:{},headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})})).mapTo({}).do((function(){return function(e){return Hk(e,["stage:requested","action:end","expected:true","reason:cancel"])}(n)})).catch(ig)},zk=function(e){var t=e.engagementApi,n=e.engagementRequestApi,r=e.cobraObservable,i=e.fetchEngagementDependencies,o=e.channelObservable,s=e.communicationLib,a=e.statsClient,c=e.webRtcMode,u=e.enabledMediaLevel,l=e.connectionStatusObservable,p=e.getRequestHeaders,f=e.internalVisitorStateObservable,h=e.volatileNotifications,d=e.pubsub,b=e.statusObservable,v=e.wsProxy,m=zv.Observable.combineLatest(r,i(),(function(e){return{cobra:e}})).publishReplay(1),y=m.connect();return n.acceptedObservable.take(1).flatMap((function(e){var n=e.engagementId,r=e.subEngagementId,i=e.operatorId,y=e.media,g=e.operatorName,_=e.operatorFormattedName,w=e.operatorPicture,O=e.operatorMediaType,E=e.entrypoint,S=e.createdAt;return m.take(1).map((function(e){var m=e.cobra,T=kS({id:i,name:g,formattedName:_,picture:w,mediaType:O,webRtcMode:c,enabledMediaType:u});return{engagementId:n,subEngagementId:r,startingMedia:y,type:"reactive",isReestablishing:!1,initialChatHistoryObservable:TT(n),operator:T,cobra:m,channelObservable:o,communicationLib:s,engagementApi:t,getRequestHeaders:p,internalVisitorStateObservable:f,entrypoint:E,volatileNotifications:h,pubsub:d,statusObservable:b,wsProxy:v,createdAt:S,statsClient:a,connectionStatusObservable:l}})).map(GA.create).do(null,(function(){return function(e){return Hk(e,["stage:requested","action:end","reason:script-load-error"])}(a)})).do(null,(function(){return t.endEngagement({engagementId:n,reason:"error",subReason:"setup_failed"})}))})).finally((function(){return y.unsubscribe()}))},Jk=function(){function e(t){s(this,e);var n=t.ticket_id,r=t.apiTimeoutMilliseconds,i=t.statsClient,o=t.wsProxy,a=t.stopObservable,c=new zv.Subject,u=zv.Observable.merge(c,a);em.info("Queue Ticket created, waiting for engagement",{queue_ticket_id:n});var l=zk(t).takeUntil(u).do((function(e){return e.start()})).catch(ig).publishReplay(1);l.connect(),this.engagementPromise=l.merge(u.flatMapTo(zv.Observable.throw(Wk))).take(1).toPromise(),this.cancel=function(){return c.next(),l.last(null,null,null).flatMap((function(e){return e?zv.Observable.fromPromise(e.end()):Gk({wsProxy:o,statsClient:i,apiTimeoutMilliseconds:r,ticket_id:n})})).toPromise()}}return c(e,null,[{key:"create",value:function(t,n){var r=new zv.Subject;return{ticket:A.compose(A.construct(e),A.assoc("stopObservable",r.asObservable()))(A.merge(t,{ticket_id:A.path(["activeTicket","id"],n)})),subscription:new zv.Subscription((function(){return r.next(),r.unsubscribe()}))}}}]),e}(),Qk="requesting",Yk="created",Kk={open:1,opened:1,full:2,unstaffed:3,closed:4},Xk=A.compose(A.reduce(A.minBy((function(e){return Kk[e]})),"closed"),A.map(A.path(["state","status"]))),$k=A.compose(A.uniq,A.chain(A.path(["state","medias"]))),Zk=function(e){var t=A.filter(A.pathEq(["state","status"],"open"),e),n=$k(t);return{state:Xk(e)||"closed",medias:n}},eI=function(e){return A.pick(Object.getOwnPropertyNames(e),e)},tI=["enqueued","request_sent"],nI=A.propEq("site_id",sm.siteId),rI=A.compose(A.filter(nI),A.pathOr([],["omniq","queue_tickets"])),iI=A.compose(A.nth(0),A.filter((function(e){return-1!==tI.indexOf(e.state)})),rI),oI=A.curry((function(e,t){return A.compose(A.nth(0),A.filter(A.propEq("id",e)),rI)(t)})),sI=function(e){var t=e.queueState,n=e.queued,r=e.enqueuedInCurrentTab;return n||!(A.isNil(t)||A.isNil(n)||A.isNil(r))},aI=function(e){return A.intersection(Dk||(Dk=["async_text","text","phone"],bS()===dS&&(Dk=Dk.concat(["audio","video"])),Dk),e)},cI=function(e){var t=e.queueState,n=e.queued,r=e.visitorLeftReason,i=e.enqueuedInCurrentTab,o=e.isEngaged,s=e.activeTicket;if(n)return new Vk(i?{state:Vk.prototype.QUEUE_STATES.QUEUED,activeTicket:s}:{state:Vk.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:Vk.prototype.TRANSITION_REASONS.ALREADY_QUEUED});var a=function(e,t){if(t)return Vk.prototype.TRANSITION_REASONS.ENGAGED;if(e)switch(e){case"finished":return Vk.prototype.TRANSITION_REASONS.ENGAGED;case"canceled":return Vk.prototype.TRANSITION_REASONS.CANCELED;case"unstaffed":return Vk.prototype.TRANSITION_REASONS.UNSTAFFED;case"closed":return Vk.prototype.TRANSITION_REASONS.CLOSED;case"disconnected":return Vk.prototype.TRANSITION_REASONS.DISCONNECTED;case"failure":return Vk.prototype.TRANSITION_REASONS.FAILED;case"forbidden":return Vk.prototype.TRANSITION_REASONS.FORBIDDEN;case"visitor_conflict":return Vk.prototype.TRANSITION_REASONS.FAILED;default:return void em.error("Unknown visitor left reason",{reason:e})}}(r,o);return a===Vk.prototype.TRANSITION_REASONS.ENGAGED||"opened"!==t.state&&"open"!==t.state?new Vk({state:Vk.prototype.QUEUE_STATES.CANNOT_QUEUE,transitionReason:a}):new Vk({state:Vk.prototype.QUEUE_STATES.CAN_QUEUE,medias:aI(t.medias),transitionReason:a})},uI=A.both(A.propEq("state",Vk.prototype.QUEUE_STATES.CANNOT_QUEUE),A.propEq("transitionReason",Vk.prototype.TRANSITION_REASONS.ENGAGED)),lI=function(e){var t=e.routingObservable,n=e.internalVisitorStateObservable,r=e.queuesStateUpdatesObservable,i=e.createQueueTicketStateObservable,o=e.queueTicketBindings,s=e.scheduler;if(s||(s=zv.Scheduler.asap),A.path(["conf","omniq","omniq_enabled"],sm)){var a=new zv.ReplaySubject(1);i.subscribe((function(e){return a.next(!A.contains(e,[Qk,Yk]))}));var c=function(e,t){return e.publish((function(e){return e.combineLatest(t,(function(e,t){return t})).filter((function(e){return e})).publish((function(t){return e.bufferWhen((function(){return t.take(1)}))}))})).flatMap((function(e){return zv.Observable.from(e)}))}(function(e){var t=e.routingObservable,n=e.queuesStateUpdatesObservable;return t.switchMap((function(e){var t=e.queue_ids;return A.not(t)?mt([]):n.subscribeToListAsObservable({queueIds:t})})).map(Zk).map(A.objOf("queueState")).distinctUntilChanged(A.equals)}({routingObservable:t,queuesStateUpdatesObservable:r}),a),u=n.scan((function(e,t){var n,r,i,o=e&&e.activeTicket&&e.activeTicket.id,s=iI(t),a=Boolean(bk(t));return s?{queued:!0,enqueuedInCurrentTab:(r=s,i=A.lensPath(["visitor","browser_tab_id"]),A.compose(A.equals(sm.tabId),A.view(i))(r)),activeTicket:{id:s.id},visitorLeftReason:null,isEngaged:a}:o&&(n=oI(o,t))?{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:n.state,isEngaged:a}:{queued:!1,enqueuedInCurrentTab:!1,activeTicket:null,visitorLeftReason:null,isEngaged:a}}),{}).do((function(e){e.queued||a.next(!0)})).distinctUntilChanged(A.equals);return{aggregateQueueStateObservable:zv.Observable.merge(c,u).scan(A.merge,{}).filter(sI).do((function(e){sm.conf.visitor_api.enable_staffing_logs&&em.info("[staffing-logs] Recording raw aggregate queue state",e)})).map(cI).distinctUntilChanged(A.equals,eI).scan(function(e){return function(t,n){var r;if(n.state===Vk.prototype.QUEUE_STATES.QUEUED){var i;t.subscription.unsubscribe();var o=Jk.create(e,n);return i=o.ticket,r=o.subscription,n.ticket=i,{queueState:n,subscription:r}}return uI(n)?(em.info("Discarding queue ticket subscription as Visitor got engaged"),{queueState:n,subscription:zv.Subscription.EMPTY}):(t.subscription!==zv.Subscription.EMPTY&&em.info("Dispose queue ticket subscription as Visitor is no longer queued"),t.subscription.unsubscribe(),{queueState:n,subscription:zv.Subscription.EMPTY})}}(o),{subscription:zv.Subscription.EMPTY}).map(A.prop("queueState")).publishReplay(1,Number.POSITIVE_INFINITY,s).refCount()}}return{aggregateQueueStateObservable:zv.Observable.empty()}},pI=function(e){return e&&e.cause===Hy.SALEMOVE.FORBIDDEN||e&&e.cause===Hy.SALEMOVE.INVALID_INPUT?["reason:invalid-input"]:["reason:unknown"]},fI=[],hI=function(e){l(n,e);var t=m(n);function n(e){var r;return s(this,n),e||(e={}),(r=t.apply(this,arguments)).ticket=e.ticket,r}return n}(tg),dI=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),bI=function(e){return!function(e){return 0===e}(e.status)?!function(e){return 403===e}(e.status)?"Service Unavailable"===e.errorThrown&&(e=new tg({cause:Hy.SALEMOVE.INTERNAL_ERROR})):e=new tg({cause:Hy.SALEMOVE.FORBIDDEN}):e=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),zv.Observable.throw(e)},vI=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{logResponse:!0},r=n.logResponse;return yg({stats:e,protocol:"rest",failureTagProperty:"error",timeout:t,timeoutError:zv.Observable.throw(dI),logResponse:r})},mI=function(e,t){return e.omniq.omniq_enabled?t():Promise.reject(new tg({cause:Hy.SALEMOVE.DISABLED}))},yI=function(e){var t=e.conf,n=e.statsClient,r=e.apiTimeoutMilliseconds;return function(){return mI(t,(function(){return vI(n,r)({resource:"queue_wait_duration",method:"get"},(function(){return QE({url:ET("/engagements/queue/wait_duration"),responseType:"json"})})).map(A.compose(A.construct(Fk),Dy({average_duration_in_seconds:"averageDurationInSeconds"}),A.map(Math.floor),A.prop("response"))).catch((function(e){return zv.Observable.throw(LA(e))})).catch(ig).toPromise()}))}},gI=A.compose((function(e){var t=e.id,n=e.name,r=e.status,i=e.availableProperties;return new Wy({id:t,name:n,status:r,medias:i.media})}),A.evolve({status:By}),A.pick(["id","name","status","availableProperties"])),_I=function(e){var t=e.conf,n=e.wsProxy,r=e.statsClient,i=e.apiTimeoutMilliseconds,o=e.apiMaxRetries,s=e.apiRetryIntervalMilliseconds;return function(){var e=function(e){return A.not(A.contains(e.status,A.range(400,499)))};return mI(t,(function(){var t=zv.Observable.defer((function(){return vI(r,i,{logResponse:!1})({resource:"queues",method:"get"},(function(){return n.request({method:"GET",url:"".concat(sm.conf.api_url,"/queues?site_ids[]=").concat(sm.siteId),payload:null,headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json"}})}))}));return Xm(t,{maxRetries:o,calculateDelay:I(s),shouldRetry:e}).map(A.prop("queues")).map(A.map(Dy({available_properties:"availableProperties"}))).map(A.map(gI)).catch(bI).catch(ig).toPromise()}))}},wI=function(e){var t=e.wsProxy,n=e.pubsub,r=e.routingObservable,i=e.engagementApi,o=e.engagementRequestApi,s=e.operatorsObservable,a=e.cobraObservable,c=e.channelObservable,u=e.communicationLib,l=e.statsClient,p=e.fetchEngagementDependencies,f=e.apiTimeoutMilliseconds,h=e.apiRetryIntervalMilliseconds,d=e.apiMaxRetries,b=e.connectionStatusObservable,v=e.webRtcMode,m=e.enabledMediaLevel,y=e.visitorMetadata,_=e.conf,w=e.getRequestHeaders,O=e.internalVisitorStateObservable,E=e.volatileNotifications,S=e.statusObservable,T=e.queuesStateUpdatesObservable,x=new zv.Subscription;x.add(r.subscribe((function(e){fI=e.queue_ids})));var k=function(e){return l.increment("engagement.flow",["entrypoint:queue-request"].concat(e))},I=new zv.Subject,N=lI({routingObservable:r,internalVisitorStateObservable:O,queuesStateUpdatesObservable:T,createQueueTicketStateObservable:I,queueTicketBindings:{apiTimeoutMilliseconds:f,statsClient:l,wsProxy:t,engagementApi:i,engagementRequestApi:o,cobraObservable:a,fetchEngagementDependencies:p,operatorsObservable:s,channelObservable:c,communicationLib:u,webRtcMode:v,enabledMediaLevel:m,connectionStatusObservable:b,getRequestHeaders:w,internalVisitorStateObservable:O,volatileNotifications:E,pubsub:n,statusObservable:S}}).aggregateQueueStateObservable,R=function(e,t){return N.take(1).flatMap((function(n){var r=n.state,i=n.medias;return r===Vk.prototype.QUEUE_STATES.CAN_QUEUE?function(e){var t=e.media,n=e.options,r=e.availableMediaTypes;return xx({media:t,options:n,availableMediaTypes:r,availableOneWayMediaTypes:$E(r)})}({media:e,options:t,availableMediaTypes:i}):zv.Observable.throw(new tg({cause:Hy.SALEMOVE.FORBIDDEN,message:"Queue state must be: ".concat(Vk.prototype.QUEUE_STATES.CAN_QUEUE)}))}))},C=function(){return O.take(1).flatMap((function(e){return Boolean(bk(e))?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.FORBIDDEN,message:"Visitor is already engaged"})):zv.Observable.of({})}))},P=function(e){return-1!==["Queue is closed","Queue is full"].indexOf(e.details)?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:e.message})):409===e.status?N.take(1).flatMap((function(e){return function(e){return zv.Observable.throw(new hI({cause:Hy.SALEMOVE.ALREADY_QUEUED,message:"Visitor is already queued",ticket:e}))}(e.ticket)})):403===e.status?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.FORBIDDEN})):"Validation error"===e.error?zv.Observable.throw(new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:e.error})):ig(e)};return{subscription:x,queueForEngagement:function(e,n){return n||(n={}),k(["action:begin"]),mI(_,(function(){var r=g(n.queueId?[{media:e,options:n},C]:[{media:e,options:n,queueIds:fI},R],2),i=r[0],o=r[1],s=function(e){var t=e.wsProxy,n=e.statsClient,r=e.apiTimeoutMilliseconds,i=e.errorHandling,o=e.visitorMetadata;return function(e){var s=e.media,a=e.options,c=e.queueIds;return vI(n,r)({resource:"queue_tickets",method:"create"},(function(){var e={};a.phoneNumber&&(e.phone_number=a.phoneNumber),a.phoneExtension&&(e.phone_extension=a.phoneExtension),a.oneWay&&(e.one_way=a.oneWay);var n=a.source||"sdk",r={media:s,visitor_id:Qv(),media_options:e,source:n,visitor_metadata:o};a.queueId?r=A.merge(r,{queue_id:a.queueId}):c&&(r=A.merge(r,{queue_ids:c}));var u={method:"POST",url:"".concat(sm.conf.api_url,"/queue_tickets"),payload:A.merge(r,{site_id:sm.siteId}),headers:{"content-type":"application/json",accept:"application/vnd.salemove.v1+json","x-salemove-tab-id":sm.tabId}};return t.request(u).catch(i||ig)}))}}({wsProxy:t,statsClient:l,apiTimeoutMilliseconds:f,visitorMetadata:y,errorHandling:P})(i);return o(e,n).do((function(){return I.next(Qk)})).do((function(){return k(["action:reach","stage:create-request"])}),(function(e){return k(["action:end","stage:pre-request"].concat(pI(e)))})).flatMapTo(s).mapTo({}).do((function(){return k(["action:reach","stage:requested"])}),(function(e){return k(["action:end","stage:create-request"].concat(pI(e)))})).do((function(){return I.next(Yk)}),(function(){return I.next("failed-to-create")})).toPromise()}))},fetchWaitDuration:yI({conf:_,statsClient:l,apiTimeoutMilliseconds:f}),aggregateQueueStateObservable:N,getQueues:Uk(_I({conf:_,wsProxy:t,statsClient:l,apiTimeoutMilliseconds:f,apiMaxRetries:d,apiRetryIntervalMilliseconds:h}),6e4,(function(e){return em.info("Returning cached response for queues",{cached_queues_length:null==e?void 0:e.length})}))}},OI=function(e,t,n){return function(){if("function"==typeof n&&n(arguments),e&&"function"==typeof e[t])return e[t].apply(e,arguments);throw new tg({cause:Hy.SALEMOVE.NOT_SUPPORTED})}},EI=function(e){if(!A.contains(e[0],Zy))throw new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Make sure function argument is one of ISO 3166-1 alpha-2 country codes"})},SI=function(){function e(t){s(this,e),this.triggerQueueMediaSelection=OI(t,"triggerQueueMediaSelection"),this.setChatMessageRenderer=OI(t,"setChatMessageRenderer"),this.setPhoneNumberDefaultCountry=OI(t,"setPhoneNumberDefaultCountry",EI),this.showVisitorCode=OI(t,"showVisitorCode")}return c(e,[{key:"triggerQueueMediaSelection",value:function(e){}},{key:"setChatMessageRenderer",value:function(e){}},{key:"setPhoneNumberDefaultCountry",value:function(e){}},{key:"showVisitorCode",value:function(){}}]),e}(),TI=function e(t){var n=t.id,r=t.siteId,i=t.visitorId,o=t.url,a=t.authenticationApi;s(this,e),this.id=n,this.siteId=r,this.visitorId=i,this.url=o,this.decline=function(e){return a.deleteAuthenticationRequest({id:this.id,siteId:this.siteId,visitorId:this.visitorId,reason:e})}},xI=new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT}),AI=function(e){var t=e.wsProxy,n=e.apiTimeoutMilliseconds,r=e.stats,i=yg({stats:r,protocol:"rest",failureTagProperty:"message",timeout:n,timeoutError:zv.Observable.throw(xI)});return{createAuthenticationRequest:function(e){var n=(e=Uy(e)).webhooks||[];return i({resource:"authentication-request",method:"create"},(function(){return t.request({method:"POST",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests"),payload:{authentication_provider_id:e.authenticationProviderId,webhooks:n,visitor_id:Qv(),site_id:sm.siteId},headers:$y}).catch((function(t){return function(e,t){var n=404===e.status?new tg({cause:Hy.SALEMOVE.INVALID_INPUT,message:"The authentication provider with ID ".concat(t.authenticationProviderId," was not found.")}):rg(e);return zv.Observable.throw(n)}(t,e)}))})).toPromise()},deleteAuthenticationRequest:function(e){var n=e.id,r=e.siteId,o=e.visitorId,s=e.reason;return i({resource:"authentication-request",method:"delete"},(function(){return t.request({method:"DELETE",url:"".concat(sm.conf.api_url,"/visitor_authentication_requests/").concat(n),payload:{site_id:r,visitor_id:o,fail_reason:s},headers:$y}).catch(og,{allowedCauses:[Hy.SALEMOVE.INVALID_INPUT,Hy.SALEMOVE.NETWORK_TIMEOUT]})})).toPromise()}}},kI=!1,II=function(e){var t=e.volatileChannelObservable,n=e.joinChannel,r=e.renewTokenAndReconnect;return function(e,t){return t.switchMap((function(t){return t.observable("message").pipe(tb((function(e){return"engagement.visitor_consolidation.requested"===e.event_type})),Xb((function(n){var r=n.site_id,o=n.visitor_id,s=n.token_event_id;return e("site_visitor:".concat(o),{topics:["site_visitor:".concat(o,":").concat(r)]}).pipe(mb((function(e){return(0,e.observable)("message",{leaveChannelOnDispose:!0})})),tb((function(e){return"engagement.visitor_consolidation"===e.event_type&&e.event_id===s})),Zb(1),lb((function(e){return i(i({},e),{},{volatileChannel:t})})))})))}))}(n,t).subscribe((function(e){var t=e.consolidation_token,n=e.assumed_visitor_id,i=e.volatileChannel;em.info("Consolidating visitor",{assumed_visitor_id:n}),i.leave(),r({newAccessToken:t}).subscribe((function(){return function(e){Jv=e,Yv.next(e)}(n)}),em.error.bind(em,"Error from renewing token and reconnecting in visitor consolidation"))}),em.error.bind(em,"Error from visitor consolidation subscription"))},NI=function(e){return function(){console.warn("Private API, do not use"),e.apply(this,arguments)}},RI=function(){function e(t){var n=this,r=t.statusObservable,i=t.cobraObservable,a=t.webRtcMode,c=t.enabledMediaLevel,u=t.statsClient,l=t.channelObservable,p=t.apiStart,f=t.visitorAppPublicInterface,h=t.pubsub,d=t.routingObservable,b=t.visitorMetadata,v=t.internalVisitorStateObservable,m=t.volatileNotifications,y=t.wsProxy,_=t.currentStatusObservable,w=t.operatorPresenceObservable,O=t.getVisitorPriority,E=t.queuesStateUpdatesObservable,S=t.dynamicImport,T=void 0===S?cm:S;s(this,e),this.willNavigate=this.willNavigate.bind(this),this.statsClient=u,this.visitorApp=new SI(f);var x=new zv.ReplaySubject(1);this.setLocale=function(e){if(A.contains(e,A.keys(sm.conf.visitor_app_assets.locales)))return KE({url:sm.conf.visitor_app_assets.locales[e],retryLimit:5,calculateAttemptDelay:I(1e3),assetKey:"locale-change",identifier:e,onSuccess:function(e){return x.next(e.response)}},this.statsClient),{};throw new tg({cause:this.ERRORS.INVALID_INPUT})};var k=w.map((function(e){return e.values()})),N=w.bufferCount(2,1).flatMap((function(e){var t=g(e,2),n=t[0],r=t[1],i=[];return n.values().forEach((function(e){var t=r.get(e.id);if(t&&!A.equals(e,t))return i.push(t)})),zv.Observable.from(i)})),R=k,C=um.vent.observable(um.MSG.PUBLIC.ENGAGEMENT_START),P=um.vent.observable(um.MSG.PUBLIC.ENGAGEMENT_END),M=!1,j=function(e,t){return zv.Observable.merge(e.map(A.always(!0)),t.map(A.always(!1))).startWith(!1)}(C,P);j.subscribe((function(e){M=e})),this.isInEngagement=function(){return M};var q=new zv.ReplaySubject(1),L=function(e){var t=A.equals("engagement");return e.map((function(e){var n=e.interaction,r=e.visitor;return new Ek({engaged:t(n),name:r&&r.name,email:r&&r.email})}))}(r),U=function(e){return e.connectedObservable.map((function(e){return new Sk({connected:e})}))}(h);II(h);var V=sm.conf.engagement.api_timeout_milliseconds||Gy,D=sm.conf.omniq.api_retry_interval_milliseconds||1e3,F=sm.conf.omniq.api_max_retries||100,B=new Ak({wsProxy:y,stats:this.statsClient,apiTimeoutMilliseconds:V}),W=new Mk({wsProxy:y,stats:this.statsClient,apiTimeoutMilliseconds:V,visitorMetadata:b,internalVisitorStateObservable:v}),H=new AI({wsProxy:y,apiTimeoutMilliseconds:V,stats:this.statsClient}),G=wI({wsProxy:y,pubsub:h,routingObservable:d,engagementApi:B,engagementRequestApi:W,operatorsObservable:R,cobraObservable:i.pluck("cobraSource"),fetchEngagementDependencies:function(){return T("Comms")},channelObservable:l,communicationLib:sm.conf.communications.lib,statsClient:this.statsClient,apiTimeoutMilliseconds:V,apiRetryIntervalMilliseconds:D,apiMaxRetries:F,connectionStatusObservable:U,webRtcMode:a,enabledMediaLevel:c,visitorMetadata:b,conf:sm.conf,getRequestHeaders:this.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:m,statusObservable:r,queuesStateUpdatesObservable:E});this.queueForEngagement=G.queueForEngagement,this.getQueueWaitDuration=G.fetchWaitDuration,this.getQueues=G.getQueues;var z=G.aggregateQueueStateObservable;this.__queueForEngagement=G.oldQueueForEngagement,this.__setQueueReestablishListener=G.oldSetQueueReestablishListener,this.__fetchQueueWaitDuration=G.getQueueWaitDuration,this.subscribeToQueueStateUpdates=hg({enabled:sm.conf.omniq.omniq_enabled,statsClient:this.statsClient,pubsub:h}).subscribe,this.requestEngagement=function(e,t){var o=zA({api:W,conf:sm.conf,operatorsObservable:R.take(1),media:e,options:t,statsClient:n.statsClient,cobraObservable:i.take(1).pluck("cobraSource"),channelObservable:l,engagementApi:B,webRtcMode:a,enabledMediaLevel:c,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,internalVisitorStateObservable:v,volatileNotifications:m,statusObservable:r,pubsub:h,wsProxy:y,dynamicImport:T});return function(e){var t=e.operatorObservable,n=e.engagementObservable,r=e.cancelEngagementRequest,i=e.engagementRequestTimeout;return new JA({timeout:i,engagementPromise:n.toPromise(),operatorPromise:t.toPromise(),cancel:r})}({operatorObservable:o.operatorObservable,engagementObservable:o.engagementObservable,cancelEngagementRequest:o.cancelEngagementRequest,engagementRequestTimeout:o.engagementRequestTimeout})};var J=function(e){var t=e.internalVisitorStateObservable,n=e.webRtcMode,r=e.enabledMediaLevel,i=e.engagementRequestApi,o=e.statsClient,s=e.cobraObservable,a=e.channelObservable,c=e.engagementApi,u=e.connectionStatus,l=e.getRequestHeaders,p=e.volatileNotifications,f=e.statusObservable,h=e.pubsub,d=e.wsProxy,b=e.dynamicImport,v=1e3*sm.conf.engagement.proactive_call_timeout,m=A.compose(A.nth(0),A.filter((function(e){return A.any(A.propEq("id",sm.siteId),e.transferrable_sites)})),A.filter(A.propEq("outcome",null)),A.filter(A.propEq("type","proactive")),A.pathOr([],["engagement","requests"]));return t.map(m).filter(A.identity).distinctUntilChanged(null,A.prop("id")).map((function(e){var b=kS({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.operator.media_type,webRtcMode:n,enabledMediaType:r}),m=kS({id:e.operator.id,name:e.operator.name,formattedName:e.operator.formatted_name,picture:{url:e.operator.picture_url},mediaType:e.offered_media_type,webRtcMode:n,enabledMediaType:r});return{incomingEngagementRequest:lk.create({api:i,id:e.id,operator:b,restrictedOperator:m,message:e.welcome_message,logoUrl:sm.conf.visitor_app.site_logo.url,platform:e.platform,timeout:v,statsClient:o,cobraObservable:s.take(1).pluck("cobraSource"),channelObservable:a,engagementApi:c,connectionStatusObservable:u,getRequestHeaders:l,internalVisitorStateObservable:t,volatileNotifications:p,statusObservable:f,pubsub:h,wsProxy:d}),platform:e.platform}})).switchMap((function(e){var t=e.incomingEngagementRequest,n=e.platform;return b("Comms").mapTo({incomingEngagementRequest:t,platform:n})}))}({dynamicImport:T,internalVisitorStateObservable:v,webRtcMode:a,enabledMediaLevel:c,engagementRequestApi:W,statsClient:this.statsClient,cobraObservable:i,channelObservable:l,engagementApi:B,connectionStatus:U,getRequestHeaders:this.getRequestHeaders,volatileNotifications:m,statusObservable:r,pubsub:h,wsProxy:y}),Q=new QA,Y=J.filter(A.propEq("platform",Ky)).map(A.prop("incomingEngagementRequest"));this.setIncomingEngagementRequestHandler=function(e){Q.add(Y.subscribe(e,em.error))};var K=function(e){var t=e.reestablishObservable,n=e.defaultOmnicoreHandler,r=e.defaultOmnibrowseHandler,i=e.internalVisitorStateObservable,o=e.sessionStore||AE,s=e.timeout||15e3,a=t.publishReplay(1);a.connect();var c={replayedReestablishObservable:a.withLatestFrom(i,(function(e,t){return{source:e,visitorState:t}})).filter((function(e){var t=e.source,n=e.visitorState;return!!t.engagement.engagementId&&A.compose(A.find(A.propEq("id",t.engagement.engagementId)),A.pathOr([],["engagement","engagements"]))(n)})).map((function(e){return e.source})),sessionStore:o,timeout:s};return{setOmnicoreReestablishHandler:Ok(A.merge(c,{defaultHandler:n,storeKey:"custom_reestablish_handler_set",platform:Ky})),setOmnibrowseReestablishHandler:Ok(A.merge(c,{defaultHandler:r,storeKey:"omnibrowse_custom_reestablish_handler_set",platform:Xy}))}}({reestablishObservable:p.flatMap((function(){return wk({channelObservable:l,internalVisitorStateObservable:v,statusObservable:r,webRtcMode:a,enabledMediaLevel:c,statsClient:n.statsClient,cobraObservable:i,isEngagedObservable:j,engagementApi:B,connectionStatusObservable:U,getRequestHeaders:n.getRequestHeaders,volatileNotifications:m,pubsub:h,wsProxy:y,dynamicImport:T})})),defaultOmnicoreHandler:function(e){return em.warn("Engagement reestablished without a reestablish handler in place")},defaultOmnibrowseHandler:function(e){return em.warn("Phone-first (OmniBrowse) engagement reestablished without a reestablish handler in place")},internalVisitorStateObservable:v}),X=K.setOmnicoreReestablishHandler,$=K.setOmnibrowseReestablishHandler;this.setEngagementReestablishHandler=X,this.requestAsset=function(e,t){t||(t={});return uk(e,(function(){return A.merge(n.getRequestHeaders(),t)})).toPromise()},this.omnibrowse=new KA({incomingEngagementRequestObservable:J,setOmnibrowseReestablishHandler:$,statsClient:this.statsClient,wsProxy:y}),this.overseer=new nk({operatorListReady:k.take(1),isOmniqEnabled:sm.conf.omniq.omniq_enabled,routingObservable:d,queueStateReady:z.take(1)}),this.omnicall=new ik,this.config=new ak,this.getBrowserContext=function(){return _.take(1).map((function(e){return{tab_id:sm.tabId,url:window.location.href,metadata:sm.conf.visitor_metadata,status:e}})).toPromise()},this.updateInformation=function(e){return _.take(1).flatMap((function(t){return function(e,t,n){n||(n=zv.Scheduler.asap);var r=t.createApiRequestObservable,i=t.serverResponseTimeout,s=t.tabId,a=t.visitorMetadata,c=t.status;if(e.customAttributes&&"object"!==o(e.customAttributes))return zv.Observable.throw({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Custom attributes must be an object"});if(A.has("customAttributesUpdateMethod",e)&&!A.contains(e.customAttributesUpdateMethod,["merge","replace"]))return zv.Observable.throw({cause:Hy.SALEMOVE.INVALID_INPUT,message:"Custom attributes update method must be either merge or replace"});var u=A.compose(Dy(qk),A.pick(jk)),l=A.has("externalId",e)?A.compose(A.assocPath(["custom_attributes","external_id"],e.externalId),u)(e):u(e);return l.context={tab_id:s,url:window.location.href,metadata:a,status:c},r(l).map((function(){return{}})).catch((function(e){return zv.Observable.throw(LA(e))})).timeoutWith(i,zv.Observable.throw(new tg({cause:Hy.SALEMOVE.NETWORK_TIMEOUT,message:"Set visitor information request timed out"})),n).do(null,A.ifElse(A.propEq("cause",Hy.SALEMOVE.TOO_MANY_REQUESTS),em.warn.bind(em,"Setting visitor information failed: too many requests"),em.info.bind(em,"Setting visitor information failed"))).catch(ig)}(e,{createApiRequestObservable:function(e){return QE({url:ET("/sites/".concat(Xv(),"/visitors/").concat(Qv())),method:"PATCH",contentType:"application/json",payload:JSON.stringify(e)})},serverResponseTimeout:Gy,tabId:sm.tabId,visitorMetadata:sm.conf.visitor_metadata,status:t})})).toPromise()},this.createAuthenticationRequest=function(e){return em.info("Create authentication request called",e),H.createAuthenticationRequest(e)},this.setupContactOperatorButton=function(e){return e||(e={}),q.next(e)};var Z=function(e){var t=e.internalVisitorStateObservable,n=e.authenticationApi,r=A.compose(A.find((function(e){return e.site_id===Xv()&&e.visitor_id===Qv()})),A.pathOr([],["authentication_requests"]));return t.map(r).filter(A.identity).distinctUntilChanged(A.equals).map((function(e){return A.construct(TI)({id:e.id,siteId:e.site_id,visitorId:e.visitor_id,url:e.url,authenticationApi:n})}))}({internalVisitorStateObservable:v,authenticationApi:H}),ee=A.fromPairs([[this.EVENTS.ENGAGEMENT_START,C],[this.EVENTS.ENGAGEMENT_END,P],[this.EVENTS.VISITOR_STATUS_UPDATE,L],[this.EVENTS.OPERATOR_STATUS_UPDATE,N],[this.EVENTS.OPERATOR_LIST_UPDATE,k],[this.EVENTS.ENGAGEMENT_REQUEST,J.map(A.always({}))],[this.EVENTS.CONNECTION_STATUS_UPDATE,U],[this.EVENTS.QUEUE_STATE_UPDATE,z],[this.EVENTS.AUTHENTICATION_REQUEST,Z],["contact_operator_button_configuration",q],["locale_change_requested",x]]),te=Ag();te.proxyAll(ee),this.addEventListener=te.addEventListener,this.removeEventListener=te.removeEventListener,this.observable=function(e){return ee[e]},function(e){var t,n=e.internalVisitorStateObservable,r=e.useOmniq,i=e.operatorListUpdate,o=e.queueStateUpdate,s=e.statsClient,a=e.staffingCheckDelayMs,c=void 0===a?1e4:a,u=e.recordingMaxTime,l=void 0===u?6e4:u,p=A.compose(A.length,A.filter(A.path(["state","available"]))),f=n.map((function(e){return Boolean(bk(e))})).filter(A.equals(!0));t=r?o.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&em.info("[staffing-logs] Recording queue state",{queue_state:e.state}),A.contains(e.state,[e.QUEUE_STATES.CAN_QUEUE,e.QUEUE_STATES.QUEUED])?"staffed":"general"})):i.map((function(e){return sm.conf.visitor_api.enable_staffing_logs&&em.info("[staffing-logs] Recording operator state",{operator_count:p(e)}),p(e)>0?"staffed":"general"})),sm.conf.visitor_api.enable_staffing_logs&&em.info("[staffing-logs] Starting recorder timer",{duration:c});var h=zv.Observable.create((function(e){var t=setTimeout((function(){e.next(null)}),c);return function(){return clearTimeout(t)}})),d=new Date,b=function(){return window.performance&&window.performance.now&&window.performance.now()},v=b();h.flatMapTo(t).take(1).takeUntil(f).subscribe((function(e){var t=new Date,n=b(),r=t-d+1e3<=c;r||t-d>l?em.warn("Recording staffing failed due to browser timer issues",{type:e,early_recording:r,start_time:d.toISOString(),recording_time:t.toISOString(),accurate_start_time:v,accurate_recording_time:n,difference:t&&t-d,accurate_difference:n&&n-v}):s.increment("usage_metrics.visitor.reactive_tab_showed",["type:".concat(e),"source:desktop","site_id:".concat(Xv()),"visitor_id:".concat(Qv())])}),em.error)}({internalVisitorStateObservable:v,useOmniq:sm.conf.omniq.omniq_enabled,operatorListUpdate:this.observable(this.EVENTS.OPERATOR_LIST_UPDATE),queueStateUpdate:this.observable(this.EVENTS.QUEUE_STATE_UPDATE),statsClient:this.statsClient});var ne=Oy();!function(e){var t=e.visitorIdleAfterTime,n=e.pubsub;t.subscribe((function(){sm.logger.info("Visitor was idle for too long, disconnecting"),n.disconnect(),kI=!0}))}({visitorIdleAfterTime:function(e,t){var n=e.activityObservable,r=e.engagementEndObservable,i=e.timeUntilIdle,o=e.maxIdleTime,s=e.isEngaged;return zv.Observable.merge(n,r).debounceTime(i+o,t).filter((function(){return!s()})).map((function(){}))}({activityObservable:ne,engagementEndObservable:P,timeUntilIdle:1e3*sm.conf.engagement.visitor_time_to_inactive_sec,maxIdleTime:1e3*sm.conf.visitor_api.max_idle_time_seconds,isEngaged:function(){return M}}).filter((function(){return sm.conf.visitor_api.disconnect_idle_visitors})),pubsub:h}),function(e){var t=e.activityObservable,n=e.pubsub;t.filter((function(){return kI&&n.allowReconnection()})).subscribe((function(){sm.logger.info("Reconnecting idle visitor due to detected activity"),kI=!1,n.connect()}))}({activityObservable:ne,pubsub:h}),this.getSessionContext=function(){var e={tab_id:sm.tabId,visitor_priority:O(),access_token:sm.accessToken};return encodeURIComponent(btoa(JSON.stringify(e)))},this.__pubsub__={reconnect:NI(h.reconnect)}}return c(e,[{key:"getRequestHeaders",value:function(){return{Accept:"application/vnd.salemove.v1+json",Authorization:"Bearer "+sm.accessToken}}},{key:"getVisitorId",value:function(){return Qv()}},{key:"getSiteId",value:function(){return Xv()}},{key:"leaveMessage",value:function(e){return ck(e,{createApiRequestObservable:function(e){return QE({url:ET("/visitor/offline_message"),method:"POST",contentType:"application/json",payload:JSON.stringify(e)})},serverResponseTimeout:Gy}).toPromise()}},{key:"leaveOperatorMessage",value:function(e){return function(e,t,n){e||(e={}),n||(n=zv.Scheduler.asap);var r=e.operatorId;return r?ck(A.merge({operator_id:r},e),t,["operator_id"],n):zv.Observable.throw({cause:Hy.SALEMOVE.INVALID_INPUT,message:"operatorId must be specified"})}(e,{createApiRequestObservable:function(e){return QE({url:ET("/visitor/operator_message"),method:"POST",contentType:"application/json",payload:JSON.stringify(e)})},serverResponseTimeout:Gy}).toPromise()}},{key:"willNavigate",value:function(){return Promise.resolve({})}},{key:"changeElementAttributesForCobrowsing",value:function(e,t){if("function"!=typeof t)throw new tg({cause:this.ERRORS.INVALID_INPUT});return e.sm_change_element_attributes=Tg("Custom element attribute serializer threw error",Yy,t),function(e){e.setAttribute(Tk,"0"===(e.getAttribute(Tk)||"0")?"1":"0")}(e),null}}]),e}();RI.prototype.ERRORS={INVALID_INPUT:"invalid input",OPERATOR_UNAVAILABLE:"operator unavailable",INTERNAL_ERROR:"internal error",RESOURCE_NOT_FOUND:"not found",OPERATOR_DECLINED:"operator declined",DECLINE:"decline",CANCEL:"cancel",TIMEOUT:"timeout",NETWORK_TIMEOUT:"network timeout",CONNECTION_LOST:"connection lost",TOO_MANY_REQUESTS:"too many requests",FORBIDDEN:"forbidden",NOT_SUPPORTED:"not supported",DISABLED:"disabled",ALREADY_QUEUED:"already queued",ALREADY_ENGAGED:"already engaged",CONFLICT:"conflict",FILE_TOO_LARGE:"file too large",FILE_CONTENT_TYPE_NOT_ALLOWED:"file content type not allowed"},RI.prototype.EVENTS={ENGAGEMENT_END:"sm:engagement:end",ENGAGEMENT_START:"sm:engagement:start",VISITOR_STATUS_UPDATE:"sm:visitor_status:update",ENGAGEMENT_REQUEST:"sm:engagement:request",OPERATOR_LIST_UPDATE:"sm:operator_list:update",OPERATOR_STATUS_UPDATE:"sm:operator_status:update",CONNECTION_STATUS_UPDATE:"sm:connection_status:update",QUEUE_STATE_UPDATE:"sm:queue:update",AUTHENTICATION_REQUEST:"sm:authentication:request"};var CI="sm.app.visitor_api.send_capabilities",PI=function(){function e(t){var n=t.channelObservable,r=t.statsClient,i=t.getLocalCapabilities,o=void 0===i?PA:i;s(this,e),this.channelObservable=n,this.statsClient=r,this.getLocalCapabilities=o,this._receivePostMessage=this._receivePostMessage.bind(this),this._restoreLastUrl=this._restoreLastUrl.bind(this),this._subscription=new zv.Subscription,this.lastUrl=window.location.href}return c(e,[{key:"start",value:function(){return this._addListeners()}},{key:"capabilitiesRequestObservable",value:function(){return this.channelObservable.switchMap((function(e){var t=e.channel;return function(e){return sm.logger.log("Capabilities response, received request"),e.observable("capabilities:request")}(t).map((function(){return t}))}))}},{key:"_addListeners",value:function(){var e=this;um.vent.observable("visit:restore_url").subscribe(this._restoreLastUrl,sm.logger.error),window.addEventListener("message",this._receivePostMessage,!1),this._subscription.add(this.capabilitiesRequestObservable().map((function(t){return{channel:t,localCapabilities:e.getLocalCapabilities()}})).do((function(){return e.statsClient.increment(CI,["action:succeeded"])})).do(null,(function(){return e.statsClient.increment(CI,["action:failed"])})).subscribe((function(e){var t=e.channel,n=e.localCapabilities;sm.logger.log("Sending local capabilities",n),t.emit("capabilities:response",n)}),sm.logger.warn.bind(sm.logger,"Failed to send visitor capabilities")))}},{key:"_receivePostMessage",value:function(e){try{var t=JSON.parse(e.data);t["sm-xdr-url"]&&(this.lastUrl=t["sm-xdr-url"])}catch(e){}}},{key:"_restoreLastUrl",value:function(){this.lastUrl&&this.lastUrl.split("#")===window.location.href.split("#")[0]?window.location.reload():window.location.href=this.lastUrl}}]),e}(),MI=["v1"],jI=new Promise((function(e,t){return sm._apiHandlers.push({resolve:e,options:{version:"v1"}})})),qI=new zv.Subject,LI=zv.Observable.fromPromise(jI).flatMap((function(e){return zv.Observable.merge(e.observable(e.EVENTS.ENGAGEMENT_START),e.observable(e.EVENTS.ENGAGEMENT_END).map((function(){return null})))})).publishReplay(1);LI.connect();var UI=function(){function e(t){var n=t.element;s(this,e),this._empty=this._empty.bind(this),this._startOperatorMediaInElement=this._startOperatorMediaInElement.bind(this),this.element=n,this._subscription=new zv.Subscription;var r=g(LI.partition(A.identity),2);this.startMediaObservable=r[0],this.endMediaObservable=r[1]}return c(e,[{key:"start",value:function(){this._subscription.add(this.startMediaObservable.subscribe(this._startOperatorMediaInElement,em.error)),this._subscription.add(this.endMediaObservable.subscribe(this._empty,em.error))}},{key:"destroy",value:function(){this._subscription.unsubscribe()}},{key:"_empty",value:function(){this.element.innerHTML=""}},{key:"_startOperatorMediaInElement",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;e.communicationWidget.startOperatorMedia(this.element),em.info("Starting operator media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),tm.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_operator","updated_webcomponents:".concat(t)])}}]),e}(),VI=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return c(n,[{key:"connectedCallback",value:function(){return this._controller=new UI({element:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){return this._controller.destroy()}}]),n}(b(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){return this._controller=new UI({element:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){return this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new UI({element:this}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},DI=function(){var e=VI();if(window.customElements)try{customElements.get("sm-engaged-operator")||window.customElements.define("sm-engaged-operator",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;tm.increment("sm.app.visitor.customElements",["action:failed","type:engaged_operator","updated_webcomponents:".concat(t)]),em.error("Failed to initiate sm-engaged-operator",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-operator",e)},FI=function(){function e(t){var n=t.engagedVisitorElement;s(this,e),this._addListeners=this._addListeners.bind(this),this._empty=this._empty.bind(this),this._startVisitorMedia=this._startVisitorMedia.bind(this),this.engagedVisitorElement=n,this._subscription=new zv.Subscription}return c(e,[{key:"start",value:function(){return this._addListeners()}},{key:"destroy",value:function(){return this._subscription.unsubscribe()}},{key:"_addListeners",value:function(){var e=g(LI.partition(A.identity),2),t=e[0],n=e[1];return this._subscription.add(t.subscribe(this._startVisitorMedia,em.error)),this._subscription.add(n.subscribe(this._empty,em.error))}},{key:"_empty",value:function(){this.engagedVisitorElement.innerHTML=""}},{key:"_startVisitorMedia",value:function(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0,r=document.createElement("div");this.engagedVisitorElement.appendChild(r),e.communicationWidget.startVisitorMedia(r),em.info("Starting visitor media in widget",{engagement_id:e.engagementId,updated_webcomponents:t}),tm.increment("sm.app.visitor.customElements",["action:succeeded","type:engaged_visitor","updated_webcomponents:".concat(t)])}}]),e}(),BI=function(){if(sm.conf.visitor_api&&sm.conf.visitor_api.use_updated_webcomponents)return function(e){l(n,e);var t=m(n);function n(){return s(this,n),t.apply(this,arguments)}return c(n,[{key:"connectedCallback",value:function(){this._controller=new FI({engagedVisitorElement:this}),this._controller.start()}},{key:"disconnectedCallback",value:function(){this._controller.destroy()}}]),n}(b(HTMLElement));if(window.customElements){var e=function e(){return window.Reflect.construct(HTMLElement,[],e)};return Object.setPrototypeOf(e.prototype,HTMLElement.prototype),Object.setPrototypeOf(e,HTMLElement),e.prototype.connectedCallback=function(){this._controller=new FI({engagedVisitorElement:this}),this._controller.start()},e.prototype.disconnectedCallback=function(){this._controller.destroy()},e}var t={}.hasOwnProperty;return function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return function(e,n){var r;for(r in n)t.call(n,r)&&(e[r]=n[r]);function i(){this.constructor=e}i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype}(n,HTMLElement),n.prototype.attachedCallback=function(){return this._controller=new FI({engagedVisitorElement:this}),this._controller.start()},n.prototype.detachedCallback=function(){return this._controller.destroy()},n}()},WI=function(){var e=BI();if(window.customElements)try{customElements.get("sm-engaged-visitor")||window.customElements.define("sm-engaged-visitor",e)}catch(e){var t=n.default.visitor_api?n.default.visitor_api.use_updated_webcomponents:void 0;tm.increment("sm.app.visitor.customElements",["action:failed","type:engaged_visitor","updated_webcomponents:".concat(t)]),em.error("Failed to initiate sm-engaged-visitor",{error_message:e?e.message:void 0,updated_webcomponents:t})}else document.registerElement("sm-engaged-visitor",e)},HI=!1,GI=!1,zI=[],JI=function e(){if(!GI){if(!document.body)return setTimeout(e,13);if(GI=!0,zI){for(var t,n=0;t=zI[n++];)t.call(document);zI=null}}},QI=function e(){document.removeEventListener("DOMContentLoaded",e,!1),JI()};function YI(e){!function(){if(!HI){if(HI=!0,"complete"===document.readyState||"interactive"===document.readyState)return JI();document.addEventListener("DOMContentLoaded",QI,!1),window.addEventListener("load",JI,!1)}}(),GI?e.call(document):zI&&zI.push(e)}sm.ready=YI;var KI=function(e){localStorage.setItem("sm.access_token",e)},XI=sm.conf.visitor_api,$I=XI.persist_session_in_url_on_xdomain_navigation,ZI=XI.persist_visitor_session_in_url;if($I||ZI){sm.urlParams=YS({accessToken:/.+/,tabId:/.+/},{targetWindow:window,logger:em})}else sm.urlParams={};if("show_visitor_code"===sm.conf.visitor_app.chat_link_visitor_consolidation){var eN=YS({showVisitorCode:/true/},{targetWindow:window,logger:em});A.isEmpty(eN)||(sm.urlParams.showVisitorCode=!0)}var tN={setStatsClient:function(){},setLogger:function(){},ready:function(){}},nN=function(e){var t=sm.conf.visitor_app_assets,n="visitor_app";return new Promise((function(r,i){var o,s,a;-1!==["latest_new_app","latest_v2","latest_v2_plus"].indexOf(sm.conf.visitor_app_option)?(o=function(e){e.setAttribute("data-sm-visitor-app-asset",""),e.setAttribute("data-loaded-callback","sm.visitorAppLoaded"),sm.visitorAppLoaded=r},a=null):(o=function(e){return e.setAttribute("data-sm-visitor-app-asset","")},a=function(){return r(tN)}),t.js.forEach((function(t){s=t.substring(t.lastIndexOf("/")+1),M({integrity:P({versionedName:s}),fileUrl:t,beforeLoad:o,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".js")])},onLoad:function(){e.increment("sm.assets.load",["action:succeeded","asset:".concat(n,".js")]),a&&a()},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".js")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".js")]),em.warn(new Error("Failed to load visitor app JS asset"),{asset_url:t})}})})),t.css.forEach((function(t){var r,i,o,a,c,u;s=t.substring(t.lastIndexOf("/")+1),r={integrity:P({versionedName:s}),fileUrl:t,onAttempt:function(){e.increment("sm.assets.load",["action:attempted","asset:".concat(n,".css")])},onError:function(){e.increment("sm.assets.load",["action:warning","asset:".concat(n,".css")])},onGiveUp:function(){e.increment("sm.assets.load",["action:failed","asset:".concat(n,".css")]),em.warn(new Error("Failed to load visitor app CSS asset"),{asset_url:t})}},i=r.integrity,o=r.fileUrl,a=r.onAttempt,c=r.onError,u=r.onGiveUp,R({calculateAttemptDelay:I(1e3),attempt:function(e){var t=e.repeat;"function"==typeof a&&a();var n=document.createElement("link");return n.type="text/css",n.rel="stylesheet",n.onerror=function(){"function"==typeof c&&c(),document.head.removeChild(n),t()},n.href=o,i&&(n.setAttribute("integrity",i),n.setAttribute("crossorigin","*")),document.head.appendChild(n),n},onGiveUp:function(){"function"==typeof u&&u()},retryLimit:5})}))}))},rN=function(){return-1!==["latest_new_app","latest_v2","latest_v2_plus","custom","omnibrowse"].indexOf(sm.conf.visitor_app_option)},iN=function(e){var t=e.stats;return rN()?nN(t):Promise.resolve(tN)},oN=function(){return sm.conf.visitor_app.visitor_app_default_locale||""},sN={translations:{}},aN=function(e){return new Promise((function(t,n){var r=oN(),i=(sm.conf.visitor_app_assets.locales||{})[r];i?KE({url:i,retryLimit:5,calculateAttemptDelay:I(1e3),assetKey:"locale",identifier:r,onSuccess:function(e){t({translations:e.response})},onError:function(){em.warn("Fetching locale failed, using empty locale"),t(sN)}},e):(em.error("Locale is not present, starting with defaultMessages",{localeKey:r,localeUrl:i}),t(sN))}))},cN=function(e){return"en-US"===oN()?Promise.resolve(sN):rN()?aN(e):Promise.resolve(sN)};function uN(e){var t={parent:{},top:{}},n=new gy(window.parent);this.start=function(){n.start()},this.stop=function(){n.stop()},this.request=function(){n.emit("sm:iframe_tab_id",e),n.request("sm:iframe_context_check",{},(function(e){t.parent[e]=!0})),n.request("sm:source:nested_cobrowsable_iframe:channel_url",{},(function(e){var n=e.url;t.nestedCobrowsableVisitorIframeChannelUrl=n}))},this.getCurrentContext=function(){return t},this.getParentWindowMessenger=function(){return n}}var lN=function e(t,n){var r=function(e,t){for(var n=e.querySelectorAll("iframe"),r=0;r<n.length;r++){var i=n[r];if(i.contentWindow===t)return i}}(t,n);if(r)return r;for(var i=t.querySelectorAll("*"),o=0;o<i.length;++o){var s=i[o];if(s.shadowRoot){var a=e(s.shadowRoot,n);if(a)return a}}return null};sm.FrameCheck={startNotifyingOfBeingVisitorPage:function(){sm.contextNotifyingMessenger=new _y({allowAnySource:!0}),sm.contextNotifyingMessenger.start(),sm.contextNotifyingMessenger.respondTo("sm:iframe_context_check",(function(e,t,n){var r=lN(document,n);r&&function(e){var t=e.attributes.cobrowsable_with_mutations;t&&t.value||(e&&e.setAttribute("cobrowsable_iframe_id",vy()),KS()&&e.setAttribute("cobrowsable_with_mutations",!0))}(r),t("visitor_page")}))},startNotifyingOfBeingVisitorBrowser:function(){var e=new _y({allowAnySource:!0});e.start(),e.respondTo("sm:iframe_context_check",(function(e,t,n){t("visitor_browser")}))}};var pN=function(e){var t=DS.extractLinkFromEvent(e);t&&function(e,t){"https:"!==t.protocol&&"http:"!==t.protocol||DS.isAllowedToNavigate(t.hostname)||(e.preventDefault(),window.open(t.href))}(e,t)},fN=function(){return SE.unloadMaybeToPageCache.subscribe((function(){return AE.set(yT,_T(document))}))},hN=function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,c=e.operatorPresenceObservable,u=e.routingObservable;document.body.addEventListener("click",pN),fN(),function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,c=e.operatorPresenceObservable,u=e.routingObservable;jg();var l=Cg({channelObservable:dT({internalVisitorStateObservable:o,getAccessToken:t,stats:n,visitorPresenceChannel:i,salemovePresentInParent:!0}).channelObservable,logger:em}).cobraObservable,p=hg({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});Sg({internalVisitorStateObservable:o,cobraObservable:l,volatileNotifications:s,stats:n,wsProxy:a,currentStatusObservable:NE(o),operatorPresenceObservable:c,queuesStateUpdatesObservable:p,routingObservable:u})}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:c,routingObservable:u}),dm(),FS()},dN={setup:function(){KI(sm.accessToken),em.info("Visitor WebRTC mode",{webrtc_mode:bS()}),sm.conf.visitor_app.theme=sm.conf.visitor_app.theme.desktop_css_url;var e=GS(),t=e.bestEffortXDomainStorage,n=e.windowNameStorage,r=e.xDomainUrlStorage,o=kE.setup(n,{sessionContext:sm._sessionContext,tabIdFromConfiguration:sm.tabId}).getId();sm.tabId=o;var s=new zv.Subject;!function(e,t){k=A.merge(k,{enabled:t}),e.take(1).subscribe((function(e){e.volatileChannelObservable.flatMap((function(e){return e.observable("system:visitor_retry_configuration")})).subscribe((function(e){k=e}))}))}(s,sm.conf.visitor_request_retries_enabled);var a=function(e){return e.getItem(PE)}(t)||CE,c=function(){return a},u=A.pathOr(!1,["sm","conf","site_visitor_config","detect_visitor_by_external_session_token"])(window),l=new zv.Subject,p=function(e){var t=e.fetchToken,n=void 0===t?BE:t,r=e.accessToken,i=e.scheduler,o=void 0===i?zv.Scheduler.asap:i,s=e.accessTokenRenewalSignal,a=void 0===s?zv.Observable.empty():s,c=e.backoffStrategy,u=void 0===c?I:c,l=e.getVisitorPriority,p=e.getVisitorTabId,f=void 0===p?function(){return sm.tabId}:p,h=e.detectVisitorByExternalSessionTokenEnabled,d=void 0!==h&&h,b=new zv.ReplaySubject(1),v=DE(r);b.next(v);var m=u(3e3),y=function(e){return e&&e.newAccessToken};return b.switchMap((function(e){return zv.Observable.timer(e,o)})).merge(a.filter(A.complement(y))).throttleTime(6e4,o).merge(a.filter(y)).switchMap((function(e){var t=e&&e.newAccessToken||r;em.info("Refreshing access token");var i=zv.Observable.defer((function(){return n({priority:l(),accessToken:t,tabId:f(),detectVisitorByExternalSessionTokenEnabled:d})})).do(null,(function(e){503!==e.status&&429!==e.status||(em.warn("Visitor access token unavailable, switching to maximum backoff"),m.maximizeNextDelay()),em.warn("Failed to fetch JWT token. Retrying...",e.responseText)}));return Xm(i,{maxRetries:403200,calculateDelay:m,scheduler:o}).do((function(e){r=e;var t=DE(e);b.next(t),em.info("Access token refresh succeeded",{interval_seconds:t/1e3})}))}))}({accessToken:sm.accessToken,accessTokenRenewalSignal:l,getVisitorPriority:c,detectVisitorByExternalSessionTokenEnabled:u}).share();p.subscribe((function(e){sm.accessToken=e,KI(e)}));var f=function(){return sm.accessToken},h=Jg({server:sm.conf.pubsub_server,stats:tm,logsEnabled:sm.conf.visitor_api.pubsub_logs_enabled,getAccessToken:f,renewAccessToken:function(e){return l.next(e),p.delay(1e3)},reconnectConf:{initialDelay:sm.conf.visitor_api.socket_connection_error_retry_delay,maxDelay:sm.conf.visitor_api.socket_connection_error_max_delay,delayFactor:sm.conf.visitor_api.socket_connection_error_delay_factor},getVisitorPriority:c});s.next(h);var d=new Qg(h,{tabId:sm.tabId,idleTimeoutSeconds:sm.conf.engagement.visitor_time_to_inactive_sec,visitorMetadata:sm.conf.visitor_metadata}),b=function(e){var t=e.pubsub,n=e.allowConnectingMultipleTimes,r=e.visitorIdObservable,o=void 0===r?Kv():r;return dE&&!n?em.error(hE):((dE=o.switchMap((function(e){return t.joinChannel("visitor_state:".concat(e)).flatMap((function(e){return(0,e.observable)("change",{leaveChannelOnDispose:!0})})).map((function(t){return i(i({},t||{}),{},{visitor_id:e})}))})).do(gE).publishReplay(1)).connect(),dE)}({pubsub:h});(function(e,t){return e.map(LE).distinctUntilChanged().do((function(e){return t.setItem(PE,e)}))})(b,t).subscribe((function(e){a=e}));var v,m=h.volatileChannelObservable.flatMap((function(e){return(0,e.observable)("message")})),y=function(e){var t=e.pubsub,n=t.joinChannel("websocket_proxy").publishReplay(1);return n.connect(),{connectedObservable:t.connectedObservable,request:function(e,t){return t||(t={}),"GET"===e.method&&null!==e.payload?(_E.error("Request with GET method cannot have payload",{params:e}),zv.Observable.throw("Request with GET method cannot have payload")):n.flatMap((function(n){return n.push("request",e,t)})).flatMap(wE).catch(OE)}}}({pubsub:h});v=sm.conf.visitor_api.use_updated_webcomponents?window.customElements&&window.customElements.define?"webcomponents_es5":"webcomponents":"legacy_webcomponents";var g=sm.BusinessRules.Controller.actionTriggers(m,sm.BusinessRules.ACTION_TYPES.SHOW_OPERATORS_IN_SELECTOR_V2).scan((function(e,t){var n=t.operator_team_id,r=t.rule_id,i=t.rule_name,o=t.clear_previous;return o?{team_ids:[n],rule_id:r,rule_name:i,clear_previous:o}:{team_ids:A.union(e.team_ids,[n]),rule_id:r,rule_name:i,clear_previous:o}}),{}).do((function(e){return em.info("Business rule setting visible teams",{team_ids:e.team_ids,rule_id:e.rule_id,rule_name:e.rule_name,clear_previous:e.clear_previous})})).pluck("team_ids").publishReplay(1);g.connect();var _=function(e){var t=e.pubsub,n=e.visibleTeamsObservable,r=e.enabledMediaLevel,i=e.webRtcMode,o=t.joinChannel("site_operator_presence:".concat(sm.siteId)).map((function(e){var t=e.phoenixChannel;return new qg.Presence(t)})).switchMap((function(e){return zv.Observable.create((function(t){return RS({presence:e,presenceMapper:IS({enabledMediaLevel:r,webRtcMode:i}),visibleTeamsObservable:n,onChange:function(e){return t.next(e)}})}))})).publishReplay(1);return(o=Km(o)).sampleTime(300)}({pubsub:h,visibleTeamsObservable:g,enabledMediaLevel:sm.conf.communications.enabled_media_level,webRtcMode:bS()}),w=sm.conf.engagement.default_queues||[],O=zS({internalVisitorStateObservable:b,defaultQueues:w});cm(v).subscribe((function(){YI((function(){window!==window.top?dN.setupIFrame({getAccessToken:f,stats:tm,pubsub:h,visitorPresenceChannel:d,internalVisitorStateObservable:b,volatileNotifications:m,wsProxy:y,bestEffortXDomainStorage:t,operatorPresenceObservable:_,xDomainUrlStorage:r,getVisitorPriority:c,routingObservable:O,tabId:o}):(sm.FrameCheck.startNotifyingOfBeingVisitorPage(),sm.FrameCheck.startNotifyingOfBeingVisitorBrowser(),dN.setupApp({getAccessToken:f,stats:tm,pubsub:h,visitorPresenceChannel:d,internalVisitorStateObservable:b,volatileNotifications:m,wsProxy:y,operatorPresenceObservable:_,bestEffortXDomainStorage:t,xDomainUrlStorage:r,getVisitorPriority:c,routingObservable:O}))}))}))},setupApp:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,c=e.operatorPresenceObservable,u=e.xDomainUrlStorage,l=e.getVisitorPriority,p=e.routingObservable;DI(),WI();return Promise.all([iN({stats:n}),cN(n),QS({stats:n})]).then((function(e){return"[0]"!==JSON.stringify([0])?(r.disconnect(),Promise.reject('Misimplemented array stringification: (JSON.stringify([0]) !== "[0]"')):e})).then((function(e){var t=g(e,2);return function(e){var t=e.visitorApp,r=e.locale;return void 0===t.setStatsClient&&em.warn("Setting dependencies failed. visitorApp.setStatsClient was undefined.",{visitorApp:t}),t.setStatsClient(n),t.setLogger(em),t.ready({locale:r}),t}({visitorApp:t[0],locale:t[1]})})).then((function(e){u.setItem("tabId",sm.tabId),u.setItem("accessToken",sm.accessToken);var f=function(e){var t=e.getAccessToken,n=e.stats,r=e.visitorPresenceChannel,i=e.internalVisitorStateObservable;jg();var o=dT({internalVisitorStateObservable:i,getAccessToken:t,stats:n,visitorPresenceChannel:r,salemovePresentInParent:!1}),s=o.channelObservable;return{channelObservable:s,statusObservable:o.statusObservable,cobraObservable:Cg({channelObservable:s,logger:em}).cobraObservable}}({getAccessToken:t,stats:n,pubsub:r,visitorPresenceChannel:i,internalVisitorStateObservable:o}),h=NE(o),d=hg({enabled:sm.conf.omniq.omniq_enabled,statsClient:n,pubsub:r});!function(e){var t,n=e.statusObservable,r=e.cobraObservable,i=e.statsClient,o=e.channelObservable,s=e.visitorAppPublicInterface,a=e.pubsub,c=e.visitorMetadata,u=e.internalVisitorStateObservable,l=e.routingObservable,p=e.volatileNotifications,f=e.wsProxy,h=e.currentStatusObservable,d=e.operatorPresenceObservable,b=e.getVisitorPriority,v=e.queuesStateUpdatesObservable,m=bS(),y=sm.conf.communications.enabled_media_level,g=new RI({statusObservable:n,webRtcMode:m,enabledMediaLevel:y,statsClient:i,cobraObservable:r,channelObservable:o,apiStart:qI,visitorAppPublicInterface:s,pubsub:a,visitorMetadata:c,internalVisitorStateObservable:u,routingObservable:l,volatileNotifications:p,wsProxy:f,currentStatusObservable:h,operatorPresenceObservable:d,getVisitorPriority:b,queuesStateUpdatesObservable:v});sm._getApi=t=function(e){e||(e={});var t=e.version;return t?A.contains(t,MI)?Promise.resolve(g):(em.warn("getApi used with unsupported version ".concat(t," at ").concat(window.location.host)),Promise.reject(new Error("".concat(t," is not supported for Glia API. ")+"The supported versions are: ".concat(Ox(MI))))):(console.warn("Requesting the Glia API without a version is deprecated. Provide the 'version' parameter to the sm.getApi function. Example: sm.getApi({version: 'v1'})"),em.warn("getApi used without version at ".concat(window.location.host)),Promise.resolve(g))},A.forEach((function(e){t(e.options).then(e.resolve.bind(e))}),sm._apiHandlers),new PI({channelObservable:o,statsClient:i}).start(),qI.next(),qI.complete(),setTimeout((function(){sm.urlParams.showVisitorCode&&s&&(s.showVisitorCode?s.showVisitorCode():em.info("showVisitorCode is undefined on visitorAppPublicInterface"))}))}({statusObservable:f.statusObservable,cobraObservable:f.cobraObservable,channelObservable:f.channelObservable,statsClient:n,visitorAppPublicInterface:e,pubsub:r,visitorMetadata:sm.conf.visitor_metadata,internalVisitorStateObservable:o,routingObservable:p,volatileNotifications:s,wsProxy:a,currentStatusObservable:h,operatorPresenceObservable:c,getVisitorPriority:l,queuesStateUpdatesObservable:d}),Sg({internalVisitorStateObservable:o,cobraObservable:f.cobraObservable,volatileNotifications:s,stats:n,wsProxy:a,currentStatusObservable:h,operatorPresenceObservable:c,queuesStateUpdatesObservable:d,routingObservable:p}),dm(),function(){var e=AE.get(yT);if(e)AE.remove(yT),gT(document,e)}()})).catch((function(e){return em.warn("Starting visitor app failed",{error:e})}))},setupIFrame:function(e){var t=e.getAccessToken,n=e.stats,r=e.pubsub,i=e.visitorPresenceChannel,o=e.internalVisitorStateObservable,s=e.volatileNotifications,a=e.wsProxy,c=e.bestEffortXDomainStorage,u=e.operatorPresenceObservable,l=e.xDomainUrlStorage,p=e.getVisitorPriority,f=e.routingObservable,h=new uN(e.tabId);h.start(),h.request(),sm.FrameCheck.startNotifyingOfBeingVisitorPage();var d=new Mg(h,sm.conf),b=!1;return d.identityObservable().subscribe((function(e){if(b)em.warn("Received iFrame identity after defaulting to unknown",{identity:e});else switch(b=!0,e){case d.IDENTITIES.NESTED_COBROWSABLE_IFRAME:dm(),function(e){var t=e.parentWindowMessenger,n=e.iframeContext,r=e.getAccessToken,i=e.stats;new fE(t,n.nestedCobrowsableVisitorIframeChannelUrl,r,i).boot()}({getAccessToken:t,parentWindowMessenger:h.getParentWindowMessenger(),iframeContext:h.getCurrentContext(),stats:n});break;case d.IDENTITIES.ENGAGEMENT_IFRAME:h.stop(),hN({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:u,routingObservable:f});break;default:sm.conf.visitor_api.allow_embedding?(em.info("Did not receive iFrame identity from parent, bootstrapping as top frame"),sm.FrameCheck.startNotifyingOfBeingVisitorBrowser(),dN.setupApp({stats:n,pubsub:r,getAccessToken:t,visitorPresenceChannel:i,internalVisitorStateObservable:o,volatileNotifications:s,wsProxy:a,operatorPresenceObservable:u,bestEffortXDomainStorage:c,xDomainUrlStorage:l,getVisitorPriority:p,routingObservable:f})):em.warn("Starting base app failed. IFrame has unknown identity.                 Top frame likely does not have Glia scripts installed.",{identity:e})}}))}};sm.EventEmitter=x,sm.dynamicImport=cm,sm.R=A,sm.Rx=zv,sm.App=um;var bN=Boolean(sm.Bootstrapper);sm.Bootstrapper={boot:function(){bN||sm.installed||(sm.installed=!0,dN.setup())}}}(sm.conf);
//# sourceMappingURL=bootstrapper-6dd946062.js.map
